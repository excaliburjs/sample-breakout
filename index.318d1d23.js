/*!
 * excalibur - 0.29.0-alpha.4+6f6d7bb - 2024-1-13
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2024 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var t={1388:(t,e,i)=>{i.d(e,{Z:()=>a});var s=i(272),r=i.n(s),n=i(2609),o=i.n(n)()(r());o.push([t.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition: background 250ms ease-in-out, transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB,8DAA8D;EAC9D,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:["/* Buttons styles start */\n\nbutton#excalibur-play {\n  display: inline-block;\n  position: relative;\n  z-index: 999;\n  border-radius: 6px;\n  border: none;\n  /*border: 3px solid;\n    border-color: white;\n    box-shadow: 0 0 10px #ccc;*/\n  padding: 1rem 1.5rem 1rem 4rem;\n  margin: 0;\n  text-decoration: none;\n  background: #00b233;\n  color: #ffffff;\n  font-family: sans-serif;\n  font-size: 2rem;\n  white-space: nowrap;\n  line-height: 1;\n  cursor: pointer;\n  text-align: center;\n  transition: background 250ms ease-in-out, transform 150ms ease;\n  -webkit-appearance: none;\n  -moz-appearance: none;\n\n  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\n  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\n  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\n  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\n  animation: excalibur-button-fadein 200ms;\n}\n\n/*\nbutton#excalibur-play {\n  display: none;\n}*/\n\nbutton#excalibur-play:after {\n  position: absolute;\n  content: '';\n  border: 8px solid;\n  border-color: transparent transparent transparent white;\n  left: 35px;\n  top: 24px;\n  width: 0;\n  height: 0;\n}\n\nbutton#excalibur-play:before {\n  position: absolute;\n  content: '';\n  border: 3px solid;\n  left: 19px;\n  top: 14px;\n  border-radius: 20px;\n  width: 30px;\n  height: 30px;\n}\n\nbutton#excalibur-play:hover,\nbutton#excalibur-play:focus {\n  background: #00982c;\n}\n\nbutton#excalibur-play:focus {\n  outline: 1px solid #fff;\n  outline-offset: -4px;\n}\n\nbutton#excalibur-play:active {\n  transform: scale(0.99);\n}\n\n@keyframes excalibur-button-fadein {\n  from {\n    opacity: 0;\n  }\n  to {\n    opacity: 1;\n  }\n}\n\n/* Firefox < 16 */\n@-moz-keyframes excalibur-button-fadein {\n  from {\n    opacity: 0;\n  }\n  to {\n    opacity: 1;\n  }\n}\n\n/* Safari, Chrome and Opera > 12.1 */\n@-webkit-keyframes excalibur-button-fadein {\n  from {\n    opacity: 0;\n  }\n  to {\n    opacity: 1;\n  }\n}\n\n/* Internet Explorer */\n@-ms-keyframes excalibur-button-fadein {\n  from {\n    opacity: 0;\n  }\n  to {\n    opacity: 1;\n  }\n}\n\n/* Opera < 12.1 */\n@-o-keyframes excalibur-button-fadein {\n  from {\n    opacity: 0;\n  }\n  to {\n    opacity: 1;\n  }\n}\n"],sourceRoot:""}]);let a=o},7379:(t,e,i)=>{i.d(e,{Z:()=>a});var s=i(272),r=i.n(s),n=i(2609),o=i.n(n)()(r());o.push([t.id,`
#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;


  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}


.ex-toast-message button {
  align-self: flex-start;
}`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:";AACA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;;EAG9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;;AAGA;EACE,sBAAsB;AACxB",sourcesContent:["\n#ex-toast-container {\n  position: absolute;\n  height: 0;\n  min-width: 50%;\n  left: 50%;\n  top: 0;\n}\n\n.ex-toast-message {\n  left: -50%;\n  position: relative;\n  display: flex;\n  justify-content: space-between;\n\n\n  padding: 10px;\n  margin-top: 5px;\n  font-size: 18px;\n  font-family: sans-serif;\n  border-radius: 6px;\n  border: 3px solid #b7b779;\n  background-color: rgb(253, 253, 192);\n}\n\n\n.ex-toast-message button {\n  align-self: flex-start;\n}"],sourceRoot:""}]);let a=o},2609:t=>{t.exports=function(t){var e=[];return e.toString=function(){return this.map(function(e){var i="",s=void 0!==e[5];return e[4]&&(i+="@supports (".concat(e[4],") {")),e[2]&&(i+="@media ".concat(e[2]," {")),s&&(i+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),i+=t(e),s&&(i+="}"),e[2]&&(i+="}"),e[4]&&(i+="}"),i}).join("")},e.i=function(t,i,s,r,n){"string"==typeof t&&(t=[[null,t,void 0]]);var o={};if(s)for(var a=0;a<this.length;a++){var h=this[a][0];null!=h&&(o[h]=!0)}for(var l=0;l<t.length;l++){var d=[].concat(t[l]);s&&o[d[0]]||(void 0!==n&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=n),i&&(d[2]&&(d[1]="@media ".concat(d[2]," {").concat(d[1],"}")),d[2]=i),r&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=r):d[4]="".concat(r)),e.push(d))}},e}},272:t=>{t.exports=function(t){var e=t[1],i=t[3];if(!i)return e;if("function"==typeof btoa){var s=btoa(unescape(encodeURIComponent(JSON.stringify(i))));return[e].concat(["/*# ".concat("sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(s)," */")]).join("\n")}return[e].join("\n")}},1324:(t,e,i)=>{i(7206);var s=i(8193);t.exports=s("Array","sort")},3571:(t,e,i)=>{i(9867);var s=i(8588);t.exports=s.Object.keys},1052:(t,e,i)=>{var s=i(688),r=i(3397),n=TypeError;t.exports=function(t){if(s(t))return t;throw new n(r(t)+" is not a function")}},9175:(t,e,i)=>{var s=i(5309),r=String,n=TypeError;t.exports=function(t){if(s(t))return t;throw new n(r(t)+" is not an object")}},1138:(t,e,i)=>{var s=i(6854),r=i(7352),n=i(8344),o=function(t){return function(e,i,o){var a,h=s(e),l=n(h),d=r(o,l);if(t&&i!=i){for(;l>d;)if((a=h[d++])!=a)return!0}else for(;l>d;d++)if((t||d in h)&&h[d]===i)return t||d||0;return!t&&-1}};t.exports={includes:o(!0),indexOf:o(!1)}},567:(t,e,i)=>{var s=i(4694);t.exports=function(t,e){var i=[][t];return!!i&&s(function(){i.call(null,e||function(){return 1},1)})}},6403:(t,e,i)=>{var s=i(7352),r=i(8344),n=i(3182),o=Array,a=Math.max;t.exports=function(t,e,i){for(var h=r(t),l=s(e,h),d=s(void 0===i?h:i,h),c=o(a(d-l,0)),u=0;l<d;l++,u++)n(c,u,t[l]);return c.length=u,c}},3097:(t,e,i)=>{var s=i(6403),r=Math.floor,n=function(t,e){var i=t.length,h=r(i/2);return i<8?o(t,e):a(t,n(s(t,0,h),e),n(s(t,h),e),e)},o=function(t,e){for(var i,s,r=t.length,n=1;n<r;){for(s=n,i=t[n];s&&e(t[s-1],i)>0;)t[s]=t[--s];s!==n++&&(t[s]=i)}return t},a=function(t,e,i,s){for(var r=e.length,n=i.length,o=0,a=0;o<r||a<n;)t[o+a]=o<r&&a<n?0>=s(e[o],i[a])?e[o++]:i[a++]:o<r?e[o++]:i[a++];return t};t.exports=n},2177:(t,e,i)=>{var s=i(9668),r=s({}.toString),n=s("".slice);t.exports=function(t){return n(r(t),8,-1)}},1566:(t,e,i)=>{var s=i(2522),r=i(688),n=i(2177),o=i(2032)("toStringTag"),a=Object,h="Arguments"===n(function(){return arguments}()),l=function(t,e){try{return t[e]}catch(t){}};t.exports=s?n:function(t){var e,i,s;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(i=l(e=a(t),o))?i:h?n(e):"Object"===(s=n(e))&&r(e.callee)?"Arguments":s}},3891:(t,e,i)=>{var s=i(4678),r=i(990),n=i(7537),o=i(2131);t.exports=function(t,e,i){for(var a=r(e),h=o.f,l=n.f,d=0;d<a.length;d++){var c=a[d];s(t,c)||i&&s(i,c)||h(t,c,l(e,c))}}},2385:(t,e,i)=>{var s=i(9924),r=i(2131),n=i(7781);t.exports=s?function(t,e,i){return r.f(t,e,n(1,i))}:function(t,e,i){return t[e]=i,t}},7781:t=>{t.exports=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}}},3182:(t,e,i)=>{var s=i(2358),r=i(2131),n=i(7781);t.exports=function(t,e,i){var o=s(e);o in t?r.f(t,o,n(0,i)):t[o]=i}},2470:(t,e,i)=>{var s=i(688),r=i(2131),n=i(1135),o=i(1604);t.exports=function(t,e,i,a){a||(a={});var h=a.enumerable,l=void 0!==a.name?a.name:e;if(s(i)&&n(i,l,a),a.global)h?t[e]=i:o(e,i);else{try{a.unsafe?t[e]&&(h=!0):delete t[e]}catch(t){}h?t[e]=i:r.f(t,e,{value:i,enumerable:!1,configurable:!a.nonConfigurable,writable:!a.nonWritable})}return t}},1604:(t,e,i)=>{var s=i(2150),r=Object.defineProperty;t.exports=function(t,e){try{r(s,t,{value:e,configurable:!0,writable:!0})}catch(i){s[t]=e}return e}},955:(t,e,i)=>{var s=i(3397),r=TypeError;t.exports=function(t,e){if(!delete t[e])throw new r("Cannot delete property "+s(e)+" of "+s(t))}},9924:(t,e,i)=>{var s=i(4694);t.exports=!s(function(){return 7!==Object.defineProperty({},1,{get:function(){return 7}})[1]})},1811:t=>{var e="object"==typeof document&&document.all;t.exports={all:e,IS_HTMLDDA:void 0===e&&void 0!==e}},1442:(t,e,i)=>{var s=i(2150),r=i(5309),n=s.document,o=r(n)&&r(n.createElement);t.exports=function(t){return o?n.createElement(t):{}}},9016:(t,e,i)=>{var s=i(1370).match(/firefox\/(\d+)/i);t.exports=!!s&&+s[1]},821:(t,e,i)=>{var s=i(1370);t.exports=/MSIE|Trident/.test(s)},1370:t=>{t.exports="undefined"!=typeof navigator&&String(navigator.userAgent)||""},7067:(t,e,i)=>{var s,r,n=i(2150),o=i(1370),a=n.process,h=n.Deno,l=a&&a.versions||h&&h.version,d=l&&l.v8;d&&(r=(s=d.split("."))[0]>0&&s[0]<4?1:+(s[0]+s[1])),!r&&o&&(!(s=o.match(/Edge\/(\d+)/))||s[1]>=74)&&(s=o.match(/Chrome\/(\d+)/))&&(r=+s[1]),t.exports=r},4389:(t,e,i)=>{var s=i(1370).match(/AppleWebKit\/(\d+)\./);t.exports=!!s&&+s[1]},8193:(t,e,i)=>{var s=i(2150),r=i(9668);t.exports=function(t,e){return r(s[t].prototype[e])}},2367:t=>{t.exports=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]},5532:(t,e,i)=>{var s=i(2150),r=i(7537).f,n=i(2385),o=i(2470),a=i(1604),h=i(3891),l=i(1633);t.exports=function(t,e){var i,d,c,u,p,_=t.target,g=t.global,m=t.stat;if(i=g?s:m?s[_]||a(_,{}):(s[_]||{}).prototype)for(d in e){if(u=e[d],c=t.dontCallGetSet?(p=r(i,d))&&p.value:i[d],!l(g?d:_+(m?".":"#")+d,t.forced)&&void 0!==c){if(typeof u==typeof c)continue;h(u,c)}(t.sham||c&&c.sham)&&n(u,"sham",!0),o(i,d,u,t)}}},4694:t=>{t.exports=function(t){try{return!!t()}catch(t){return!0}}},6398:(t,e,i)=>{var s=i(4694);t.exports=!s(function(){var t=(function(){}).bind();return"function"!=typeof t||t.hasOwnProperty("prototype")})},8724:(t,e,i)=>{var s=i(6398),r=Function.prototype.call;t.exports=s?r.bind(r):function(){return r.apply(r,arguments)}},453:(t,e,i)=>{var s=i(9924),r=i(4678),n=Function.prototype,o=s&&Object.getOwnPropertyDescriptor,a=r(n,"name"),h=a&&(!s||s&&o(n,"name").configurable);t.exports={EXISTS:a,PROPER:a&&"something"===(function(){}).name,CONFIGURABLE:h}},9668:(t,e,i)=>{var s=i(6398),r=Function.prototype,n=r.call,o=s&&r.bind.bind(n,n);t.exports=s?o:function(t){return function(){return n.apply(t,arguments)}}},2160:(t,e,i)=>{var s=i(2150),r=i(688);t.exports=function(t,e){var i;return arguments.length<2?r(i=s[t])?i:void 0:s[t]&&s[t][e]}},5383:(t,e,i)=>{var s=i(1052),r=i(5268);t.exports=function(t,e){var i=t[e];return r(i)?void 0:s(i)}},2150:function(t,e,i){var s=function(t){return t&&t.Math===Math&&t};t.exports=s("object"==typeof globalThis&&globalThis)||s("object"==typeof window&&window)||s("object"==typeof self&&self)||s("object"==typeof i.g&&i.g)||s("object"==typeof this&&this)||function(){return this}()||Function("return this")()},4678:(t,e,i)=>{var s=i(9668),r=i(298),n=s({}.hasOwnProperty);t.exports=Object.hasOwn||function(t,e){return n(r(t),e)}},7390:t=>{t.exports={}},7913:(t,e,i)=>{var s=i(9924),r=i(4694),n=i(1442);t.exports=!s&&!r(function(){return 7!==Object.defineProperty(n("div"),"a",{get:function(){return 7}}).a})},4347:(t,e,i)=>{var s=i(9668),r=i(4694),n=i(2177),o=Object,a=s("".split);t.exports=r(function(){return!o("z").propertyIsEnumerable(0)})?function(t){return"String"===n(t)?a(t,""):o(t)}:o},1881:(t,e,i)=>{var s=i(9668),r=i(688),n=i(6762),o=s(Function.toString);r(n.inspectSource)||(n.inspectSource=function(t){return o(t)}),t.exports=n.inspectSource},7804:(t,e,i)=>{var s,r,n,o=i(4724),a=i(2150),h=i(5309),l=i(2385),d=i(4678),c=i(6762),u=i(1962),p=i(7390),_="Object already initialized",g=a.TypeError,m=a.WeakMap;if(o||c.state){var f=c.state||(c.state=new m);f.get=f.get,f.has=f.has,f.set=f.set,s=function(t,e){if(f.has(t))throw new g(_);return e.facade=t,f.set(t,e),e},r=function(t){return f.get(t)||{}},n=function(t){return f.has(t)}}else{var v=u("state");p[v]=!0,s=function(t,e){if(d(t,v))throw new g(_);return e.facade=t,l(t,v,e),e},r=function(t){return d(t,v)?t[v]:{}},n=function(t){return d(t,v)}}t.exports={set:s,get:r,has:n,enforce:function(t){return n(t)?r(t):s(t,{})},getterFor:function(t){return function(e){var i;if(!h(e)||(i=r(e)).type!==t)throw new g("Incompatible receiver, "+t+" required");return i}}}},688:(t,e,i)=>{var s=i(1811),r=s.all;t.exports=s.IS_HTMLDDA?function(t){return"function"==typeof t||t===r}:function(t){return"function"==typeof t}},1633:(t,e,i)=>{var s=i(4694),r=i(688),n=/#|\.prototype\./,o=function(t,e){var i=h[a(t)];return i===d||i!==l&&(r(e)?s(e):!!e)},a=o.normalize=function(t){return String(t).replace(n,".").toLowerCase()},h=o.data={},l=o.NATIVE="N",d=o.POLYFILL="P";t.exports=o},5268:t=>{t.exports=function(t){return null==t}},5309:(t,e,i)=>{var s=i(688),r=i(1811),n=r.all;t.exports=r.IS_HTMLDDA?function(t){return"object"==typeof t?null!==t:s(t)||t===n}:function(t){return"object"==typeof t?null!==t:s(t)}},6555:t=>{t.exports=!1},7935:(t,e,i)=>{var s=i(2160),r=i(688),n=i(6148),o=i(4866),a=Object;t.exports=o?function(t){return"symbol"==typeof t}:function(t){var e=s("Symbol");return r(e)&&n(e.prototype,a(t))}},8344:(t,e,i)=>{var s=i(7331);t.exports=function(t){return s(t.length)}},1135:(t,e,i)=>{var s=i(9668),r=i(4694),n=i(688),o=i(4678),a=i(9924),h=i(453).CONFIGURABLE,l=i(1881),d=i(7804),c=d.enforce,u=d.get,p=String,_=Object.defineProperty,g=s("".slice),m=s("".replace),f=s([].join),v=a&&!r(function(){return 8!==_(function(){},"length",{value:8}).length}),x=String(String).split("String"),y=t.exports=function(t,e,i){"Symbol("===g(p(e),0,7)&&(e="["+m(p(e),/^Symbol\(([^)]*)\)/,"$1")+"]"),i&&i.getter&&(e="get "+e),i&&i.setter&&(e="set "+e),(!o(t,"name")||h&&t.name!==e)&&(a?_(t,"name",{value:e,configurable:!0}):t.name=e),v&&i&&o(i,"arity")&&t.length!==i.arity&&_(t,"length",{value:i.arity});try{i&&o(i,"constructor")&&i.constructor?a&&_(t,"prototype",{writable:!1}):t.prototype&&(t.prototype=void 0)}catch(t){}var s=c(t);return o(s,"source")||(s.source=f(x,"string"==typeof e?e:"")),t};Function.prototype.toString=y(function(){return n(this)&&u(this).source||l(this)},"toString")},1787:t=>{var e=Math.ceil,i=Math.floor;t.exports=Math.trunc||function(t){var s=+t;return(s>0?i:e)(s)}},2131:(t,e,i)=>{var s=i(9924),r=i(7913),n=i(2666),o=i(9175),a=i(2358),h=TypeError,l=Object.defineProperty,d=Object.getOwnPropertyDescriptor,c="enumerable",u="configurable",p="writable";e.f=s?n?function(t,e,i){if(o(t),e=a(e),o(i),"function"==typeof t&&"prototype"===e&&"value"in i&&p in i&&!i[p]){var s=d(t,e);s&&s[p]&&(t[e]=i.value,i={configurable:u in i?i[u]:s[u],enumerable:c in i?i[c]:s[c],writable:!1})}return l(t,e,i)}:l:function(t,e,i){if(o(t),e=a(e),o(i),r)try{return l(t,e,i)}catch(t){}if("get"in i||"set"in i)throw new h("Accessors not supported");return"value"in i&&(t[e]=i.value),t}},7537:(t,e,i)=>{var s=i(9924),r=i(8724),n=i(8208),o=i(7781),a=i(6854),h=i(2358),l=i(4678),d=i(7913),c=Object.getOwnPropertyDescriptor;e.f=s?c:function(t,e){if(t=a(t),e=h(e),d)try{return c(t,e)}catch(t){}if(l(t,e))return o(!r(n.f,t,e),t[e])}},6217:(t,e,i)=>{var s=i(1528),r=i(2367).concat("length","prototype");e.f=Object.getOwnPropertyNames||function(t){return s(t,r)}},5168:(t,e)=>{e.f=Object.getOwnPropertySymbols},6148:(t,e,i)=>{var s=i(9668);t.exports=s({}.isPrototypeOf)},1528:(t,e,i)=>{var s=i(9668),r=i(4678),n=i(6854),o=i(1138).indexOf,a=i(7390),h=s([].push);t.exports=function(t,e){var i,s=n(t),l=0,d=[];for(i in s)!r(a,i)&&r(s,i)&&h(d,i);for(;e.length>l;)r(s,i=e[l++])&&(~o(d,i)||h(d,i));return d}},1728:(t,e,i)=>{var s=i(1528),r=i(2367);t.exports=Object.keys||function(t){return s(t,r)}},8208:(t,e)=>{var i={}.propertyIsEnumerable,s=Object.getOwnPropertyDescriptor,r=s&&!i.call({1:2},1);e.f=r?function(t){var e=s(this,t);return!!e&&e.enumerable}:i},110:(t,e,i)=>{var s=i(8724),r=i(688),n=i(5309),o=TypeError;t.exports=function(t,e){var i,a;if("string"===e&&r(i=t.toString)&&!n(a=s(i,t))||r(i=t.valueOf)&&!n(a=s(i,t))||"string"!==e&&r(i=t.toString)&&!n(a=s(i,t)))return a;throw new o("Can't convert object to primitive value")}},990:(t,e,i)=>{var s=i(2160),r=i(9668),n=i(6217),o=i(5168),a=i(9175),h=r([].concat);t.exports=s("Reflect","ownKeys")||function(t){var e=n.f(a(t)),i=o.f;return i?h(e,i(t)):e}},8588:(t,e,i)=>{var s=i(2150);t.exports=s},1166:(t,e,i)=>{var s=i(5268),r=TypeError;t.exports=function(t){if(s(t))throw new r("Can't call method on "+t);return t}},1962:(t,e,i)=>{var s=i(2645),r=i(5736),n=s("keys");t.exports=function(t){return n[t]||(n[t]=r(t))}},6762:(t,e,i)=>{var s=i(2150),r=i(1604),n="__core-js_shared__",o=s[n]||r(n,{});t.exports=o},2645:(t,e,i)=>{var s=i(6555),r=i(6762);(t.exports=function(t,e){return r[t]||(r[t]=void 0!==e?e:{})})("versions",[]).push({version:"3.33.3",mode:s?"pure":"global",copyright:"© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.33.3/LICENSE",source:"https://github.com/zloirock/core-js"})},4112:(t,e,i)=>{var s=i(7067),r=i(4694),n=i(2150).String;t.exports=!!Object.getOwnPropertySymbols&&!r(function(){var t=Symbol("symbol detection");return!n(t)||!(Object(t) instanceof Symbol)||!Symbol.sham&&s&&s<41})},7352:(t,e,i)=>{var s=i(1680),r=Math.max,n=Math.min;t.exports=function(t,e){var i=s(t);return i<0?r(i+e,0):n(i,e)}},6854:(t,e,i)=>{var s=i(4347),r=i(1166);t.exports=function(t){return s(r(t))}},1680:(t,e,i)=>{var s=i(1787);t.exports=function(t){var e=+t;return e!=e||0===e?0:s(e)}},7331:(t,e,i)=>{var s=i(1680),r=Math.min;t.exports=function(t){return t>0?r(s(t),9007199254740991):0}},298:(t,e,i)=>{var s=i(1166),r=Object;t.exports=function(t){return r(s(t))}},1272:(t,e,i)=>{var s=i(8724),r=i(5309),n=i(7935),o=i(5383),a=i(110),h=i(2032),l=TypeError,d=h("toPrimitive");t.exports=function(t,e){if(!r(t)||n(t))return t;var i,h=o(t,d);if(h){if(void 0===e&&(e="default"),!r(i=s(h,t,e))||n(i))return i;throw new l("Can't convert object to primitive value")}return void 0===e&&(e="number"),a(t,e)}},2358:(t,e,i)=>{var s=i(1272),r=i(7935);t.exports=function(t){var e=s(t,"string");return r(e)?e:e+""}},2522:(t,e,i)=>{var s=i(2032)("toStringTag"),r={};r[s]="z",t.exports="[object z]"===String(r)},599:(t,e,i)=>{var s=i(1566),r=String;t.exports=function(t){if("Symbol"===s(t))throw TypeError("Cannot convert a Symbol value to a string");return r(t)}},3397:t=>{var e=String;t.exports=function(t){try{return e(t)}catch(t){return"Object"}}},5736:(t,e,i)=>{var s=i(9668),r=0,n=Math.random(),o=s(1..toString);t.exports=function(t){return"Symbol("+(void 0===t?"":t)+")_"+o(++r+n,36)}},4866:(t,e,i)=>{var s=i(4112);t.exports=s&&!Symbol.sham&&"symbol"==typeof Symbol.iterator},2666:(t,e,i)=>{var s=i(9924),r=i(4694);t.exports=s&&r(function(){return 42!==Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype})},4724:(t,e,i)=>{var s=i(2150),r=i(688),n=s.WeakMap;t.exports=r(n)&&/native code/.test(String(n))},2032:(t,e,i)=>{var s=i(2150),r=i(2645),n=i(4678),o=i(5736),a=i(4112),h=i(4866),l=s.Symbol,d=r("wks"),c=h?l.for||l:l&&l.withoutSetter||o;t.exports=function(t){return n(d,t)||(d[t]=a&&n(l,t)?l[t]:c("Symbol."+t)),d[t]}},7206:(t,e,i)=>{var s=i(5532),r=i(9668),n=i(1052),o=i(298),a=i(8344),h=i(955),l=i(599),d=i(4694),c=i(3097),u=i(567),p=i(9016),_=i(821),g=i(7067),m=i(4389),f=[],v=r(f.sort),x=r(f.push),y=d(function(){f.sort(void 0)}),w=d(function(){f.sort(null)}),b=u("sort"),C=!d(function(){if(g)return g<70;if(!p||!(p>3)){if(_)return!0;if(m)return m<603;var t,e,i,s,r="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(s=0;s<47;s++)f.push({k:e+s,v:i})}for(f.sort(function(t,e){return e.v-t.v}),s=0;s<f.length;s++)e=f[s].k.charAt(0),r.charAt(r.length-1)!==e&&(r+=e);return"DGBEFHACIJK"!==r}});s({target:"Array",proto:!0,forced:y||!w||!b||!C},{sort:function(t){void 0!==t&&n(t);var e,i,s=o(this);if(C)return void 0===t?v(s):v(s,t);var r=[],d=a(s);for(i=0;i<d;i++)i in s&&x(r,s[i]);for(c(r,function(e,i){return void 0===i?-1:void 0===e?1:void 0!==t?+t(e,i)||0:l(e)>l(i)?1:-1}),e=a(r),i=0;i<e;)s[i]=r[i++];for(;i<d;)h(s,i++);return s}})},9867:(t,e,i)=>{var s=i(5532),r=i(298),n=i(1728);s({target:"Object",stat:!0,forced:i(4694)(function(){n(1)})},{keys:function(t){return n(r(t))}})}},e={};function i(s){var r=e[s];if(void 0!==r)return r.exports;var n=e[s]={id:s,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s={};(()=>{i.d(s,{y1j:()=>et,fWn:()=>sH,Ia8:()=>sC,rqv:()=>nt,zH6:()=>t8,hLI:()=>sW,yyv:()=>rR,tX5:()=>t5,vtX:()=>sZ,r7K:()=>sl,lCh:()=>rn,cE4:()=>ek,fwF:()=>rb,sce:()=>ta,AQ6:()=>rw,_c7:()=>th,KUs:()=>rf,Ajp:()=>i_,dkO:()=>O,RDh:()=>tn,_H9:()=>ti,mxs:()=>sM,OmD:()=>sh,kBf:()=>eA,C4F:()=>Y,NQt:()=>rV,JjN:()=>rq,EK_:()=>U,V1s:()=>rt,xHm:()=>s8,Xz7:()=>iA,Cdc:()=>sy,FKn:()=>st,SUY:()=>rQ,ab2:()=>i7,GfZ:()=>i8,YMS:()=>i3,oyv:()=>sa,aUb:()=>se,SdD:()=>t1,JUv:()=>iQ,jEj:()=>i$,TFq:()=>ss,HDU:()=>tJ,R_y:()=>tQ,ydN:()=>K,t50:()=>t0,s$$:()=>ry,v2G:()=>Z,Ilk:()=>eb,s9i:()=>rN,dxL:()=>tc,LLX:()=>rO,wA2:()=>iX,R_p:()=>i6,IQ$:()=>rA,I5F:()=>er,X8$:()=>rv,FR6:()=>t$,U8o:()=>tj,kbG:()=>$,iS_:()=>t4,cGG:()=>rH,RPN:()=>sQ,skb:()=>rI,SLU:()=>eZ,RdJ:()=>Q,cNu:()=>sz,gU7:()=>iL,LSk:()=>sU,Nmp:()=>tr,d1Y:()=>X,xrL:()=>i2,sRW:()=>i4,cmV:()=>ny,qWz:()=>sk,N0Q:()=>sF,q8b:()=>sb,ynB:()=>sr,jT9:()=>s6,wAz:()=>tl,D4V:()=>r3,NLr:()=>r4,N6H:()=>t9,W1A:()=>t6,JHW:()=>s_,ZZ$:()=>sp,v2K:()=>rl,pBf:()=>r6,vpe:()=>tT,GMl:()=>z,zW2:()=>tf,B0K:()=>iT,Nv7:()=>id,C_p:()=>ih,MUA:()=>t7,xqU:()=>t3,pTp:()=>sL,vUK:()=>tC,j9l:()=>sO,Zxw:()=>sq,v51:()=>sV,Hdx:()=>ts,Z$d:()=>tt,iqV:()=>r$,o$7:()=>rW,olM:()=>eT,Zm$:()=>tS,$QH:()=>tD,i78:()=>tR,nJg:()=>ei,h6u:()=>tq,hts:()=>tV,j88:()=>tW,VME:()=>tG,fy2:()=>ee,nt:()=>nd,Ukr:()=>rX,zsu:()=>eH,oA6:()=>sv,TVh:()=>rC,TwZ:()=>sm,GTT:()=>sf,xxj:()=>rP,XdK:()=>tZ,Jmb:()=>q,cXo:()=>eV,Dm5:()=>t2,IIB:()=>ty,ebW:()=>r5,zI0:()=>j,LYD:()=>rB,cEG:()=>rF,SEl:()=>r8,t9V:()=>r7,ez5:()=>ea,N1d:()=>eh,R8U:()=>H,SKZ:()=>tE,__J:()=>r9,RI$:()=>s7,x12:()=>nm,ccz:()=>i9,aNw:()=>ik,XrL:()=>iF,xwn:()=>s3,dNK:()=>s4,ini:()=>N,YdH:()=>es,F5T:()=>is,y3G:()=>eF,l57:()=>V,xn0:()=>iP,t2V:()=>sN,uxB:()=>ij,cpd:()=>rm,fiy:()=>sS,$XZ:()=>sE,UG6:()=>tp,uqK:()=>iI,STE:()=>iD,y$z:()=>iK,mAD:()=>rk,sOq:()=>iJ,hUw:()=>s$,_0G:()=>ne,Sqs:()=>ng,hpZ:()=>rS,Vol:()=>rE,vYX:()=>td,wIZ:()=>iW,cBi:()=>rG,c30:()=>rM,MPV:()=>t_,RFv:()=>sw,Ux6:()=>rZ,rxy:()=>rj,I$c:()=>W,kfC:()=>rD,VjY:()=>tg,mgq:()=>nf,YVA:()=>sn,Kgp:()=>it,HH$:()=>tY,M_d:()=>tz,rgh:()=>tF,Ra6:()=>tH,KhR:()=>tI,gvQ:()=>tM,BS5:()=>tO,xhz:()=>tK,xOq:()=>tL,a9j:()=>tB,bHk:()=>tN,CgK:()=>tP,cEd:()=>tk,cuY:()=>tU,kvE:()=>i0,SBu:()=>e6,PsT:()=>sJ,AE_:()=>rc,ctO:()=>ru,OLH:()=>s9,kky:()=>el,nSF:()=>iC,zHn:()=>i5,zwx:()=>rx,AeJ:()=>sx,hLz:()=>sc,D9g:()=>ra,wA:()=>sA,jhr:()=>sT,GVs:()=>ic,_zO:()=>eU,LXZ:()=>ez,w6$:()=>sI,mhV:()=>sP,MOD:()=>J,kwd:()=>sR,Lmr:()=>sD,xsS:()=>rz,K5l:()=>rL,lLr:()=>ip,Z$r:()=>en,IXb:()=>sY,Xsu:()=>iu,SGH:()=>rU,SMj:()=>tm,L34:()=>nx,exe:()=>eJ,bnF:()=>so,MFA:()=>G,$uU:()=>iB,Sap:()=>iR,jyi:()=>eW,E03:()=>eX,V6q:()=>eq,rg2:()=>rJ,DVW:()=>iS,nVo:()=>s5,F6N:()=>np,xP7:()=>rr,Odq:()=>rp,Zif:()=>to,ZGJ:()=>iZ,MJk:()=>r0,xvT:()=>sX,PHM:()=>te,dpR:()=>eG,n9L:()=>s2,KwO:()=>s1,SxM:()=>s0,B7y:()=>sj,x7r:()=>r2,wx7:()=>iq,Uvn:()=>iY,OFT:()=>i1,xzN:()=>rs,CcZ:()=>re,M5Z:()=>ed,ZrN:()=>tw,OWs:()=>ey,dF9:()=>iG,oZy:()=>e0,rD2:()=>e1,VHo:()=>tX,ohE:()=>ig,R$E:()=>iE,xQN:()=>tu,AdJ:()=>rK,q3I:()=>r_,Pab:()=>e_,uZ5:()=>ep,McK:()=>tA,F9c:()=>ec,k0b:()=>sg,hnT:()=>ns,RSJ:()=>na,Mku:()=>nn,h90:()=>nl,rms:()=>nh,ErP:()=>ni,aVg:()=>no,lPc:()=>nr,Z8E:()=>sd,_N2:()=>ro,yFn:()=>rh,lNv:()=>su,cu9:()=>sK,MZQ:()=>iz,FUM:()=>iH,BxR:()=>io,vdf:()=>ev,iaL:()=>ex,w6H:()=>ef,Q4c:()=>iO,Xxe:()=>eu,Uxb:()=>eg,Yr5:()=>em,Bhw:()=>ew,yOA:()=>tv});var t,e,r,n,o,a,h,l,d,c,u,p,_,g,m,f,v,x,y,w,b,C,A,T,S,E,P,I,D,R,B,F,k,M,L,z,U,O,N,H,W,G,V,q,X,Z,K,Y,j,$,Q,J,tt,te,ti,ts,tr,tn,to,ta,th,tl,td,tc,tu,tp,t_,tg,tm,tf={};i.r(tf),i.d(tf,{ActionCompleteEvent:()=>et,ActionStartEvent:()=>t8,ActivateEvent:()=>t5,CollisionEndEvent:()=>t1,CollisionPostSolveEvent:()=>tJ,CollisionPreSolveEvent:()=>tQ,CollisionStartEvent:()=>t0,ContactEndEvent:()=>t$,ContactStartEvent:()=>tj,DeactivateEvent:()=>t4,EnterTriggerEvent:()=>t9,EnterViewPortEvent:()=>t6,EventTypes:()=>z,ExitTriggerEvent:()=>t7,ExitViewPortEvent:()=>t3,GameEvent:()=>tS,GameStartEvent:()=>tD,GameStopEvent:()=>tR,GamepadAxisEvent:()=>tq,GamepadButtonEvent:()=>tV,GamepadConnectEvent:()=>tW,GamepadDisconnectEvent:()=>tG,HiddenEvent:()=>tZ,InitializeEvent:()=>t2,KillEvent:()=>tE,PostCollisionEvent:()=>tY,PostDebugDrawEvent:()=>tz,PostDrawEvent:()=>tF,PostFrameEvent:()=>tH,PostKillEvent:()=>tI,PostTransformDrawEvent:()=>tM,PostUpdateEvent:()=>tO,PreCollisionEvent:()=>tK,PreDebugDrawEvent:()=>tL,PreDrawEvent:()=>tB,PreFrameEvent:()=>tN,PreKillEvent:()=>tP,PreTransformDrawEvent:()=>tk,PreUpdateEvent:()=>tU,VisibleEvent:()=>tX});var tv={};i.r(tv),i.d(tv,{getAttributeComponentSize:()=>e$,getAttributePointerType:()=>eQ,getGlTypeSizeBytes:()=>ej});var tx={};i.r(tx),i.d(tx,{circle:()=>iw,line:()=>im,point:()=>iv,roundRect:()=>iy,vector:()=>ix});var ty={};i.r(ty),i.d(ty,{Axes:()=>O,Buttons:()=>U,Gamepad:()=>ei,Gamepads:()=>ee,KeyEvent:()=>ea,Keyboard:()=>eh,Keys:()=>H,NativePointerButton:()=>tp,PointerButton:()=>t_,PointerComponent:()=>sw,PointerEvent:()=>rZ,PointerEventReceiver:()=>rj,PointerScope:()=>W,PointerSystem:()=>rD,PointerType:()=>tg,WheelDeltaMode:()=>tu,WheelEvent:()=>rK});var tw={};function tb(){if("undefined"==typeof window&&(window={audioContext:function(){}}),"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setInterval(t,1e3/60)}),"undefined"==typeof window||window.cancelAnimationFrame||(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),"undefined"!=typeof window&&!window.AudioContext){if(window.webkitAudioContext){let t=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(e){return new Promise((i,s)=>{t.call(this,e,i,s)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}"undefined"==typeof window||window.devicePixelRatio||(window.devicePixelRatio=window.devicePixelRatio||1)}i.r(tw),i.d(tw,{ConsoleAppender:()=>er,DrawUtil:()=>tx,EasingFunctions:()=>sb,LogLevel:()=>N,Logger:()=>es,Observable:()=>iK,ScreenAppender:()=>en,addItemToArray:()=>eE,contains:()=>eI,delay:()=>eR,fail:()=>eD,getPosition:()=>eS,omit:()=>eB,removeItemFromArray:()=>eP}),i(1324),i(3571);class tC{static useCanvasGraphicsContext(){tC.enable("use-canvas-context")}static freeze(){tC._FROZEN=!0}static _reset(){tC._FROZEN=!1,tC._FLAGS={}}static enable(t){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");tC._FLAGS[t]=!0}static disable(t){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");tC._FLAGS[t]=!1}static isEnabled(t){return!!tC._FLAGS[t]}static show(){return Object.keys(tC._FLAGS)}}function tA(t,e){return{type:t,value:e}}tC._FROZEN=!1,tC._FLAGS={};class tT{constructor(){this._paused=!1,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0}on(t,e){var i;return this._listeners[t]=null!==(i=this._listeners[t])&&void 0!==i?i:[],this._listeners[t].push(e),{close:()=>this.off(t,e)}}once(t,e){var i;return this._listenersOnce[t]=null!==(i=this._listenersOnce[t])&&void 0!==i?i:[],this._listenersOnce[t].push(e),{close:()=>this.off(t,e)}}off(t,e){var i,s;if(e){let r=null===(i=this._listeners[t])||void 0===i?void 0:i.filter(t=>t!==e);this._listeners[t]=r;let n=null===(s=this._listenersOnce[t])||void 0===s?void 0:s.filter(t=>t!==e);this._listenersOnce[t]=n}else delete this._listeners[t]}emit(t,e){var i;if(this._paused)return;null===(i=this._listeners[t])||void 0===i||i.forEach(t=>t(e));let s=this._listenersOnce[t];this._listenersOnce[t]=[],s&&s.forEach(t=>t(e)),this._pipes.forEach(i=>{i.emit(t,e)})}pipe(t){if(this===t)throw Error("Cannot pipe to self");return this._pipes.push(t),{close:()=>{let e=this._pipes.indexOf(t);e>-1&&this._pipes.splice(e,1)}}}unpipe(t){let e=this._pipes.indexOf(t);e>-1&&this._pipes.splice(e,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}(t=z||(z={})).Kill="kill",t.PreKill="prekill",t.PostKill="postkill",t.PreDraw="predraw",t.PostDraw="postdraw",t.PreDebugDraw="predebugdraw",t.PostDebugDraw="postdebugdraw",t.PreUpdate="preupdate",t.PostUpdate="postupdate",t.PreFrame="preframe",t.PostFrame="postframe",t.PreCollision="precollision",t.CollisionStart="collisionstart",t.CollisionEnd="collisionend",t.PostCollision="postcollision",t.Initialize="initialize",t.Activate="activate",t.Deactivate="deactivate",t.ExitViewport="exitviewport",t.EnterViewport="enterviewport",t.ExitTrigger="exit",t.EnterTrigger="enter",t.Connect="connect",t.Disconnect="disconnect",t.Button="button",t.Axis="axis",t.Visible="visible",t.Hidden="hidden",t.Start="start",t.Stop="stop",t.PointerUp="pointerup",t.PointerDown="pointerdown",t.PointerMove="pointermove",t.PointerEnter="pointerenter",t.PointerLeave="pointerleave",t.PointerCancel="pointercancel",t.PointerWheel="pointerwheel",t.Up="up",t.Down="down",t.Move="move",t.Enter="enter",t.Leave="leave",t.Cancel="cancel",t.Wheel="wheel",t.Press="press",t.Release="release",t.Hold="hold",t.PointerDragStart="pointerdragstart",t.PointerDragEnd="pointerdragend",t.PointerDragEnter="pointerdragenter",t.PointerDragLeave="pointerdragleave",t.PointerDragMove="pointerdragmove",t.ActionStart="actionstart",t.ActionComplete="actioncomplete";class tS{constructor(){this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(t){this._bubbles=t}stopPropagation(){this.bubbles=!1}}class tE extends tS{constructor(t){super(),this.target=t}}class tP extends tS{constructor(t){super(),this.target=t}}class tI extends tS{constructor(t){super(),this.target=t}}class tD extends tS{constructor(t){super(),this.target=t}}class tR extends tS{constructor(t){super(),this.target=t}}class tB extends tS{constructor(t,e,i){super(),this.ctx=t,this.delta=e,this.target=i}}class tF extends tS{constructor(t,e,i){super(),this.ctx=t,this.delta=e,this.target=i}}class tk extends tS{constructor(t,e,i){super(),this.ctx=t,this.delta=e,this.target=i}}class tM extends tS{constructor(t,e,i){super(),this.ctx=t,this.delta=e,this.target=i}}class tL extends tS{constructor(t,e){super(),this.ctx=t,this.target=e}}class tz extends tS{constructor(t,e){super(),this.ctx=t,this.target=e}}class tU extends tS{constructor(t,e,i){super(),this.engine=t,this.delta=e,this.target=i}}class tO extends tS{constructor(t,e,i){super(),this.engine=t,this.delta=e,this.target=i}}class tN extends tS{constructor(t,e){super(),this.engine=t,this.prevStats=e,this.target=t}}class tH extends tS{constructor(t,e){super(),this.engine=t,this.stats=e,this.target=t}}class tW extends tS{constructor(t,e){super(),this.index=t,this.gamepad=e,this.target=e}}class tG extends tS{constructor(t,e){super(),this.index=t,this.gamepad=e,this.target=e}}class tV extends tS{constructor(t,e,i){super(),this.button=t,this.value=e,this.target=i}}class tq extends tS{constructor(t,e,i){super(),this.axis=t,this.value=e,this.target=i}}class tX extends tS{constructor(t){super(),this.target=t}}class tZ extends tS{constructor(t){super(),this.target=t}}class tK extends tS{constructor(t,e,i,s,r){super(),this.other=e,this.side=i,this.intersection=s,this.contact=r,this.target=t}}class tY extends tS{constructor(t,e,i,s,r){super(),this.other=e,this.side=i,this.intersection=s,this.contact=r,this.target=t}get actor(){return this.target}set actor(t){this.target=t}}class tj{constructor(t,e,i,s){this.target=t,this.other=e,this.side=i,this.contact=s}}class t${constructor(t,e){this.target=t,this.other=e}}class tQ{constructor(t,e,i,s,r){this.target=t,this.other=e,this.side=i,this.intersection=s,this.contact=r}}class tJ{constructor(t,e,i,s,r){this.target=t,this.other=e,this.side=i,this.intersection=s,this.contact=r}}class t0 extends tS{constructor(t,e,i,s){super(),this.other=e,this.side=i,this.contact=s,this.target=t}get actor(){return this.target}set actor(t){this.target=t}}class t1 extends tS{constructor(t,e){super(),this.other=e,this.target=t}get actor(){return this.target}set actor(t){this.target=t}}class t2 extends tS{constructor(t,e){super(),this.engine=t,this.target=e}}class t5 extends tS{constructor(t,e){super(),this.context=t,this.target=e}}class t4 extends tS{constructor(t,e){super(),this.context=t,this.target=e}}class t3 extends tS{constructor(t){super(),this.target=t}}class t6 extends tS{constructor(t){super(),this.target=t}}class t9 extends tS{constructor(t,e){super(),this.target=t,this.actor=e}}class t7 extends tS{constructor(t,e){super(),this.target=t,this.actor=e}}class t8 extends tS{constructor(t,e){super(),this.action=t,this.target=e}}class et extends tS{constructor(t,e){super(),this.action=t,this.target=e}}class ee{constructor(){this.events=new tT,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null}init(){this.supported&&!this._initSuccess&&(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0))}setMinimumGamepadConfiguration(t){this._enableAndUpdate(),this._minimumConfiguration=t}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(t){if(!this._minimumConfiguration)return!0;if(!t)return!1;let e=t.axes.filter(t=>!0).length,i=t.buttons.filter(t=>!0).length;return e>=this._minimumConfiguration.axis&&i>=this._minimumConfiguration.buttons&&t.connected}emit(t,e){this.events.emit(t,e)}on(t,e){return this._enableAndUpdate(),this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this._enableAndUpdate(),this.events.off(t,e)}update(){if(!this.enabled||!this.supported)return;this.init();let t=this._navigator.getGamepads();for(let e=0;e<t.length;e++){let i,s,r,n,o;if(t[e])!this.at(e).connected&&this._isGamepadValid(t[e])&&this.events.emit("connect",new tW(e,this.at(e))),this.at(e).connected=!0;else{let t=this.at(e);t.connected&&this.events.emit("disconnect",new tG(e,t)),t.connected=!1;continue}if(this.at(e).update(),!t[e].timestamp||t[e].timestamp!==this._gamePadTimeStamps[e]){for(i in this._gamePadTimeStamps[e]=t[e].timestamp,this.at(e).navigatorGamepad=t[e],U)"number"==typeof(s=U[i])&&t[e].buttons[s]&&(o=t[e].buttons[s].value)!==this._oldPads[e].getButton(s)&&(t[e].buttons[s].pressed?(this.at(e).updateButton(s,o),this.at(e).events.emit("button",new tV(s,o,this.at(e)))):this.at(e).updateButton(s,0));for(r in O)"number"==typeof(n=O[r])&&(o=t[e].axes[n])!==this._oldPads[e].getAxes(n)&&(this.at(e).updateAxes(n,o),this.at(e).events.emit("axis",new tq(n,o,this.at(e))));this._oldPads[e]=this._clonePad(t[e])}}}at(t){if(this._enableAndUpdate(),t>=this._pads.length)for(let e=this._pads.length-1;e<t;e++)this._pads.push(new ei),this._oldPads.push(new ei);return this._pads[t]}getValidGamepads(){this._enableAndUpdate();let t=[];for(let e=0;e<this._pads.length;e++)this._isGamepadValid(this.at(e).navigatorGamepad)&&this.at(e).connected&&t.push(this.at(e));return t}count(){return this._pads.filter(t=>t.connected).length}_clonePads(t){let e=[];for(let i=0,s=t.length;i<s;i++)e.push(this._clonePad(t[i]));return e}_clonePad(t){let e,i;let s=new ei;if(!t)return s;for(e=0,i=t.buttons.length;e<i;e++)t.buttons[e]&&s.updateButton(e,t.buttons[e].value);for(e=0,i=t.axes.length;e<i;e++)s.updateAxes(e,t.axes[e]);return s}}ee.MinAxisMoveThreshold=.05;class ei{constructor(){this.events=new tT,this.connected=!1,this._axes=[,,,,],this._buttons=Array(16),this._buttonsUp=Array(16),this._buttonsDown=Array(16);for(let t=0;t<this._buttons.length;t++)this._buttons[t]=0;for(let t=0;t<this._axes.length;t++)this._axes[t]=0}update(){this._buttonsDown=Array(16),this._buttonsUp=Array(16)}isButtonPressed(t,e=1){return this._buttons[t]>=e}isButtonHeld(t,e=1){return this._buttons[t]>=e}wasButtonPressed(t,e=1){return this._buttonsDown[t]>=e}wasButtonReleased(t){return!!this._buttonsUp[t]}getButton(t){return this._buttons[t]}getAxes(t){let e=this._axes[t];return Math.abs(e)<ee.MinAxisMoveThreshold?0:e}updateButton(t,e){0===e&&this._buttons[t]?this._buttonsUp[t]=1:this._buttonsDown[t]=e,this._buttons[t]=e}updateAxes(t,e){this._axes[t]=e}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}}(e=U||(U={}))[e.Face1=0]="Face1",e[e.Face2=1]="Face2",e[e.Face3=2]="Face3",e[e.Face4=3]="Face4",e[e.LeftBumper=4]="LeftBumper",e[e.RightBumper=5]="RightBumper",e[e.LeftTrigger=6]="LeftTrigger",e[e.RightTrigger=7]="RightTrigger",e[e.Select=8]="Select",e[e.Start=9]="Start",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick",e[e.DpadUp=12]="DpadUp",e[e.DpadDown=13]="DpadDown",e[e.DpadLeft=14]="DpadLeft",e[e.DpadRight=15]="DpadRight",(r=O||(O={}))[r.LeftStickX=0]="LeftStickX",r[r.LeftStickY=1]="LeftStickY",r[r.RightStickX=2]="RightStickX",r[r.RightStickY=3]="RightStickY",(n=N||(N={}))[n.Debug=0]="Debug",n[n.Info=1]="Info",n[n.Warn=2]="Warn",n[n.Error=3]="Error",n[n.Fatal=4]="Fatal";class es{constructor(){if(this._appenders=[],this.defaultLevel=N.Info,es._INSTANCE)throw Error("Logger is a singleton");return es._INSTANCE=this,es._INSTANCE.addAppender(new er),es._INSTANCE}static getInstance(){return null==es._INSTANCE&&(es._INSTANCE=new es),es._INSTANCE}addAppender(t){this._appenders.push(t)}clearAppenders(){this._appenders.length=0}_log(t,e){null==t&&(t=this.defaultLevel);let i=this._appenders.length;for(let s=0;s<i;s++)t>=this.defaultLevel&&this._appenders[s].log(t,e)}debug(...t){this._log(N.Debug,t)}info(...t){this._log(N.Info,t)}warn(...t){this._log(N.Warn,t)}error(...t){this._log(N.Error,t)}fatal(...t){this._log(N.Fatal,t)}}es._INSTANCE=null;class er{log(t,e){if(!console&&!console.log&&console.warn&&console.error)return;let i=[];i.unshift.apply(i,e),i.unshift("["+N[t]+"] : "),t<N.Warn?console.log.apply?console.log.apply(console,i):console.log(i.join(" ")):t<N.Error?console.warn.apply?console.warn.apply(console,i):console.warn(i.join(" ")):console.error.apply?console.error.apply(console,i):console.error(i.join(" "))}}class en{constructor(t,e){this._messages=[],this._canvas=document.createElement("canvas"),this._canvas.width=t||window.innerWidth,this._canvas.height=e||window.innerHeight,this._canvas.style.position="absolute",this._ctx=this._canvas.getContext("2d"),document.body.appendChild(this._canvas)}log(t,e){let i=e.join(",");this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._messages.unshift("["+N[t]+"] : "+i);let s=10,r=1;for(let t=0;t<this._messages.length;t++)this._ctx.fillStyle="rgba(255,255,255,"+r.toFixed(2)+")",this._ctx.fillText(this._messages[t],200,s),s+=10,r=r>0?r-.05:0}}function eo(){try{let t=()=>{};window.top.addEventListener("blur",t),window.top.removeEventListener("blur",t)}catch(t){return!0}return!1}(o=H||(H={})).Num0="Numpad0",o.Num1="Numpad1",o.Num2="Numpad2",o.Num3="Numpad3",o.Num4="Numpad4",o.Num5="Numpad5",o.Num6="Numpad6",o.Num7="Numpad7",o.Num8="Numpad8",o.Num9="Numpad9",o.NumAdd="NumpadAdd",o.NumSubtract="NumpadSubtract",o.NumMultiply="NumpadMultiply",o.NumDivide="NumpadDivide",o.NumDecimal="NumpadDecimal",o.Numpad0="Numpad0",o.Numpad1="Numpad1",o.Numpad2="Numpad2",o.Numpad3="Numpad3",o.Numpad4="Numpad4",o.Numpad5="Numpad5",o.Numpad6="Numpad6",o.Numpad7="Numpad7",o.Numpad8="Numpad8",o.Numpad9="Numpad9",o.NumpadAdd="NumpadAdd",o.NumpadSubtract="NumpadSubtract",o.NumpadMultiply="NumpadMultiply",o.NumpadDivide="NumpadDivide",o.NumpadDecimal="NumpadDecimal",o.NumLock="NumLock",o.ShiftLeft="ShiftLeft",o.ShiftRight="ShiftRight",o.AltLeft="AltLeft",o.AltRight="AltRight",o.ControlLeft="ControlLeft",o.ControlRight="ControlRight",o.MetaLeft="MetaLeft",o.MetaRight="MetaRight",o.Key0="Digit0",o.Key1="Digit1",o.Key2="Digit2",o.Key3="Digit3",o.Key4="Digit4",o.Key5="Digit5",o.Key6="Digit6",o.Key7="Digit7",o.Key8="Digit8",o.Key9="Digit9",o.Digit0="Digit0",o.Digit1="Digit1",o.Digit2="Digit2",o.Digit3="Digit3",o.Digit4="Digit4",o.Digit5="Digit5",o.Digit6="Digit6",o.Digit7="Digit7",o.Digit8="Digit8",o.Digit9="Digit9",o.F1="F1",o.F2="F2",o.F3="F3",o.F4="F4",o.F5="F5",o.F6="F6",o.F7="F7",o.F8="F8",o.F9="F9",o.F10="F10",o.F11="F11",o.F12="F12",o.A="KeyA",o.B="KeyB",o.C="KeyC",o.D="KeyD",o.E="KeyE",o.F="KeyF",o.G="KeyG",o.H="KeyH",o.I="KeyI",o.J="KeyJ",o.K="KeyK",o.L="KeyL",o.M="KeyM",o.N="KeyN",o.O="KeyO",o.P="KeyP",o.Q="KeyQ",o.R="KeyR",o.S="KeyS",o.T="KeyT",o.U="KeyU",o.V="KeyV",o.W="KeyW",o.X="KeyX",o.Y="KeyY",o.Z="KeyZ",o.KeyA="KeyA",o.KeyB="KeyB",o.KeyC="KeyC",o.KeyD="KeyD",o.KeyE="KeyE",o.KeyF="KeyF",o.KeyG="KeyG",o.KeyH="KeyH",o.KeyI="KeyI",o.KeyJ="KeyJ",o.KeyK="KeyK",o.KeyL="KeyL",o.KeyM="KeyM",o.KeyN="KeyN",o.KeyO="KeyO",o.KeyP="KeyP",o.KeyQ="KeyQ",o.KeyR="KeyR",o.KeyS="KeyS",o.KeyT="KeyT",o.KeyU="KeyU",o.KeyV="KeyV",o.KeyW="KeyW",o.KeyX="KeyX",o.KeyY="KeyY",o.KeyZ="KeyZ",o.Semicolon="Semicolon",o.Quote="Quote",o.Comma="Comma",o.Minus="Minus",o.Period="Period",o.Slash="Slash",o.Equal="Equal",o.BracketLeft="BracketLeft",o.Backslash="Backslash",o.BracketRight="BracketRight",o.Backquote="Backquote",o.Up="ArrowUp",o.Down="ArrowDown",o.Left="ArrowLeft",o.Right="ArrowRight",o.ArrowUp="ArrowUp",o.ArrowDown="ArrowDown",o.ArrowLeft="ArrowLeft",o.ArrowRight="ArrowRight",o.Space="Space",o.Backspace="Backspace",o.Delete="Delete",o.Esc="Escape",o.Escape="Escape",o.Enter="Enter",o.NumpadEnter="NumpadEnter",o.ContextMenu="ContextMenu";class ea extends tS{constructor(t,e,i){super(),this.key=t,this.value=e,this.originalEvent=i}}class eh{constructor(){this.events=new tT,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=t=>{for(let e of this._keys){let i=new ea(e,t.key,t);this.events.emit("up",i),this.events.emit("release",i)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=t=>{!t.metaKey&&(this._keys.includes(H.MetaLeft)||this._keys.includes(H.MetaRight))&&this._releaseAllKeys(t);let e=t.code;if(-1===this._keys.indexOf(e)){this._keys.push(e),this._keysDown.push(e);let i=new ea(e,t.key,t);this.events.emit("down",i),this.events.emit("press",i)}},this._handleKeyUp=t=>{let e=t.code,i=this._keys.indexOf(e);this._keys.splice(i,1),this._keysUp.push(e);let s=new ea(e,t.key,t);this.events.emit("up",s),this.events.emit("release",s),"Meta"===t.key&&this._releaseAllKeys(t)}}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}init(t){let{global:e}=t,{grabWindowFocus:i}=t;e||(eo()?(e=window,i&&window.focus(),es.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):e=window.top),e.addEventListener("blur",()=>{this._keys.length=0}),e.addEventListener("keyup",this._handleKeyUp),e.addEventListener("keydown",this._handleKeyDown)}update(){this._keysDown.length=0,this._keysUp.length=0;for(let t=0;t<this._keys.length;t++)this.events.emit("hold",new ea(this._keys[t]))}getKeys(){return this._keys}wasPressed(t){return this._keysDown.indexOf(t)>-1}isHeld(t){return this._keys.indexOf(t)>-1}wasReleased(t){return this._keysUp.indexOf(t)>-1}triggerEvent(t,e,i){"down"===t&&this._handleKeyDown(new KeyboardEvent("keydown",{code:e,key:null!=i?i:null})),"up"===t&&this._handleKeyUp(new KeyboardEvent("keyup",{code:e,key:null!=i?i:null}))}}(a=W||(W={})).Canvas="Canvas",a.Document="Document";class el{constructor(t){this.seed=t,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=Array(this._n),this._mt[0]=(t||Date.now())>>>0;for(let t=1;t<this._n;t++){let e=this._mt[t-1]^this._mt[t-1]>>>this._w-2;this._mt[t]=(this._f*((4294901760&e)>>>16)<<16)+this._f*(65535&e)+t>>>0}this._index=this._n}_twist(){let t=[0,this._a],e=0,i=0;for(;i<this._n-this._m;i++)e=this._mt[i]&this._upperMask|this._mt[i+1]&this._lowerMask,this._mt[i]=this._mt[i+this._m]^e>>>1^4294967295&t[1&e];for(;i<this._n-1;i++)e=this._mt[i]&this._upperMask|this._mt[i+1]&this._lowerMask,this._mt[i]=this._mt[i+(this._m-this._n)]^e>>>1^4294967295&t[1&e];e=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^e>>>1^4294967295&t[1&e],this._index=0}nextInt(){this._index>=this._n&&this._twist();let t=this._mt[this._index++];return t^=t>>>this._u,t^=t<<this._s&this._b,t^=t<<this._t&this._c,(t^=t>>>this._l)>>>0}next(){return this.nextInt()*(1/4294967296)}floating(t,e){return(e-t)*this.next()+t}integer(t,e){return Math.floor((e-t+1)*this.next()+t)}bool(t=.5){return this.next()<=t}pickOne(t){return t[this.integer(0,t.length-1)]}pickSet(t,e,i=!1){return i?this._pickSetWithDuplicates(t,e):this._pickSetWithoutDuplicates(t,e)}_pickSetWithoutDuplicates(t,e){if(e>t.length||e<0)throw Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(e===t.length)return t;let i=Array(e),s=0,r=t.slice(0);for(;s<e;){let t=this.integer(0,r.length-1);i[s++]=r[t],r.splice(t,1)}return i}_pickSetWithDuplicates(t,e){if(e<0)throw Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");let i=Array(e);for(let s=0;s<e;s++)i[s]=this.pickOne(t);return i}shuffle(t){let e=t.slice(0),i=null;for(let t=0;t<e.length-2;t++){let s=this.integer(t,e.length-1);i=e[t],e[t]=e[s],e[s]=i}return e}range(t,e,i){let s=Array(t);for(let r=0;r<t;r++)s[r]=this.integer(e,i);return s}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}let ed=2*Math.PI;function ec(t){return t>=0?t-Math.floor(t):t-Math.ceil(t)}function eu(t){return 0===t?0:t<0?-1:1}function ep(t,e,i){return Math.min(Math.max(e,t),i)}function e_(t){let e=t;if(t>ed)for(;e>ed;)e-=ed;if(t<0)for(;e<0;)e+=ed;return e}function eg(t){return 180/Math.PI*t}function em(t){return t/180*Math.PI}let ef=(t,e)=>Array.from(Array(e-t+1),(e,i)=>i+t);function ev(t,e,i=new el){return i?i.floating(t,e):t+Math.random()*(e-t)}function ex(t,e,i=new el){return i?i.integer(t,e):Math.round(ev(t,e))}class ey{static get Zero(){return new ey(0,0)}static get One(){return new ey(1,1)}static get Half(){return new ey(.5,.5)}static get Up(){return new ey(0,-1)}static get Down(){return new ey(0,1)}static get Left(){return new ey(-1,0)}static get Right(){return new ey(1,0)}static fromAngle(t){return new ey(Math.cos(t),Math.sin(t))}static isValid(t){return!(null==t||isNaN(t.x)||isNaN(t.y))&&t.x!==1/0&&t.y!==1/0&&t.x!==-1/0&&t.y!==-1/0}static distance(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}static min(t,e){return new ey(Math.min(t.x,e.x),Math.min(t.y,e.y))}static max(t,e){return new ey(Math.max(t.x,e.x),Math.max(t.y,e.y))}constructor(t,e){this._x=0,this._y=0,this._x=t,this._y=e}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}setTo(t,e){this.x=t,this.y=e}equals(t,e=.001){return Math.abs(this.x-t.x)<=e&&Math.abs(this.y-t.y)<=e}distance(t){if(!t)return Math.sqrt(this.x*this.x+this.y*this.y);let e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)}squareDistance(t){t||(t=ey.Zero);let e=this.x-t.x,i=this.y-t.y;return e*e+i*i}clampMagnitude(t){let e=ep(this.size,0,t);return this.size=e,this}get size(){return this.distance()}set size(t){let e=this.normalize().scale(t);this.setTo(e.x,e.y)}normalize(){let t=this.distance();return t>0?new ey(this.x/t,this.y/t):new ey(0,1)}average(t){return this.add(t).scale(.5)}scale(t,e){let i=e||new ey(0,0);return t instanceof ey?(i.x=this.x*t.x,i.y=this.y*t.y):(i.x=this.x*t,i.y=this.y*t),i}add(t,e){return e?(e.x=this.x+t.x,e.y=this.y+t.y,e):new ey(this.x+t.x,this.y+t.y)}sub(t){return new ey(this.x-t.x,this.y-t.y)}addEqual(t){return this.setTo(this.x+t.x,this.y+t.y),this}subEqual(t){return this.setTo(this.x-t.x,this.y-t.y),this}scaleEqual(t){return this.setTo(this.x*t,this.y*t),this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return t instanceof ey?this.x*t.y-this.y*t.x:"number"==typeof t?new ey(t*this.y,-t*this.x):void 0}static cross(t,e){return new ey(-t*e.y,t*e.x)}perpendicular(){return new ey(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return Math.atan2(this.y,this.x)}rotate(t,e){e||(e=new ey(0,0));let i=Math.sin(t),s=Math.cos(t);return new ey(s*(this.x-e.x)-i*(this.y-e.y)+e.x,i*(this.x-e.x)+s*(this.y-e.y)+e.y)}clone(t){let e=null!=t?t:new ey(0,0);return e.x=this.x,e.y=this.y,e}toString(t){return t?`(${this.x.toFixed(t)}, ${this.y.toFixed(t)})`:`(${this.x}, ${this.y})`}}function ew(t,e){return new ey(t,e)}class eb{constructor(t,e,i,s){this.r=t,this.g=e,this.b=i,this.a=null!=s?s:1}static fromRGB(t,e,i,s){return new eb(t,e,i,s)}static fromRGBString(t){let e=null;if(e=t.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i)){let t=parseInt(e[1],10),i=parseInt(e[2],10),s=parseInt(e[3],10),r=1;return e[4]&&(r=parseFloat(e[4])),new eb(t,i,s,r)}throw Error("Invalid rgb/a string: "+t)}static fromHex(t){let e=null;if(e=t.match(/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i)){let t=parseInt(e[1],16),i=parseInt(e[2],16),s=parseInt(e[3],16),r=1;return e[4]&&(r=parseInt(e[4],16)/255),new eb(t,i,s,r)}throw Error("Invalid hex string: "+t)}static fromHSL(t,e,i,s=1){return new eC(t,e,i,s).toRGBA()}lighten(t=.1){let e=eC.fromRGBA(this.r,this.g,this.b,this.a);return e.l+=(1-e.l)*t,e.toRGBA()}darken(t=.1){let e=eC.fromRGBA(this.r,this.g,this.b,this.a);return e.l-=e.l*t,e.toRGBA()}saturate(t=.1){let e=eC.fromRGBA(this.r,this.g,this.b,this.a);return e.s+=e.s*t,e.toRGBA()}desaturate(t=.1){let e=eC.fromRGBA(this.r,this.g,this.b,this.a);return e.s-=e.s*t,e.toRGBA()}multiply(t){let e=t.r/255*this.r/255*255;return new eb(e,t.g/255*this.g/255*255,t.b/255*this.b/255*255,t.a*this.a)}screen(t){let e=t.invert(),i=t.invert();return e.multiply(i).invert()}invert(){return new eb(255-this.r,255-this.g,255-this.b,1-this.a)}average(t){let e=(t.r+this.r)/2;return new eb(e,(t.g+this.g)/2,(t.b+this.b)/2,(t.a+this.a)/2)}equal(t){return this.toString()===t.toString()}toString(t="rgb"){switch(t){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw Error("Invalid Color format")}}_componentToHex(t){let e=t.toString(16);return 1===e.length?"0"+e:e}toHex(){return"#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b)}toRGBA(){let t=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return void 0!==this.a||null!==this.a?"rgba("+t+", "+String(this.a)+")":"rgb("+t+")"}toHSLA(){return eC.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(){return new eb(this.r,this.g,this.b,this.a)}static get Black(){return eb.fromHex("#000000")}static get White(){return eb.fromHex("#FFFFFF")}static get Gray(){return eb.fromHex("#808080")}static get LightGray(){return eb.fromHex("#D3D3D3")}static get DarkGray(){return eb.fromHex("#A9A9A9")}static get Yellow(){return eb.fromHex("#FFFF00")}static get Orange(){return eb.fromHex("#FFA500")}static get Red(){return eb.fromHex("#FF0000")}static get Vermilion(){return eb.fromHex("#FF5B31")}static get Rose(){return eb.fromHex("#FF007F")}static get Magenta(){return eb.fromHex("#FF00FF")}static get Violet(){return eb.fromHex("#7F00FF")}static get Blue(){return eb.fromHex("#0000FF")}static get Azure(){return eb.fromHex("#007FFF")}static get Cyan(){return eb.fromHex("#00FFFF")}static get Viridian(){return eb.fromHex("#59978F")}static get Green(){return eb.fromHex("#00FF00")}static get Chartreuse(){return eb.fromHex("#7FFF00")}static get Transparent(){return eb.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return eb.fromHex("#176BAA")}}class eC{constructor(t,e,i,s){this.h=t,this.s=e,this.l=i,this.a=s}static hue2rgb(t,e,i){return(i<0&&(i+=1),i>1&&(i-=1),i<1/6)?t+(e-t)*6*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}static fromRGBA(t,e,i,s){let r,n;t/=255,e/=255,i/=255;let o=Math.max(t,e,i),a=Math.min(t,e,i),h=(o+a)/2;if(o===a)r=n=0;else{let s=o-a;switch(n=h>.5?s/(2-o-a):s/(o+a),o){case t:r=(e-i)/s+(e<i?6:0);break;case e:r=(i-t)/s+2;break;case i:r=(t-e)/s+4}r/=6}return new eC(r,n,h,s)}toRGBA(){let t,e,i;if(0===this.s)t=e=i=this.l;else{let s=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,r=2*this.l-s;t=eC.hue2rgb(r,s,this.h+1/3),e=eC.hue2rgb(r,s,this.h),i=eC.hue2rgb(r,s,this.h-1/3)}return new eb(255*t,255*e,255*i,this.a)}toString(){let t=this.h.toFixed(0),e=this.s.toFixed(0),i=this.l.toFixed(0),s=this.a.toFixed(0);return`hsla(${t}, ${e}, ${i}, ${s})`}}(h=G||(G={})).None="None",h.Top="Top",h.Bottom="Bottom",h.Left="Left",h.Right="Right",(l=G||(G={})).getOpposite=function(t){return t===l.Top?l.Bottom:t===l.Bottom?l.Top:t===l.Left?l.Right:t===l.Right?l.Left:l.None},l.fromDirection=function(t){let e=[ey.Left,ey.Right,ey.Up,ey.Down],i=[l.Left,l.Right,l.Top,l.Bottom],s=-Number.MAX_VALUE,r=-1;for(let i=0;i<e.length;i++)e[i].dot(t)>s&&(s=e[i].dot(t),r=i);return i[r]};class eA{constructor(t=0,e=0,i=0,s=0){"object"==typeof t?(this.left=t.left,this.top=t.top,this.right=t.right,this.bottom=t.bottom):"number"==typeof t&&(this.left=t,this.top=e,this.right=i,this.bottom=s)}clone(){return new eA(this.left,this.top,this.right,this.bottom)}static getSideFromIntersection(t){return t?t?Math.abs(t.x)>Math.abs(t.y)?t.x<0?G.Right:G.Left:t.y<0?G.Bottom:G.Top:G.None:G.None}static fromPoints(t){let e=1/0,i=1/0,s=-1/0,r=-1/0;for(let n=0;n<t.length;n++)t[n].x<e&&(e=t[n].x),t[n].x>s&&(s=t[n].x),t[n].y<i&&(i=t[n].y),t[n].y>r&&(r=t[n].y);return new eA(e,i,s,r)}static fromDimension(t,e,i=ey.Half,s=ey.Zero){return new eA(-t*i.x+s.x,-e*i.y+s.y,t-t*i.x+s.x,e-e*i.y+s.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return 0===this.width||0===this.height}get center(){return new ey((this.left+this.right)/2,(this.top+this.bottom)/2)}translate(t){return new eA(this.left+t.x,this.top+t.y,this.right+t.x,this.bottom+t.y)}rotate(t,e=ey.Zero){let i=this.getPoints().map(i=>i.rotate(t,e));return eA.fromPoints(i)}scale(t,e=ey.Zero){let i=this.translate(e);return new eA(i.left*t.x,i.top*t.y,i.right*t.x,i.bottom*t.y)}transform(t){let e=t.data[0]*this.left,i=t.data[1]*this.left,s=t.data[0]*this.right,r=t.data[1]*this.right,n=t.data[2]*this.top,o=t.data[3]*this.top,a=t.data[2]*this.bottom,h=t.data[3]*this.bottom,l=t.getPosition(),d=Math.min(e,s)+Math.min(n,a)+l.x;return new eA({left:d,top:Math.min(i,r)+Math.min(o,h)+l.y,right:Math.max(e,s)+Math.max(n,a)+l.x,bottom:Math.max(i,r)+Math.max(o,h)+l.y})}getPerimeter(){return 2*(this.width+this.height)}getPoints(){let t=[];return t.push(new ey(this.left,this.top)),t.push(new ey(this.right,this.top)),t.push(new ey(this.right,this.bottom)),t.push(new ey(this.left,this.bottom)),t}rayCast(t,e=1/0){let i=-1/0,s=1/0,r=0===t.dir.x?Number.MAX_VALUE:1/t.dir.x,n=0===t.dir.y?Number.MAX_VALUE:1/t.dir.y,o=(this.left-t.pos.x)*r,a=(this.right-t.pos.x)*r;i=Math.min(o,a),s=Math.max(o,a);let h=(this.top-t.pos.y)*n,l=(this.bottom-t.pos.y)*n;return i=Math.max(i,Math.min(h,l)),(s=Math.min(s,Math.max(h,l)))>=Math.max(0,i)&&i<e}rayCastTime(t,e=1/0){let i=-1/0,s=1/0,r=0===t.dir.x?Number.MAX_VALUE:1/t.dir.x,n=0===t.dir.y?Number.MAX_VALUE:1/t.dir.y,o=(this.left-t.pos.x)*r,a=(this.right-t.pos.x)*r;i=Math.min(o,a),s=Math.max(o,a);let h=(this.top-t.pos.y)*n,l=(this.bottom-t.pos.y)*n;return(i=Math.max(i,Math.min(h,l)),(s=Math.min(s,Math.max(h,l)))>=Math.max(0,i)&&i<e)?i:-1}contains(t){return t instanceof ey?this.left<=t.x&&this.top<=t.y&&this.bottom>=t.y&&this.right>=t.x:t instanceof eA&&this.left<=t.left&&this.top<=t.top&&t.bottom<=this.bottom&&t.right<=this.right}combine(t){return new eA(Math.min(this.left,t.left),Math.min(this.top,t.top),Math.max(this.right,t.right),Math.max(this.bottom,t.bottom))}get dimensions(){return new ey(this.width,this.height)}overlaps(t,e){let i=e||0;if(t.hasZeroDimensions())return this.contains(t);if(this.hasZeroDimensions())return t.contains(this);let s=this.combine(t);return s.width+i<t.width+this.width&&s.height+i<t.height+this.height}intersect(t){let e=this.combine(t);if(e.width<t.width+this.width&&e.height<t.height+this.height&&!e.dimensions.equals(t.dimensions)&&!e.dimensions.equals(this.dimensions)){let e=0;e=this.right>=t.left&&this.right<=t.right?t.left-this.right:t.right-this.left;let i=0;return Math.abs(e)<Math.abs(i=this.top<=t.bottom&&this.top>=t.top?t.bottom-this.top:t.top-this.bottom)?new ey(e,0):new ey(0,i)}if(!(e.dimensions.equals(t.dimensions)||e.dimensions.equals(this.dimensions)))return null;{let e=0;e=this.width-t.width>=0?this.right-t.right<=t.left-this.left?t.left-this.right:t.right-this.left:t.right-this.right<=this.left-t.left?this.left-t.right:this.right-t.left;let i=0;return Math.abs(e)<Math.abs(i=this.height-t.height>=0?this.bottom-t.bottom<=t.top-this.top?t.top-this.bottom:t.bottom-this.top:t.bottom-this.bottom<=this.top-t.top?this.top-t.bottom:this.bottom-t.top)?new ey(e,0):new ey(0,i)}}intersectWithSide(t){let e=this.intersect(t);return eA.getSideFromIntersection(e)}draw(t,e=eb.Yellow){t.debug.drawRect(this.left,this.top,this.width,this.height,{color:e})}}class eT{constructor(){this._isCompleted=!1,this.promise=new Promise((t,e)=>{this._resolver=t,this._rejecter=e})}get isCompleted(){return this._isCompleted}resolve(t){this._isCompleted||(this._isCompleted=!0,this._resolver(t))}reject(t){this._isCompleted||(this._isCompleted=!0,this._rejecter(t))}}function eS(t){let e=0,i=0,s=t=>{e+=t.offsetLeft,t.offsetParent&&s(t.offsetParent)},r=t=>{i+=t.offsetTop,t.offsetParent&&r(t.offsetParent)};return s(t),r(t),new ey(e,i)}function eE(t,e){return -1===e.indexOf(t)&&(e.push(t),!0)}function eP(t,e){let i=-1;return(i=e.indexOf(t))>-1&&(e.splice(i,1),!0)}function eI(t,e){for(let i=0;i<t.length;i++)if(t[i]===e)return!0;return!1}function eD(t){throw Error(t)}function eR(t,e){var i;let s=new eT;return(null!==(i=null==e?void 0:e.schedule.bind(e))&&void 0!==i?i:setTimeout)(()=>{s.resolve()},t),s.promise}function eB(t,e){let i={};for(let s in t)e.includes(s)||(i[s]=t[s]);return i}(d=V||(V={}))[d.X=12]="X",d[d.Y=13]="Y";class eF{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(t,e,i,s,r,n){let o=new eF;return o.data[0]=2/(e-t),o.data[1]=0,o.data[2]=0,o.data[3]=0,o.data[4]=0,o.data[5]=2/(s-i),o.data[6]=0,o.data[7]=0,o.data[8]=0,o.data[9]=0,o.data[10]=-2/(n-r),o.data[11]=0,o.data[12]=-(e+t)/(e-t),o.data[13]=-(s+i)/(s-i),o.data[14]=-(n+r)/(n-r),o.data[15]=1,o}clone(t){let e=t||new eF;return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=this.data[2],e.data[3]=this.data[3],e.data[4]=this.data[4],e.data[5]=this.data[5],e.data[6]=this.data[6],e.data[7]=this.data[7],e.data[8]=this.data[8],e.data[9]=this.data[9],e.data[10]=this.data[10],e.data[11]=this.data[11],e.data[12]=this.data[12],e.data[13]=this.data[13],e.data[14]=this.data[14],e.data[15]=this.data[15],e}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(t){let e=new eF;return e.data=t,e}static identity(){let t=new eF;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}reset(){return this.data[0]=1,this.data[1]=0,this.data[2]=0,this.data[3]=0,this.data[4]=0,this.data[5]=1,this.data[6]=0,this.data[7]=0,this.data[8]=0,this.data[9]=0,this.data[10]=1,this.data[11]=0,this.data[12]=0,this.data[13]=0,this.data[14]=0,this.data[15]=1,this}static translation(t,e){let i=eF.identity();return i.data[12]=t,i.data[13]=e,i}static scale(t,e){let i=eF.identity();return i.data[0]=t,i.data[5]=e,i.data[10]=1,i.data[15]=1,i}static rotation(t){let e=eF.identity();return e.data[0]=Math.cos(t),e.data[4]=-Math.sin(t),e.data[1]=Math.sin(t),e.data[5]=Math.cos(t),e}multiply(t,e){if(t instanceof ey){let i=e||new ey(0,0),s=t.x*this.data[0]+t.y*this.data[4]+this.data[12],r=t.x*this.data[1]+t.y*this.data[5]+this.data[13];return i.x=s,i.y=r,i}{let i=e||new eF,s=this.data[0],r=this.data[1],n=this.data[2],o=this.data[3],a=this.data[4],h=this.data[5],l=this.data[6],d=this.data[7],c=this.data[8],u=this.data[9],p=this.data[10],_=this.data[11],g=this.data[12],m=this.data[13],f=this.data[14],v=this.data[15],x=t.data[0],y=t.data[1],w=t.data[2],b=t.data[3],C=t.data[4],A=t.data[5],T=t.data[6],S=t.data[7],E=t.data[8],P=t.data[9],I=t.data[10],D=t.data[11],R=t.data[12],B=t.data[13],F=t.data[14],k=t.data[15];i.data[0]=s*x+a*y+c*w+g*b,i.data[1]=r*x+h*y+u*w+m*b,i.data[2]=n*x+l*y+p*w+f*b,i.data[3]=o*x+d*y+_*w+v*b,i.data[4]=s*C+a*A+c*T+g*S,i.data[5]=r*C+h*A+u*T+m*S,i.data[6]=n*C+l*A+p*T+f*S,i.data[7]=o*C+d*A+_*T+v*S,i.data[8]=s*E+a*P+c*I+g*D,i.data[9]=r*E+h*P+u*I+m*D,i.data[10]=n*E+l*P+p*I+f*D,i.data[11]=o*E+d*P+_*I+v*D,i.data[12]=s*R+a*B+c*F+g*k,i.data[13]=r*R+h*B+u*F+m*k,i.data[14]=n*R+l*B+p*F+f*k,i.data[15]=o*R+d*B+_*F+v*k;let M=this.getScale();return i._scaleSignX=eu(M.x)*eu(i._scaleSignX),i._scaleSignY=eu(M.y)*eu(i._scaleSignY),i}}translate(t,e){let i=this.data[0],s=this.data[1],r=this.data[2],n=this.data[3],o=this.data[4],a=this.data[5],h=this.data[6],l=this.data[7],d=this.data[8],c=this.data[9],u=this.data[10],p=this.data[11],_=this.data[12],g=this.data[13],m=this.data[14],f=this.data[15];return this.data[12]=i*t+o*e+0*d+1*_,this.data[13]=s*t+a*e+0*c+1*g,this.data[14]=r*t+h*e+0*u+1*m,this.data[15]=n*t+l*e+0*p+1*f,this}setPosition(t,e){this.data[12]=t,this.data[13]=e}getPosition(){return ew(this.data[12],this.data[13])}rotate(t){let e=this.data[0],i=this.data[1],s=this.data[2],r=this.data[3],n=this.data[4],o=this.data[5],a=this.data[6],h=this.data[7],l=Math.sin(t),d=Math.cos(t);return this.data[0]=d*e+l*n,this.data[1]=d*i+l*o,this.data[2]=d*s+l*a,this.data[3]=d*r+l*h,this.data[4]=d*n-l*e,this.data[5]=d*o-l*i,this.data[6]=d*a-l*s,this.data[7]=d*h-l*r,this}scale(t,e){let i=this.data[0],s=this.data[1],r=this.data[2],n=this.data[3],o=this.data[4],a=this.data[5],h=this.data[6],l=this.data[7];return this.data[0]=i*t,this.data[1]=s*t,this.data[2]=r*t,this.data[3]=n*t,this.data[4]=o*e,this.data[5]=a*e,this.data[6]=h*e,this.data[7]=l*e,this}setRotation(t){let e=this.getScale(),i=Math.sin(t),s=Math.cos(t);this.data[0]=s*e.x,this.data[1]=i*e.y,this.data[4]=-i*e.x,this.data[5]=s*e.y}getRotation(){return e_(Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX()))}getScaleX(){let t=ew(this.data[0],this.data[4]).size;return this._scaleSignX*t}getScaleY(){let t=ew(this.data[1],this.data[5]).size;return this._scaleSignY*t}getScale(){return ew(this.getScaleX(),this.getScaleY())}setScaleX(t){if(this._scaleX===t)return;this._scaleSignX=eu(t);let e=ew(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=e.x*t,this.data[4]=e.y*t,this._scaleX=t}setScaleY(t){if(this._scaleY===t)return;this._scaleSignY=eu(t);let e=ew(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=e.x*t,this.data[5]=e.y*t,this._scaleY=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(t){let e=1/this.getBasisDeterminant(),i=this.data[0],s=this.data[4],r=this.data[1],n=this.data[5],o=t||eF.identity();o.data[0]=n*e,o.data[1]=-r*e,o.data[4]=-s*e,o.data[5]=i*e;let a=this.data[12],h=this.data[13];return o.data[12]=-(a*o.data[0]+h*o.data[4]),o.data[13]=-(a*o.data[1]+h*o.data[5]),o}isIdentity(){return 1===this.data[0]&&0===this.data[1]&&0===this.data[2]&&0===this.data[3]&&0===this.data[4]&&1===this.data[5]&&0===this.data[6]&&0===this.data[7]&&0===this.data[8]&&0===this.data[9]&&1===this.data[10]&&0===this.data[11]&&0===this.data[12]&&0===this.data[13]&&0===this.data[14]&&1===this.data[15]}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class ek{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){let t=new ek;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}static translation(t,e){let i=ek.identity();return i.data[4]=t,i.data[5]=e,i}static scale(t,e){let i=ek.identity();return i.data[0]=t,i.data[3]=e,i._scale[0]=t,i._scale[1]=e,i}static rotation(t){let e=ek.identity();return e.data[0]=Math.cos(t),e.data[1]=Math.sin(t),e.data[2]=-Math.sin(t),e.data[3]=Math.cos(t),e}setPosition(t,e){this.data[4]=t,this.data[5]=e}getPosition(){return ew(this.data[4],this.data[5])}rotate(t){let e=this.data[0],i=this.data[1],s=this.data[2],r=this.data[3],n=Math.sin(t),o=Math.cos(t);return this.data[0]=o*e+n*s,this.data[1]=o*i+n*r,this.data[2]=o*s-n*e,this.data[3]=o*r-n*i,this}translate(t,e){let i=this.data[0],s=this.data[1],r=this.data[2],n=this.data[3],o=this.data[4],a=this.data[5];return this.data[4]=i*t+r*e+o,this.data[5]=s*t+n*e+a,this}scale(t,e){let i=this.data[0],s=this.data[1],r=this.data[2],n=this.data[3];return this.data[0]=i*t,this.data[1]=s*t,this.data[2]=r*e,this.data[3]=n*e,this._scale[0]=t,this._scale[1]=e,this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(t){let e=1/this.determinant(),i=this.data[0],s=this.data[2],r=this.data[1],n=this.data[3],o=t||ek.identity();o.data[0]=n*e,o.data[1]=-r*e,o.data[2]=-s*e,o.data[3]=i*e;let a=this.data[4],h=this.data[5];return o.data[4]=-(a*o.data[0]+h*o.data[2]),o.data[5]=-(a*o.data[1]+h*o.data[3]),o}multiply(t,e){if(t instanceof ey){let i=e||new ey(0,0),s=t.x*this.data[0]+t.y*this.data[2]+this.data[4],r=t.x*this.data[1]+t.y*this.data[3]+this.data[5];return i.x=s,i.y=r,i}{let i=e||new ek,s=this.data[0],r=this.data[1],n=this.data[2],o=this.data[3],a=this.data[4],h=this.data[5],l=t.data[0],d=t.data[1],c=t.data[2],u=t.data[3],p=t.data[4],_=t.data[5];i.data[0]=s*l+n*d,i.data[1]=r*l+o*d,i.data[2]=s*c+n*u,i.data[3]=r*c+o*u,i.data[4]=s*p+n*_+a,i.data[5]=r*p+o*_+h;let g=this.getScale();return i._scaleSignX=eu(g.x)*eu(i._scaleSignX),i._scaleSignY=eu(g.y)*eu(i._scaleSignY),i}}to4x4(){let t=new eF;return t.data[0]=this.data[0],t.data[1]=this.data[1],t.data[2]=0,t.data[3]=0,t.data[4]=this.data[2],t.data[5]=this.data[3],t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=this.data[4],t.data[13]=this.data[5],t.data[14]=0,t.data[15]=1,t}setRotation(t){let e=this.getScale(),i=Math.sin(t),s=Math.cos(t);this.data[0]=s*e.x,this.data[1]=i*e.y,this.data[2]=-i*e.x,this.data[3]=s*e.y}getRotation(){return e_(Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX()))}getScaleX(){let t=ew(this.data[0],this.data[2]).distance();return this._scaleSignX*t}getScaleY(){let t=ew(this.data[1],this.data[3]).distance();return this._scaleSignY*t}getScale(){return ew(this.getScaleX(),this.getScaleY())}setScaleX(t){if(t===this._scale[0])return;this._scaleSignX=eu(t);let e=ew(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=e.x*t,this.data[2]=e.y*t,this._scale[0]=t}setScaleY(t){if(t===this._scale[1])return;this._scaleSignY=eu(t);let e=ew(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=e.x*t,this.data[3]=e.y*t,this._scale[1]=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}isIdentity(){return 1===this.data[0]&&0===this.data[1]&&0===this.data[2]&&1===this.data[3]&&0===this.data[4]&&0===this.data[5]}reset(){return this.data[0]=1,this.data[1]=0,this.data[2]=0,this.data[3]=1,this.data[4]=0,this.data[5]=0,this}clone(t){let e=t||new ek;return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=this.data[2],e.data[3]=this.data[3],e.data[4]=this.data[4],e.data[5]=this.data[5],e}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}class eM{constructor(){this._transforms=[],this._currentTransform=ek.identity()}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone()}restore(){this._currentTransform=this._transforms.pop()}translate(t,e){return this._currentTransform.translate(t,e)}rotate(t){return this._currentTransform.rotate(t)}scale(t,e){return this._currentTransform.scale(t,e)}set current(t){this._currentTransform=t}get current(){return this._currentTransform}}class eL{constructor(){this._states=[],this._currentState=this._getDefaultState()}_getDefaultState(){return{opacity:1,z:0,tint:eb.White,material:null}}_cloneState(){return{opacity:this._currentState.opacity,z:this._currentState.z,tint:this._currentState.tint.clone(),material:this._currentState.material}}save(){this._states.push(this._currentState),this._currentState=this._cloneState()}restore(){this._currentState=this._states.pop()}get current(){return this._currentState}set current(t){this._currentState=t}}let ez={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class eU{constructor(t,e,i=!1){this.path=t,this.responseType=e,this.bustCache=i,this.data=null,this.logger=es.getInstance(),this.events=new tT}isLoaded(){return null!==this.data}_cacheBust(t){return/\?\w*=\w*/.test(t)?t+="&__="+Date.now():t+="?__="+Date.now(),t}load(){return new Promise((t,e)=>{if(null!==this.data){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),t(this.data);return}let i=new XMLHttpRequest;i.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),i.responseType=this.responseType,i.addEventListener("loadstart",t=>this.events.emit("loadstart",t)),i.addEventListener("progress",t=>this.events.emit("progress",t)),i.addEventListener("error",t=>this.events.emit("error",t)),i.addEventListener("load",t=>this.events.emit("load",t)),i.addEventListener("load",()=>{if(0!==i.status&&200!==i.status){this.logger.error("Failed to load resource ",this.path," server responded with error code",i.status),this.events.emit("error",i.response),e(Error(i.statusText));return}this.data=i.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),t(this.data)}),i.send()})}}function eO(t,e){return t&&void 0===t.__isProxy?new Proxy(t,{set:(t,i,s)=>(t[i]!==s&&(t[i]=s,"string"==typeof i&&"_"!==i[0]&&e(t)),!0),get:(t,e)=>"__isProxy"===e||t[e]}):t}function eN(t,e){return t&&void 0===t.__isProxy?new Proxy(t,{set:(t,i,s)=>(t[i]=s,"string"==typeof i&&"_"!==i[0]&&e(t),!0),get:(t,e)=>"__isProxy"===e||t[e]}):t}class eH{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(t){this._flipHorizontal=t,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(t){this._flipVertical=t,this._transformStale=!0}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._transformStale=!0}get scale(){return this._scale}set scale(t){this._scale=eO(t,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(t){this._origin=eO(t,()=>{this._transformStale=!0}),this._transformStale=!0}constructor(t){var e,i,s,r,n,o,a;this.id=eH._ID++,this.transform=ek.identity(),this.tint=null,this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=ey.One,this._origin=null,this._width=0,this._height=0,t&&(this.origin=null!==(e=t.origin)&&void 0!==e?e:this.origin,this.flipHorizontal=null!==(i=t.flipHorizontal)&&void 0!==i?i:this.flipHorizontal,this.flipVertical=null!==(s=t.flipVertical)&&void 0!==s?s:this.flipVertical,this.rotation=null!==(r=t.rotation)&&void 0!==r?r:this.rotation,this.opacity=null!==(n=t.opacity)&&void 0!==n?n:this.opacity,this.scale=null!==(o=t.scale)&&void 0!==o?o:this.scale,this.tint=null!==(a=t.tint)&&void 0!==a?a:this.tint)}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():null,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():null,tint:this.tint?this.tint.clone():null}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(t){this._width=t,this._transformStale=!0}set height(t){this._height=t,this._transformStale=!0}get localBounds(){return eA.fromDimension(this.width,this.height,ey.Zero)}draw(t,e,i){this._preDraw(t,e,i),this._drawImage(t,0,0),this._postDraw(t)}_preDraw(t,e,i){t.save(),t.translate(e,i),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),t.multiply(this.transform),t.opacity=t.opacity*this.opacity,this.tint&&(t.tint=this.tint)}_rotate(t){var e;let i=this.scale.x>0?1:-1,s=this.scale.y>0?1:-1,r=null!==(e=this.origin)&&void 0!==e?e:ew(this.width/2,this.height/2);t.translate(r.x,r.y),t.rotate(this.rotation),t.scale(i,s),t.translate(-r.x,-r.y)}_flip(t){this.flipHorizontal&&(t.translate(this.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,this.height/this.scale.y),t.scale(1,-1))}_postDraw(t){this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore()}}eH._ID=0;class eW extends eH{static from(t){return new eW({image:t})}constructor(t){var e,i;super(t),this._logger=es.getInstance(),this._dirty=!0,this._logNotLoadedWarning=!1,this.image=t.image;let{width:s,height:r}=t;this.sourceView=null!==(e=t.sourceView)&&void 0!==e?e:{x:0,y:0,width:null!=s?s:0,height:null!=r?r:0},this.destSize=null!==(i=t.destSize)&&void 0!==i?i:{width:null!=s?s:0,height:null!=r?r:0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(t){t/=Math.abs(this.scale.x),this.destSize.width=t,super.width=Math.ceil(this.destSize.width)}set height(t){t/=Math.abs(this.scale.y),this.destSize.height=t,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var t,e,i,s,r,n;let{width:o,height:a}=this.image;this.sourceView.width=(null===(t=this.sourceView)||void 0===t?void 0:t.width)||o,this.sourceView.height=(null===(e=this.sourceView)||void 0===e?void 0:e.height)||a,this.destSize.width=(null===(i=this.destSize)||void 0===i?void 0:i.width)||(null===(s=this.sourceView)||void 0===s?void 0:s.width)||o,this.destSize.height=(null===(r=this.destSize)||void 0===r?void 0:r.height)||(null===(n=this.sourceView)||void 0===n?void 0:n.height)||a,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(t,e,i){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(t,e,i)}_drawImage(t,e,i){this.image.isLoaded()?t.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,e,i,this.destSize.width,this.destSize.height):(this._logNotLoadedWarning||this._logger.warn(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`),this._logNotLoadedWarning=!0)}clone(){return new eW({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}(c=q||(q={})).Pixel="Pixel",c.Blended="Blended";class eG{constructor(t){this._textureMap=new Map,this._gl=t,eG._MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE)}get(t){return this._textureMap.get(t)}has(t){return this._textureMap.has(t)}load(t,e,i=!1){let s=this._gl;if(!s)return null;let r=null;if(this.has(t)&&(r=this.get(t)),r)return i&&(s.bindTexture(s.TEXTURE_2D,r),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,t)),r;r=s.createTexture(),eG.checkImageSizeSupportedAndLog(t),s.bindTexture(s.TEXTURE_2D,r),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);let n=null!=e?e:eG.filtering;return s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,n===q.Pixel?s.NEAREST:s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,n===q.Pixel?s.NEAREST:s.LINEAR),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,t),this._textureMap.set(t,r),r}delete(t){let e=this._gl;if(!e)return null;let i=null;this.has(t)&&(i=this.get(t),e.deleteTexture(i))}static checkImageSizeSupportedAndLog(t){var e;let i=null!==(e=t.dataset.originalSrc)&&void 0!==e?e:"internal canvas bitmap";return t.width>eG._MAX_TEXTURE_SIZE||t.height>eG._MAX_TEXTURE_SIZE?(eG._LOGGER.error(`The image [${i}] provided to Excalibur is too large for the device's maximum texture size of (${eG._MAX_TEXTURE_SIZE}x${eG._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((t.width>4096||t.height>4096)&&eG._LOGGER.warn(`The image [${i}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}eG._LOGGER=es.getInstance(),eG.filtering=q.Blended,eG._MAX_TEXTURE_SIZE=4096;class eV{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(t,e=!1,i){this.path=t,this._logger=es.getInstance(),this.data=new Image,this._readyFuture=new eT,this.ready=this._readyFuture.promise,this._resource=new eU(t,"blob",e),this.filtering=i,(t.endsWith(".svg")||t.endsWith(".gif"))&&this._logger.warn(`Image type is not fully supported, you may have mixed results ${t}. Fully supported: jpg, bmp, and png`)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){if(this.isLoaded())return this.data;try{let t;if(this.path.includes("data:image/"))t=this.path;else{let e=await this._resource.load();t=URL.createObjectURL(e)}let e=new Image,i=new eT;e.onload=()=>i.resolve(),e.src=t,e.setAttribute("data-original-src",this.path),await i.promise,this.data=e,eG.checkImageSizeSupportedAndLog(this.data)}catch(t){throw`Error loading ImageSource from path '${this.path}' with error [${t.message}]`}return this.data.setAttribute("filtering",this.filtering),this._readyFuture.resolve(this.data),this.data}toSprite(){return eW.from(this)}unload(){this.data=new Image}}class eq{constructor(t){this._logger=es.getInstance(),this.sprites=[];let{sprites:e,rows:i,columns:s}=t;this.sprites=e,this.rows=null!=i?i:1,this.columns=null!=s?s:this.sprites.length}getSprite(t,e){if(t>=this.columns||t<0)return this._logger.warn(`No sprite exists in the SpriteSheet at (${t}, ${e}), x: ${t} should be between 0 and ${this.columns-1}`),null;if(e>=this.rows||e<0)return this._logger.warn(`No sprite exists in the SpriteSheet at (${t}, ${e}), y: ${e} should be between 0 and ${this.rows-1}`),null;let i=t+e*this.columns;return this.sprites[i]}static fromImageSourceWithSourceViews(t){return new eq({sprites:t.sourceViews.map(e=>new eW({image:t.image,sourceView:e}))})}static fromImageSource(t){var e;let i=[];t.spacing=null!==(e=t.spacing)&&void 0!==e?e:{};let{image:s,grid:{rows:r,columns:n,spriteWidth:o,spriteHeight:a},spacing:{originOffset:h,margin:l}}=t,d={x:0,y:0,...h},c={x:0,y:0,...l};for(let t=0;t<n;t++)for(let e=0;e<r;e++)i[t+e*n]=new eW({image:s,sourceView:{x:t*o+c.x*t+d.x,y:e*a+c.y*e+d.y,width:o,height:a},destSize:{height:a,width:o}});return new eq({sprites:i,rows:r,columns:n})}clone(){return new eq({sprites:this.sprites.map(t=>t.clone()),rows:this.rows,columns:this.columns})}}class eX extends eH{constructor(t){super(t),this._text="",this.alphabet="",this.shadow=null,this.caseInsensitive=!1,this.spacing=0,this._logger=es.getInstance(),this._alreadyWarnedAlphabet=!1,this._alreadyWarnedSpriteSheet=!1;let{alphabet:e,spriteSheet:i,caseInsensitive:s,spacing:r,shadow:n}=t;this.alphabet=e,this.spriteSheet=i,this.caseInsensitive=null!=s?s:this.caseInsensitive,this.spacing=null!=r?r:this.spacing,this.shadow=null!=n?n:this.shadow}_getCharacterSprites(t){let e=[],i=this.caseInsensitive?t.toLocaleLowerCase():t,s=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let t=0;t<i.length;t++){let r=i[t],n=s.indexOf(r);-1!==n||(n=0,this._alreadyWarnedAlphabet||(this._logger.warn(`SpriteFont - Cannot find letter '${r}' in configured alphabet '${s}'.`),this._logger.warn("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."),this._alreadyWarnedAlphabet=!0));let o=this.spriteSheet.sprites[n];o?e.push(o):this._alreadyWarnedSpriteSheet||(this._logger.warn(`SpriteFont - Cannot find sprite for '${r}' at index '${n}' in configured SpriteSheet`),this._logger.warn("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."),this._alreadyWarnedSpriteSheet=!0)}return e}measureText(t,e){let i=this._getLinesFromText(t,e),s=i.reduce((t,e)=>t.length>e.length?t:e),r=this._getCharacterSprites(s),n=0,o=0;for(let t of r)n+=t.width+this.spacing,o=Math.max(o,t.height);return eA.fromDimension(n,o*i.length,ey.Zero)}_drawImage(t,e,i,s){let r=0,n=0,o=0;for(let a of this._getLinesFromText(this._text,s)){for(let s of this._getCharacterSprites(a))s.draw(t,e+r,i+n),r+=s.width+this.spacing,o=Math.max(o,s.height);r=0,n+=o}}render(t,e,i,s,r,n){this._text=e;let o=this.measureText(e,n);this.width=o.width,this.height=o.height,this.shadow&&(t.save(),t.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(t,s,r),this._drawImage(t,0,0,n),this._postDraw(t),t.restore()),this._preDraw(t,s,r),this._drawImage(t,0,0,n),this._postDraw(t)}clone(){return new eX({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(t,e){if(this._cachedText===t&&this._cachedRenderWidth===e)return this._cachedLines;let i=t.split("\n");if(null==e)return i;for(let t=0;t<i.length;t++){let s=i[t],r="";if(this.measureText(s).width>e){for(;this.measureText(s).width>e;)r=s[s.length-1]+r,s=s.slice(0,-1);i[t]=s,i[t+1]=r}}return this._cachedText=t,this._cachedLines=i,this._cachedRenderWidth=e,i}}class eZ{constructor(){this.fontSheet="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==",this.size=16,this.load()}load(){return this._imageSource=new eV(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=eq.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new eX({alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&.\"?-()+# ",caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(t,e,i){this._imageSource.isLoaded()&&this._spriteFont.render(t,e,null,i.x,i.y)}}class eK{constructor(t,e){this._gl=t,this._texture=e}use(){let t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture)}disable(){let t=this._gl;t.bindTexture(t.TEXTURE_2D,null)}}class eY{constructor(t){this.width=t.width,this.height=t.height,this._gl=t.gl,this._setupFramebuffer()}setResolution(t,e){let i=this._gl;this.width=t,this.height=e,i.bindTexture(i.TEXTURE_2D,this._frameTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.width,this.height,0,i.RGBA,i.UNSIGNED_BYTE,null)}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupFramebuffer(){let t=this._gl;this._frameTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._frameTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);let e=t.COLOR_ATTACHMENT0;this._frameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return new eK(this._gl,this._frameTexture)}use(){let t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.viewport(0,0,this.width,this.height)}disable(){let t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null)}}function ej(t,e){switch(e){case t.FLOAT:return 4;case t.SHORT:case t.UNSIGNED_SHORT:return 2;case t.BYTE:case t.UNSIGNED_BYTE:default:return 1}}function e$(t,e){switch(e){case t.LOW_FLOAT:case t.HIGH_FLOAT:case t.FLOAT:return 1;case t.FLOAT_VEC2:return 2;case t.FLOAT_VEC3:return 3;case t.FLOAT_VEC4:return 4;case t.BYTE:case t.UNSIGNED_BYTE:case t.UNSIGNED_SHORT:case t.SHORT:default:return 1}}function eQ(t,e){switch(e){case t.LOW_FLOAT:case t.HIGH_FLOAT:case t.FLOAT:case t.FLOAT_VEC2:case t.FLOAT_VEC3:case t.FLOAT_VEC4:return t.FLOAT;case t.BYTE:return t.BYTE;case t.UNSIGNED_BYTE:return t.UNSIGNED_BYTE;case t.SHORT:return t.SHORT;case t.UNSIGNED_SHORT:return t.UNSIGNED_SHORT;default:return t.FLOAT}}class eJ{get compiled(){return this._compiled}constructor(t){this._logger=es.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;let{gl:e,vertexSource:i,fragmentSource:s}=t;this._gl=e,this.vertexSource=i,this.fragmentSource=s}use(){this._gl.useProgram(this.program),eJ._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return eJ._ACTIVE_SHADER_INSTANCE===this}compile(){let t=this._gl,e=this._compileShader(t,this.vertexSource,t.VERTEX_SHADER),i=this._compileShader(t,this.fragmentSource,t.FRAGMENT_SHADER);for(let s of(this.program=this._createProgram(t,e,i),this.getAttributes()))this.attributes[s.name]=s;for(let t of this.getUniforms())this.uniforms[t.name]=t;return this._compiled=!0,this.program}getUniforms(){let t=this._gl,e=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS),i=[];for(let s=0;s<e;s++){let e=t.getActiveUniform(this.program,s),r=t.getUniformLocation(this.program,e.name);i.push({name:e.name,glType:e.type,location:r})}return i}getAttributes(){let t=this._gl,e=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES),i=[];for(let s=0;s<e;s++){let e=t.getActiveAttrib(this.program,s),r=t.getAttribLocation(this.program,e.name);i.push({name:e.name,glType:eQ(t,e.type),size:e$(t,e.type),location:r,normalized:!1})}return i}setTexture(t,e){let i=this._gl;i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_2D,e)}setUniformInt(t,e){this.setUniform("uniform1i",t,~~e)}trySetUniformInt(t,e){return this.trySetUniform("uniform1i",t,~~e)}setUniformIntArray(t,e){this.setUniform("uniform1iv",t,e)}trySetUniformIntArray(t,e){return this.trySetUniform("uniform1iv",t,e)}setUniformBoolean(t,e){this.setUniform("uniform1i",t,e?1:0)}trySetUniformBoolean(t,e){return this.trySetUniform("uniform1i",t,e?1:0)}setUniformFloat(t,e){this.setUniform("uniform1f",t,e)}trySetUniformFloat(t,e){return this.trySetUniform("uniform1f",t,e)}setUniformFloatArray(t,e){this.setUniform("uniform1fv",t,e)}trySetUniformFloatArray(t,e){return this.trySetUniform("uniform1fv",t,e)}setUniformFloatVector(t,e){this.setUniform("uniform2f",t,e.x,e.y)}trySetUniformFloatVector(t,e){return this.trySetUniform("uniform2f",t,e.x,e.y)}setUniformFloatColor(t,e){this.setUniform("uniform4f",t,e.r/255,e.g/255,e.b/255,e.a)}trySetUniformFloatColor(t,e){return this.trySetUniform("uniform4f",t,e.r/255,e.g/255,e.b/255,e.a)}setUniformMatrix(t,e){this.setUniform("uniformMatrix4fv",t,!1,e.data)}trySetUniformMatrix(t,e){return this.trySetUniform("uniformMatrix4fv",t,!1,e.data)}setUniform(t,e,...i){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${t}:${e}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");let s=this._gl.getUniformLocation(this.program,e);if(s){let e=[s,...i];this._gl[t].apply(this._gl,e)}else throw Error(`Uniform ${t}:${e} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(t,e,...i){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${t}:${e}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;let s=this._gl.getUniformLocation(this.program,e);if(!s)return!1;{let e=[s,...i];this._gl[t].apply(this._gl,e)}return!0}_createProgram(t,e,i){let s=t.createProgram();if(null===s)throw Error("Could not create graphics shader program");if(t.attachShader(s,e),t.attachShader(s,i),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS))throw Error(`Could not link the program: [${t.getProgramInfoLog(s)}]`);return s}_compileShader(t,e,i){let s=t.VERTEX_SHADER===i?"vertex":"fragment",r=t.createShader(i);if(null===r)throw Error(`Could not build shader: [${e}]`);if(t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){let i=t.getShaderInfoLog(r);throw Error(`Could not compile ${s} shader:

${i}${this._processSourceForError(e,i)}`)}return r}_processSourceForError(t,e){if(!t)return e;let i=t.split("\n"),s=e.search(/\d:\d/),r=e.indexOf(" ",s),[n,o]=e.slice(s,r).split(":").map(t=>Number(t));for(let t=0;t<i.length;t++)i[t]=`${t+1}: ${i[t]}${o===t+1?" <----- ERROR!":""}`;return"\n\nSource:\n"+i.join("\n")}}eJ._ACTIVE_SHADER_INSTANCE=null;class e0{constructor(t){this.type="dynamic";let{gl:e,size:i,type:s,data:r}=t;if(this._gl=e,this.buffer=this._gl.createBuffer(),!r&&!i)throw Error("Must either provide data or a size to the VertexBuffer");r?this.bufferData=r:this.bufferData=new Float32Array(i),this.type=null!=s?s:this.type,e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e.bufferData(e.ARRAY_BUFFER,this.bufferData,"static"===this.type?e.STATIC_DRAW:e.DYNAMIC_DRAW)}bind(){let t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this.buffer)}upload(t){let e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,this.buffer),t?e.bufferSubData(e.ARRAY_BUFFER,0,this.bufferData,0,t):e.bufferData(e.ARRAY_BUFFER,this.bufferData,"static"===this.type?e.STATIC_DRAW:e.DYNAMIC_DRAW)}}class e1{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(t){this._logger=es.getInstance(),this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0;let{gl:e,shader:i,vertexBuffer:s,attributes:r}=t;this._gl=e,this._vertexBuffer=s,this._attributes=r,this._shader=i,i&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(t){t&&this._shader!==t&&(this._shader=t,this.initialize())}get shader(){return this._shader}initialize(){if(!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;let t=this._shader.attributes;for(let e of this._attributes){let i=t[e[0]];if(!i)throw Error(`The attribute named: ${e[0]} size ${e[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);if(i.size!==e[1])throw Error(`VertexLayout size definition for attribute: [${e[0]}, ${e[1]}], doesnt match shader source size ${i.size}:
 ${this._shader.vertexSource}`);this._layout.push(i)}let e=0;for(let t of this._layout){let i=ej(this._gl,t.glType);this._vertexTotalSizeBytes+=i*t.size,e+=t.size}this._vertexBuffer.bufferData.length%e!=0&&this._logger.warn(`The vertex component size (${e})  does divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`)}use(t=!1,e){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");let i=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),t&&this._vertexBuffer.upload(e);let s=0;for(let t of this._layout)i.vertexAttribPointer(t.location,t.size,t.glType,t.normalized,this.totalVertexSizeBytes,s),i.enableVertexAttribArray(t.location),s+=ej(i,t.glType)*t.size}}class e2{static clear(){e2.DrawCallCount=0,e2.DrawnImagesCount=0}}e2.DrawCallCount=0,e2.DrawnImagesCount=0;class e5{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0}initialize(t,e){this._gl=t,this._context=e,this._shader=new eJ({gl:t,vertexSource:"#version 300 es\nin vec2 a_position;\nin vec4 a_color;\n\nout lowp vec4 v_color;\n\nuniform mat4 u_matrix;\n\nvoid main() {\n   // Set the vertex position using the ortho transform matrix\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\n\n   // Passthrough the color\n   v_color = a_color;\n}",fragmentSource:"#version 300 es\nprecision mediump float;\n\n// Color\nin lowp vec4 v_color;\n\nout vec4 fragColor;\n\nvoid main() {\n  fragColor = v_color;\n}"}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new e0({gl:t,size:12*this._maxLines,type:"dynamic"}),this._layout=new e1({gl:t,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}draw(t,e,i){this._isFull()&&this.flush(),this._lineCount++;let s=this._context.getTransform(),r=s.multiply(t),n=s.multiply(e),o=this._vertexBuffer.bufferData;o[this._vertexIndex++]=r.x,o[this._vertexIndex++]=r.y,o[this._vertexIndex++]=i.r/255,o[this._vertexIndex++]=i.g/255,o[this._vertexIndex++]=i.b/255,o[this._vertexIndex++]=i.a,o[this._vertexIndex++]=n.x,o[this._vertexIndex++]=n.y,o[this._vertexIndex++]=i.r/255,o[this._vertexIndex++]=i.g/255,o[this._vertexIndex++]=i.b/255,o[this._vertexIndex++]=i.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return 0!==this._lineCount}flush(){if(0===this._lineCount)return;let t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.LINES,0,2*this._lineCount),e2.DrawnImagesCount+=this._lineCount,e2.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}class e4{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(t,e){this._gl=t,this._context=e,this._shader=new eJ({gl:t,vertexSource:"#version 300 es\nin vec2 a_position;\nin vec4 a_color;\nin float a_size;\nout lowp vec4 v_color;\nuniform mat4 u_matrix;\n\nvoid main() {\n  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\n  gl_PointSize = a_size * 2.0;\n  v_color = a_color;\n}",fragmentSource:'#version 300 es\n\nprecision mediump float;\nin lowp vec4 v_color;\n\nout vec4 fragColor;\n\nvoid main() {\n  float r = 0.0, delta = 0.0, alpha = 1.0;\n  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\n  r = dot(cxy, cxy);\n\n  delta = fwidth(r);\n  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\n  // "premultiply" the color by alpha\n  vec4 color = v_color;\n  color.a = color.a * alpha;\n  color.rgb = color.rgb * color.a;\n  fragColor = color;\n}'}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new e0({gl:t,size:7*this._maxPoints,type:"dynamic"}),this._layout=new e1({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}draw(t,e,i){this._isFull()&&this.flush(),this._pointCount++;let s=this._context.getTransform(),r=this._context.opacity,n=this._context.snapToPixel,o=s.multiply(t);n&&(o.x=~~(o.x+io),o.y=~~(o.y+io));let a=this._buffer.bufferData;a[this._vertexIndex++]=o.x,a[this._vertexIndex++]=o.y,a[this._vertexIndex++]=e.r/255,a[this._vertexIndex++]=e.g/255,a[this._vertexIndex++]=e.b/255,a[this._vertexIndex++]=e.a*r,a[this._vertexIndex++]=i*Math.max(s.getScaleX(),s.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return 0!==this._pointCount}flush(){if(0===this._pointCount)return;let t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.POINTS,0,this._pointCount),e2.DrawnImagesCount+=this._pointCount,e2.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}class e3{constructor(t){this._gl=t,this._shader=new eJ({gl:t,vertexSource:"#version 300 es\nin vec2 a_position;\n\nin vec2 a_texcoord;\nout vec2 v_texcoord;\n\nvoid main() {\n  gl_Position = vec4(a_position, 0.0, 1.0);\n\n  // Pass the texcoord to the fragment shader.\n  v_texcoord = a_texcoord;\n}",fragmentSource:"#version 300 es\nprecision mediump float;\n\n// Passed in from the vertex shader.\nin vec2 v_texcoord;\n\n// The texture.\nuniform sampler2D u_texture;\n\nout vec4 fragColor;\n\nvoid main() {\n   fragColor = texture(u_texture, v_texcoord);\n}"}),this._shader.compile(),this._buffer=new e0({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new e1({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(t){let e=this._gl;t.getShader().use(),t.getLayout().use(),e.drawArrays(e.TRIANGLES,0,6)}renderToScreen(){let t=this._gl;this._shader.use(),this._layout.use(),t.drawArrays(t.TRIANGLES,0,6)}}class e6{constructor(t,e,i){this._logger=es.getInstance(),this._gl=t,this.buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer);let s=6*e;if(i){let i=Math.floor(16383.5);this.bufferGlType=t.UNSIGNED_SHORT,this.bufferData=new Uint16Array(s),e>i&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${i}) requested quads(${e})`)}else this.bufferData=new Uint32Array(s);let r=0;for(let t=0;t<s;t+=6)this.bufferData[t+0]=r+0,this.bufferData[t+1]=r+1,this.bufferData[t+2]=r+2,this.bufferData[t+3]=r+2,this.bufferData[t+4]=r+1,this.bufferData[t+5]=r+3,r+=4;t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){let t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}bind(){let t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer)}}class e9{constructor(){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._vertexIndex=0}initialize(t,e){this._gl=t,this._context=e,this._maxTextures=Math.min(t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),125);let i=this._transformFragmentSource("#version 300 es\nprecision mediump float;\n\n// UV coord\nin vec2 v_texcoord;\n\n// Texture index\nin lowp float v_textureIndex;\n\n// Textures in the current draw\nuniform sampler2D u_textures[%%count%%];\n\n// Opacity\nin float v_opacity;\n\nin vec4 v_tint;\n\nout vec4 fragColor;\n\nvoid main() {\n   // In order to support the most efficient sprite batching, we have multiple\n   // textures loaded into the gpu (usually 8) this picker logic skips over textures\n   // that do not apply to a particular sprite.\n\n   vec4 color = vec4(1.0, 0, 0, 1.0);\n\n   // GLSL is templated out to pick the right texture and set the vec4 color\n   %%texture_picker%%\n\n   color.rgb = color.rgb * v_opacity;\n   color.a = color.a * v_opacity;\n   fragColor = color * v_tint;\n}",this._maxTextures);this._shader=new eJ({gl:t,fragmentSource:i,vertexSource:"#version 300 es\nin vec2 a_position;\n\n// Opacity \nin float a_opacity;\nout float v_opacity;\n\n// UV coordinate\nin vec2 a_texcoord;\nout vec2 v_texcoord;\n\n// Texture number\nin lowp float a_textureIndex;\nout lowp float v_textureIndex;\n\nin vec4 a_tint;\nout vec4 v_tint;\n\nuniform mat4 u_matrix;\n\nvoid main() {\n   // Set the vertex position using the ortho transform matrix\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\n\n   // Pass through the Opacity to the fragment shader\n   v_opacity = a_opacity;\n   // Pass through the UV coord to the fragment shader\n   v_texcoord = a_texcoord;\n   // Pass through the texture number to the fragment shader\n   v_textureIndex = a_textureIndex;\n   // Pass through the tint\n   v_tint = a_tint;\n}"}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",e.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((t,e)=>e)),this._buffer=new e0({gl:t,size:40*this._maxImages,type:"dynamic"}),this._layout=new e1({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new e6(t,this._maxImages,!0)}_transformFragmentSource(t,e){let i=t.replace("%%count%%",e.toString()),s="";for(let t=0;t<e;t++)0===t?s+=`if (v_textureIndex <= ${t}.5) {
`:s+=`   else if (v_textureIndex <= ${t}.5) {
`,s+=`      color = texture(u_textures[${t}], v_texcoord);
   }
`;return i.replace("%%texture_picker%%",s)}_addImageAsTexture(t){let e=t.getAttribute("filtering"),i=null;(e===q.Blended||e===q.Pixel)&&(i=e);let s="true"===t.getAttribute("forceUpload"),r=this._context.textureLoader.load(t,i,s);t.removeAttribute("forceUpload"),-1===this._textures.indexOf(r)&&this._textures.push(r)}_bindTextures(t){for(let e=0;e<this._maxTextures;e++)t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this._textures[e]||this._textures[0])}_getTextureIdForImage(t){if(t){let e=this._context.textureLoader.get(t);return this._textures.indexOf(e)}return -1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}draw(t,e,i,s,r,n,o,a,h){var l,d,c,u;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);let p=(null==t?void 0:t.width)||s||0,_=(null==t?void 0:t.height)||r||0,g=[0,0,null!==(l=null!=s?s:null==t?void 0:t.width)&&void 0!==l?l:0,null!==(d=null!=r?r:null==t?void 0:t.height)&&void 0!==d?d:0],m=[null!=e?e:1,null!=i?i:1];void 0!==n&&void 0!==o&&void 0!==a&&void 0!==h&&(g=[null!=e?e:1,null!=i?i:1,null!==(c=null!=s?s:null==t?void 0:t.width)&&void 0!==c?c:0,null!==(u=null!=r?r:null==t?void 0:t.height)&&void 0!==u?u:0],m=[n,o],p=a,_=h),e=g[0],i=g[1];let f=g[2],v=g[3],x=this._context.getTransform(),y=this._context.opacity,w=this._context.snapToPixel,b=ew(m[0],m[1]),C=ew(m[0]+p,m[1]),A=ew(m[0],m[1]+_),T=ew(m[0]+p,m[1]+_);b=x.multiply(b),C=x.multiply(C),A=x.multiply(A),T=x.multiply(T),w&&(b.x=~~(b.x+io),b.y=~~(b.y+io),C.x=~~(C.x+io),C.y=~~(C.y+io),A.x=~~(A.x+io),A.y=~~(A.y+io),T.x=~~(T.x+io),T.y=~~(T.y+io));let S=this._context.tint,E=this._getTextureIdForImage(t),P=t.width||p,I=t.height||_,D=e/P,R=i/I,B=(e+f-.01)/P,F=(i+v-.01)/I,k=this._layout.vertexBuffer.bufferData;k[this._vertexIndex++]=b.x,k[this._vertexIndex++]=b.y,k[this._vertexIndex++]=y,k[this._vertexIndex++]=D,k[this._vertexIndex++]=R,k[this._vertexIndex++]=E,k[this._vertexIndex++]=S.r/255,k[this._vertexIndex++]=S.g/255,k[this._vertexIndex++]=S.b/255,k[this._vertexIndex++]=S.a,k[this._vertexIndex++]=A.x,k[this._vertexIndex++]=A.y,k[this._vertexIndex++]=y,k[this._vertexIndex++]=D,k[this._vertexIndex++]=F,k[this._vertexIndex++]=E,k[this._vertexIndex++]=S.r/255,k[this._vertexIndex++]=S.g/255,k[this._vertexIndex++]=S.b/255,k[this._vertexIndex++]=S.a,k[this._vertexIndex++]=C.x,k[this._vertexIndex++]=C.y,k[this._vertexIndex++]=y,k[this._vertexIndex++]=B,k[this._vertexIndex++]=R,k[this._vertexIndex++]=E,k[this._vertexIndex++]=S.r/255,k[this._vertexIndex++]=S.g/255,k[this._vertexIndex++]=S.b/255,k[this._vertexIndex++]=S.a,k[this._vertexIndex++]=T.x,k[this._vertexIndex++]=T.y,k[this._vertexIndex++]=y,k[this._vertexIndex++]=B,k[this._vertexIndex++]=F,k[this._vertexIndex++]=E,k[this._vertexIndex++]=S.r/255,k[this._vertexIndex++]=S.g/255,k[this._vertexIndex++]=S.b/255,k[this._vertexIndex++]=S.a}hasPendingDraws(){return 0!==this._imageCount}flush(){if(0===this._imageCount)return;let t=this._gl;this._shader.use(),this._layout.use(!0,40*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._bindTextures(t),this._quads.bind(),t.drawElements(t.TRIANGLES,6*this._imageCount,this._quads.bufferGlType,0),e2.DrawnImagesCount+=this._imageCount,e2.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0}}class e7{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0}initialize(t,e){this._gl=t,this._context=e,this._shader=new eJ({gl:t,fragmentSource:"#version 300 es\n\nprecision mediump float;\n\n// UV coord\nin vec2 v_uv;\n\nin vec2 v_size; // in pixels\n\n// Color coord to blend with image\nin lowp vec4 v_color;\n\n// Stroke color if used\nin lowp vec4 v_strokeColor;\n\n// Stroke thickness if used\nin lowp float v_strokeThickness; // in pixels\n\n// Opacity\nin float v_opacity;\n\nout vec4 fragColor;\n\nvoid main() {\n    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\n    vec2 uv = v_uv;\n    vec2 fragCoord = uv * v_size;\n    float maxX = v_size.x - v_strokeThickness;\n    float minX = v_strokeThickness;\n    float maxY = v_size.y - v_strokeThickness;\n    float minY = v_strokeThickness;\n\n    if (fragCoord.x < maxX && fragCoord.x > minX &&\n        fragCoord.y < maxY && fragCoord.y > minY) {\n      fragColor = v_color;\n    } else {\n      fragColor = v_strokeColor;\n    }\n    fragColor.a *= v_opacity;\n    fragColor.rgb *= fragColor.a;\n\n    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\n    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\n\n    // float fHalfBorderDist      = 0.0;\n    // float fHalfBorderThickness = 0.0;\n\n    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \n    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\n    // {\n    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\n    //     fHalfBorderThickness = v_strokeThickness / 2.0;\n    // }\n    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \n    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\n    // {\n    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\n    //     fHalfBorderThickness = v_strokeThickness / 2.0;\n    // }\n    // else\n    // {\n    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\n    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\n    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\n        \n    //     float ellipse_ab    = v_radius-v_strokeThickness;\n    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\n    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \n            \n    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\n    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\n    // }\n\n    // vec4 v4FromColor = v_strokeColor;\n    // v4FromColor.rgb *= v4FromColor.a;\n    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\n    // if (fHalfBorderDist < 0.0) {\n    //     v4ToColor = v_color;\n    //     v4ToColor.rgb *= v4ToColor.a;\n    // }\n\n    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\n\n    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\n    // gl_FragColor = finalColor;\n}",vertexSource:"#version 300 es\nin vec2 a_position;\n\n// UV coordinate\nin vec2 a_uv;\nout vec2 v_uv;\n\nin vec2 a_size;\nout vec2 v_size;\n\n// Opacity \nin float a_opacity;\nout float v_opacity;\n\nin vec4 a_color;\nout vec4 v_color;\n\nin vec4 a_strokeColor;\nout vec4 v_strokeColor;\n\nin float a_strokeThickness;\nout float v_strokeThickness;\n\nuniform mat4 u_matrix;\n\n\nvoid main() {\n   // Set the vertex position using the ortho transform matrix\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\n\n   // Pass through UV coords\n   v_uv = a_uv;\n   // Pass through size\n   v_size = a_size;\n   // Pass through the Opacity to the fragment shader\n   v_opacity = a_opacity;\n   // Pass through the color to the fragment shader\n   v_color = a_color;\n   // Pass through the stroke color to the fragment shader\n   v_strokeColor = a_strokeColor;\n   // Pass through the stroke thickenss to the fragment shader\n   v_strokeThickness = a_strokeThickness;\n}"}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",e.ortho),this._buffer=new e0({gl:t,size:64*this._maxRectangles,type:"dynamic"}),this._layout=new e1({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new e6(t,this._maxRectangles,!0)}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...t){t[0]instanceof ey&&t[1]instanceof ey?this.drawLine.apply(this,t):this.drawRectangle.apply(this,t)}drawLine(t,e,i,s=1){this._isFull()&&this.flush(),this._rectangleCount++;let r=this._context.getTransform(),n=this._context.opacity,o=this._context.snapToPixel,a=e.sub(t),h=a.size,l=a.normalize().perpendicular(),d=s/2,c=r.multiply(l.scale(d).add(t)),u=r.multiply(l.scale(-d).add(t)),p=r.multiply(l.scale(d).add(e)),_=r.multiply(l.scale(-d).add(e));o&&(c.x=~~(c.x+io),c.y=~~(c.y+io),p.x=~~(p.x+io),p.y=~~(p.y+io),u.x=~~(u.x+io),u.y=~~(u.y+io),_.x=~~(_.x+io),_.y=~~(_.y+io));let g=eb.Transparent,m=this._layout.vertexBuffer.bufferData;m[this._vertexIndex++]=c.x,m[this._vertexIndex++]=c.y,m[this._vertexIndex++]=0,m[this._vertexIndex++]=0,m[this._vertexIndex++]=h,m[this._vertexIndex++]=s,m[this._vertexIndex++]=n,m[this._vertexIndex++]=i.r/255,m[this._vertexIndex++]=i.g/255,m[this._vertexIndex++]=i.b/255,m[this._vertexIndex++]=i.a,m[this._vertexIndex++]=g.r/255,m[this._vertexIndex++]=g.g/255,m[this._vertexIndex++]=g.b/255,m[this._vertexIndex++]=g.a,m[this._vertexIndex++]=0,m[this._vertexIndex++]=u.x,m[this._vertexIndex++]=u.y,m[this._vertexIndex++]=0,m[this._vertexIndex++]=1,m[this._vertexIndex++]=h,m[this._vertexIndex++]=s,m[this._vertexIndex++]=n,m[this._vertexIndex++]=i.r/255,m[this._vertexIndex++]=i.g/255,m[this._vertexIndex++]=i.b/255,m[this._vertexIndex++]=i.a,m[this._vertexIndex++]=g.r/255,m[this._vertexIndex++]=g.g/255,m[this._vertexIndex++]=g.b/255,m[this._vertexIndex++]=g.a,m[this._vertexIndex++]=0,m[this._vertexIndex++]=p.x,m[this._vertexIndex++]=p.y,m[this._vertexIndex++]=1,m[this._vertexIndex++]=0,m[this._vertexIndex++]=h,m[this._vertexIndex++]=s,m[this._vertexIndex++]=n,m[this._vertexIndex++]=i.r/255,m[this._vertexIndex++]=i.g/255,m[this._vertexIndex++]=i.b/255,m[this._vertexIndex++]=i.a,m[this._vertexIndex++]=g.r/255,m[this._vertexIndex++]=g.g/255,m[this._vertexIndex++]=g.b/255,m[this._vertexIndex++]=g.a,m[this._vertexIndex++]=0,m[this._vertexIndex++]=_.x,m[this._vertexIndex++]=_.y,m[this._vertexIndex++]=1,m[this._vertexIndex++]=1,m[this._vertexIndex++]=h,m[this._vertexIndex++]=s,m[this._vertexIndex++]=n,m[this._vertexIndex++]=i.r/255,m[this._vertexIndex++]=i.g/255,m[this._vertexIndex++]=i.b/255,m[this._vertexIndex++]=i.a,m[this._vertexIndex++]=g.r/255,m[this._vertexIndex++]=g.g/255,m[this._vertexIndex++]=g.b/255,m[this._vertexIndex++]=g.a,m[this._vertexIndex++]=0}drawRectangle(t,e,i,s,r=eb.Transparent,n=0){this._isFull()&&this.flush(),this._rectangleCount++;let o=this._context.getTransform(),a=this._context.opacity,h=this._context.snapToPixel,l=o.multiply(t.add(ew(0,0))),d=o.multiply(t.add(ew(e,0))),c=o.multiply(t.add(ew(e,i))),u=o.multiply(t.add(ew(0,i)));h&&(l.x=~~(l.x+io),l.y=~~(l.y+io),d.x=~~(d.x+io),d.y=~~(d.y+io),u.x=~~(u.x+io),u.y=~~(u.y+io),c.x=~~(c.x+io),c.y=~~(c.y+io));let p=this._layout.vertexBuffer.bufferData;p[this._vertexIndex++]=l.x,p[this._vertexIndex++]=l.y,p[this._vertexIndex++]=0,p[this._vertexIndex++]=0,p[this._vertexIndex++]=e,p[this._vertexIndex++]=i,p[this._vertexIndex++]=a,p[this._vertexIndex++]=s.r/255,p[this._vertexIndex++]=s.g/255,p[this._vertexIndex++]=s.b/255,p[this._vertexIndex++]=s.a,p[this._vertexIndex++]=r.r/255,p[this._vertexIndex++]=r.g/255,p[this._vertexIndex++]=r.b/255,p[this._vertexIndex++]=r.a,p[this._vertexIndex++]=n,p[this._vertexIndex++]=u.x,p[this._vertexIndex++]=u.y,p[this._vertexIndex++]=0,p[this._vertexIndex++]=1,p[this._vertexIndex++]=e,p[this._vertexIndex++]=i,p[this._vertexIndex++]=a,p[this._vertexIndex++]=s.r/255,p[this._vertexIndex++]=s.g/255,p[this._vertexIndex++]=s.b/255,p[this._vertexIndex++]=s.a,p[this._vertexIndex++]=r.r/255,p[this._vertexIndex++]=r.g/255,p[this._vertexIndex++]=r.b/255,p[this._vertexIndex++]=r.a,p[this._vertexIndex++]=n,p[this._vertexIndex++]=d.x,p[this._vertexIndex++]=d.y,p[this._vertexIndex++]=1,p[this._vertexIndex++]=0,p[this._vertexIndex++]=e,p[this._vertexIndex++]=i,p[this._vertexIndex++]=a,p[this._vertexIndex++]=s.r/255,p[this._vertexIndex++]=s.g/255,p[this._vertexIndex++]=s.b/255,p[this._vertexIndex++]=s.a,p[this._vertexIndex++]=r.r/255,p[this._vertexIndex++]=r.g/255,p[this._vertexIndex++]=r.b/255,p[this._vertexIndex++]=r.a,p[this._vertexIndex++]=n,p[this._vertexIndex++]=c.x,p[this._vertexIndex++]=c.y,p[this._vertexIndex++]=1,p[this._vertexIndex++]=1,p[this._vertexIndex++]=e,p[this._vertexIndex++]=i,p[this._vertexIndex++]=a,p[this._vertexIndex++]=s.r/255,p[this._vertexIndex++]=s.g/255,p[this._vertexIndex++]=s.b/255,p[this._vertexIndex++]=s.a,p[this._vertexIndex++]=r.r/255,p[this._vertexIndex++]=r.g/255,p[this._vertexIndex++]=r.b/255,p[this._vertexIndex++]=r.a,p[this._vertexIndex++]=n}hasPendingDraws(){return 0!==this._rectangleCount}flush(){if(0===this._rectangleCount)return;let t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,6*this._rectangleCount,this._quads.bufferGlType,0),e2.DrawnImagesCount+=this._rectangleCount,e2.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}class e8{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(t,e){this._gl=t,this._context=e,this._shader=new eJ({gl:t,fragmentSource:"#version 300 es\nprecision highp float;\n\n// UV coord\nin vec2 v_uv;\n\n// Color coord to blend with image\nin lowp vec4 v_color;\n\n// Stroke color if used\nin lowp vec4 v_strokeColor;\n\n// Stroke thickness if used\nin lowp float v_strokeThickness;\n\n// Opacity\nin float v_opacity;\n\nout vec4 fragColor;\n\nvoid main() {\n  // make (0, 0) the center the uv \n  vec2 uv = v_uv * 2.0 - 1.0;\n\n  vec4 color = v_color;\n  vec4 strokeColor = v_strokeColor;\n\n  // circle border is at radius 1.0 \n  // dist is > 0 when inside the circle \n  float d = length(uv);\n  float dist = 1.0 - length(uv);\n\n  // Fade based on fwidth\n  float fade = fwidth(dot(uv, uv));\n\n  // if dist is greater than 0 step to 1;\n  // when we cross this 0 threshold add a smooth fade\n  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\n\n  // if dist is greater than the stroke thickness step to 1\n  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\n\n  strokeColor.a *= fill * stroke;\n  strokeColor.rgb *= strokeColor.a;\n\n  color.a *= fill * (1.0 - stroke);\n  color.rgb *= color.a;\n\n  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\n  finalColor.rgb = finalColor.rgb * v_opacity;\n  finalColor.a = finalColor.a * v_opacity;\n  fragColor = finalColor;\n}",vertexSource:"#version 300 es\nin vec2 a_position;\n\n// UV coordinate\nin vec2 a_uv;\nout vec2 v_uv;\n\n// Opacity \nin float a_opacity;\nout float v_opacity;\n\nin vec4 a_color;\nout vec4 v_color;\n\nin vec4 a_strokeColor;\nout vec4 v_strokeColor;\n\nin float a_strokeThickness;\nout float v_strokeThickness;\n\nuniform mat4 u_matrix;\n\n\nvoid main() {\n   // Set the vertex position using the ortho transform matrix\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\n\n   // Pass through UV coords\n   v_uv = a_uv;\n   // Pass through the Opacity to the fragment shader\n   v_opacity = a_opacity;\n   // Pass through the color to the fragment shader\n   v_color = a_color;\n   // Pass through the stroke color to the fragment shader\n   v_strokeColor = a_strokeColor;\n   // Pass through the stroke thickenss to the fragment shader\n   v_strokeThickness = a_strokeThickness;\n}"}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",e.ortho),this._buffer=new e0({gl:t,size:56*this._maxCircles,type:"dynamic"}),this._layout=new e1({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new e6(t,this._maxCircles,!0)}_isFull(){return this._circleCount>=this._maxCircles}draw(t,e,i,s=eb.Transparent,r=0){this._isFull()&&this.flush(),this._circleCount++;let n=this._context.getTransform(),o=this._context.opacity,a=this._context.snapToPixel,h=n.multiply(t.add(ew(-e,-e))),l=n.multiply(t.add(ew(e,-e))),d=n.multiply(t.add(ew(e,e))),c=n.multiply(t.add(ew(-e,e)));a&&(h.x=~~(h.x+io),h.y=~~(h.y+io),l.x=~~(l.x+io),l.y=~~(l.y+io),c.x=~~(c.x+io),c.y=~~(c.y+io),d.x=~~(d.x+io),d.y=~~(d.y+io));let u=this._layout.vertexBuffer.bufferData;u[this._vertexIndex++]=h.x,u[this._vertexIndex++]=h.y,u[this._vertexIndex++]=0,u[this._vertexIndex++]=0,u[this._vertexIndex++]=o,u[this._vertexIndex++]=i.r/255,u[this._vertexIndex++]=i.g/255,u[this._vertexIndex++]=i.b/255,u[this._vertexIndex++]=i.a,u[this._vertexIndex++]=s.r/255,u[this._vertexIndex++]=s.g/255,u[this._vertexIndex++]=s.b/255,u[this._vertexIndex++]=s.a,u[this._vertexIndex++]=r/e,u[this._vertexIndex++]=c.x,u[this._vertexIndex++]=c.y,u[this._vertexIndex++]=0,u[this._vertexIndex++]=1,u[this._vertexIndex++]=o,u[this._vertexIndex++]=i.r/255,u[this._vertexIndex++]=i.g/255,u[this._vertexIndex++]=i.b/255,u[this._vertexIndex++]=i.a,u[this._vertexIndex++]=s.r/255,u[this._vertexIndex++]=s.g/255,u[this._vertexIndex++]=s.b/255,u[this._vertexIndex++]=s.a,u[this._vertexIndex++]=r/e,u[this._vertexIndex++]=l.x,u[this._vertexIndex++]=l.y,u[this._vertexIndex++]=1,u[this._vertexIndex++]=0,u[this._vertexIndex++]=o,u[this._vertexIndex++]=i.r/255,u[this._vertexIndex++]=i.g/255,u[this._vertexIndex++]=i.b/255,u[this._vertexIndex++]=i.a,u[this._vertexIndex++]=s.r/255,u[this._vertexIndex++]=s.g/255,u[this._vertexIndex++]=s.b/255,u[this._vertexIndex++]=s.a,u[this._vertexIndex++]=r/e,u[this._vertexIndex++]=d.x,u[this._vertexIndex++]=d.y,u[this._vertexIndex++]=1,u[this._vertexIndex++]=1,u[this._vertexIndex++]=o,u[this._vertexIndex++]=i.r/255,u[this._vertexIndex++]=i.g/255,u[this._vertexIndex++]=i.b/255,u[this._vertexIndex++]=i.a,u[this._vertexIndex++]=s.r/255,u[this._vertexIndex++]=s.g/255,u[this._vertexIndex++]=s.b/255,u[this._vertexIndex++]=s.a,u[this._vertexIndex++]=r/e}hasPendingDraws(){return 0!==this._circleCount}flush(){if(0===this._circleCount)return;let t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,6*this._circleCount,this._quads.bufferGlType,0),e2.DrawnImagesCount+=this._circleCount,e2.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class it{constructor(t,e,i=100){this.builder=t,this.recycler=e,this.maxObjects=i,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=es.getInstance()}preallocate(){for(let t=0;t<this.maxObjects;t++)this.objects[t]=this.builder()}using(t){let e=t(this);return e?this.done(...e):this.done()}borrow(t){t(this.get()),this.index--}get(...t){return(this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=2*this.maxObjects),this.objects[this.index])?this.recycler(this.objects[this.index++],...t):(this.totalAllocations++,this.objects[this.index++]=this.builder(...t))}done(...t){for(let e of(this.index=0,t)){let t=this.objects.indexOf(e);this.objects[t]=this.builder(),this.totalAllocations++}return t}}class ie{constructor(){this.z=0,this.priority=0,this.transform=ek.identity(),this.state={z:0,opacity:1,tint:eb.White,material:null}}}let ii=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class is{constructor(t){this._color=eb.Transparent,this._initialized=!1;let{color:e,name:i,vertexSource:s,fragmentSource:r}=t;this._name=i,this._vertexSource=null!=s?s:ii,this._fragmentSource=r,this._color=null!=e?e:this._color}initialize(t,e){this._initialized||(this._shader=e.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0)}get name(){var t;return null!==(t=this._name)&&void 0!==t?t:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(t){this._shader&&(this._shader.use(),t(this._shader))}getShader(){return this._shader}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class ir{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(t,e){this._gl=t,this._context=e,this._buffer=new e0({gl:t,size:24,type:"dynamic"}),this._layout=new e1({gl:t,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]]}),this._quads=new e6(t,1,!0)}draw(t,e,i,s,r,n,o,a,h){var l,d,c,u;let p=this._gl,_=this._context.material;_.initialize(p,this._context);let g=this._context.getTransform(),m=this._context.opacity,f=_.getShader(),v=this._layout.vertexBuffer.bufferData,x=0,y=(null==t?void 0:t.width)||s||0,w=(null==t?void 0:t.height)||r||0,b=[0,0,null!==(l=null!=s?s:null==t?void 0:t.width)&&void 0!==l?l:0,null!==(d=null!=r?r:null==t?void 0:t.height)&&void 0!==d?d:0],C=[null!=e?e:1,null!=i?i:1];void 0!==n&&void 0!==o&&void 0!==a&&void 0!==h&&(b=[null!=e?e:1,null!=i?i:1,null!==(c=null!=s?s:null==t?void 0:t.width)&&void 0!==c?c:0,null!==(u=null!=r?r:null==t?void 0:t.height)&&void 0!==u?u:0],C=[n,o],y=a,w=h),e=b[0],i=b[1];let A=b[2],T=b[3],S=ew(C[0],C[1]),E=ew(C[0]+y,C[1]),P=ew(C[0],C[1]+w),I=ew(C[0]+y,C[1]+w),D=t.width||y,R=t.height||w,B=e/D,F=i/R,k=(e+A-.01)/D,M=(i+T-.01)/R,L=g.getPosition(),z=L.add(I),U=L.x/this._context.width,O=L.y/this._context.height,N=z.x/this._context.width,H=z.y/this._context.height;v[x++]=S.x,v[x++]=S.y,v[x++]=B,v[x++]=F,v[x++]=U,v[x++]=O,v[x++]=P.x,v[x++]=P.y,v[x++]=B,v[x++]=M,v[x++]=U,v[x++]=H,v[x++]=E.x,v[x++]=E.y,v[x++]=k,v[x++]=F,v[x++]=N,v[x++]=O,v[x++]=I.x,v[x++]=I.y,v[x++]=k,v[x++]=M,v[x++]=N,v[x++]=H;let W=this._addImageAsTexture(t);_.use(),this._layout.shader=f,this._layout.use(!0),f.trySetUniformFloat("u_time_ms",performance.now()),f.trySetUniformFloat("u_opacity",m),f.trySetUniformFloatVector("u_resolution",ew(this._context.width,this._context.height)),f.trySetUniformFloatVector("u_graphic_resolution",ew(D,R)),f.trySetUniformFloatVector("u_size",ew(A,T)),f.trySetUniformMatrix("u_matrix",this._context.ortho),f.trySetUniformMatrix("u_transform",g.to4x4()),p.activeTexture(p.TEXTURE0+0),p.bindTexture(p.TEXTURE_2D,W),f.trySetUniformInt("u_graphic",0),p.activeTexture(p.TEXTURE0+1),p.bindTexture(p.TEXTURE_2D,this._context.materialScreenTexture),f.trySetUniformInt("u_screen_texture",1),this._quads.bind(),p.drawElements(p.TRIANGLES,6,this._quads.bufferGlType,0),e2.DrawnImagesCount++,e2.DrawCallCount++}_addImageAsTexture(t){let e=t.getAttribute("filtering"),i=null;(e===q.Blended||e===q.Pixel)&&(i=e);let s="true"===t.getAttribute("forceUpload"),r=this._context.textureLoader.load(t,i,s);return t.removeAttribute("forceUpload"),-1===this._textures.indexOf(r)&&this._textures.push(r),r}hasPendingDraws(){return!1}flush(){}}let io=1e-4;class ia{constructor(t){this._webglCtx=t,this._debugText=new eZ}drawRect(t,e,i,s,r={color:eb.Black}){this.drawLine(ew(t,e),ew(t+i,e),{...r}),this.drawLine(ew(t+i,e),ew(t+i,e+s),{...r}),this.drawLine(ew(t+i,e+s),ew(t,e+s),{...r}),this.drawLine(ew(t,e+s),ew(t,e),{...r})}drawLine(t,e,i={color:eb.Black}){this._webglCtx.draw("ex.line",t,e,i.color)}drawPoint(t,e={color:eb.Black,size:5}){this._webglCtx.draw("ex.point",t,e.color,e.size)}drawText(t,e){this._debugText.write(this._webglCtx,t,e)}}class ih{get z(){return this._state.current.z}set z(t){this._state.current.z=t}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(t){let e=!0;return(t.width>4096||t.height>4096)&&(e=!1),e}constructor(t){this._logger=es.getInstance(),this._renderers=new Map,this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new it(()=>new ie,t=>(t.priority=0,t.z=0,t.renderer=void 0,t.args=void 0,t),4e3),this._drawCalls=[],this._postProcessTargets=[],this._postprocessors=[],this._transform=new eM,this._state=new eL,this.snapToPixel=!1,this.smoothing=!1,this.backgroundColor=eb.ExcaliburBlue,this._alreadyWarnedDrawLifecycle=!1,this.debug=new ia(this),this._totalPostProcessorTime=0;let{canvasElement:e,enableTransparency:i,smoothing:s,snapToPixel:r,backgroundColor:n,useDrawSorting:o}=t;if(this.__gl=e.getContext("webgl2",{antialias:null!=s?s:this.smoothing,premultipliedAlpha:!1,alpha:null==i||i,depth:!0,powerPreference:"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");this.textureLoader=new eG(this.__gl),this.snapToPixel=null!=r?r:this.snapToPixel,this.smoothing=null!=s?s:this.smoothing,this.backgroundColor=null!=n?n:this.backgroundColor,this.useDrawSorting=null!=o?o:this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}_init(){let t=this.__gl;this._ortho=eF.ortho(0,t.canvas.width,t.canvas.height,0,400,-400),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),this.register(new e9),this.register(new ir),this.register(new e7),this.register(new e8),this.register(new e4),this.register(new e5),this.materialScreenTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.materialScreenTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null),this._screenRenderer=new e3(t),this._renderTarget=new eY({gl:t,width:t.canvas.width,height:t.canvas.height}),this._postProcessTargets=[new eY({gl:t,width:t.canvas.width,height:t.canvas.height}),new eY({gl:t,width:t.canvas.width,height:t.canvas.height})]}register(t){this._renderers.set(t.type,t),t.initialize(this.__gl,this)}get(t){return this._renderers.get(t)}_isCurrentRenderer(t){return!this._currentRenderer||this._currentRenderer===t}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(t,...e){this._isDrawLifecycle||this._alreadyWarnedDrawLifecycle||(this._logger.warn(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._alreadyWarnedDrawLifecycle=!0);let i=this._renderers.get(t);if(i){if(this.useDrawSorting){let s=this._drawCallPool.get();s.z=this._state.current.z,s.priority=i.priority,s.renderer=t,this.getTransform().clone(s.transform),s.state.z=this._state.current.z,s.state.opacity=this._state.current.opacity,s.state.tint=this._state.current.tint,s.state.material=this._state.current.material,s.args=e,this._drawCalls.push(s)}else this._currentRenderer||(this._currentRenderer=i),this._isCurrentRenderer(i)||this._currentRenderer.flush(),i.draw(...e),this._currentRenderer=i}else throw Error(`No renderer with name ${t} has been registered`)}resetTransform(){this._transform.current=ek.identity()}updateViewport(t){let e=this.__gl;this._ortho=this._ortho=eF.ortho(0,t.width,t.height,0,400,-400),this._renderTarget.setResolution(e.canvas.width,e.canvas.height),this._postProcessTargets[0].setResolution(e.canvas.width,e.canvas.height),this._postProcessTargets[1].setResolution(e.canvas.width,e.canvas.height)}drawImage(t,e,i,s,r,n,o,a,h){if(0!==s&&0!==r&&0!==a&&0!==h&&0!==t.width&&0!==t.height){if(!t){es.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",t,e,i,s,r,n,o,a,h):this.draw("ex.image",t,e,i,s,r,n,o,a,h)}}drawLine(t,e,i,s=1){this.draw("ex.rectangle",t,e,i,s)}drawRectangle(t,e,i,s,r,n){this.draw("ex.rectangle",t,e,i,s,r,n)}drawCircle(t,e,i,s,r){this.draw("ex.circle",t,e,i,s,r)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(t,e){this._transform.translate(this.snapToPixel?~~(t+io):t,this.snapToPixel?~~(e+io):e)}rotate(t){this._transform.rotate(t)}scale(t,e){this._transform.scale(t,e)}transform(t){this._transform.current=t}getTransform(){return this._transform.current}multiply(t){this._transform.current.multiply(t,this._transform.current)}addPostProcessor(t){this._postprocessors.push(t),t.initialize(this.__gl)}removePostProcessor(t){let e=this._postprocessors.indexOf(t);-1!==e&&this._postprocessors.splice(e,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(t){for(let e of this._postprocessors){let i=e.getShader();i.use();let s=i.getUniforms();this._totalPostProcessorTime+=t,s.find(t=>"u_time_ms"===t.name)&&i.setUniformFloat("u_time_ms",this._totalPostProcessorTime),s.find(t=>"u_elapsed_ms"===t.name)&&i.setUniformFloat("u_elapsed_ms",t),s.find(t=>"u_resolution"===t.name)&&i.setUniformFloatVector("u_resolution",ew(this.width,this.height)),e.onUpdate&&e.onUpdate(t)}}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){let e=new is(t);return e.initialize(this.__gl,this),e}createShader(t){let e=this.__gl,{vertexSource:i,fragmentSource:s}=t,r=new eJ({gl:e,vertexSource:i,fragmentSource:s});return r.compile(),r}clear(){let t=this.__gl;this._renderTarget.use(),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT)}flush(){let t=this.__gl;if(this._renderTarget.use(),this.useDrawSorting){let t=new Map;for(let[e]of this._renderers){let i=this._drawCalls.findIndex(t=>t.renderer===e);t.set(e,i)}this._drawCalls.sort((e,i)=>{let s=e.z-i.z,r=t.get(e.renderer)-t.get(i.renderer),n=e.priority-i.priority;return 0===s?0===n?r:n:s});let e=this._transform.current,i=this._state.current;if(this._drawCalls.length){let t=this._drawCalls[0].renderer,e=this._renderers.get(t);for(let i=0;i<this._drawCalls.length;i++){if(this._transform.current=this._drawCalls[i].transform,this._state.current=this._drawCalls[i].state,this._drawCalls[i].renderer!==t&&(e.flush(),t=this._drawCalls[i].renderer,e=this._renderers.get(t)),e instanceof ir&&this.material.isUsingScreenTexture){let t=this.__gl;t.bindTexture(t.TEXTURE_2D,this.materialScreenTexture),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,this.width,this.height,0),this._renderTarget.use()}e.draw(...this._drawCalls[i].args)}e.hasPendingDraws()&&e.flush()}this._transform.current=e,this._state.current=i,this._drawCallPool.done(),this._drawCalls.length=0}else for(let t of this._renderers.values())t.hasPendingDraws()&&t.flush();this._renderTarget.disable(),this._renderTarget.toRenderSource().use();for(let t=0;t<this._postprocessors.length;t++)this._postProcessTargets[t%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[t]),this._postProcessTargets[t%2].toRenderSource().use();t.bindFramebuffer(t.FRAMEBUFFER,null),this._screenRenderer.renderToScreen()}}class il{constructor(t){this._ex=t,this._debugText=new eZ}drawRect(t,e,i,s){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(t+1e-4):t,this._ex.snapToPixel?~~(e+1e-4):e,this._ex.snapToPixel?~~(i+1e-4):i,this._ex.snapToPixel?~~(s+1e-4):s),this._ex.__ctx.restore()}drawLine(t,e,i={color:eb.Black}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=i.color.toString(),this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(t.x+1e-4):t.x,this._ex.snapToPixel?~~(t.y+1e-4):t.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(e.x+1e-4):e.x,this._ex.snapToPixel?~~(e.y+1e-4):e.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(t,e={color:eb.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=e.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(t.x+1e-4):t.x,this._ex.snapToPixel?~~(t.y+1e-4):t.y,e.size,0,2*Math.PI),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(t,e){this._debugText.write(this._ex,t,e)}}class id{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(t){this.__ctx.imageSmoothingEnabled=t}constructor(t){this.useDrawSorting=!1,this.z=0,this.backgroundColor=eb.ExcaliburBlue,this._state=new eL,this.snapToPixel=!1,this.debug=new il(this);let{canvasElement:e,enableTransparency:i,snapToPixel:s,smoothing:r,backgroundColor:n}=t;this.__ctx=e.getContext("2d",{alpha:null==i||i}),this.backgroundColor=null!=n?n:this.backgroundColor,this.snapToPixel=null!=s?s:this.snapToPixel,this.smoothing=null!=r?r:this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(t){}drawImage(t,e,i,s,r,n,o,a,h){if(0===s||0===r||0===a||0===h||0===t.width||0===t.height)return;this.__ctx.globalAlpha=this.opacity;let l=[t,e,i,s,r,n,o,a,h].filter(t=>void 0!==t).map(t=>"number"==typeof t&&this.snapToPixel?~~t:t);this.__ctx.drawImage.apply(this.__ctx,l),e2.DrawCallCount++,e2.DrawnImagesCount=1}drawLine(t,e,i,s=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=i.toString(),this.__ctx.moveTo(this.snapToPixel?~~(t.x+1e-4):t.x,this.snapToPixel?~~(t.y+1e-4):t.y),this.__ctx.lineTo(this.snapToPixel?~~(e.x+1e-4):e.x,this.snapToPixel?~~(e.y+1e-4):e.y),this.__ctx.lineWidth=s,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(t,e,i,s){this.__ctx.save(),this.__ctx.fillStyle=s.toString(),this.__ctx.fillRect(this.snapToPixel?~~(t.x+1e-4):t.x,this.snapToPixel?~~(t.y+1e-4):t.y,this.snapToPixel?~~(e+1e-4):e,this.snapToPixel?~~(i+1e-4):i),this.__ctx.restore()}drawCircle(t,e,i,s,r){this.__ctx.save(),this.__ctx.beginPath(),s&&(this.__ctx.strokeStyle=s.toString()),r&&(this.__ctx.lineWidth=r),this.__ctx.fillStyle=i.toString(),this.__ctx.arc(this.snapToPixel?~~(t.x+1e-4):t.x,this.snapToPixel?~~(t.y+1e-4):t.y,e,0,2*Math.PI),this.__ctx.fill(),s&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(t,e){this.__ctx.translate(this.snapToPixel?~~(t+1e-4):t,this.snapToPixel?~~(e+1e-4):e)}rotate(t){this.__ctx.rotate(t)}scale(t,e){this.__ctx.scale(t,e)}getTransform(){throw Error("Not implemented")}multiply(t){this.__ctx.setTransform(this.__ctx.getTransform().multiply(t.toDOMMatrix()))}addPostProcessor(t){}removePostProcessor(t){}clearPostProcessors(){}updatePostProcessors(t){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),e2.clear()}flush(){}}(u=X||(X={})).Fixed="Fixed",u.FitContainerAndFill="FitContainerAndFill",u.FitScreenAndFill="FitScreenAndFill",u.FitContainerAndZoom="FitContainerAndZoom",u.FitScreenAndZoom="FitScreenAndZoom",u.FitScreen="FitScreen",u.FillScreen="FillScreen",u.FitContainer="FitContainer",u.FillContainer="FillContainer";class ic{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}let iu={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class ip{constructor(t){var e,i,s;this.events=new tT,this._antialiasing=!0,this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullScreen=!1,this._isDisposed=!1,this._logger=es.getInstance(),this._fullscreenChangeHandler=()=>{this._isFullScreen=!this._isFullScreen,this._logger.debug("Fullscreen Change",this._isFullScreen),this.events.emit("fullscreen",{fullscreen:this.isFullScreen})},this._pixelRatioChangeHandler=()=>{this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio})},this._resizeHandler=()=>{let t=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(t),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._alreadyWarned=!1,this._contentArea=new eA,this.viewport=t.viewport,this.resolution=null!==(e=t.resolution)&&void 0!==e?e:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=null!==(i=t.displayMode)&&void 0!==i?i:X.Fixed,this._canvas=t.canvas,this.graphicsContext=t.context,this._antialiasing=null!==(s=t.antialiasing)&&void 0!==s?s:this._antialiasing,this._browser=t.browser,this._pixelRatioOverride=t.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this._browser.window.off("resize",this._resizeHandler),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler))}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get isHiDpi(){return 1!==this.pixelRatio}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case X.FillContainer:case X.FitContainer:case X.FitContainerAndFill:case X.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(t){this._resolution=t}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(t){this._viewport=t}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(t){this._camera=t}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop()}applyResolutionAndViewport(){this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this.graphicsContext instanceof ih&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&!this._alreadyWarned&&(this._alreadyWarned=!0,this._logger.warn(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)),this._antialiasing?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",""===this._canvas.style.imageRendering&&(this._canvas.style.imageRendering="crisp-edges")),this._canvas.style.width=this.viewport.width+"px",this._canvas.style.height=this.viewport.height+"px",this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof id&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio)}get antialiasing(){return this._antialiasing}set antialiasing(t){this._antialiasing=t,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullScreen}goFullScreen(t){if(t){let e=document.getElementById(t);if(e)return e.getAttribute("ex-fullscreen-listener")||(e.setAttribute("ex-fullscreen-listener","true"),e.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),e.requestFullscreen()}return this._canvas.requestFullscreen()}exitFullScreen(){return document.exitFullscreen()}pageToScreenCoordinates(t){let e=t.x,i=t.y;if(this._isFullScreen||(e-=eS(this._canvas).x,i-=eS(this._canvas).y),this._isFullScreen){if(window.innerWidth/this.aspectRatio<window.innerHeight){let t=window.innerWidth/this.aspectRatio;i=(i-(window.innerHeight-t)/2)/t*this.viewport.height,e=e/window.innerWidth*this.viewport.width}else{let t=window.innerHeight*this.aspectRatio;e=(e-(window.innerWidth-t)/2)/t*this.viewport.width,i=i/window.innerHeight*this.viewport.height}}return new ey(e=e/this.viewport.width*this.resolution.width,i=i/this.viewport.height*this.resolution.height)}screenToPageCoordinates(t){let e=t.x,i=t.y;if(e=e/this.resolution.width*this.viewport.width,i=i/this.resolution.height*this.viewport.height,this._isFullScreen){if(window.innerWidth/this.aspectRatio<window.innerHeight){let t=window.innerWidth/this.aspectRatio,s=(window.innerHeight-t)/2;i=i/this.viewport.height*t+s,e=e/this.viewport.width*window.innerWidth}else{let t=window.innerHeight*this.aspectRatio,s=(window.innerWidth-t)/2;e=e/this.viewport.width*t+s,i=i/this.viewport.height*window.innerHeight}}return this._isFullScreen||(e+=eS(this._canvas).x,i+=eS(this._canvas).y),new ey(e,i)}screenToWorldCoordinates(t){return this._camera?this._camera.inverse.multiply(t):t.sub(ew(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(t){return this._camera?this._camera.transform.multiply(t):t.add(ew(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(t){let e=this.pageToScreenCoordinates(t);return this.screenToWorldCoordinates(e)}worldToPageCoordinates(t){let e=this.worldToScreenCoordinates(t);return this.screenToPageCoordinates(e)}getWorldBounds(){return eA.fromDimension(this.resolution.width,this.resolution.height,ey.Half).scale(ew(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.pos)}getScreenBounds(){return eA.fromDimension(this.resolution.width,this.resolution.height,ey.Zero,ey.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return ew(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";let t=this.aspectRatio,e=0,i=0;window.innerWidth/t<window.innerHeight?(e=window.innerWidth,i=window.innerWidth/t):(e=window.innerHeight*t,i=window.innerHeight),this.viewport={width:e,height:i},this._contentArea=eA.fromDimension(this.resolution.width,this.resolution.height,ey.Zero)}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";let t=window.innerWidth,e=window.innerHeight;this._computeFitAndFill(t,e)}_computeFitContainerAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";let t=this.canvas.parentElement,e=t.clientWidth,i=t.clientHeight;this._computeFitAndFill(e,i)}_computeFitAndFill(t,e){if(this.viewport={width:t,height:e},t/e<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:t*this._contentResolution.width/t,height:t*this._contentResolution.width/t*e/t};let i=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new eA({top:i,left:0,right:this._contentResolution.width,bottom:this.resolution.height-i})}else{this.resolution={width:e*this._contentResolution.height/e*t/e,height:e*this._contentResolution.height/e};let i=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new eA({top:0,left:i,right:this.resolution.width-i,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";let t=window.innerWidth,e=window.innerHeight;this._computeFitAndZoom(t,e)}_computeFitContainerAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";let t=this.canvas.parentElement;t.style.position="relative",t.style.overflow="hidden";let e=t.clientWidth,i=t.clientHeight;this._computeFitAndZoom(e,i)}_computeFitAndZoom(t,e){let i=this.aspectRatio,s=0,r=0;t/i<e?(s=t,r=t/i):(s=e*i,r=e);let n=Math.max(t/s,e/r),o=s*n,a=r*n;o>t?this.canvas.style.left=-(o-t)/2+"px":this.canvas.style.left="",a>e?this.canvas.style.top=-(a-e)/2+"px":this.canvas.style.top="",this.viewport={width:o,height:a};let h=eA.fromDimension(this.viewport.width,this.viewport.height,ey.Zero);if(this.viewport.width>t){let e=(this.viewport.width-t)/this.viewport.width*this.resolution.width;h.top=0,h.left=e/2,h.right=this.resolution.width-e/2,h.bottom=this.resolution.height}if(this.viewport.height>e){let t=(this.viewport.height-e)/this.viewport.height*this.resolution.height;h.top=t/2,h.left=0,h.bottom=this.resolution.height-t/2,h.right=this.resolution.width}this._contentArea=h}_computeFitContainer(){let t=this.aspectRatio,e=0,i=0,s=this.canvas.parentElement;s.clientWidth/t<s.clientHeight?(e=s.clientWidth,i=s.clientWidth/t):(e=s.clientHeight*t,i=s.clientHeight),this.viewport={width:e,height:i},this._contentArea=eA.fromDimension(this.resolution.width,this.resolution.height,ey.Zero)}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(t){this.displayMode===X.FillContainer&&(this.resolution={width:t.clientWidth,height:t.clientHeight},this.viewport=this.resolution),this.displayMode===X.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:t.innerWidth,height:t.innerHeight},this.viewport=this.resolution),this._contentArea=eA.fromDimension(this.resolution.width,this.resolution.height,ey.Zero),this.displayMode===X.FitScreen&&this._computeFit(),this.displayMode===X.FitContainer&&this._computeFitContainer(),this.displayMode===X.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===X.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===X.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===X.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class i_{static create(){return!this._INSTANCE&&(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}i_._INSTANCE=null;class ig{static unlock(){return new Promise((t,e)=>{if(ig._UNLOCKED||!i_.create())return t(!0);let i=setTimeout(()=>{es.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),t(!1)},200),s=i_.create();s.resume().then(()=>{let e=s.createBuffer(1,1,22050),r=s.createBufferSource(),n=!1;r.buffer=e,r.connect(s.destination),r.onended=()=>n=!0,r.start(0),setTimeout(()=>{r.playbackState?(r.playbackState===r.PLAYING_STATE||r.playbackState===r.FINISHED_STATE)&&(ig._UNLOCKED=!0):(s.currentTime>0||n)&&(ig._UNLOCKED=!0)},0),clearTimeout(i),t(!0)},()=>{e()})})}static isUnlocked(){return this._UNLOCKED}}function im(t,e=eb.Red,i,s,r,n,o=1,a="butt"){t.save(),t.beginPath(),t.lineWidth=o,t.lineCap=a,t.strokeStyle=e.toString(),t.moveTo(i,s),t.lineTo(r,n),t.closePath(),t.stroke(),t.restore()}function iv(t,e=eb.Red,i){t.beginPath(),t.strokeStyle=e.toString(),t.arc(i.x,i.y,5,0,2*Math.PI),t.closePath(),t.stroke()}function ix(t,e,i,s,r=1){let n=e?e.toString():"blue",o=s.scale(r);t.beginPath(),t.strokeStyle=n,t.moveTo(i.x,i.y),t.lineTo(i.x+o.x,i.y+o.y),t.closePath(),t.stroke()}function iy(t,e,i,s,r,n=5,o=eb.White,a=null){let h;if("number"==typeof n)h={tl:n,tr:n,br:n,bl:n};else{let t={tl:0,tr:0,br:0,bl:0};for(let e in t)t.hasOwnProperty(e)&&(h[e]=n[e]||t[e])}t.beginPath(),t.moveTo(e+h.tl,i),t.lineTo(e+s-h.tr,i),t.quadraticCurveTo(e+s,i,e+s,i+h.tr),t.lineTo(e+s,i+r-h.br),t.quadraticCurveTo(e+s,i+r,e+s-h.br,i+r),t.lineTo(e+h.bl,i+r),t.quadraticCurveTo(e,i+r,e,i+r-h.bl),t.lineTo(e,i+h.tl),t.quadraticCurveTo(e,i,e+h.tl,i),t.closePath(),a&&(t.fillStyle=a.toString(),t.fill()),o&&(t.strokeStyle=o.toString(),t.stroke())}function iw(t,e,i,s,r=eb.White,n=null){t.beginPath(),t.arc(e,i,s,0,2*Math.PI),t.closePath(),n&&(t.fillStyle=n.toString(),t.fill()),r&&(t.strokeStyle=r.toString(),t.stroke())}ig._UNLOCKED=!1;var ib=i(1388);class iC extends eH{constructor(t){var e,i,s,r,n,o,a,h,l,d;super(eB(t,["width","height"])),this.filtering=null,this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=eO(eb.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,t&&(this.quality=null!==(e=t.quality)&&void 0!==e?e:this.quality,this.color=null!==(i=t.color)&&void 0!==i?i:eb.Black,this.strokeColor=null==t?void 0:t.strokeColor,this.smoothing=null!==(s=t.smoothing)&&void 0!==s?s:this.smoothing,this.lineWidth=null!==(r=t.lineWidth)&&void 0!==r?r:this.lineWidth,this.lineDash=null!==(n=t.lineDash)&&void 0!==n?n:this.lineDash,this.lineCap=null!==(o=t.lineCap)&&void 0!==o?o:this.lineCap,this.padding=null!==(a=t.padding)&&void 0!==a?a:this.padding,this.filtering=null!==(h=t.filtering)&&void 0!==h?h:this.filtering),this._bitmap=document.createElement("canvas");let c=null!==(l=null==t?void 0:t.width)&&void 0!==l?l:this._bitmap.width,u=null!==(d=null==t?void 0:t.height)&&void 0!==d?d:this._bitmap.height;this.width=c,this.height=u;let p=this._bitmap.getContext("2d");if(p)this._ctx=p;else throw Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():null,strokeColor:this.strokeColor?this.strokeColor.clone():null,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(t){t/=Math.abs(this.scale.x),this._bitmap.width=t,this._originalWidth=t,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(t){t/=Math.abs(this.scale.y),this._bitmap.height=t,this._originalHeight=t,this.flagDirty()}_getTotalWidth(){var t;return((null!==(t=this._originalWidth)&&void 0!==t?t:this._bitmap.width)+2*this.padding)*1}_getTotalHeight(){var t;return((null!==(t=this._originalHeight)&&void 0!==t?t:this._bitmap.height)+2*this.padding)*1}get localBounds(){return eA.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,ey.Zero)}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this.flagDirty()}get color(){return this._color}set color(t){this.flagDirty(),this._color=eO(t,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(t){this.flagDirty(),this._strokeColor=eO(t,()=>this.flagDirty())}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(t){this._lineDash=t,this.flagDirty()}get padding(){return this._padding}set padding(t){this._padding=t,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(t){var e,i,s;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),t.scale(this.quality,this.quality),t.translate(this.padding,this.padding),t.imageSmoothingEnabled=this.smoothing,t.lineWidth=this.lineWidth,t.setLineDash(null!==(e=this.lineDash)&&void 0!==e?e:t.getLineDash()),t.lineCap=this.lineCap,t.strokeStyle=null===(i=this.strokeColor)||void 0===i?void 0:i.toString(),t.fillStyle=null===(s=this.color)||void 0===s?void 0:s.toString()}_drawImage(t,e,i){this._dirty&&this.rasterize(),t.scale(1/this.quality,1/this.quality),t.drawImage(this._bitmap,e,i)}}class iA extends iC{get ctx(){return this._ctx}constructor(t){super(t),this._options=t}clone(){return new iA({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){var e,i;(null===(e=this._options)||void 0===e?void 0:e.draw)&&(null===(i=this._options)||void 0===i||i.draw(t)),this._options.cache||this.flagDirty()}}class iT{}iT.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class iS{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(t){this._currentState=t}static create(t,e){let i=new iS;for(let s in i.data=e,t.states)i.states.set(s,{name:s,...t.states[s]});for(let t of i.states.values())for(let e of t.transitions)if("*"!==e&&!i.states.has(e))throw Error(`Invalid state machine, state [${t.name}] has a transition to another state that doesn't exist [${e}]`);return i.currentState=i.startState=i.states.get(t.start),i}in(t){return this.currentState.name===t}go(t,e){var i,s;if(this.currentState.transitions.includes(t)||this.currentState.transitions.includes("*")){let r=this.states.get(t);return(!this.currentState.onExit||!1!==(null===(i=this.currentState)||void 0===i?void 0:i.onExit({to:r.name,data:this.data})))&&(null==r||!r.onEnter||!1!==(null==r?void 0:r.onEnter({from:this.currentState.name,eventData:e,data:this.data})))&&(this.currentState=r,(null===(s=this.currentState)||void 0===s?void 0:s.onState)&&this.currentState.onState(),!0)}return!1}update(t){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,t)}save(t){localStorage.setItem(t,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(t){let e=JSON.parse(localStorage.getItem(t));this.currentState=this.states.get(e.currentState),this.data=e.data}}class iE{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(t){this._loop=t,this._instance&&(this._instance.loop=t,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(t){t=ep(t,0,1),this._volume=t,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(t,this._audioContext.currentTime,.1):this._volumeNode.gain.value=t}get volume(){return this._volume}get duration(){var t;return null!==(t=this._duration)&&void 0!==t?t:this.getTotalPlaybackDuration()}set duration(t){this._duration=t}constructor(t){this._src=t,this._audioContext=i_.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new eT,this._stateMachine=iS.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:t})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,t.pausedAt*this._playbackRate):this._instance.start(0,t.pausedAt*this._playbackRate,this.duration),t.startedAt=this._audioContext.currentTime-t.pausedAt,t.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:t})=>{"STOPPED"===t&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:t,data:e})=>{e.pausedAt=(null!=t?t:0)/this._playbackRate,e.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:t})=>{t.pausedAt=0,t.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:t})=>{t.pausedAt=this._audioContext.currentTime-t.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(t=()=>{}){return this._playStarted=t,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(t){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",t)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){let{pausedAt:t,startedAt:e}=this._stateMachine.data;return t?t*this._playbackRate:e?(this._audioContext.currentTime-e)*this._playbackRate:0}set playbackRate(t){this._instance.playbackRate.value=this._playbackRate=t}get playbackRate(){return this._instance.playbackRate.value}}class iP extends tS{set bubbles(t){}get bubbles(){return!1}get _path(){return null}set _path(t){}constructor(t,e="MediaEvent"){super(),this.target=t,this._name=e}stopPropagation(){}action(){}propagate(){}layPath(t){}}class iI extends iP{constructor(t,e){super(t,"NativeSoundEvent"),this.track=e}}class iD extends iP{constructor(t,e){super(t,"NativeSoundProcessedEvent"),this._processedData=e,this.data=this._processedData}}let iR={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class iB{set loop(t){for(let e of(this._loop=t,this._tracks))e.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(t){for(let e of(this._volume=t,this._tracks))e.volume=this._volume;this.events.emit("volumechange",new iI(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(t){this._duration=t}get instances(){return this._tracks}get path(){return this._resource.path}set path(t){this._resource.path=t}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}constructor(...t){for(let e of(this.events=new tT,this.logger=es.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=i_.create(),this._resource=new eU("",iT.type.arraybuffer),t))if(function(t){try{let e=new Audio,i=t.match(/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/)[1];if(e.canPlayType("audio/"+i))return!0;return!1}catch(t){return es.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",t),!1}}(e)){this.path=e;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",t.join(", ")),this.logger.warn("Attempting to use",t[0]),this.path=t[0])}isLoaded(){return!!this.data}async load(){var t,e;if(this.data)return this.data;let i=await this._resource.load(),s=await this.decodeAudio(i.slice(0));return this._duration=null!==(e=null!==(t=this._duration)&&void 0!==t?t:null==s?void 0:s.duration)&&void 0!==e?e:void 0,this.events.emit("processed",new iD(this,s)),this.data=s}async decodeAudio(t){try{return await this._audioContext.decodeAudioData(t.slice(0))}catch(t){return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(t){t&&(this._engine=t,this._engine.on("hidden",()=>{t.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{t.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(t=>t.isPlaying())}isPaused(){return this._tracks.some(t=>t.isPaused())}isStopped(){return this._tracks.some(t=>t.isStopped())}play(t){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=t||this.volume,this.isPaused())?this._resumePlayback():this._startPlayback():(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(let t of this._tracks)t.pause();this.events.emit("pause",new iI(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(let t of this._tracks)t.stop();this.events.emit("stop",new iI(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._tracks.forEach(t=>{t.playbackRate=this._playbackRate})}seek(t,e=0){0===this._tracks.length&&this._getTrackInstance(this.data),this._tracks[e].seek(t)}getTotalPlaybackDuration(){return this.data.duration}getPlaybackPosition(t=0){return this._tracks.length?this._tracks[t].getPlaybackPosition():0}getTrackId(t){return this._tracks.indexOf(t)}async _resumePlayback(){if(this.isPaused){let t=[];for(let e of this._tracks)t.push(e.play().then(()=>(this.events.emit("playbackend",new iI(this,e)),this._tracks.splice(this.getTrackId(e),1),!0)));this.events.emit("resume",new iI(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(t)}return!0}async _startPlayback(){let t=this._getTrackInstance(this.data),e=await t.play(()=>{this.events.emit("playbackstart",new iI(this,t)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new iI(this,t));let i=this.getTrackId(t);return -1!==i&&this._tracks.splice(i,1),e}_getTrackInstance(t){let e=new iE(t);return e.loop=this.loop,e.volume=this.volume,e.duration=this.duration,e.playbackRate=this._playbackRate,this._tracks.push(e),e}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}}let iF={};class ik{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.src=this.logo),this._imageElement}_getScreenParent(){return this._engine?this._engine.screen.canvas.parentElement:document.body}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){let t=document.getElementById("excalibur-play-root");return t&&(this._playButtonRootElement=t),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",this._getScreenParent().appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(t){this.events=new tT,this.canvas=new iA({filtering:q.Blended,smoothing:!0,cache:!0,draw:this.draw.bind(this)}),this._resourceList=[],this._index=0,this._playButtonShown=!1,this._resourceCount=0,this._numLoaded=0,this._progressCounts={},this._totalCounts={},this.logo="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=",this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=eb.White,this.backgroundColor="#176BAA",this.suppressPlayButton=!1,this._playButtonStyles=ib.Z.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let t=document.getElementById("excalibur-play");return t||(t=document.createElement("button")),t.id="excalibur-play",t.textContent=this.playButtonText,t.style.display="none",t},this._loaderResizeHandler=t=>{this._engine.screen.resolution=this._engine.screen.viewport,this._engine.screen.applyResolutionAndViewport(),this.canvas.width=t.viewport.width,this.canvas.height=t.viewport.height,this.canvas.flagDirty()},this._loadingFuture=new eT,t&&this.addResources(t)}wireEngine(t){this._engine||(this._engine=t,this.canvas.width=this._engine.canvas.width,this.canvas.height=this._engine.canvas.height)}addResource(t){let e=this._index++;this._resourceList.push(t),this._progressCounts[e]=0,this._totalCounts[e]=1,this._resourceCount++}addResources(t){let e=0,i=t.length;for(;e<i;e++)this.addResource(t[e])}isLoaded(){return this._numLoaded===this._resourceCount}async showPlayButton(){var t,e;if(this.suppressPlayButton)this.hidePlayButton(),await eR(500,null===(t=this._engine)||void 0===t?void 0:t.clock);else{let t=()=>{this._positionPlayButton()};(null===(e=this._engine)||void 0===e?void 0:e.browser)&&this._engine.browser.window.on("resize",t),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",t=>{"Enter"===t.key&&this._playButton.click()}),this._positionPlayButton();let i=new Promise(e=>{let i=i=>{var s;i.stopPropagation(),this.hidePlayButton(),(null===(s=this._engine)||void 0===s?void 0:s.browser)&&this._engine.browser.window.off("resize",t),e()};this._playButton.addEventListener("click",i),this._playButton.addEventListener("touchend",i),this._playButton.addEventListener("pointerup",i)});return await i}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}update(t,e){}areResourcesLoaded(){return this._loadingFuture.promise}async load(){var t,e;for(let e of(this._engine.screen.events.on("resize",this._loaderResizeHandler),await (null===(t=this._image)||void 0===t?void 0:t.decode()),this.canvas.flagDirty(),await Promise.all(this._resourceList.map(async t=>{await t.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty()})})),this._resourceList))e instanceof iB&&e.wireEngine(this._engine);return this._loadingFuture.resolve(),await eR(200,null===(e=this._engine)||void 0===e?void 0:e.clock),this.canvas.flagDirty(),await this.showPlayButton(),await ig.unlock(),this._engine.screen.events.off("resize",this._loaderResizeHandler),this.data=this._resourceList}markResourceComplete(){this._numLoaded++}get progress(){return this._resourceCount>0?ep(this._numLoaded,0,this._resourceCount)/this._resourceCount:1}_positionPlayButton(){if(this._engine){let t=this._engine.screen.viewport.height,e=this._engine.screen.viewport.width;if(this._playButtonRootElement){let i=this._engine.canvas.offsetLeft,s=this._engine.canvas.offsetTop,r=this._playButton.clientWidth,n=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${i+e/2-r/2}px`,this._playButtonRootElement.style.top=`${s+t/2-n/2+100}px`)}}}draw(t){let e=this._engine.canvasHeight/this._engine.pixelRatio,i=this._engine.canvasWidth/this._engine.pixelRatio;this._positionPlayButton(),t.fillStyle=this.backgroundColor,t.fillRect(0,0,i,e);let s=e/2,r=Math.min(this.logoWidth,.75*i),n=i/2-r/2;this.logoPosition&&(n=this.logoPosition.x,s=this.logoPosition.y);let o=Math.floor(this.logoHeight/this.logoWidth*r),a=this._engine.getAntialiasing();if(this._engine.setAntialiasing(!0),this.logoPosition?t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,n,s,r,o):t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,n,s-o-20,r,o),!this.suppressPlayButton&&this._playButtonShown){this._engine.setAntialiasing(a);return}let h=n,l=s;this.loadingBarPosition&&(h=this.loadingBarPosition.x,l=this.loadingBarPosition.y),t.lineWidth=2,iy(t,h,l,r,20,10,this.loadingBarColor);let d=r*this.progress-10;iy(t,h+5,l+5,d>10?d:10,10,5,null,this.loadingBarColor),this._engine.setAntialiasing(a)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}}let iM={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class iL{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){let t=document.createElement("canvas");return!!(t.getContext&&t.getContext("2d"))},arrayBufferSupport:function(){let t=new XMLHttpRequest;t.open("GET","/");try{t.responseType="arraybuffer"}catch(t){return!1}return"arraybuffer"===t.responseType},dataUrlSupport:function(){return 0===document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){let t=document.createElement("a").style;return t.cssText="background-color:rgba(150,255,150,.5)",(""+t.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){let t=document.createElement("canvas");return!!(t.getContext&&t.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return null===this._features&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let t="%cSUPPORTED BROWSER FEATURES\n==========================%c\n",e=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],i=this.getBrowserFeatures();for(let s of Object.keys(iM))i[s]?(t+="(%c✓%c)",e.push("font-weight: bold; color: green")):(t+="(%c✗%c)",e.push("font-weight: bold; color: red")),e.push("font-weight: normal; color: inherit"),t+=" "+iM[s]+"\n";e.unshift(t),console.log.apply(console,e)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let t=!1;for(let e in this._criticalTests)this._criticalTests[e].call(this)||(this.failedTests.push(e),es.getInstance().error("Critical browser feature missing, Excalibur requires:",e),t=!0);if(t)return!1;for(let t in this._warningTest)this._warningTest[t]()||es.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",t);return!0}}(p=Z||(Z={})).PreventCollision="PreventCollision",p.Passive="Passive",p.Active="Active",p.Fixed="Fixed";let iz=5,iU={},iO=()=>{for(let t in iU)iU[t]=0},iN=(t,e)=>{let i=tC.isEnabled("suppress-obsolete-message");iU[t]<iz&&!i&&(es.getInstance().warn(t),console.trace&&e.showStackTrace&&console.trace()),iU[t]++};function iH(t){return t={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...t},function(e,i,s){if(s&&!("function"==typeof s.value||"function"==typeof s.get||"function"==typeof s.set))throw SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");let r=`${e.name||""}${e.name&&i?".":""}${i||""}`,n=`${r} is marked obsolete: ${t.message}`+(t.alternateMethod?` Use ${t.alternateMethod} instead`:"");iU[n]||(iU[n]=0);let o=s?{...s}:e;return s?(s&&s.value?o.value=function(){return iN(n,t),s.value.apply(this,arguments)}:(s&&s.get&&(o.get=function(){return iN(n,t),s.get.apply(this,arguments)}),s&&s.set&&(o.set=function(){return iN(n,t),s.set.apply(this,arguments)})),o):class extends o{constructor(...e){iN(n,t),super(...e)}}}}(_=K||(K={})).Arcade="arcade",_.Realistic="realistic",(g=Y||(Y={}))[g.DynamicAABBTree=0]="DynamicAABBTree",(m=j||(j={}))[m.Euler=0]="Euler";class iW{static get gravity(){return iW.acc}static set gravity(t){iW.acc=t}static useArcadePhysics(){iW.collisionResolutionStrategy=K.Arcade}static useRealisticPhysics(){iW.collisionResolutionStrategy=K.Realistic}static get dynamicTreeVelocityMultiplyer(){return iW.dynamicTreeVelocityMultiplier}static set dynamicTreeVelocityMultiplyer(t){iW.dynamicTreeVelocityMultiplier=t}}iW.acc=new ey(0,0),iW.enabled=!0,iW.broadphaseStrategy=Y.DynamicAABBTree,iW.collisionResolutionStrategy=K.Arcade,iW.defaultMass=10,iW.integrator=j.Euler,iW.dynamicTreeVelocityMultiplier=2,iW.boundsPadding=5,iW.positionIterations=3,iW.velocityIterations=8,iW.slop=1,iW.steeringFactor=.2,iW.warmStart=!0,iW.bodiesCanSleepByDefault=!1,iW.surfaceEpsilon=.1,iW.sleepEpsilon=.07,iW.wakeThreshold=3*iW.sleepEpsilon,iW.sleepBias=.9,iW.checkForFastBodies=!0,iW.disableMinimumSpeedForFastBody=!1,function(t,e,i,s){var r,n=arguments.length,o=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,s);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(n<3?r(o):n>3?r(e,i,o):r(e,i))||o);n>3&&o&&Object.defineProperty(e,i,o)}([iH({message:"Alias for incorrect spelling used in older versions, will be removed in v0.25.0",alternateMethod:"dynamicTreeVelocityMultiplier"})],iW,"dynamicTreeVelocityMultiplyer",null),(f=$||($={})).World="world",f.Screen="screen";class iG extends ey{constructor(t){super(0,0),this._getX=t.getX,this._getY=t.getY,this._setX=t.setX,this._setY=t.setY}get x(){return this._x=this._getX()}set x(t){this._setX(t),this._x=t}get y(){return this._y=this._getY()}set y(t){this._setY(t),this._y=t}}class iV extends ey{constructor(t,e){super(t.x,t.y),this.original=t,this.change=e}get x(){return this._x=this.original.x}set x(t){this.change(t,this._y),this._x=this.original.x=t}get y(){return this._y=this.original.y}set y(t){this.change(this._x,t),this._y=this.original.y=t}}class iq{constructor(){this._parent=null,this._children=[],this._pos=ew(0,0),this._rotation=0,this._scale=ew(1,1),this._isDirty=!1,this._isInverseDirty=!1,this._matrix=ek.identity(),this._inverse=ek.identity()}get parent(){return this._parent}set parent(t){if(this._parent){let t=this._parent._children.indexOf(this);t>-1&&this._parent._children.splice(t,1)}this._parent=t,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(t){t.equals(this._pos)||(this._pos.x=t.x,this._pos.y=t.y,this.flagDirty())}get pos(){return new iV(this._pos,(t,e)=>{(t!==this._pos.x||e!==this._pos.y)&&this.flagDirty()})}set globalPos(t){let e=t.clone();this.parent&&(e=this.parent.inverse.multiply(t)),e.equals(this._pos)||(this._pos=e,this.flagDirty())}get globalPos(){return new iG({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:t=>{if(this.parent){let{x:e}=this.parent.inverse.multiply(ew(t,this.pos.y));this.pos.x=e}else this.pos.x=t;t!==this.matrix.data[4]&&this.flagDirty()},setY:t=>{if(this.parent){let{y:e}=this.parent.inverse.multiply(ew(this.pos.x,t));this.pos.y=e}else this.pos.y=t;t!==this.matrix.data[5]&&this.flagDirty()}})}set rotation(t){let e=e_(t);e!==this._rotation&&this.flagDirty(),this._rotation=e}get rotation(){return this._rotation}set globalRotation(t){let e=0;this.parent&&(e=this.parent.globalRotation);let i=e_(t+e);i!==this._rotation&&this.flagDirty(),this._rotation=i}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(t){t.equals(this._scale)||(this._scale.x=t.x,this._scale.y=t.y,this.flagDirty())}get scale(){return new iV(this._scale,(t,e)=>{(t!==this._scale.x||e!==this._scale.y)&&this.flagDirty()})}set globalScale(t){let e=ew(1,1);this.parent&&(e=this.parent.globalScale),this.scale=t.scale(ew(1/e.x,1/e.y))}get globalScale(){return new iG({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:t=>{if(this.parent){let e=this.parent.globalScale.x;this.scale.x=t/e}else this.scale.x=t},setY:t=>{if(this.parent){let e=this.parent.globalScale.y;this.scale.y=t/e}else this.scale.y=t}})}get matrix(){return this._isDirty&&(null===this.parent?this._matrix=this._calculateMatrix():this._matrix=this.parent.matrix.multiply(this._calculateMatrix()),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this._inverse=this.matrix.inverse(),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return ek.identity().translate(this.pos.x,this.pos.y).rotate(this.rotation).scale(this.scale.x,this.scale.y)}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let t=0;t<this._children.length;t++)this._children[t].flagDirty()}apply(t){return this.matrix.multiply(t)}applyInverse(t){return this.inverse.multiply(t)}setTransform(t,e,i){this._pos.x=t.x,this._pos.y=t.y,this._rotation=e_(e),this._scale.x=i.x,this._scale.y=i.y,this.flagDirty()}clone(t){let e=null!=t?t:new iq;return this._pos.clone(e._pos),e._rotation=this._rotation,this._scale.clone(e._scale),e.flagDirty(),e}}class iX{constructor(){this.owner=null}clone(){let t=new this.constructor;for(let e in this)if(this.hasOwnProperty(e)){let i=this[e];(null==i?void 0:i.clone)&&"owner"!==e&&"clone"!==e?t[e]=i.clone():t[e]=i}return t}}class iZ extends iX{constructor(t,e){super(),this.type=t,this.value=e}}class iK{constructor(){this.observers=[],this.subscriptions=[]}register(t){this.observers.push(t)}subscribe(t){this.subscriptions.push(t)}unregister(t){let e=this.observers.indexOf(t);-1!==e&&this.observers.splice(e,1)}unsubscribe(t){let e=this.subscriptions.indexOf(t);-1!==e&&this.subscriptions.splice(e,1)}notifyAll(t){let e=this.observers.length;for(let i=0;i<e;i++)this.observers[i].notify(t);let i=this.subscriptions.length;for(let e=0;e<i;e++)this.subscriptions[e](t)}clear(){this.observers.length=0,this.subscriptions.length=0}}class iY extends iX{constructor(){super(...arguments),this.type="ex.transform",this._transform=new iq,this._addChildTransform=t=>{let e=t.get(iY);e&&(e._transform.parent=this._transform)},this.zIndexChanged$=new iK,this._z=0,this.coordPlane=$.World}get(){return this._transform}onAdd(t){for(let e of t.children)this._addChildTransform(e);t.childrenAdded$.subscribe(t=>this._addChildTransform(t)),t.childrenRemoved$.subscribe(t=>{let e=t.get(iY);e&&(e._transform.parent=null)})}onRemove(t){this._transform.parent=null}get z(){return this._z}set z(t){let e=this._z;this._z=t,e!==t&&this.zIndexChanged$.notifyAll(t)}get pos(){return this._transform.pos}set pos(t){this._transform.pos=t}get globalPos(){return this._transform.globalPos}set globalPos(t){this._transform.globalPos=t}get rotation(){return this._transform.rotation}set rotation(t){this._transform.rotation=t}get globalRotation(){return this._transform.globalRotation}set globalRotation(t){this._transform.globalRotation=t}get scale(){return this._transform.scale}set scale(t){this._transform.scale=t}get globalScale(){return this._transform.globalScale}set globalScale(t){this._transform.globalScale=t}applyInverse(t){return this._transform.applyInverse(t)}apply(t){return this._transform.apply(t)}clone(){let t=new iY;return t._transform=this._transform.clone(),t._z=this._z,t}}class ij extends iX{constructor(){super(...arguments),this.type="ex.motion",this.vel=ey.Zero,this.acc=ey.Zero,this.scaleFactor=ey.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class i${static create(t,e){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(t)){let i=this._GROUPS.get(t);if(i.mask===e)return i;throw Error(`Collision group ${t} already exists with a different mask!`)}let i=new iQ(t,this._CURRENT_BIT,void 0!==e?e:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(t,i),i}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(t){return this._GROUPS.get(t)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}i$._STARTING_BIT=1,i$._MAX_GROUPS=32,i$._CURRENT_GROUP=1,i$._CURRENT_BIT=i$._STARTING_BIT,i$._GROUPS=new Map;class iQ{constructor(t,e,i){this._name=t,this._category=e,this._mask=i}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(t){let e=this.category&t.mask,i=this.mask&t.category;return 0!==e&&0!==i}invert(){let t=i$.create("~("+this.name+")",0|~this.mask);return t._category=~this.category,t}static combine(t){let e=t.map(t=>t.name).join("+"),i=t.reduce((t,e)=>e.category|t,0);return i$.create(e,~i)}static collidesWith(t){let e=`collidesWith(${t.map(t=>t.name).join("+")})`,i=t.reduce((t,e)=>e.category|t,0);return i$.create(e,i)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}iQ.All=new iQ("Collide with all groups",-1,-1);class iJ{constructor(t,e){this.colliderA=t,this.colliderB=e,this.id=null,this.id=iJ.calculatePairHash(t.id,e.id)}static canCollide(t,e){var i,s;let r=null===(i=null==t?void 0:t.owner)||void 0===i?void 0:i.get(sh),n=null===(s=null==e?void 0:e.owner)||void 0===s?void 0:s.get(sh);return!(t.id===e.id||t.owner&&e.owner&&t.owner.id===e.owner.id||t.localBounds.hasZeroDimensions()||e.localBounds.hasZeroDimensions())&&!!r&&!!n&&!!r.group.canCollide(n.group)&&(r.collisionType!==Z.Fixed||n.collisionType!==Z.Fixed)&&n.collisionType!==Z.PreventCollision&&r.collisionType!==Z.PreventCollision&&!!r.active&&!!n.active}get canCollide(){let t=this.colliderA,e=this.colliderB;return iJ.canCollide(t,e)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(t){return t===this.colliderA||t===this.colliderB}static calculatePairHash(t,e){return t.value<e.value?`#${t.value}+${e.value}`:`#${e.value}+${t.value}`}}class i0{constructor(t,e){this.min=t,this.max=e}overlaps(t){return this.max>t.min&&t.max>this.min}getOverlap(t){return this.overlaps(t)?this.max>t.max?t.max-this.min:this.max-t.min:0}}class i1{constructor(t){this.parent=t,this.parent=t||null,this.data=null,this.bounds=new eA,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class i2{constructor(t=new eA(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this.worldBounds=t,this.root=null,this.nodes={}}_insert(t){if(null===this.root){this.root=t,this.root.parent=null;return}let e=t.bounds,i=this.root;for(;!i.isLeaf();){let t;let s=i.left,r=i.right,n=i.bounds.getPerimeter(),o=i.bounds.combine(e).getPerimeter(),a=2*o,h=2*(o-n),l=0,d=e.combine(s.bounds);s.isLeaf()?l=d.getPerimeter()+h:(t=s.bounds.getPerimeter(),l=d.getPerimeter()-t+h);let c=0,u=e.combine(r.bounds);if(r.isLeaf()?c=u.getPerimeter()+h:(t=r.bounds.getPerimeter(),c=u.getPerimeter()-t+h),a<l&&a<c)break;i=l<c?s:r}let s=i.parent,r=new i1(s);r.bounds=e.combine(i.bounds),r.height=i.height+1,null!==s?(s.left===i?s.left=r:s.right=r,r.left=i,r.right=t,i.parent=r,t.parent=r):(r.left=i,r.right=t,i.parent=r,t.parent=r,this.root=r);let n=t.parent;for(;n;){if(!(n=this._balance(n)).left)throw Error("Parent of current leaf cannot have a null left child"+n);if(!n.right)throw Error("Parent of current leaf cannot have a null right child"+n);n.height=1+Math.max(n.left.height,n.right.height),n.bounds=n.left.bounds.combine(n.right.bounds),n=n.parent}}_remove(t){let e;if(t===this.root){this.root=null;return}let i=t.parent,s=i.parent;if(e=i.left===t?i.right:i.left,s){s.left===i?s.left=e:s.right=e,e.parent=s;let t=s;for(;t;)(t=this._balance(t)).bounds=t.left.bounds.combine(t.right.bounds),t.height=1+Math.max(t.left.height,t.right.height),t=t.parent}else this.root=e,e.parent=null}trackCollider(t){let e=new i1;e.data=t,e.bounds=t.bounds,e.bounds.left-=2,e.bounds.top-=2,e.bounds.right+=2,e.bounds.bottom+=2,this.nodes[t.id.value]=e,this._insert(e)}updateCollider(t){var e;let i=this.nodes[t.id.value];if(!i)return!1;let s=t.bounds;if(!this.worldBounds.contains(s))return es.getInstance().warn("Collider with id "+t.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(t),!1;if(i.bounds.contains(s))return!1;if(this._remove(i),s.left-=iW.boundsPadding,s.top-=iW.boundsPadding,s.right+=iW.boundsPadding,s.bottom+=iW.boundsPadding,t.owner){let i=null===(e=t.owner)||void 0===e?void 0:e.get(sh);if(i){let t=32*i.vel.x/1e3*iW.dynamicTreeVelocityMultiplier,e=32*i.vel.y/1e3*iW.dynamicTreeVelocityMultiplier;t<0?s.left+=t:s.right+=t,e<0?s.top+=e:s.bottom+=e}}return i.bounds=s,this._insert(i),!0}untrackCollider(t){let e=this.nodes[t.id.value];e&&(this._remove(e),this.nodes[t.id.value]=null,delete this.nodes[t.id.value])}_balance(t){if(null===t)throw Error("Cannot balance at null node");if(t.isLeaf()||t.height<2)return t;let e=t.left,i=t.right,s=e.left,r=e.right,n=i.left,o=i.right,a=i.height-e.height;if(a>1)return i.left=t,i.parent=t.parent,t.parent=i,i.parent?i.parent.left===t?i.parent.left=i:i.parent.right=i:this.root=i,n.height>o.height?(i.right=n,t.right=o,o.parent=t,t.bounds=e.bounds.combine(o.bounds),i.bounds=t.bounds.combine(n.bounds),t.height=1+Math.max(e.height,o.height),i.height=1+Math.max(t.height,n.height)):(i.right=o,t.right=n,n.parent=t,t.bounds=e.bounds.combine(n.bounds),i.bounds=t.bounds.combine(o.bounds),t.height=1+Math.max(e.height,n.height),i.height=1+Math.max(t.height,o.height)),i;if(a<-1){if(e.left=t,e.parent=t.parent,t.parent=e,e.parent){if(e.parent.left===t)e.parent.left=e;else{if(e.parent.right!==t)throw"Error rotating Dynamic Tree";e.parent.right=e}}else this.root=e;return s.height>r.height?(e.right=s,t.left=r,r.parent=t,t.bounds=i.bounds.combine(r.bounds),e.bounds=t.bounds.combine(s.bounds),t.height=1+Math.max(i.height,r.height),e.height=1+Math.max(t.height,s.height)):(e.right=r,t.left=s,s.parent=t,t.bounds=i.bounds.combine(s.bounds),e.bounds=t.bounds.combine(r.bounds),t.height=1+Math.max(i.height,s.height),e.height=1+Math.max(t.height,r.height)),e}return t}getHeight(){return null===this.root?0:this.root.height}query(t,e){let i=t.bounds,s=r=>{if(r&&r.bounds.overlaps(i)){if(!r.isLeaf()||r.data===t)return s(r.left)||s(r.right);if(e.call(t,r.data))return!0}return!1};s(this.root)}rayCastQuery(t,e=1/0,i){let s=r=>{if(r&&r.bounds.rayCast(t,e)){if(!r.isLeaf())return s(r.left)||s(r.right);if(i.call(t,r.data))return!0}return!1};s(this.root)}getNodes(){let t=e=>e?[e].concat(t(e.left),t(e.right)):[];return t(this.root)}debug(t){let e=i=>{i&&(i.isLeaf()?i.bounds.draw(t,eb.Green):i.bounds.draw(t,eb.White),i.left&&e(i.left),i.right&&e(i.right))};e(this.root)}}class i5{constructor(t,e){this.pos=t,this.dir=e.normalize()}intersect(t){let e=t.begin.sub(this.pos);if(0===this.dir.cross(t.getSlope())&&0!==e.cross(this.dir))return -1;let i=this.dir.cross(t.getSlope());if(0===i)return -1;let s=e.cross(t.getSlope())/i;if(s>=0){let r=e.cross(this.dir)/i/t.getLength();if(r>=0&&r<=1)return s}return -1}intersectPoint(t){let e=this.intersect(t);return e<0?null:this.getPoint(e)}getPoint(t){return this.pos.add(this.dir.scale(t))}}class i4{constructor(){this._dynamicCollisionTree=new i2,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[]}getColliders(){return this._colliders}rayCast(t,e){var i,s,r;let n=[],o=null!==(i=null==e?void 0:e.maxDistance)&&void 0!==i?i:1/0,a=null==e?void 0:e.collisionGroup,h=a?a.category:null!==(s=null==e?void 0:e.collisionMask)&&void 0!==s?s:iQ.All.category,l=null!==(r=null==e?void 0:e.searchAllColliders)&&void 0!==r&&r;return this._dynamicCollisionTree.rayCastQuery(t,o,e=>{let i=e.owner.get(sh),s=(h&i.group.category)!=0;if((null==i?void 0:i.group)&&!s)return!1;let r=e.rayCast(t,o);return!!r&&(n.push({distance:r.sub(t.pos).distance(),point:r,collider:e,body:i}),!l)}),n}track(t){if(!t){es.getInstance().warn("Cannot track null collider");return}if(t instanceof i6)for(let e of t.getColliders())e.owner=t.owner,this._colliders.push(e),this._dynamicCollisionTree.trackCollider(e);else this._colliders.push(t),this._dynamicCollisionTree.trackCollider(t)}untrack(t){if(!t){es.getInstance().warn("Cannot untrack a null collider");return}if(t instanceof i6)for(let e of t.getColliders()){let t=this._colliders.indexOf(e);-1!==t&&this._colliders.splice(t,1),this._dynamicCollisionTree.untrackCollider(e)}else{let e=this._colliders.indexOf(t);-1!==e&&this._colliders.splice(e,1),this._dynamicCollisionTree.untrackCollider(t)}}_pairExists(t,e){let i=iJ.calculatePairHash(t.id,e.id);return this._pairs.has(i)}broadphase(t,e,i){let s;let r=e/1e3,n=t.filter(t=>{var e,i;let s=null===(e=t.owner)||void 0===e?void 0:e.get(sh);return(null===(i=t.owner)||void 0===i?void 0:i.active)&&s.collisionType!==Z.PreventCollision});this._collisionPairCache=[],this._pairs.clear();for(let t=0,e=n.length;t<e;t++)s=n[t],this._dynamicCollisionTree.query(s,t=>{if(!this._pairExists(s,t)&&iJ.canCollide(s,t)){let e=new iJ(s,t);this._pairs.add(e.id),this._collisionPairCache.push(e)}return!1});if(i&&(i.physics.pairs=this._collisionPairCache.length),iW.checkForFastBodies)for(let t of n){let e=t.owner.get(sh);if(e.collisionType!==Z.Active)continue;let s=e.vel.size*r+.5*e.acc.size*r*r,n=Math.min(t.bounds.height,t.bounds.width);if(iW.disableMinimumSpeedForFastBody||s>n/2){let r;i&&i.physics.fastBodies++;let n=e.globalPos.sub(e.oldPos),o=t.center,a=t.getFurthestPoint(e.vel),h=a.sub(n),l=new i5(h,e.vel);l.pos=l.pos.add(l.dir.scale(-2*iW.surfaceEpsilon));let d=new ey(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(l,s+2*iW.surfaceEpsilon,e=>{if(!this._pairExists(t,e)&&iJ.canCollide(t,e)){let t=e.rayCast(l,s+10*iW.surfaceEpsilon);if(t){let i=t.sub(h);i.size<d.size&&(d=i,r=e)}}return!1}),r&&ey.isValid(d)){let s=new iJ(t,r);this._pairs.has(s.id)||(this._pairs.add(s.id),this._collisionPairCache.push(s));let n=o.sub(a);e.globalPos=h.add(n).add(d).add(l.dir.scale(10*iW.surfaceEpsilon)),t.update(e.transform.get()),i&&i.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(t,e){let i=[];for(let s=0;s<t.length;s++){let r=t[s].collide();if(i=i.concat(r),e&&r.length>0)for(let t of r)e.physics.contacts.set(t.id,t)}return e&&(e.physics.collisions+=i.length),i}update(t){let e=0,i=t.length;for(let s=0;s<i;s++)this._dynamicCollisionTree.updateCollider(t[s])&&e++;return e}debug(t){this._dynamicCollisionTree.debug(t)}}class i3{constructor(){this.id=tA("collider",i3._ID++),this.__compositeColliderId=null,this.events=new tT,this.offset=ey.Zero}touching(t){return!!this.collide(t)}}i3._ID=0;class i6 extends i3{constructor(t){for(let e of(super(),this._collisionProcessor=new i4,this._dynamicAABBTree=new i2,this._colliders=[],t))this.addCollider(e)}clearColliders(){this._colliders=[]}addCollider(t){let e;for(let i of(t instanceof i6?(e=t.getColliders()).forEach(e=>e.offset.addEqual(t.offset)):e=[t],e))i.events.pipe(this.events),i.__compositeColliderId=this.id,this._colliders.push(i),this._collisionProcessor.track(i),this._dynamicAABBTree.trackCollider(i)}removeCollider(t){t.events.pipe(this.events),t.__compositeColliderId=null,eP(t,this._colliders),this._collisionProcessor.untrack(t),this._dynamicAABBTree.untrackCollider(t)}getColliders(){return this._colliders}get worldPos(){var t,e;return(null!==(e=null===(t=this._transform)||void 0===t?void 0:t.pos)&&void 0!==e?e:ey.Zero).add(this.offset)}get center(){var t,e;return(null!==(e=null===(t=this._transform)||void 0===t?void 0:t.pos)&&void 0!==e?e:ey.Zero).add(this.offset)}get bounds(){var t,e;let i=this.getColliders();return i.reduce((t,e)=>t.combine(e.bounds),null!==(e=null===(t=i[0])||void 0===t?void 0:t.bounds)&&void 0!==e?e:new eA().translate(this.worldPos)).translate(this.offset)}get localBounds(){var t,e;let i=this.getColliders();return i.reduce((t,e)=>t.combine(e.localBounds),null!==(e=null===(t=i[0])||void 0===t?void 0:t.localBounds)&&void 0!==e?e:new eA)}get axes(){let t=this.getColliders(),e=[];for(let i of t)e=e.concat(i.axes);return e}getFurthestPoint(t){let e=this.getColliders(),i=[];for(let s of e)i.push(s.getFurthestPoint(t));let s=i[0],r=-Number.MAX_VALUE;for(let e of i){let i=e.dot(t);i>r&&(s=e,r=i)}return s}getInertia(t){let e=this.getColliders(),i=0;for(let s of e)i+=s.getInertia(t);return i}collide(t){let e=[t];t instanceof i6&&(e=t.getColliders());let i=[];for(let t of e)this._dynamicAABBTree.query(t,e=>(i.push(new iJ(t,e)),!1));let s=[];for(let t of i)s=s.concat(t.collide());return s}getClosestLineBetween(t){let e=this.getColliders(),i=[];if(t instanceof i6){let s=t.getColliders();for(let t of e)for(let e of s){let s=t.getClosestLineBetween(e);s&&i.push(s)}}else for(let s of e){let e=t.getClosestLineBetween(s);e&&i.push(e)}if(i.length){let t=i[0].getLength(),e=i[0];for(let s of i){let i=s.getLength();i<t&&(t=i,e=s)}return e}return null}contains(t){for(let e of this.getColliders())if(e.contains(t))return!0;return!1}rayCast(t,e){let i=this.getColliders(),s=[];for(let r of i){let i=r.rayCast(t,e);i&&s.push(i)}if(s.length){let e=s[0],i=e.dot(t.dir);for(let r of s){let s=t.dir.dot(r);s<i&&(e=r,i=s)}return e}return null}project(t){let e=this.getColliders(),i=[];for(let s of e){let e=s.project(t);e&&i.push(e)}if(i.length){let t=new i0(i[0].min,i[0].max);for(let e of i)t.min=Math.min(e.min,t.min),t.max=Math.max(e.max,t.max);return t}return null}update(t){if(t)for(let e of this.getColliders())e.owner=this.owner,e.update(t)}debug(t,e,i){let s=this.getColliders();for(let r of(t.save(),t.translate(this.offset.x,this.offset.y),s))r.debug(t,e,i);t.restore()}clone(){let t=new i6(this._colliders.map(t=>t.clone()));return t.offset=this.offset.clone(),t}}class i9{constructor(t,e){this.begin=t,this.end=e}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;let t=this.begin,e=this.end,i=t.distance(e);return this._slope=e.sub(t).scale(1/i)}getEdge(){let t=this.begin;return this.end.sub(t)}getLength(){if(this._length)return this._length;let t=this.begin,e=this.end,i=t.distance(e);return this._length=i}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new i9(this.end,this.begin)}below(t){return(this.end.x-this.begin.x)*(t.y-this.begin.y)-(this.end.y-this.begin.y)*(t.x-this.begin.x)>=0}clip(t,e){let i=t,s=(i=i.normalize()).dot(this.begin)-e,r=i.dot(this.end)-e,n=[];return(s<=0&&n.push(this.begin),r<=0&&n.push(this.end),s*r<0&&n.push(this.begin.add(this.end.sub(this.begin).scale(s/(s-r)))),2!==n.length)?null:new i9(n[0],n[1])}distanceToPoint(t,e=!1){let i=t.x,s=t.y,r=this.getLength(),n=((this.end.y-this.begin.y)*i-(this.end.x-this.begin.x)*s+this.end.x*this.begin.y-this.end.y*this.begin.x)/r;return e?n:Math.abs(n)}findVectorToPoint(t){let e=this.begin.sub(t),i=this.getSlope();return e.sub(i.scale(e.dot(i)))}findPoint(t=null,e=null){let i=this.slope,s=this.intercept;if(null!==t)return new ey(t,i*t+s);if(null!==e)return new ey((e-s)/i,e);throw Error("You must provide an X or a Y value")}hasPoint(){let t;let e=0;if("number"==typeof arguments[0]&&"number"==typeof arguments[1])t=new ey(arguments[0],arguments[1]),e=arguments[2]||0;else if(arguments[0]instanceof ey)t=arguments[0],e=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";let i=t.x-this.begin.x,s=t.y-this.begin.y,r=this.end.x-this.begin.x,n=this.end.y-this.begin.y;return!(Math.abs(i*n-s*r)>e)&&(Math.abs(r)>=Math.abs(n)?r>0?this.begin.x<=t.x&&t.x<=this.end.x:this.end.x<=t.x&&t.x<=this.begin.x:n>0?this.begin.y<=t.y&&t.y<=this.end.y:this.end.y<=t.y&&t.y<=this.begin.y)}}function i7(t,e,i,s){let r=t.sub(i),n=e.dot(e),o=e.dot(s),a=s.dot(s),h=e.dot(r),l=s.dot(r),d=n*a-o*o,c=d,u=d;if(0===d||d<=.01)return new i9(t,i.add(s.scale(h/o)));let p=o*l-a*h,_=n*l-o*h;return p<0?(p=0,_=l,u=a):p>c&&(p=c,_=l+o,u=a),_<0?(_=0,0>-h?p=0:-h>n?p=c:(p=-h,c=n)):_>u&&(_=u,-h+o<0?p=0:-h+o>n?p=c:(p=-h+o,c=n)),p=.001>Math.abs(p)?0:p/c,_=.001>Math.abs(_)?0:_/u,new i9(t.add(e.scale(p)),i.add(s.scale(_)))}let i8={PolygonPolygonClosestLine(t,e){let i=e.worldPos,s=i.sub(t.worldPos),r=s.negate(),n=new i5(t.worldPos,s),o=new i5(i,r),a=t.rayCast(n).add(n.dir.scale(.1)),h=e.rayCast(o).add(o.dir.scale(.1)),l=t.getClosestFace(a),d=e.getClosestFace(h),c=l.face.begin;return i7(c,l.face.getEdge(),d.face.begin,d.face.getEdge())},PolygonEdgeClosestLine(t,e){let i=e.worldPos.sub(t.worldPos),s=new i5(t.worldPos,i),r=t.rayCast(s).add(s.dir.scale(.1)),n=t.getClosestFace(r),o=n.face.begin,a=n.face.getEdge(),h=e.asLine();return i7(o,a,h.begin,h.getEdge())},PolygonCircleClosestLine(t,e){let i=e.worldPos,s=i.sub(t.worldPos),r=new i5(t.worldPos,s.normalize()),n=t.rayCast(r).add(r.dir.scale(.1)),o=t.getClosestFace(n),a=o.face.begin,h=o.face.getEdge(),l=(h.x*(i.x-a.x)+h.y*(i.y-a.y))/(h.x*h.x+h.y*h.y);l>1?l=1:l<0&&(l=0);let d=Math.sqrt(Math.pow(a.x+h.x*l-i.x,2)+Math.pow(a.y+h.y*l-i.y,2))-e.radius,c=(a.x+h.x*l-i.x)*e.radius/(e.radius+d),u=(a.y+h.y*l-i.y)*e.radius/(e.radius+d);return new i9(h.scale(l).add(a),new ey(i.x+c,i.y+u))},CircleCircleClosestLine(t,e){let i=e.worldPos.sub(t.worldPos),s=t.worldPos.sub(e.worldPos),r=new i5(t.worldPos,i),n=new i5(e.worldPos,s);return new i9(t.rayCast(r),e.rayCast(n))},CircleEdgeClosestLine(t,e){let i=t.worldPos,s=e.asLine(),r=s.begin,n=s.getEdge(),o=(n.x*(i.x-r.x)+n.y*(i.y-r.y))/(n.x*n.x+n.y*n.y);o>1?o=1:o<0&&(o=0);let a=Math.sqrt(Math.pow(r.x+n.x*o-i.x,2)+Math.pow(r.y+n.y*o-i.y,2))-t.radius,h=(r.x+n.x*o-i.x)*t.radius/(t.radius+a),l=(r.y+n.y*o-i.y)*t.radius/(t.radius+a);return new i9(n.scale(o).add(r),new ey(i.x+h,i.y+l))},EdgeEdgeClosestLine(t,e){let i=t.asLine(),s=i.begin,r=i.getEdge(),n=e.asLine();return i7(s,r,n.begin,n.getEdge())}};class st extends i3{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var t;let e=this._transform,i=null!==(t=null==e?void 0:e.globalScale)&&void 0!==t?t:ey.One;return this._naturalRadius*Math.min(i.x,i.y)}set radius(t){var e;let i=this._transform,s=null!==(e=null==i?void 0:i.globalScale)&&void 0!==e?e:ey.One;this._naturalRadius=t/Math.min(s.x,s.y)}constructor(t){super(),this.offset=ey.Zero,this._globalMatrix=ek.identity(),this.offset=t.offset||ey.Zero,this.radius=t.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new st({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(t){var e,i;return(null!==(i=null===(e=this._transform)||void 0===e?void 0:e.pos)&&void 0!==i?i:this.offset).distance(t)<=this.radius}rayCast(t,e=1/0){let i=this.center,s=t.dir,r=t.pos,n=Math.sqrt(Math.pow(s.dot(r.sub(i)),2)-Math.pow(r.sub(i).distance(),2)+Math.pow(this.radius,2));if(n<0)return null;{let o=0;if(0===n)return(o=-s.dot(r.sub(i)))>0&&o<e?t.getPoint(o):null;{let o=-s.dot(r.sub(i))+n,a=-s.dot(r.sub(i))-n,h=[];o>=0&&h.push(o),a>=0&&h.push(a);let l=Math.min(...h);return l<=e?t.getPoint(l):null}}}getClosestLineBetween(t){if(t instanceof st)return i8.CircleCircleClosestLine(this,t);if(t instanceof sn)return i8.PolygonCircleClosestLine(t,this).flip();if(t instanceof sr)return i8.CircleEdgeClosestLine(this,t).flip();throw Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof st)return ss.CollideCircleCircle(this,t);if(t instanceof sn)return ss.CollideCirclePolygon(this,t);if(t instanceof sr)return ss.CollideCircleEdge(this,t);throw Error(`Circle could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){return this.center.add(t.normalize().scale(this.radius))}getFurthestLocalPoint(t){return t.normalize().scale(this.radius)}get bounds(){var t,e,i;let s=this._transform,r=null!==(t=null==s?void 0:s.globalScale)&&void 0!==t?t:ey.One,n=null!==(e=null==s?void 0:s.globalRotation)&&void 0!==e?e:0,o=null!==(i=null==s?void 0:s.globalPos)&&void 0!==i?i:ey.Zero;return new eA(this.offset.x-this._naturalRadius,this.offset.y-this._naturalRadius,this.offset.x+this._naturalRadius,this.offset.y+this._naturalRadius).rotate(n).scale(r).translate(o)}get localBounds(){return new eA(this.offset.x-this._naturalRadius,this.offset.y-this._naturalRadius,this.offset.x+this._naturalRadius,this.offset.y+this._naturalRadius)}get axes(){return[]}getInertia(t){return t*this.radius*this.radius/2}update(t){var e;this._transform=t,(null!==(e=t.matrix)&&void 0!==e?e:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(t){let e=[],i=this.center.dot(t);return e.push(i),e.push(i+this.radius),e.push(i-this.radius),new i0(Math.min.apply(Math,e),Math.max.apply(Math,e))}debug(t,e,i){var s,r,n,o;let{lineWidth:a}={lineWidth:1,...i},h=this._transform,l=null!==(s=null==h?void 0:h.globalScale)&&void 0!==s?s:ey.One,d=null!==(r=null==h?void 0:h.globalRotation)&&void 0!==r?r:0,c=null!==(n=null==h?void 0:h.globalPos)&&void 0!==n?n:ey.Zero;t.save(),t.translate(c.x,c.y),t.rotate(d),t.scale(l.x,l.y),t.drawCircle(null!==(o=this.offset)&&void 0!==o?o:ey.Zero,this._naturalRadius,eb.Transparent,e,a),t.restore()}}class se{constructor(t,e,i,s,r,n,o,a){var h,l;this._canceled=!1,this.colliderA=t,this.colliderB=e,this.mtv=i,this.normal=s,this.tangent=r,this.points=n,this.localPoints=o,this.info=a,this.id=iJ.calculatePairHash(t.id,e.id),(t.__compositeColliderId||e.__compositeColliderId)&&(this.id+="|"+iJ.calculatePairHash(null!==(h=t.__compositeColliderId)&&void 0!==h?h:t.id,null!==(l=e.__compositeColliderId)&&void 0!==l?l:e.id))}matchAwake(){let t=this.colliderA.owner.get(sh),e=this.colliderB.owner.get(sh);t&&e&&t.sleeping!==e.sleeping&&(t.sleeping&&t.collisionType!==Z.Fixed&&e.sleepMotion>=iW.wakeThreshold&&t.setSleeping(!1),e.sleeping&&e.collisionType!==Z.Fixed&&t.sleepMotion>=iW.wakeThreshold&&e.setSleeping(!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}}class si{static findPolygonPolygonSeparation(t,e){let i=-Number.MAX_VALUE,s=null,r=null,n=-1,o=null,a=t.getSides(),h=t.getLocalSides();for(let t=0;t<a.length;t++){let h=a[t],l=h.normal(),d=e.getFurthestPoint(l.negate()),c=h.distanceToPoint(d,!0);c>i&&(i=c,s=h,r=l,n=t,o=d)}return{collider:t,separation:r?i:99,axis:r,side:s,localSide:h[n],sideId:n,point:o,localPoint:r?e.getFurthestLocalPoint(r.negate()):null}}static findCirclePolygonSeparation(t,e){let i=e.axes,s=e.center.sub(t.worldPos),r=e.getFurthestPoint(s.negate());i.push(r.sub(t.worldPos).normalize());let n=Number.MAX_VALUE,o=null,a=-1;for(let s=0;s<i.length;s++){let r=e.project(i[s]),h=t.project(i[s]),l=r.getOverlap(h);if(l<=0)return null;l<n&&(n=l,o=i[s],a=s)}return a<0?null:o.normalize().scale(n)}}let ss={CollideCircleCircle(t,e){let i=t.worldPos,s=e.worldPos,r=t.radius+e.radius,n=i.distance(s);if(n>r)return[];let o=r-n,a=s.sub(i).normalize(),h=a.perpendicular(),l=a.scale(o),d=t.getFurthestPoint(a),c=t.getFurthestLocalPoint(a);return[new se(t,e,l,a,h,[d],[c],{collider:t,separation:o,axis:a,point:d})]},CollideCirclePolygon(t,e){var i,s;let r=si.findCirclePolygonSeparation(t,e);if(!r)return[];r=0>r.dot(e.center.sub(t.center))?r.negate():r;let n=t.getFurthestPoint(r),o=(null!==(s=null===(i=t.owner)||void 0===i?void 0:i.get(iY))&&void 0!==s?s:new iY).applyInverse(n),a=r.normalize(),h={collider:t,separation:-r.size,axis:a,point:n,localPoint:o,side:e.findSide(a.negate()),localSide:e.findLocalSide(a.negate())};return[new se(t,e,r,a,a.perpendicular(),[n],[o],h)]},CollideCircleEdge(t,e){let i=t.center,s=e.asLine(),r=s.end.sub(s.begin),n=r.dot(s.end.sub(i)),o=r.dot(i.sub(s.begin)),a=e.asLine(),h=e.asLocalLine();if(o<=0){let r=s.begin.sub(i),n=r.dot(r);if(n>t.radius*t.radius)return[];let o=r.normalize(),l=t.radius-Math.sqrt(n),d={collider:t,separation:l,axis:o,point:a.begin,side:a,localSide:h};return[new se(t,e,o.scale(l),o,o.perpendicular(),[a.begin],[h.begin],d)]}if(n<=0){let r=s.end.sub(i),n=r.dot(r);if(n>t.radius*t.radius)return[];let o=r.normalize(),l=t.radius-Math.sqrt(n),d={collider:t,separation:l,axis:o,point:a.end,side:a,localSide:h};return[new se(t,e,o.scale(l),o,o.perpendicular(),[a.end],[h.end],d)]}let l=r.dot(r),d=s.begin.scale(n).add(s.end.scale(o)).scale(1/l),c=i.sub(d),u=c.dot(c);if(u>t.radius*t.radius)return[];let p=r.perpendicular();0>p.dot(i.sub(s.begin))&&(p.x=-p.x,p.y=-p.y),p=p.normalize();let _=t.radius-Math.sqrt(u),g=p.scale(_),m={collider:t,separation:_,axis:p,point:d,side:a,localSide:h};return[new se(t,e,g,p.negate(),p.negate().perpendicular(),[d],[d.sub(e.worldPos)],m)]},CollideEdgeEdge:()=>[],CollidePolygonEdge(t,e){var i;let s=t.center,r=e.center.sub(s).normalize(),n=new sn({points:[e.begin,e.end,e.end.add(r.scale(100)),e.begin.add(r.scale(100))],offset:e.offset});n.owner=e.owner,(null===(i=e.owner)||void 0===i?void 0:i.get(iY))&&n.update(e.owner.get(iY).get());let o=this.CollidePolygonPolygon(t,n);return o.length&&(o[0].colliderB=e,o[0].id=iJ.calculatePairHash(t.id,e.id)),o},CollidePolygonPolygon(t,e){var i,s,r,n;let o=si.findPolygonPolygonSeparation(t,e);if(o.separation>0)return[];let a=si.findPolygonPolygonSeparation(e,t);if(a.separation>0)return[];let h=o.separation>a.separation?o:a,l=(h.collider===t?e:t).findSide(h.axis.negate()),d=h.side,c=d.dir().normalize(),u=l.clip(c.negate(),-c.dot(d.begin)),p=null;if(u&&(p=u.clip(c,c.dot(d.end))),p){let o=p.getPoints().filter(t=>d.below(t)),a=h.axis,l=a.perpendicular();0>e.center.sub(t.center).dot(a)&&(l=(a=a.negate()).perpendicular());let c=[];if(h.collider===t){let t=null!==(s=null===(i=e.owner)||void 0===i?void 0:i.get(iY))&&void 0!==s?s:new iY;c=o.map(e=>t.applyInverse(e))}else{let e=null!==(n=null===(r=t.owner)||void 0===r?void 0:r.get(iY))&&void 0!==n?n:new iY;c=o.map(t=>e.applyInverse(t))}return[new se(t,e,a.scale(-h.separation),a,l,o,c,h)]}return[]},FindContactSeparation(t,e){var i,s,r,n;let o=t.colliderA,a=null!==(s=null===(i=t.colliderA.owner)||void 0===i?void 0:i.get(iY))&&void 0!==s?s:new iY,h=t.colliderB,l=null!==(n=null===(r=t.colliderB.owner)||void 0===r?void 0:r.get(iY))&&void 0!==n?n:new iY;if(o instanceof st&&h instanceof st)return-(o.radius+h.radius-a.pos.distance(l.pos));if(o instanceof sn&&h instanceof sn&&t.info.localSide){let i,s;return t.info.collider===o?(i=new i9(a.apply(t.info.localSide.begin),a.apply(t.info.localSide.end)),s=l.apply(e)):(i=new i9(l.apply(t.info.localSide.begin),l.apply(t.info.localSide.end)),s=a.apply(e)),i.distanceToPoint(s,!0)}if(o instanceof sn&&h instanceof st||h instanceof sn&&o instanceof st){let i=a.apply(e);if(t.info.side)return t.info.side.distanceToPoint(i,!0)}if(o instanceof sr&&h instanceof sn||h instanceof sr&&o instanceof sn){let i;if(i=t.info.collider===o?l.apply(e):a.apply(e),t.info.side)return t.info.side.distanceToPoint(i,!0)}if(o instanceof st&&h instanceof sr||h instanceof st&&o instanceof sr){let i;let s=l.apply(e);o instanceof st&&(i=o.getFurthestPoint(t.normal));let r=s.distance(i);if(t.info.side)return r>0?-r:0}return 0}};class sr extends i3{constructor(t){var e;super(),this._globalMatrix=ek.identity(),this.begin=t.begin||ey.Zero,this.end=t.end||ey.Zero,this.offset=null!==(e=t.offset)&&void 0!==e?e:ey.Zero}clone(){return new sr({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var t;let e=this._transform;return null!==(t=null==e?void 0:e.globalPos.add(this.offset))&&void 0!==t?t:this.offset}get center(){let t=this._getTransformedBegin(),e=this._getTransformedEnd();return t.average(e)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){let t=this._getTransformedBegin(),e=this._getTransformedEnd(),i=t.distance(e);return e.sub(t).scale(1/i)}getLength(){let t=this._getTransformedBegin(),e=this._getTransformedEnd();return t.distance(e)}contains(){return!1}rayCast(t,e=1/0){let i=this._getTransformedBegin().sub(t.pos);if(0===t.dir.cross(this.getSlope())&&0!==i.cross(t.dir))return null;let s=t.dir.cross(this.getSlope());if(0===s)return null;let r=i.cross(this.getSlope())/s;if(r>=0&&r<=e){let e=i.cross(t.dir)/s/this.getLength();if(e>=0&&e<=1)return t.getPoint(r)}return null}getClosestLineBetween(t){if(t instanceof st)return i8.CircleEdgeClosestLine(t,this);if(t instanceof sn)return i8.PolygonEdgeClosestLine(t,this).flip();if(t instanceof sr)return i8.EdgeEdgeClosestLine(this,t);throw Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof st)return ss.CollideCircleEdge(t,this);if(t instanceof sn)return ss.CollidePolygonEdge(t,this);if(t instanceof sr)return ss.CollideEdgeEdge();throw Error(`Edge could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){let e=this._getTransformedBegin(),i=this._getTransformedEnd();return t.dot(e)>0?e:i}_boundsFromBeginEnd(t,e,i=10){return new eA(Math.min(t.x,e.x)-i,Math.min(t.y,e.y)-i,Math.max(t.x,e.x)+i,Math.max(t.y,e.y)+i)}get bounds(){let t=this._getTransformedBegin(),e=this._getTransformedEnd();return this._boundsFromBeginEnd(t,e)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new i9(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new i9(this.begin,this.end)}get axes(){let t=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),e=[];return e.push(t),e.push(t.negate()),e.push(t.normal()),e.push(t.normal().negate()),e}getInertia(t){let e=this.end.sub(this.begin).distance()/2;return t*e*e}update(t){var e;this._transform=t,(null!==(e=t.matrix)&&void 0!==e?e:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(t){let e=[],i=[this._getTransformedBegin(),this._getTransformedEnd()],s=i.length;for(let r=0;r<s;r++)e.push(i[r].dot(t));return new i0(Math.min.apply(Math,e),Math.max.apply(Math,e))}debug(t,e){let i=this._getTransformedBegin(),s=this._getTransformedEnd();t.drawLine(i,s,e,2),t.drawCircle(i,2,e),t.drawCircle(s,2,e)}}class sn extends i3{set points(t){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._sidesDirty=!0,this._points=t}get points(){return this._points}constructor(t){var e,i;super(),this._logger=es.getInstance(),this._transformedPoints=[],this._sides=[],this._localSides=[],this._globalMatrix=ek.identity(),this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=null!==(e=t.offset)&&void 0!==e?e:ey.Zero,this._globalMatrix.translate(this.offset.x,this.offset.y),this.points=null!==(i=t.points)&&void 0!==i?i:[],this._isCounterClockwiseWinding(this.points)||this.points.reverse(),this.isConvex()||t.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_isCounterClockwiseWinding(t){let e=0;for(let i=0;i<t.length;i++)e+=(t[(i+1)%t.length].x-t[i].x)*(t[(i+1)%t.length].y+t[i].y);return e<0}isConvex(){if(this.points.length<3)return!1;let t=this.points[this.points.length-2],e=this.points[this.points.length-1],i=Math.atan2(e.y-t.y,e.x-t.x),s=0,r=0,n=0;for(let[o,a]of this.points.entries()){if(t=e,s=i,i=Math.atan2((e=a).y-t.y,e.x-t.x),t.equals(e))return!1;let h=i-s;if(h<=-Math.PI?h+=2*Math.PI:h>Math.PI&&(h-=2*Math.PI),0===o){if(0===h)return!1;r=h>0?1:-1}else if(r*h<=0)return!1;n+=h}return 1===Math.abs(Math.round(n/(2*Math.PI)))}tessellate(){let t=[];for(let e=1;e<this.points.length-2;e++)t.push([this.points[0],this.points[e+1],this.points[e+2]]);return t.push([this.points[0],this.points[1],this.points[2]]),new i6(t.map(t=>so.Polygon(t)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");let t=[],e=[...this.points].reverse(),i=e.length;function s(t){return 0===t?i-1:t-1}function r(t){return t===i-1?0:t+1}function n(t){let i=s(t),n=r(t),o=e[i],a=e[t],h=e[n],l=o.sub(a),d=h.sub(a);return!(0>l.cross(d))}let o=e.map((t,e)=>n(e));for(;i>3;){!function(n){let a=s(n),h=r(n),l=e[a],d=e[n],c=e[h];t.push([l,d,c]),e.splice(n,1),o.splice(n,1),i--}(function(){for(let t=0;t<i;t++)if(o[t]){let n=s(t),o=r(t),a=e[n],h=e[t],l=e[o],d=!0;for(let s=0;s<i;s++)if(s!==t&&s!==n&&s!==o&&function(t,e,i,s){let r=i.sub(e),n=s.sub(i),o=e.sub(s),a=t.sub(e),h=t.sub(i),l=t.sub(s),d=r.cross(a),c=n.cross(h),u=o.cross(l);return!(d>0)&&!(c>0)&&!(u>0)}(e[s],a,h,l)){d=!1;break}if(d)return t}for(let t=0;t<i;t++)if(o[t])return t;return 0}());for(let t=0;t<i;t++)o[t]=n(t)}return t.push([e[0],e[1],e[2]]),new i6(t.map(t=>so.Polygon(t,ey.Zero,!0)))}clone(){return new sn({offset:this.offset.clone(),points:this.points.map(t=>t.clone())})}get worldPos(){return this._transform?this._transform.pos.add(this.offset):this.offset}get center(){return this.bounds.center}_calculateTransformation(){let t=this.points,e=t.length;this._transformedPoints.length=0;for(let i=0;i<e;i++)this._transformedPoints[i]=this._globalMatrix.multiply(t[i].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){let t=[],e=this.getTransformedPoints(),i=e.length;for(let s=0;s<i;s++)t.push(new i9(e[s],e[(s+1)%i]));this._sides=t,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){let t=[],e=this.points,i=e.length;for(let s=0;s<i;s++)t.push(new i9(e[s],e[(s+1)%i]));this._localSides=t,this._localSidesDirty=!1}return this._localSides}findSide(t){let e=this.getSides(),i=e[0],s=-Number.MAX_VALUE;for(let r=0;r<e.length;r++){let n=e[r],o=n.normal().dot(t);o>s&&(i=n,s=o)}return i}findLocalSide(t){let e=this.getLocalSides(),i=e[0],s=-Number.MAX_VALUE;for(let r=0;r<e.length;r++){let n=e[r],o=n.normal().dot(t);o>s&&(i=n,s=o)}return i}get axes(){let t=[],e=this.getSides();for(let i=0;i<e.length;i++)t.push(e[i].normal());return t}update(t){var e;t&&(this._transform=t,this._transformedPointsDirty=!0,this._sidesDirty=!0,(null!==(e=t.matrix)&&void 0!==e?e:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y))}contains(t){let e=new i5(t,new ey(1,0));return this.getSides().reduce(function(t,i){return e.intersect(i)>=0?t+1:t},0)%2!=0}getClosestLineBetween(t){if(t instanceof st)return i8.PolygonCircleClosestLine(this,t);if(t instanceof sn)return i8.PolygonPolygonClosestLine(this,t);if(t instanceof sr)return i8.PolygonEdgeClosestLine(this,t);throw Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof st)return ss.CollideCirclePolygon(t,this);if(t instanceof sn)return ss.CollidePolygonPolygon(this,t);if(t instanceof sr)return ss.CollidePolygonEdge(this,t);throw Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){let e=this.getTransformedPoints(),i=null,s=-Number.MAX_VALUE;for(let r=0;r<e.length;r++){let n=t.dot(e[r]);n>s&&(s=n,i=e[r])}return i}getFurthestLocalPoint(t){let e=this.points,i=e[0],s=-Number.MAX_VALUE;for(let r=0;r<e.length;r++){let n=t.dot(e[r]);n>s&&(s=n,i=e[r])}return i}getClosestFace(t){let e=this.getSides(),i=Number.POSITIVE_INFINITY,s=-1,r=-1;for(let n=0;n<e.length;n++){let o=e[n].distanceToPoint(t);o<i&&(i=o,s=n,r=o)}return -1!==s?{distance:e[s].normal().scale(r),face:e[s]}:null}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=eA.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(t){if(this._cachedMass===t&&this._cachedInertia)return this._cachedInertia;let e=0,i=0,s=this.points;for(let t=0;t<s.length;t++){let r=(t+1)%s.length,n=s[r].cross(s[t]);e+=n*(s[t].dot(s[t])+s[t].dot(s[r])+s[r].dot(s[r])),i+=n}return this._cachedMass=t,this._cachedInertia=t/6*(e/i)}rayCast(t,e=1/0){let i=this.getSides(),s=i.length,r=Number.MAX_VALUE,n=-1;for(let o=0;o<s;o++){let s=t.intersect(i[o]);s>=0&&s<r&&s<=e&&(r=s,n=o)}return n>=0?t.getPoint(r):null}project(t){let e=this.getTransformedPoints(),i=e.length,s=Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let n=0;n<i;n++){let i=e[n].dot(t);s=Math.min(s,i),r=Math.max(r,i)}return new i0(s,r)}debug(t,e,i){let s=this.getTransformedPoints()[0],r=[s,...this.getTransformedPoints(),s],{lineWidth:n,pointSize:o}={lineWidth:1,pointSize:1,...i};for(let i=0;i<r.length-1;i++)t.drawLine(r[i],r[i+1],e,n),t.drawCircle(r[i],o,e),t.drawCircle(r[i+1],o,e)}}class so{static Box(t,e,i=ey.Half,s=ey.Zero){return new sn({points:new eA(-t*i.x,-e*i.y,t-t*i.x,e-e*i.y).getPoints(),offset:s})}static Polygon(t,e=ey.Zero,i=!1){return new sn({points:t,offset:e,suppressConvexWarning:i})}static Circle(t,e=ey.Zero){return new st({radius:t,offset:e})}static Edge(t,e){return new sr({begin:t,end:e})}static Capsule(t,e,i=ey.Zero){let s=es.getInstance();return new i6((t===e&&s.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),e>=t)?[so.Circle(t/2,ew(0,-e/2+t/2).add(i)),so.Box(t,e-t,ey.Half,i),so.Circle(t/2,ew(0,e/2-t/2).add(i))]:[so.Circle(e/2,ew(-t/2+e/2,0).add(i)),so.Box(t-e,e,ey.Half,i),so.Circle(e/2,ew(t/2-e/2,0).add(i))])}}class sa extends iX{constructor(t){super(),this.type="ex.collider",this.events=new tT,this.$colliderAdded=new iK,this.$colliderRemoved=new iK,this.set(t)}get(){return this._collider}set(t){return this.clear(),t&&(this._collider=t,this._collider.owner=this.owner,t.events.pipe(this.events),this.$colliderAdded.notifyAll(t),this.update()),t}clear(){this._collider&&(this._collider.events.unpipe(this.events),this.$colliderRemoved.notifyAll(this._collider),this._collider.owner=null,this._collider=null)}clone(){return new sa(this._collider.clone())}get bounds(){var t,e;return null!==(e=null===(t=this._collider)||void 0===t?void 0:t.bounds)&&void 0!==e?e:new eA}get localBounds(){var t,e;return null!==(e=null===(t=this._collider)||void 0===t?void 0:t.localBounds)&&void 0!==e?e:new eA}update(){var t;let e=null===(t=this.owner)||void 0===t?void 0:t.get(iY);this._collider&&(this._collider.owner=this.owner,e&&this._collider.update(e.get()))}collide(t){let e=this._collider,i=t._collider;if(!e||!i)return[];let s=!1;if(i instanceof i6&&(e=i,i=this._collider,s=!0),this._collider){let r=e.collide(i);if(r)return s&&r.forEach(e=>{e.mtv=e.mtv.negate(),e.normal=e.normal.negate(),e.tangent=e.normal.perpendicular(),e.colliderA=this._collider,e.colliderB=t._collider}),r}return[]}onAdd(t){this._collider&&this.update(),this.events.on("precollision",e=>{t.events.emit("precollision",new tK(e.target.owner,e.other.owner,e.side,e.intersection,e.contact)),t instanceof sZ&&t.onPreCollisionResolve(e.target,e.other,e.side,e.contact)}),this.events.on("postcollision",e=>{t.events.emit("postcollision",new tY(e.target.owner,e.other.owner,e.side,e.intersection,e.contact)),t instanceof sZ&&t.onPostCollisionResolve(e.target,e.other,e.side,e.contact)}),this.events.on("collisionstart",e=>{t.events.emit("collisionstart",new t0(e.target.owner,e.other.owner,e.side,e.contact)),t instanceof sZ&&t.onCollisionStart(e.target,e.other,e.side,e.contact)}),this.events.on("collisionend",e=>{t.events.emit("collisionend",new t1(e.target.owner,e.other.owner)),t instanceof sZ&&t.onCollisionEnd(e.target,e.other)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(t,e,i=ey.Half,s=ey.Zero){let r=so.Box(t,e,i,s);return this.set(r)}usePolygonCollider(t,e=ey.Zero){let i=so.Polygon(t,e);return this.set(i)}useCircleCollider(t,e=ey.Zero){let i=so.Circle(t,e);return this.set(i)}useEdgeCollider(t,e){let i=so.Edge(t,e);return this.set(i)}useCompositeCollider(t){return this.set(new i6(t))}}(v=Q||(Q={})).Rotation="rotation",v.X="x",v.Y="y";class sh extends iX{constructor(t){var e,i,s;super(),this.type="ex.body",this.dependencies=[iY,ij],this.id=tA("body",sh._ID++),this.events=new tT,this.oldTransform=new iq,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=Z.PreventCollision,this.group=iQ.All,this._mass=iW.defaultMass,this.sleepMotion=5*iW.sleepEpsilon,this.canSleep=iW.bodiesCanSleepByDefault,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this.oldVel=new ey(0,0),this.oldAcc=ey.Zero,t&&(this.collisionType=null!==(e=t.type)&&void 0!==e?e:this.collisionType,this.group=null!==(i=t.group)&&void 0!==i?i:this.group,this.useGravity=null!==(s=t.useGravity)&&void 0!==s?s:this.useGravity)}get matrix(){return this.transform.get().matrix}get mass(){return this._mass}set mass(t){this._mass=t,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===Z.Fixed?0:1/this.mass}get sleeping(){return this._sleeping}setSleeping(t){this._sleeping=t,t?(this.vel=ey.Zero,this.acc=ey.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=5*iW.sleepEpsilon}updateMotion(){this._sleeping&&this.setSleeping(!0);let t=this.vel.size*this.vel.size+Math.abs(this.angularVelocity*this.angularVelocity),e=iW.sleepBias;this.sleepMotion=e*this.sleepMotion+(1-e)*t,this.sleepMotion=ep(this.sleepMotion,0,10*iW.sleepEpsilon),this.canSleep&&this.sleepMotion<iW.sleepEpsilon&&this.setSleeping(!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;let t=this.owner.get(sa);if(t){t.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),t.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});let e=t.get();if(e)return this._cachedInertia=e.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===Z.Fixed?0:1/this.inertia}get active(){var t;return!!(null===(t=this.owner)||void 0===t?void 0:t.active)}get center(){return this.globalPos}get transform(){var t;return null===(t=this.owner)||void 0===t?void 0:t.get(iY)}get motion(){var t;return null===(t=this.owner)||void 0===t?void 0:t.get(ij)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get globalPos(){return this.transform.globalPos}set globalPos(t){this.transform.globalPos=t}get oldPos(){return this.oldTransform.pos}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t}get torque(){return this.motion.torque}set torque(t){this.motion.torque=t}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(t){this.transform.globalRotation=t}get scale(){return this.transform.globalScale}set scale(t){this.transform.globalScale=t}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(t){this.motion.scaleFactor=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}applyImpulse(t,e){if(this.collisionType!==Z.Active)return;let i=e.scale(this.inverseMass);if(this.limitDegreeOfFreedom.includes(Q.X)&&(i.x=0),this.limitDegreeOfFreedom.includes(Q.Y)&&(i.y=0),this.vel.addEqual(i),!this.limitDegreeOfFreedom.includes(Q.Rotation)){let i=t.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*i.cross(e)}}applyLinearImpulse(t){if(this.collisionType!==Z.Active)return;let e=t.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(Q.X)&&(e.x=0),this.limitDegreeOfFreedom.includes(Q.Y)&&(e.y=0),this.vel=this.vel.add(e)}applyAngularImpulse(t,e){if(this.collisionType===Z.Active&&!this.limitDegreeOfFreedom.includes(Q.Rotation)){let i=t.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*i.cross(e)}}captureOldTransform(){this.__oldTransformCaptured=!0;let t=this.transform.get();t.clone(this.oldTransform),this.oldTransform.parent=t.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y)}clone(){return super.clone()}}sh._ID=0;class sl{constructor(t){this.data=t,this.type="Component Added"}}function sd(t){return!!t&&"Component Added"===t.type}class sc{constructor(t){this.data=t,this.type="Component Removed"}}function su(t){return!!t&&"Component Removed"===t.type}let sp={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class s_{constructor(t,e){if(this.events=new tT,this.id=s_._ID++,this.scene=null,this._name="anonymous",this.active=!0,this._componentsToRemove=[],this._componentTypeToInstance=new Map,this._componentStringToInstance=new Map,this._tagsMemo=[],this._typesMemo=[],this.componentAdded$=new iK,this.componentRemoved$=new iK,this._parent=null,this.childrenAdded$=new iK,this.childrenRemoved$=new iK,this._children=[],this._isInitialized=!1,this._setName(e),t)for(let e of t)this.addComponent(e)}_setName(t){t?this._name=t:this._name=`Entity#${this.id}`}get name(){return this._name}set name(t){this._setName(t)}kill(){this.active&&(this.active=!1,this.unparent())}isKilled(){return!this.active}get tags(){return this._tagsMemo}hasTag(t){return this.tags.includes(t)}addTag(t){return this.addComponent(new iZ(t))}removeTag(t,e=!1){return this.removeComponent(t,e)}get types(){return this._typesMemo}_rebuildMemos(){this._tagsMemo=Array.from(this._componentStringToInstance.values()).filter(t=>t instanceof iZ).map(t=>t.type),this._typesMemo=Array.from(this._componentStringToInstance.keys())}getComponents(){return Array.from(this._componentStringToInstance.values())}_notifyAddComponent(t){this._rebuildMemos();let e=new sl({component:t,entity:this});this.componentAdded$.notifyAll(e)}_notifyRemoveComponent(t){let e=new sc({component:t,entity:this});this.componentRemoved$.notifyAll(e),this._rebuildMemos()}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(t){if(null===t.parent){if(this.getAncestors().includes(t))throw Error("Cycle detected, cannot add entity");this._children.push(t),t._parent=this,this.childrenAdded$.notifyAll(t)}else throw Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(t){return t.parent===this&&(eP(t,this._children),t._parent=null,this.childrenRemoved$.notifyAll(t)),this}removeAllChildren(){for(let t=this.children.length-1;t>=0;t--)this.removeChild(this.children[t]);return this}getAncestors(){let t=[this],e=this.parent;for(;e;)t.push(e),e=e.parent;return t.reverse()}getDescendants(){let t=[this],e=[this];for(;e.length>0;){let i=e.pop();e=e.concat(i.children),t=t.concat(i.children)}return t}clone(){let t=new s_;for(let e of this.types)t.addComponent(this.get(e).clone());for(let e of this.children)t.addChild(e.clone());return t}addTemplate(t,e=!1){for(let i of t.getComponents())this.addComponent(i.clone(),e);for(let e of t.children)this.addChild(e.clone().addTemplate(e));return this}addComponent(t,e=!1){if(this.has(t.type)){if(!e)return this;this.removeComponent(t,!0)}if(t.dependencies&&t.dependencies.length)for(let e of t.dependencies)this.addComponent(new e);t.owner=this;let i=t.constructor;return this._componentTypeToInstance.set(i,t),this._componentStringToInstance.set(t.type,t),t.onAdd&&t.onAdd(this),this._notifyAddComponent(t),this}removeComponent(t,e=!1){return e?"string"==typeof t?this._removeComponentByType(t):t instanceof iX&&this._removeComponentByType(t.type):this._componentsToRemove.push(t),this}clearComponents(){for(let t of this.getComponents())this.removeComponent(t)}_removeComponentByType(t){if(this.has(t)){let e=this.get(t);e.owner=null,e.onRemove&&e.onRemove(this);let i=e.constructor;this._componentTypeToInstance.delete(i),this._componentStringToInstance.delete(e.type),this._notifyRemoveComponent(e)}}processComponentRemoval(){for(let t of this._componentsToRemove){let e="string"==typeof t?t:t.type;this._removeComponentByType(e)}this._componentsToRemove.length=0}has(t){return"string"==typeof t?this._componentStringToInstance.has(t):this._componentTypeToInstance.has(t)}get(t){return"string"==typeof t?this._componentStringToInstance.get(t):this._componentTypeToInstance.get(t)}get isInitialized(){return this._isInitialized}_initialize(t){this.isInitialized||(this.onInitialize(t),this.events.emit("initialize",new t2(t,this)),this._isInitialized=!0)}_preupdate(t,e){this.events.emit("preupdate",new tU(t,e,this)),this.onPreUpdate(t,e)}_postupdate(t,e){this.events.emit("postupdate",new tO(t,e,this)),this.onPostUpdate(t,e)}onInitialize(t){}onPreUpdate(t,e){}onPostUpdate(t,e){}update(t,e){for(let i of(this._initialize(t),this._preupdate(t,e),this.children))i.update(t,e);this._postupdate(t,e)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}}function sg(t){return!!t.tick}s_._ID=0;class sm{constructor(t,e){this._options=t,this._graphics=e,this.graphics=[]}get name(){return this._options.name}hide(t){if(t){let e=null;e=t instanceof eH?t:this._graphics.getGraphic(t),this.graphics=this.graphics.filter(t=>t.graphic!==e),this._graphics.recalculateBounds()}else this.graphics.length=0}show(t,e){let i;return(e={...e},t instanceof eH?i=this._graphics.copyGraphics?t.clone():t:(i=this._graphics.getGraphic(t))||es.getInstance().error(`No such graphic added to component named ${t}. These named graphics are available: `,this._graphics.getNames()),i)?(this.graphics.push({graphic:i,options:e}),this._graphics.recalculateBounds(),i):null}use(t,e){return e={...e},this.hide(),this.show(t,e)}get order(){return this._options.order}set order(t){this._options.order=t}get offset(){var t;return null!==(t=this._options.offset)&&void 0!==t?t:ey.Zero}set offset(t){this._options.offset=t}get currentKeys(){var t;return null!==(t=this.name)&&void 0!==t?t:"anonymous"}clone(t){let e=new sm({...this._options},t);return e.graphics=[...this.graphics.map(t=>({graphic:t.graphic.clone(),options:{...t.options}}))],e}}class sf{constructor(t){this._component=t,this._layers=[],this._layerMap={},this.default=new sm({name:"default",order:0},t),this._maybeAddLayer(this.default)}create(t){let e=new sm(t,this._component);return this._maybeAddLayer(e)}get(t){return t?this._getLayer(t):this._layers}currentKeys(){let t=[];for(let e of this._layers)t.push(e.currentKeys);return t}has(t){return t in this._layerMap}_maybeAddLayer(t){return this._layerMap[t.name]?this._layerMap[t.name]:(this._layerMap[t.name]=t,this._layers.push(t),this._layers.sort((t,e)=>t.order-e.order),t)}_getLayer(t){return this._layerMap[t]}clone(t){let e=new sf(t);return e._layerMap={},e._layers=[],e.default=this.default.clone(t),e._maybeAddLayer(e.default),this._layers.filter(t=>"default"!==t.name).map(e=>e.clone(t)).forEach(t=>e._maybeAddLayer(t)),e}}class sv extends iX{getGraphic(t){return this._graphics[t]}getNames(){return Object.keys(this._graphics)}constructor(t){super(),this.type="ex.graphics",this._graphics={},this.material=null,this.visible=!0,this.opacity=1,this.offset=ey.Zero,this.anchor=ey.Half,this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,this._localBounds=null;let{current:e,anchor:i,opacity:s,visible:r,graphics:n,offset:o,copyGraphics:a,onPreDraw:h,onPostDraw:l}=t={visible:this.visible,...t};this._graphics=n||{},this.offset=null!=o?o:this.offset,this.opacity=null!=s?s:this.opacity,this.anchor=null!=i?i:this.anchor,this.copyGraphics=null!=a?a:this.copyGraphics,this.onPreDraw=null!=h?h:this.onPreDraw,this.onPostDraw=null!=l?l:this.onPostDraw,this.visible=!!r,this.layers=new sf(this),e&&this._graphics[e]&&this.show(this._graphics[e])}get current(){return this.layers.default.graphics}get graphics(){return this._graphics}add(t,e){let i="default",s=null;return"string"==typeof t?(i=t,s=e):s=t,this._graphics[i]=this.copyGraphics?s.clone():s,"default"===i&&this.show("default"),s}show(t,e){let i=this.layers.default.show(t,e);return this.recalculateBounds(),i}use(t,e){let i=this.layers.default.use(t,e);return this.recalculateBounds(),i}hide(t){this.layers.default.hide(t)}set localBounds(t){this._localBounds=t}recalculateBounds(){let t=new eA;for(let e of this.layers.get())for(let{graphic:i,options:s}of e.graphics){let r=this.anchor,n=this.offset;(null==s?void 0:s.anchor)&&(r=s.anchor),(null==s?void 0:s.offset)&&(n=s.offset);let o=i.localBounds,a=-o.width*r.x+n.x,h=-o.height*r.y+n.y;t=null==i?void 0:i.localBounds.translate(ew(a+e.offset.x,h+e.offset.y)).combine(t)}this._localBounds=t}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}update(t,e=0){for(let i of this.layers.get())for(let{graphic:s}of i.graphics)sg(s)&&(null==s||s.tick(t,e))}clone(){let t=new sv;return t._graphics={...this._graphics},t.offset=this.offset.clone(),t.opacity=this.opacity,t.anchor=this.anchor.clone(),t.copyGraphics=this.copyGraphics,t.onPreDraw=this.onPreDraw,t.onPostDraw=this.onPostDraw,t.visible=this.visible,t.layers=this.layers.clone(t),t}}class sx extends iC{constructor(t){super(t),this.width=t.width,this.height=t.height,this.rasterize()}clone(){return new sx({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.color&&t.fillRect(0,0,this.width,this.height),this.strokeColor&&t.strokeRect(0,0,this.width,this.height)}}class sy extends iC{get radius(){return this._radius}set radius(t){this._radius=t,this.width=2*this._radius,this.height=2*this._radius,this.flagDirty()}constructor(t){var e,i,s;super(t),this._radius=0;let r=null!==(e=t.lineWidth)&&void 0!==e?e:t.strokeColor?1:0;this.padding=null!==(i=t.padding)&&void 0!==i?i:2+r/2,this.radius=t.radius,this.filtering=null!==(s=t.filtering)&&void 0!==s?s:q.Blended,this.rasterize()}clone(){return new sy({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.radius>0&&(t.beginPath(),t.arc(this.radius,this.radius,this.radius,0,2*Math.PI),this.color&&t.fill(),this.strokeColor&&t.stroke())}}class sw extends iX{constructor(){super(...arguments),this.type="ex.pointer",this.useColliderShape=!0,this.useGraphicsBounds=!1}}class sb{static CreateReversibleEasingFunction(t){return(e,i,s,r)=>s<i?i-(t(e,s,i,r)-s):t(e,i,s,r)}static CreateVectorEasingFunction(t){return(e,i,s,r)=>new ey(t(e,i.x,s.x,r),t(e,i.y,s.y,r))}}sb.Linear=sb.CreateReversibleEasingFunction((t,e,i,s)=>(i-=e)*t/s+e),sb.EaseInQuad=sb.CreateReversibleEasingFunction((t,e,i,s)=>(i-=e)*(t/=s)*t+e),sb.EaseOutQuad=sb.CreateReversibleEasingFunction((t,e,i,s)=>-(i-=e)*(t/=s)*(t-2)+e),sb.EaseInOutQuad=sb.CreateReversibleEasingFunction((t,e,i,s)=>(i-=e,(t/=s/2)<1)?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e),sb.EaseInCubic=sb.CreateReversibleEasingFunction((t,e,i,s)=>(i-=e)*(t/=s)*t*t+e),sb.EaseOutCubic=sb.CreateReversibleEasingFunction((t,e,i,s)=>(i-=e,t/=s,i*(--t*t*t+1)+e)),sb.EaseInOutCubic=sb.CreateReversibleEasingFunction((t,e,i,s)=>(i-=e,(t/=s/2)<1)?i/2*t*t*t+e:i/2*((t-=2)*t*t+2)+e);class sC{constructor(t){this._actions=[],this._completedActions=[],this._entity=t}add(t){this._actions.push(t)}remove(t){let e=this._actions.indexOf(t);this._actions.splice(e,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}hasNext(){return this._actions.length>0}isComplete(){return 0===this._actions.length}reset(){this._actions=this.getActions();let t=this._actions.length;for(let e=0;e<t;e++)this._actions[e].reset();this._completedActions=[]}update(t){this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new t8(this._currentAction,this._entity))),this._currentAction.update(t),this._currentAction.isComplete(this._entity)&&(this._entity.emit("actioncomplete",new et(this._currentAction,this._entity)),this._completedActions.push(this._actions.shift())))}}class sA{constructor(t,e,i){this._stopped=!1,this._repeatBuilder=e,this._repeatContext=new sH(t),this._actionQueue=this._repeatContext.getQueue(),this._repeat=i,this._originalRepeat=i,this._repeatBuilder(this._repeatContext),this._repeat--}update(t){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(t)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class sT{constructor(t,e){this._stopped=!1,this._repeatBuilder=e,this._repeatContext=new sH(t),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(t){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(t))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}class sS{constructor(t,e,i,s){if(this._started=!1,this._stopped=!1,this._entity=t,this._tx=t.get(iY),this._motion=t.get(ij),this._speed=s,this._offset=new ey(e,i),s<=0)throw es.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+s),Error("Speed must be greater than 0 pixels per second")}update(t){this._started||(this._started=!0,this._start=new ey(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.size,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=ew(this._end.x,this._end.y),this._motion.vel=ew(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(t){let e=t.get(iY);return this._stopped||e.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=ew(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class sE{constructor(t,e,i,s){this.entity=t,this._started=!1,this._stopped=!1,this._tx=t.get(iY),this._motion=t.get(ij),this._end=new ey(e,i),this._speed=s}update(t){this._started||(this._started=!0,this._start=new ey(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());let e=this._dir.scale(this._speed);this._motion.vel=ew(e.x,e.y),this.isComplete(this.entity)&&(this._tx.pos=ew(this._end.x,this._end.y),this._motion.vel=ew(0,0))}isComplete(t){let e=t.get(iY);return this._stopped||new ey(e.pos.x,e.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=ew(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}(x=J||(J={}))[x.ShortestPath=0]="ShortestPath",x[x.LongestPath=1]="LongestPath",x[x.Clockwise=2]="Clockwise",x[x.CounterClockwise=3]="CounterClockwise";class sP{constructor(t,e,i,s){this._started=!1,this._stopped=!1,this._tx=t.get(iY),this._motion=t.get(ij),this._end=e,this._speed=i,this._rotationType=s||J.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;let t=Math.abs(this._end-this._start),e=ed-t;switch(t>e?(this._shortDistance=e,this._longDistance=t):(this._shortDistance=t,this._longDistance=e),this._shortestPathIsPositive=(this._start-this._end+ed)%ed>=Math.PI,this._rotationType){case J.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case J.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case J.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case J.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){let t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class sI{constructor(t,e,i,s){this._started=!1,this._stopped=!1,this._tx=t.get(iY),this._motion=t.get(ij),this._speed=i,this._offset=e,this._rotationType=s||J.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;let t=Math.abs(this._end-this._start),e=ed-t;switch(t>e?(this._shortDistance=e,this._longDistance=t):(this._shortDistance=t,this._longDistance=e),this._shortestPathIsPositive=(this._start-this._end+ed)%ed>=Math.PI,this._rotationType){case J.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case J.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case J.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case J.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){let t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}class sD{constructor(t,e,i,s,r){this._started=!1,this._stopped=!1,this._tx=t.get(iY),this._motion=t.get(ij),this._endX=e,this._endY=i,this._speedX=s,this._speedY=r}update(t){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{let t=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*t}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{let t=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*t}this.isComplete()&&(this._tx.scale=ew(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class sR{constructor(t,e,i,s){this._started=!1,this._stopped=!1,this._tx=t.get(iY),this._motion=t.get(ij),this._offset=new ey(e,i),this._speedX=this._speedY=s}update(t){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class sB{constructor(t){this._method=null,this._hasBeenCalled=!1,this._method=t}update(t){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class sF{constructor(t,e,i,s,r){this.easingFcn=r,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=new ey(0,0),this._lerpEnd=new ey(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(iY),this._motion=t.get(ij),this._lerpDuration=s,this._lerpEnd=new ey(e,i)}_initialize(){this._lerpStart=new ey(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let e=this._tx.pos.x,i=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(e=this._lerpEnd.x<this._lerpStart.x?this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),i=this._lerpEnd.y<this._lerpStart.y?this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=ew((e-this._tx.pos.x)/(t/1e3),(i-this._tx.pos.y)/(t/1e3))):(this._tx.pos=ew(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=ey.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=ew(0,0),this._stopped=!0}}class sk{constructor(t,e,i,s,r){this.easingFcn=r,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=new ey(0,0),this._lerpEnd=new ey(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(iY),this._motion=t.get(ij),this._lerpDuration=s,this._offset=new ey(e,i)}_initialize(){this._lerpStart=new ey(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let e=this._tx.pos.x,i=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(e=this._lerpEnd.x<this._lerpStart.x?this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),i=this._lerpEnd.y<this._lerpStart.y?this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=ew((e-this._tx.pos.x)/(t/1e3),(i-this._tx.pos.y)/(t/1e3))):(this._tx.pos=ew(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=ey.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=ew(0,0),this._stopped=!0}}class sM{constructor(t,e,i,s=1){this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=t.get(sv),this._timeVisible=e,this._timeNotVisible=i,this._duration=(e+i)*s}update(t){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=t,this._totalTime+=t,this._graphics.visible&&this._elapsedTime>=this._timeVisible&&(this._graphics.visible=!1,this._elapsedTime=0),!this._graphics.visible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.visible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.visible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.visible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class sL{constructor(t,e,i){this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=t.get(sv),this._endOpacity=e,this._speed=this._ogspeed=i}update(t){this._graphics&&(this._started||(this._started=!0,this._speed=this._ogspeed,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._speed>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*t)/this._speed),this._speed-=t,this.isComplete()&&(this._graphics.opacity=this._endOpacity),es.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||.05>Math.abs(this._graphics.opacity-this._endOpacity)}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class sz{constructor(t){this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=t}update(t){this._started||(this._started=!0),this._elapsedTime+=t}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class sU{constructor(t){this._stopped=!1,this._entity=t}update(t){this._entity.get(sW).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class sO{constructor(t,e,i){this._started=!1,this._stopped=!1,this._tx=t.get(iY),this._motion=t.get(ij),this._followTx=e.get(iY),this._followMotion=e.get(ij),this._current=new ey(this._tx.pos.x,this._tx.pos.y),this._end=new ey(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=void 0!==i?i:this._current.distance(this._end),this._speed=0}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());let e=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(0!==e&&(this._speed=e),this._current=ew(this._tx.pos.x,this._tx.pos.y),this._end=ew(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){let t=this._dir.scale(this._speed);this._motion.vel=ew(t.x,t.y)}else this._motion.vel=ew(0,0);this.isComplete()&&(this._tx.pos=ew(this._end.x,this._end.y),this._motion.vel=ew(0,0))}stop(){this._motion.vel=ew(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class sN{constructor(t,e,i){this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=t.get(iY),this._motion=t.get(ij),this._meetTx=e.get(iY),this._meetMotion=e.get(ij),this._current=new ey(this._tx.pos.x,this._tx.pos.y),this._end=new ey(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=i||0,void 0!==i&&(this._speedWasSpecified=!0)}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());let e=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));0===e||this._speedWasSpecified||(this._speed=e),this._current=ew(this._tx.pos.x,this._tx.pos.y),this._end=ew(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();let i=this._dir.scale(this._speed);this._motion.vel=ew(i.x,i.y),this.isComplete()&&(this._tx.pos=ew(this._end.x,this._end.y),this._motion.vel=ew(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=ew(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=void 0}}class sH{constructor(t){this._entity=t,this._queue=new sC(t)}getQueue(){return this._queue}update(t){this._queue.update(t)}clearActions(){this._queue.clearActions()}runAction(t){return t.reset(),this._queue.add(t),this}easeTo(...t){var e,i;let s=0,r=0,n=0,o=sb.Linear;return t[0]instanceof ey?(s=t[0].x,r=t[0].y,n=t[1],o=null!==(e=t[2])&&void 0!==e?e:o):(s=t[0],r=t[1],n=t[2],o=null!==(i=t[3])&&void 0!==i?i:o),this._queue.add(new sF(this._entity,s,r,n,o)),this}easeBy(...t){var e,i;let s=0,r=0,n=0,o=sb.Linear;return t[0]instanceof ey?(s=t[0].x,r=t[0].y,n=t[1],o=null!==(e=t[2])&&void 0!==e?e:o):(s=t[0],r=t[1],n=t[2],o=null!==(i=t[3])&&void 0!==i?i:o),this._queue.add(new sk(this._entity,s,r,n,o)),this}moveTo(t,e,i){let s=0,r=0,n=0;return t instanceof ey?(s=t.x,r=t.y,n=e):(s=t,r=e,n=i),this._queue.add(new sE(this._entity,s,r,n)),this}moveBy(t,e,i){let s=0,r=0,n=0;return t instanceof ey?(s=t.x,r=t.y,n=e):(s=t,r=e,n=i),this._queue.add(new sS(this._entity,s,r,n)),this}rotateTo(t,e,i){return this._queue.add(new sP(this._entity,t,e,i)),this}rotateBy(t,e,i){return this._queue.add(new sI(this._entity,t,e,i)),this}scaleTo(t,e,i,s){let r=1,n=1,o=0,a=0;return t instanceof ey&&e instanceof ey&&(r=t.x,n=t.y,o=e.x,a=e.y),"number"==typeof t&&"number"==typeof e&&(r=t,n=e,o=i,a=s),this._queue.add(new sD(this._entity,r,n,o,a)),this}scaleBy(t,e,i){let s=1,r=1;return t instanceof ey&&(s=t.x,r=t.y,i=e),"number"==typeof t&&"number"==typeof e&&(s=t,r=e),this._queue.add(new sR(this._entity,s,r,i)),this}blink(t,e,i=1){return this._queue.add(new sM(this._entity,t,e,i)),this}fade(t,e){return this._queue.add(new sL(this._entity,t,e)),this}delay(t){return this._queue.add(new sz(t)),this}die(){return this._queue.add(new sU(this._entity)),this}callMethod(t){return this._queue.add(new sB(t)),this}repeat(t,e){return e?this._queue.add(new sA(this._entity,t,e)):this.repeatForever(t),this}repeatForever(t){return this._queue.add(new sT(this._entity,t)),this}follow(t,e){return void 0===e?this._queue.add(new sO(this._entity,t)):this._queue.add(new sO(this._entity,t,e)),this}meet(t,e){return void 0===e?this._queue.add(new sN(this._entity,t)):this._queue.add(new sN(this._entity,t,e)),this}toPromise(){return new Promise(t=>{this._queue.add(new sB(()=>{t()}))})}}class sW extends iX{constructor(){super(...arguments),this.type="ex.actions",this.dependencies=[iY,ij]}onAdd(t){this._ctx=new sH(t)}onRemove(){this._ctx=null}getQueue(){var t;return null===(t=this._ctx)||void 0===t?void 0:t.getQueue()}runAction(t){var e;return null===(e=this._ctx)||void 0===e?void 0:e.runAction(t)}update(t){var e;return null===(e=this._ctx)||void 0===e?void 0:e.update(t)}clearActions(){var t;null===(t=this._ctx)||void 0===t||t.clearActions()}easeTo(...t){return this._ctx.easeTo.apply(this._ctx,t)}easeBy(...t){return this._ctx.easeBy.apply(this._ctx,t)}moveTo(t,e,i){return this._ctx.moveTo.apply(this._ctx,[t,e,i])}moveBy(t,e,i){return this._ctx.moveBy.apply(this._ctx,[t,e,i])}rotateTo(t,e,i){return this._ctx.rotateTo(t,e,i)}rotateBy(t,e,i){return this._ctx.rotateBy(t,e,i)}scaleTo(t,e,i,s){return this._ctx.scaleTo.apply(this._ctx,[t,e,i,s])}scaleBy(t,e,i){return this._ctx.scaleBy.apply(this._ctx,[t,e,i])}blink(t,e,i){return this._ctx.blink(t,e,i)}fade(t,e){return this._ctx.fade(t,e)}delay(t){return this._ctx.delay(t)}die(){return this._ctx.die()}callMethod(t){return this._ctx.callMethod(t)}repeat(t,e){return this._ctx.repeat(t,e)}repeatForever(t){return this._ctx.repeatForever(t)}follow(t,e){return this._ctx.follow(t,e)}meet(t,e){return this._ctx.meet(t,e)}toPromise(){return this._ctx.toPromise()}}(y=tt||(tt={})).Em="em",y.Rem="rem",y.Px="px",y.Pt="pt",y.Percent="%",(w=te||(te={})).Left="left",w.Right="right",w.Center="center",w.Start="start",w.End="end",(b=ti||(ti={})).Top="top",b.Hanging="hanging",b.Middle="middle",b.Alphabetic="alphabetic",b.Ideographic="ideographic",b.Bottom="bottom",(C=ts||(ts={})).Normal="normal",C.Italic="italic",C.Oblique="oblique",(A=tr||(tr={})).LeftToRight="ltr",A.RightToLeft="rtl";class sG{constructor(t,e,i,s){this.font=t,this.text=e,this.color=i,this.maxWidth=s,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.dimensions=this.measureText(e),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(t,e){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let i=null,s=(i=null!=e?this._getLinesFromText(t,e):t.split("\n")).reduce((t,e)=>t.length>e.length?t:e);this._applyFont(this.ctx);let r=this.ctx.measureText(s),n=Math.abs(r.actualBoundingBoxAscent)+Math.abs(r.actualBoundingBoxDescent),o=n*i.length;n=o;let a=o-Math.abs(r.actualBoundingBoxAscent);return new eA({left:0-Math.abs(r.actualBoundingBoxLeft)-this.font.padding,top:0-Math.abs(r.actualBoundingBoxAscent)-this.font.padding,bottom:0+a+this.font.padding,right:0+Math.abs(r.actualBoundingBoxRight)+this.font.padding})}_setDimension(t,e){e.canvas.width=(t.width+2*this.font.padding)*2*this.font.quality,e.canvas.height=(t.height+2*this.font.padding)*2*this.font.quality}static getHashCode(t,e,i){var s;return e+"__hashcode__"+t.fontString+t.showDebug+t.textAlign+t.baseAlign+t.direction+JSON.stringify(t.shadow)+(t.padding.toString()+t.smoothing.toString()+t.lineWidth.toString()+t.lineDash.toString()+(null===(s=t.strokeColor)||void 0===s?void 0:s.toString())+(i?i.toString():t.color.toString()))}getHashCode(t=!0){return sG.getHashCode(this.font,this.text,t?this.color:void 0)}_applyRasterProperties(t){var e,i;t.translate(this.font.padding,this.font.padding),t.imageSmoothingEnabled=this.font.smoothing,t.lineWidth=this.font.lineWidth,t.setLineDash(null!==(e=this.font.lineDash)&&void 0!==e?e:t.getLineDash()),t.strokeStyle=null===(i=this.font.strokeColor)||void 0===i?void 0:i.toString(),t.fillStyle=this.color.toString()}_applyFont(t){t.resetTransform(),t.translate(this.font.padding+t.canvas.width/2,this.font.padding+t.canvas.height/2),t.scale(this.font.quality,this.font.quality),t.textAlign=this.font.textAlign,t.textBaseline=this.font.baseAlign,t.font=this.font.fontString,t.direction=this.font.direction,this.font.shadow&&(t.shadowColor=this.font.shadow.color.toString(),t.shadowBlur=this.font.shadow.blur,t.shadowOffsetX=this.font.shadow.offset.x,t.shadowOffsetY=this.font.shadow.offset.y)}_drawText(t,e,i){this._applyRasterProperties(t),this._applyFont(t);for(let s=0;s<e.length;s++){let r=e[s];this.color&&t.fillText(r,0,s*i),this.font.strokeColor&&t.strokeText(r,0,s*i)}this.font.showDebug&&(im(t,eb.Green,-t.canvas.width/2,0,t.canvas.width/2,0,2),im(t,eb.Red,0,-t.canvas.height/2,0,t.canvas.height/2,2))}_splitTextBitmap(t){let e=[],i=0,s=0,r=Math.min(4096,t.canvas.width),n=Math.min(4096,t.canvas.height);for(;i<t.canvas.width;){for(;s<t.canvas.height;){let o=document.createElement("canvas");o.width=r,o.height=n,o.getContext("2d").drawImage(t.canvas,i,s,r,n,0,0,r,n),e.push({x:i,y:s,canvas:o}),s+=n}i+=r,s=0}return e}flagDirty(){this._dirty=!0}render(t,e,i,s){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=t;let r=this.getHashCode();if(this._lastHashCode!==r&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,s),this._setDimension(this.dimensions,this.ctx);let e=this._getLinesFromText(this.text,s),i=this.dimensions.height/e.length;if(this._drawText(this.ctx,e,i),t instanceof ih)for(let e of this._textFragments)t.textureLoader.delete(e.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),t instanceof ih)for(let e of this._textFragments)t.textureLoader.load(e.canvas,this.font.filtering,!0);this._lastHashCode=r,this._dirty=!1}for(let s of this._textFragments)t.drawImage(s.canvas,0,0,s.canvas.width,s.canvas.height,s.x/this.font.quality+e-this.ctx.canvas.width/this.font.quality/2,s.y/this.font.quality+i-this.ctx.canvas.height/this.font.quality/2,s.canvas.width/this.font.quality,s.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof ih)for(let t of this._textFragments)this._ex.textureLoader.delete(t.canvas);this._textFragments.length=0}_getLinesFromText(t,e){if(this._chachedText===t&&this._cachedRenderWidth===e)return this._chachedLines;let i=t.split("\n");if(null==e)return i;for(let t=0;t<i.length;t++){let s=i[t],r="";if(this.measureText(s).width>e){for(;this.measureText(s).width>e;)r=s[s.length-1]+r,s=s.slice(0,-1);i[t]=s,i[t+1]=r}}return this._chachedText=t,this._chachedLines=i,this._cachedRenderWidth=e,i}}class sV{static measureText(t,e,i){let s=sG.getHashCode(e,t);if(sV._MEASURE_CACHE.has(s))return sV._MEASURE_CACHE.get(s);sV._LOGGER.debug("Font text measurement cache miss");let r=e.measureTextWithoutCache(t,i);return sV._MEASURE_CACHE.set(s,r),r}static getTextInstance(t,e,i){let s=sG.getHashCode(e,t,i),r=sV._TEXT_CACHE.get(s);return r||(r=new sG(e,t,i),sV._TEXT_CACHE.set(s,r),sV._LOGGER.debug("Font text instance cache miss")),sV._TEXT_USAGE.set(r,performance.now()),r}static checkAndClearCache(){let t=[],e=new Set;for(let[i,s]of sV._TEXT_USAGE.entries())if(s+sV.FONT_TIMEOUT<performance.now())sV._LOGGER.debug(`Text cache entry timed out ${i.text}`),t.push(i),i.dispose();else{let t=i.getHashCode(!1);e.add(t)}for(let[e]of(t.forEach(t=>{sV._TEXT_USAGE.delete(t)}),this._TEXT_CACHE.clear(),this._TEXT_USAGE.entries()))this._TEXT_CACHE.set(e.getHashCode(),e);let i=new Map;for(let t of e)sV._MEASURE_CACHE.has(t)&&i.set(t,sV._MEASURE_CACHE.get(t));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=i}static get cacheSize(){return sV._TEXT_USAGE.size}static clearCache(){for(let[t]of sV._TEXT_USAGE.entries())t.dispose();sV._TEXT_USAGE.clear(),sV._TEXT_CACHE.clear(),sV._MEASURE_CACHE.clear()}}sV.FONT_TIMEOUT=500,sV._LOGGER=es.getInstance(),sV._TEXT_USAGE=new Map,sV._TEXT_CACHE=new Map,sV._MEASURE_CACHE=new Map;class sq extends eH{constructor(t={}){var e,i,s,r,n,o,a,h,l,d,c,u,p,_,g,m,f,v,x;super(t),this.filtering=q.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=eb.Black,this.family="sans-serif",this.style=ts.Normal,this.bold=!1,this.unit=tt.Px,this.textAlign=te.Left,this.baseAlign=ti.Alphabetic,this.direction=tr.LeftToRight,this.size=10,this.shadow=null,this._textBounds=new eA,this._textMeasurement=new sG(this,"",eb.Black),this.smoothing=null!==(e=null==t?void 0:t.smoothing)&&void 0!==e?e:this.smoothing,this.padding=null!==(i=null==t?void 0:t.padding)&&void 0!==i?i:this.padding,this.color=null!==(s=null==t?void 0:t.color)&&void 0!==s?s:this.color,this.strokeColor=null!==(r=null==t?void 0:t.strokeColor)&&void 0!==r?r:this.strokeColor,this.lineDash=null!==(n=null==t?void 0:t.lineDash)&&void 0!==n?n:this.lineDash,this.lineWidth=null!==(o=null==t?void 0:t.lineWidth)&&void 0!==o?o:this.lineWidth,this.filtering=null!==(a=null==t?void 0:t.filtering)&&void 0!==a?a:this.filtering,this.family=null!==(h=null==t?void 0:t.family)&&void 0!==h?h:this.family,this.style=null!==(l=null==t?void 0:t.style)&&void 0!==l?l:this.style,this.bold=null!==(d=null==t?void 0:t.bold)&&void 0!==d?d:this.bold,this.size=null!==(c=null==t?void 0:t.size)&&void 0!==c?c:this.size,this.unit=null!==(u=null==t?void 0:t.unit)&&void 0!==u?u:this.unit,this.textAlign=null!==(p=null==t?void 0:t.textAlign)&&void 0!==p?p:this.textAlign,this.baseAlign=null!==(_=null==t?void 0:t.baseAlign)&&void 0!==_?_:this.baseAlign,this.direction=null!==(g=null==t?void 0:t.direction)&&void 0!==g?g:this.direction,this.quality=null!==(m=null==t?void 0:t.quality)&&void 0!==m?m:this.quality,(null==t?void 0:t.shadow)&&(this.shadow={},this.shadow.blur=null!==(f=t.shadow.blur)&&void 0!==f?f:this.shadow.blur,this.shadow.offset=null!==(v=t.shadow.offset)&&void 0!==v?v:this.shadow.offset,this.shadow.color=null!==(x=t.shadow.color)&&void 0!==x?x:this.shadow.color)}clone(){return new sq({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:null})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(t,e,i){}_rotate(t){var e;let i=null!==(e=this.origin)&&void 0!==e?e:this._textBounds.center;t.translate(i.x,i.y),t.rotate(this.rotation),t.translate(-i.x,-i.y)}_flip(t){this.flipHorizontal&&(t.translate(this._textBounds.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,-this._textBounds.height/2/this.scale.y),t.scale(1,-1))}measureTextWithoutCache(t,e){return this._textMeasurement.measureText(t,e)}measureText(t,e){return sV.measureText(t,this,e)}_postDraw(t){t.restore()}render(t,e,i,s,r,n){let o=sV.getTextInstance(e,this,i);this._textBounds=o.dimensions,this._preDraw(t,s,r),o.render(t,s,r,n),this._postDraw(t)}}class sX extends eH{constructor(t){var e,i;super(t),this._text="",this._textWidth=0,this._textHeight=0,this.font=null!==(e=t.font)&&void 0!==e?e:new sq,this.color=null!==(i=t.color)&&void 0!==i?i:this.color,this.text=t.text,this.maxWidth=t.maxWidth}clone(){var t,e;return new sX({text:this.text.slice(),color:null!==(e=null===(t=this.color)||void 0===t?void 0:t.clone())&&void 0!==e?e:eb.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(t){this._text=t,this._calculateDimension()}get font(){return this._font}set font(t){this._font=t}get width(){return 0===this._textWidth&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return 0===this._textHeight&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){let{width:t,height:e}=this.font.measureText(this._text,this.maxWidth);this._textWidth=t,this._textHeight=e}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(t){}_flip(t){}_preDraw(t,e,i){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(t,e,i)}_drawImage(t,e,i){var s;let r=eb.Black;this.font instanceof sq&&(r=null!==(s=this.color)&&void 0!==s?s:this.font.color);let{width:n,height:o}=this.font.measureText(this._text,this.maxWidth);this._textWidth=n,this._textHeight=o,this.font.render(t,this._text,r,e,i,this.maxWidth),this.font.showDebug&&(t.debug.drawRect(e-n,i-o,2*n,2*o),null!=this.maxWidth&&t.debug.drawRect(e,i,this.maxWidth,this.height,{color:eb.Yellow}))}}class sZ extends s_{get body(){return this.get(sh)}get transform(){return this.get(iY)}get motion(){return this.get(ij)}get graphics(){return this.get(sv)}get collider(){return this.get(sa)}get pointer(){return this.get(sw)}get actions(){return this.get(sW)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t.clone()}get oldPos(){return this.body.oldPos}set oldPos(t){this.body.oldPos.setTo(t.x,t.y)}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t.clone()}get oldVel(){return this.body.oldVel}set oldVel(t){this.body.oldVel.setTo(t.x,t.y)}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t.clone()}set oldAcc(t){this.body.oldAcc.setTo(t.x,t.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(t){this.transform.rotation=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}get scale(){return this.get(iY).scale}set scale(t){this.get(iY).scale=t}get anchor(){return this._anchor}set anchor(t){this._anchor=eO(t,t=>this._handleAnchorChange(t)),this._handleAnchorChange(t)}_handleAnchorChange(t){this.graphics&&(this.graphics.anchor=t)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(t){t&&(t&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!t&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=t)}get color(){return this._color}set color(t){var e;this._color=t.clone();let i=null===(e=this.graphics.layers.default.graphics[0])||void 0===e?void 0:e.graphic;(i instanceof iC||i instanceof sX)&&(i.color=this._color)}constructor(t){super(),this.events=new tT,this._anchor=eO(ey.Half,t=>this._handleAnchorChange(t)),this.logger=es.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=t=>{this._dragging&&(this.pos=t.worldPos)},this._pointerDragLeaveHandler=t=>{this._dragging&&(this.pos=t.worldPos)};let{name:e,x:i,y:s,pos:r,coordPlane:n,scale:o,width:a,height:h,radius:l,collider:d,vel:c,acc:u,rotation:p,angularVelocity:_,z:g,color:m,visible:f,anchor:v,collisionType:x,collisionGroup:y}={...t};this._setName(e),this.anchor=null!=v?v:sZ.defaults.anchor.clone();let w=new iY;this.addComponent(w),this.pos=null!=r?r:ew(null!=i?i:0,null!=s?s:0),this.rotation=null!=p?p:0,this.scale=null!=o?o:ew(1,1),this.z=null!=g?g:0,w.coordPlane=null!=n?n:$.World,this.addComponent(new sw),this.addComponent(new sv({anchor:this.anchor})),this.addComponent(new ij),this.vel=null!=c?c:ey.Zero,this.acc=null!=u?u:ey.Zero,this.angularVelocity=null!=_?_:0,this.addComponent(new sW),this.addComponent(new sh),this.body.collisionType=null!=x?x:Z.Passive,y&&(this.body.group=y),d?this.addComponent(new sa(d)):l?this.addComponent(new sa(so.Circle(l))):a>0&&h>0?this.addComponent(new sa(so.Box(a,h,this.anchor))):this.addComponent(new sa),this.graphics.visible=null==f||f,m&&(this.color=m,a&&h?this.graphics.add(new sx({color:m,width:a,height:h})):l&&this.graphics.add(new sy({color:m,radius:l})))}clone(){let t=new sZ({color:this.color.clone(),anchor:this.anchor.clone()});for(let e of(t.clearComponents(),t.processComponentRemoval(),this.getComponents()))t.addComponent(e.clone(),!0);return t}onInitialize(t){}_initialize(t){for(let e of(super._initialize(t),this.children))e._initialize(t)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}_prekill(t){this.events.emit("prekill",new tP(this)),this.onPreKill(t)}onPreKill(t){}_postkill(t){this.events.emit("postkill",new tI(this)),this.onPostKill(t)}onPostKill(t){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new tE(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.active=!0}isKilled(){return!this.active}get z(){return this.get(iY).z}set z(t){this.get(iY).z=t}get center(){let t=this.getGlobalPos();return new ey(t.x+this.width/2-this.anchor.x*this.width,t.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new ey(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(iY).globalRotation}getGlobalPos(){return this.get(iY).globalPos}getGlobalScale(){return this.get(iY).globalScale}contains(t,e,i=!1){let s=ew(t,e),r=this.get(sa);r.update();let n=r.get();if(!n)return!1;let o=n.contains(s);return i?o||this.children.some(i=>i.contains(t,e,!0)):o}within(t,e){let i=this.get(sa),s=t.get(sa),r=i.get(),n=s.get();return!!r&&!!n&&r.getClosestLineBetween(n).getLength()<=e}update(t,e){this._initialize(t),this._preupdate(t,e),this._postupdate(t,e)}onPreUpdate(t,e){}onPostUpdate(t,e){}onPreCollisionResolve(t,e,i,s){}onPostCollisionResolve(t,e,i,s){}onCollisionStart(t,e,i,s){}onCollisionEnd(t,e){}_preupdate(t,e){this.events.emit("preupdate",new tU(t,e,this)),this.onPreUpdate(t,e)}_postupdate(t,e){this.events.emit("postupdate",new tO(t,e,this)),this.onPostUpdate(t,e)}}function sK(t){return t instanceof sY}sZ.defaults={anchor:ey.Half};class sY extends sZ{constructor(t){var e,i;super({...t}),this.get(iY).coordPlane=$.Screen,this.anchor=null!==(e=null==t?void 0:t.anchor)&&void 0!==e?e:ew(0,0),this.body.collisionType=null!==(i=null==t?void 0:t.collisionType)&&void 0!==i?i:Z.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!(null==t?void 0:t.collider)&&(null==t?void 0:t.width)>0&&(null==t?void 0:t.height)>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(t){this._engine=t,super._initialize(t)}contains(t,e,i=!0){if(i)return super.contains(t,e);let s=this._engine.worldToScreenCoordinates(new ey(t,e));return super.contains(s.x,s.y)}}class sj{get complete(){return this._complete}constructor(t,e,i,s,r,n){if(this._logger=es.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null,"function"!=typeof t){let o=t;t=o.fcn,e=o.interval,i=o.repeats,s=o.numberOfRepeats,r=o.randomRange,n=o.random}if(s&&s>=0&&(this.maxNumberOfRepeats=s,!i))throw Error("repeats must be set to true if numberOfRepeats is set");if(this.id=sj._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=e,r){if(r[0]>r[1])throw Error("min value must be lower than max value for range");this.random=null!=n?n:new el,this.randomRange=r,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=i||this.repeats,t&&this.on(t)}on(t){this._callbacks.push(t)}off(t){let e=this._callbacks.indexOf(t);this._callbacks.splice(e,1)}update(t){this._running&&(this._totalTimeAlive+=t,this._elapsedTime+=t,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(t=>{t.call(this)}),this._numberOfTicks++,this.repeats||(this._complete=!0,this._running=!1),this._elapsedTime=0))}reset(t,e){if(t&&t>=0&&(this._baseInterval=this.interval=t),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=e,!this.repeats))throw Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}sj._MAX_ID=0;class s$ extends iX{constructor(t){super(),this.type="ex.parallax",this.parallaxFactor=ew(1,1),this.parallaxFactor=null!=t?t:this.parallaxFactor}}class sQ extends iX{constructor(t,e=!0){super(),this.draw=t,this.useTransform=e,this.type="ex.debuggraphics"}}class sJ{constructor(t,e){this.bounds=t,this.options=e,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...e},this.halfWidth=t.width/2,this.halfHeight=t.height/2}_split(){this._isDivided=!0;let t={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new sJ(new eA({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),t),this.topRight=new sJ(new eA({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),t),this.bottomLeft=new sJ(new eA({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),t),this.bottomRight=new sJ(new eA({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),t)}_insertIntoSubNodes(t){var e,i,s,r;(null===(e=this.topLeft)||void 0===e?void 0:e.bounds.overlaps(t.bounds))&&this.topLeft.insert(t),(null===(i=this.topRight)||void 0===i?void 0:i.bounds.overlaps(t.bounds))&&this.topRight.insert(t),(null===(s=this.bottomLeft)||void 0===s?void 0:s.bounds.overlaps(t.bounds))&&this.bottomLeft.insert(t),(null===(r=this.bottomRight)||void 0===r?void 0:r.bounds.overlaps(t.bounds))&&this.bottomRight.insert(t)}insert(t){if(this._isDivided){this._insertIntoSubNodes(t);return}if(this.items.push(t),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){for(let t of(this._isDivided||this._split(),this.items))this._insertIntoSubNodes(t);this.items.length=0}}remove(t){var e,i,s,r;if(this.bounds.overlaps(t.bounds)){if(!this._isDivided){let e=this.items.indexOf(t);e>-1&&this.items.splice(e,1);return}(null===(e=this.topLeft)||void 0===e?void 0:e.bounds.overlaps(t.bounds))&&this.topLeft.remove(t),(null===(i=this.topRight)||void 0===i?void 0:i.bounds.overlaps(t.bounds))&&this.topRight.remove(t),(null===(s=this.bottomLeft)||void 0===s?void 0:s.bounds.overlaps(t.bounds))&&this.bottomLeft.remove(t),(null===(r=this.bottomRight)||void 0===r?void 0:r.bounds.overlaps(t.bounds))&&this.bottomRight.remove(t)}}query(t){let e=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(t)&&(e=e.concat(this.topLeft.query(t))),this.topRight.bounds.overlaps(t)&&(e=e.concat(this.topRight.query(t))),this.bottomLeft.bounds.overlaps(t)&&(e=e.concat(this.bottomLeft.query(t))),this.bottomRight.bounds.overlaps(t)&&(e=e.concat(this.bottomRight.query(t)))),e=e.filter((t,i)=>e.indexOf(t)>=i)}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let t=this.items;return this._isDivided&&(t=(t=(t=(t=t.concat(this.topLeft.getAllItems())).concat(this.topRight.getAllItems())).concat(this.bottomLeft.getAllItems())).concat(this.bottomRight.getAllItems())),t=t.filter((e,i)=>t.indexOf(e)>=i)}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(t){this.bounds.draw(t,eb.Yellow),this._isDivided&&(this.topLeft.bounds.draw(t,eb.Yellow),this.topRight.bounds.draw(t,eb.Yellow),this.bottomLeft.bounds.draw(t,eb.Yellow),this.bottomRight.bounds.draw(t,eb.Yellow))}}let s0={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw"};class s1 extends s_{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let t=0;t<this.tiles.length;t++)this.tiles[t]&&this.tiles[t].flagDirty()}get x(){var t;return null!==(t=this._transform.pos.x)&&void 0!==t?t:0}set x(t){var e;(null===(e=this._transform)||void 0===e?void 0:e.pos)&&(this.get(iY).pos=ew(t,this.y))}get y(){var t,e;return null!==(e=null===(t=this._transform)||void 0===t?void 0:t.pos.y)&&void 0!==e?e:0}set y(t){var e;(null===(e=this._transform)||void 0===e?void 0:e.pos)&&(this._transform.pos=ew(this.x,t))}get z(){var t;return null!==(t=this._transform.z)&&void 0!==t?t:0}set z(t){this._transform&&(this._transform.z=t)}get rotation(){var t,e;return null!==(e=null===(t=this._transform)||void 0===t?void 0:t.rotation)&&void 0!==e?e:0}set rotation(t){this._transform&&(this._transform.rotation=t)}get scale(){var t,e;return null!==(e=null===(t=this._transform)||void 0===t?void 0:t.scale)&&void 0!==e?e:ey.One}set scale(t){var e;(null===(e=this._transform)||void 0===e?void 0:e.scale)&&(this._transform.scale=t)}get pos(){return this._transform.pos}set pos(t){this._transform.pos=t}get vel(){return this._motion.vel}set vel(t){this._motion.vel=t}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}constructor(t){var e,i;super(null,t.name),this.events=new tT,this._token=0,this.logger=es.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this._collidersDirty=!0,this._originalOffsets=new WeakMap,this.addComponent(new iY),this.addComponent(new ij),this.addComponent(new sh({type:Z.Fixed})),this.addComponent(new sv({onPostDraw:(t,e)=>this.draw(t,e)})),this.addComponent(new sQ((t,e)=>this.debug(t,e),!1)),this.addComponent(new sa),this._graphics=this.get(sv),this._transform=this.get(iY),this._motion=this.get(ij),this._collider=this.get(sa),this._composite=this._collider.useCompositeCollider([]),this._transform.pos=null!==(e=t.pos)&&void 0!==e?e:ey.Zero,this._oldPos=this._transform.pos.clone(),this._oldScale=this._transform.scale.clone(),this.renderFromTopOfGraphic=null!==(i=t.renderFromTopOfGraphic)&&void 0!==i?i:this.renderFromTopOfGraphic,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight,this.rows=t.rows,this.columns=t.columns,this._quadTree=new sJ(eA.fromDimension(this.columns*this.tileWidth,this.rows*this.tileHeight,ey.Zero,this.pos)),this.tiles=Array(this.rows*this.columns),this._rows=Array(this.rows),this._cols=Array(this.columns);let s=[];for(let t=0;t<this.columns;t++){for(let e=0;e<this.rows;e++){let i=new s2({x:t,y:e,map:this});i.map=this,this._quadTree.insert(i),this.tiles[t+e*this.columns]=i,s.push(i),this._rows[e]||(this._rows[e]=[]),this._rows[e].push(i)}this._cols[t]=s,s=[]}this._graphics.localBounds=new eA({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(t){super._initialize(t),this._engine=t}_getOrSetColliderOriginalOffset(t){if(this._originalOffsets.has(t))return this._originalOffsets.get(t);{let e=t.offset;return this._originalOffsets.set(t,e),e}}_updateQuadTree(){this._quadTree=new sJ(eA.fromDimension(this.columns*this.tileWidth,this.rows*this.tileHeight,ey.Zero,ey.Zero).scale(this.scale).translate(this.pos).rotate(this.rotation,this.pos));for(let t=0;t<this.tiles.length;t++)this._quadTree.insert(this.tiles[t])}_updateColliders(){let t;this._collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();let e=[];this._composite=this._collider.useCompositeCollider([]);let i=(t,e)=>!!t&&!!e&&t.top===e.top&&t.bottom===e.bottom&&t.right===e.left,s=(t,e,s=10)=>{if(!t)return!1;for(let r=e.length-1;r>=0&&!(s--<0);r--){let s=e[r];if(i(s,t))return e[r]=s.combine(t),!0}return!1};for(let i=0;i<this.columns;i++){for(let r=0;r<this.rows;r++){let n=this.tiles[i+r*this.columns];if(n.solid){if(n.getColliders().length>0){for(let t of n.getColliders()){let e=this._getOrSetColliderOriginalOffset(t);t.offset=ew(n.x*this.tileWidth*this.scale.x,n.y*this.tileHeight*this.scale.y).add(e),t.owner=this,this._composite.addCollider(t)}t&&!s(t,e)&&e.push(t),t=null}else t=t?t.combine(n.defaultGeometry):n.defaultGeometry}else t&&!s(t,e)&&e.push(t),t=null}t&&!s(t,e)&&e.push(t),t=null}for(let t of e){let e=so.Box(t.width,t.height,ey.Zero,ew(t.left-this.pos.x,t.top-this.pos.y));e.owner=this,this._composite.addCollider(e)}this._collider.update(),this._collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(t){return this.tiles[t]}getTile(t,e){return t<0||e<0||t>=this.columns||e>=this.rows?null:this.tiles[t+e*this.columns]}getTileByPoint(t){let e=Math.floor((t.x-this.pos.x)/(this.tileWidth*this.scale.x)),i=Math.floor((t.y-this.pos.y)/(this.tileHeight*this.scale.y)),s=this.getTile(e,i);return e>=0&&i>=0&&e<this.columns&&i<this.rows&&s?s:null}getRows(){return this._rows}getColumns(){return this._cols}update(t,e){this.onPreUpdate(t,e),this.emit("preupdate",new tU(t,e,this)),this._oldPos.equals(this.pos)&&this._oldRotation===this.rotation&&this._oldScale.equals(this.scale)||(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders(),this._updateQuadTree()),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this._transform.pos=this.pos,this.onPostUpdate(t,e),this.emit("postupdate",new tO(t,e,this))}draw(t,e){let i,s,r;this.emit("predraw",new tB(t,e,this));let n=this._engine.screen.getWorldBounds(),o=this._engine.screen.getScreenBounds(),a=this._transform.coordPlane===$.Screen,h=this.get(s$);if(h){let t=this.pos,e=ey.One.sub(h.parallaxFactor),i=this._engine.currentScene.camera.pos.scale(e);t=t.sub(i),n=n.translate(t)}let l=this._quadTree.query(a?o:n);for(let n=0;n<l.length;n++){let o=l[n],a=o.getGraphicsOffsets();for(s=0,r=(i=o.getGraphics()).length;s<r;s++){let r=i[s],n=a[s];if(r){sg(r)&&(null==r||r.tick(e,this._token));let i=this.renderFromTopOfGraphic?0:r.height-this.tileHeight;r.draw(t,o.x*this.tileWidth+n.x,o.y*this.tileHeight-i+n.y)}}}this.emit("postdraw",new tF(t,e,this))}debug(t,e){let{showAll:i,showGrid:s,gridColor:r,gridWidth:n,showSolidBounds:o,solidBoundsColor:a,showColliderGeometry:h,showQuadTree:l}=e.tilemap,{geometryColor:d,geometryLineWidth:c,geometryPointSize:u}=e.collider,p=this.tileWidth*this.columns*this.scale.x,_=this.tileHeight*this.rows*this.scale.y,g=this.pos;if(s||i){for(let e=0;e<this.rows+1;e++){let i=ew(0,e*this.tileHeight*this.scale.y);t.drawLine(g.add(i),g.add(ew(p,i.y)),r,n)}for(let e=0;e<this.columns+1;e++){let i=ew(e*this.tileWidth*this.scale.x,0);t.drawLine(g.add(i),g.add(ew(i.x,_)),r,n)}}if(i||o||h){let e=this._composite.getColliders();for(let i of(t.save(),t.translate(this.pos.x,this.pos.y),t.scale(this.scale.x,this.scale.y),e)){let e=i.localBounds,s=i.worldPos.sub(this.pos);o&&t.drawRectangle(s,e.width,e.height,a)}if(t.restore(),h)for(let i of e)i.debug(t,d,{lineWidth:c,pointSize:u})}if(i||l||o){if(t.save(),t.z=999,l&&this._quadTree.debug(t),o)for(let e=0;e<this.tiles.length;e++)this.tiles[e].bounds.draw(t);t.restore()}}}class s2 extends s_{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(t){var e;null===(e=this.map)||void 0===e||e.flagCollidersDirty(),this._solid=t}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(t,e){this._graphics.push(t),(null==e?void 0:e.offset)?this._offsets.push(e.offset):this._offsets.push(ey.Zero)}removeGraphic(t){let e=this._graphics.indexOf(t);e>-1&&(this._graphics.splice(e,1),this._offsets.splice(e,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){let e=this._colliders.indexOf(t);e>-1&&this._colliders.splice(e,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(t){var e,i;super(),this._posDirty=!1,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=t.x,this.y=t.y,this.map=t.map,this._width=t.map.tileWidth*this.map.scale.x,this._height=t.map.tileHeight*this.map.scale.y,this.solid=null!==(e=t.solid)&&void 0!==e?e:this.solid,this._graphics=null!==(i=t.graphics)&&void 0!==i?i:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){let t=this.map.pos.add(ew(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new eA(t.x,t.y,t.x+this.map.tileWidth,t.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(ew(this.x*this._width,this.y*this._height)),this._bounds=new eA(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new ey(this._pos.x+this._width/2,this._pos.y+this._height/2)}}class s5{constructor(t){this.camera=t}lockToActor(t){this.camera.addStrategy(new s4(t))}lockToActorAxis(t,e){this.camera.addStrategy(new s3(t,e))}elasticToActor(t,e,i){this.camera.addStrategy(new s6(t,e,i))}radiusAroundActor(t,e){this.camera.addStrategy(new s9(t,e))}limitCameraBounds(t){this.camera.addStrategy(new s7(t))}}(T=tn||(tn={}))[T.X=0]="X",T[T.Y=1]="Y";class s4{constructor(t){this.target=t,this.action=(t,e,i,s)=>t.center}}class s3{constructor(t,e){this.target=t,this.axis=e,this.action=(t,e,i,s)=>{let r=t.center,n=e.getFocus();return this.axis===tn.X?new ey(r.x,n.y):new ey(n.x,r.y)}}}class s6{constructor(t,e,i){this.target=t,this.cameraElasticity=e,this.cameraFriction=i,this.action=(t,e,i,s)=>{let r=t.center,n=e.getFocus(),o=e.vel.clone(),a=r.sub(n).scale(this.cameraElasticity),h=(o=o.add(a)).scale(-1).scale(this.cameraFriction);return o=o.add(h),n=n.add(o)}}}class s9{constructor(t,e){this.target=t,this.radius=e,this.action=(t,e,i,s)=>{let r=t.center,n=e.getFocus(),o=r.sub(n),a=o.size;if(a>=this.radius){let t=a-this.radius;return n.add(o.normalize().scale(t))}return n}}}class s7{constructor(t){this.target=t,this.boundSizeChecked=!1,this.action=(t,e,i,s)=>{let r=e.getFocus();this.boundSizeChecked||((t.bottom-t.top<i.drawHeight||t.right-t.left<i.drawWidth)&&es.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let n=r.x,o=r.y;return r.x<t.left+i.halfDrawWidth?n=t.left+i.halfDrawWidth:r.x>t.right-i.halfDrawWidth&&(n=t.right-i.halfDrawWidth),r.y<t.top+i.halfDrawHeight?o=t.top+i.halfDrawHeight:r.y>t.bottom-i.halfDrawHeight&&(o=t.bottom-i.halfDrawHeight),ew(n,o)}}}let s8={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class rt{constructor(){this.events=new tT,this.transform=ek.identity(),this.inverse=ek.identity(),this._cameraStrategies=[],this.strategy=new s5(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=eN(ey.Zero,()=>this._posChanged=!0),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=ey.Zero,this.acc=ey.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=sb.EaseInOutCubic,this._easing=sb.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1}get zoom(){return this._z}set zoom(t){this._z=t,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(t){this._angularVelocity=t}get pos(){return this._pos}set pos(t){this._pos=eN(t,()=>this._posChanged=!0),this._posChanged=!0}get x(){return this.pos.x}set x(t){this._follow||this._cameraMoving||(this.pos=ew(t,this.pos.y))}get y(){return this.pos.y}set y(t){this._follow||this._cameraMoving||(this.pos=ew(this.pos.x,t))}get dx(){return this.vel.x}set dx(t){this.vel=ew(t,this.vel.y)}get dy(){return this.vel.y}set dy(t){this.vel=ew(this.vel.x,t)}get ax(){return this.acc.x}set ax(t){this.acc=ew(t,this.acc.y)}get ay(){return this.acc.y}set ay(t){this.acc=ew(this.acc.x,t)}getFocus(){return this.pos}move(t,e,i=sb.EaseInOutCubic){if("function"!=typeof i)throw"Please specify an EasingFunction";return this._follow?Promise.reject(t):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(t),this._lerpPromise=new Promise(t=>{this._lerpResolve=t}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=e,this._lerpEnd=t,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=i,this._lerpPromise)}shake(t,e,i){this._isShaking=!0,this._shakeMagnitudeX=t,this._shakeMagnitudeY=e,this._shakeDuration=i}zoomOverTime(t,e=0,i=sb.EaseInOutCubic){return(this._zoomPromise=new Promise(t=>{this._zoomResolve=t}),e)?(this._isZooming=!0,this._zoomEasing=i,this._currentZoomTime=0,this._zoomDuration=e,this._zoomStart=this.zoom,this._zoomEnd=t,this._zoomPromise):(this._isZooming=!1,this.zoom=t,Promise.resolve(!0))}get viewport(){return this._viewport?this._viewport:new eA(0,0,0,0)}addStrategy(t){this._cameraStrategies.push(t)}removeStrategy(t){eP(t,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(t,e){this.events.emit("preupdate",new tU(t,e,this)),this.onPreUpdate(t,e)}onPreUpdate(t,e){}_postupdate(t,e){this.events.emit("postupdate",new tO(t,e,this)),this.onPostUpdate(t,e)}onPostUpdate(t,e){}get isInitialized(){return this._isInitialized}_initialize(t){if(!this.isInitialized){this._engine=t,this._screen=t.screen;let e=this._screen.contentArea,i=ew(e.width/2,e.height/2);if(!this._engine.loadingComplete){let t=this._screen.peekResolution();t&&(i=ew(t.width/2,t.height/2))}this._halfWidth=i.x,this._halfHeight=i.y,this._posChanged||(this.pos=i),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(t,t.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(t),this.events.emit("initialize",new t2(t,this)),this._isInitialized=!0}}onInitialize(t){}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}runStrategies(t,e){for(let i of this._cameraStrategies)this.pos=i.action.call(i,i.target,this,t,e)}updateViewport(){this._viewport=new eA(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(t,e){if(this._initialize(t),this._preupdate(t,e),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(e/1e3)),this.zoom+=this.dz*e/1e3,this.vel=this.vel.add(this.acc.scale(e/1e3)),this.dz+=this.az*e/1e3,this.rotation+=this.angularVelocity*e/1e3,this._isZooming){if(this._currentZoomTime<this._zoomDuration){let t=(0,this._zoomEasing)(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=t,this._currentZoomTime+=e}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0)}if(this._cameraMoving){if(this._currentLerpTime<this._lerpDuration){let t=sb.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=t,this._currentLerpTime+=e}else{this.pos=this._lerpEnd;let t=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(t)}}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=e,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(t,e),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(t,e)}draw(t){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateFps){let t=this._engine.currentFrameLagMs/(1e3/this._engine.fixedUpdateFps),e=this.pos.scale(t).add(this._oldPos.scale(1-t));e.clone(this.drawPos),this.updateTransform(e)}t.multiply(this.transform)}updateTransform(t){let e=this._screen.resolution.width/this.zoom,i=this._screen.resolution.height/this.zoom,s=ew(-t.x+e/2+this._xShake,-t.y+i/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(e/2,i/2),this.transform.rotate(this.rotation),this.transform.translate(-e/2,-i/2),this.transform.translate(s.x,s.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}let re={ExitTrigger:"exit",EnterTrigger:"enter"},ri={pos:ey.Zero,width:10,height:10,visible:!1,action:()=>{},filter:()=>!0,repeat:-1};class rs extends sZ{constructor(t){super({x:t.pos.x,y:t.pos.y,width:t.width,height:t.height}),this.events=new tT,this.action=()=>{},this.filter=()=>!0,this.repeat=-1,t={...ri,...t},this.filter=t.filter||this.filter,this.repeat=t.repeat||this.repeat,this.action=t.action||this.action,t.target&&(this.target=t.target),this.graphics.visible=t.visible,this.body.collisionType=Z.Passive,this.events.on("collisionstart",t=>{this.filter(t.other)&&(this.events.emit("enter",new t9(this,t.other)),this._dispatchAction(),0===this.repeat&&this.kill())}),this.events.on("collisionend",t=>{this.filter(t.other)&&this.events.emit("exit",new t7(this,t.other))})}set target(t){this._target=t,this.filter=e=>e===t}get target(){return this._target}_initialize(t){super._initialize(t)}_dispatchAction(){0!==this.repeat&&(this.action.call(this),this.repeat--)}}(S=to||(to={})).Update="update",S.Draw="draw";class rr{constructor(){this.priority=0}notify(t){}}class rn{constructor(t){this.data=t,this.type="Entity Added"}}function ro(t){return!!t&&"Entity Added"===t.type}class ra{constructor(t){this.data=t,this.type="Entity Removed"}}function rh(t){return!!t&&"Entity Removed"===t.type}class rl{constructor(t){this._world=t,this.entities=[],this._entityIndex={},this._entitiesToRemove=[]}updateEntities(t,e){for(let i of this.entities)i.update(t.engine,e),i.active||this.removeEntity(i)}findEntitiesForRemoval(){for(let t of this.entities)t.active||this.removeEntity(t)}notify(t){sd(t)&&this._world.queryManager.addEntity(t.data.entity),su(t)&&this._world.queryManager.removeComponent(t.data.entity,t.data.component)}addEntity(t){t.active=!0,t.scene=this._world.context,t&&!this._entityIndex[t.id]&&(this._entityIndex[t.id]=t,this.entities.push(t),this._world.queryManager.addEntity(t),t.componentAdded$.register(this),t.componentRemoved$.register(this),t.children.forEach(e=>{e.scene=t.scene,this.addEntity(e)}),t.childrenAdded$.register({notify:t=>{this.addEntity(t)}}),t.childrenRemoved$.register({notify:t=>{this.removeEntity(t,!1)}}))}removeEntity(t,e=!0){var i;let s=0;s=t instanceof s_?t.id:t;let r=this._entityIndex[s];if(r&&r.active&&(r.active=!1),r&&e){this._entitiesToRemove.push(r);return}delete this._entityIndex[s],r&&(r.scene=null,eP(r,this.entities),this._world.queryManager.removeEntity(r),r.componentAdded$.unregister(this),r.componentRemoved$.unregister(this),r.children.forEach(t=>{t.scene=null,this.removeEntity(t,e)}),r.childrenAdded$.clear(),r.childrenRemoved$.clear(),(null===(i=this._world.context)||void 0===i?void 0:i.engine)&&this._world.context.engine.stats.currFrame.actors.killed++)}processEntityRemovals(){for(let t of this._entitiesToRemove)t.active||this.removeEntity(t,!1);this._entitiesToRemove.length=0}processComponentRemovals(){for(let t of this.entities)t.processComponentRemoval()}getById(t){return this._entityIndex[t]}getByName(t){return this.entities.filter(e=>e.name===t)}clear(){for(let t=this.entities.length-1;t>=0;t--)this.removeEntity(this.entities[t])}}let rd=t=>[...t].sort((t,e)=>t.localeCompare(e)).join("+");class rc extends iK{get key(){return this._key?this._key:this._key=rd(this.types)}constructor(t){super(),this._entities=[],t[0]instanceof Function?this.types=t.map(t=>(new t).type):this.types=t}getEntities(t){return t&&this._entities.sort(t),this._entities}addEntity(t){!eI(this._entities,t)&&this.matches(t)&&(this._entities.push(t),this.notifyAll(new rn(t)))}removeEntity(t){eP(t,this._entities)&&this.notifyAll(new ra(t))}clear(){this._entities.length=0;for(let t=this.observers.length-1;t>=0;t--)this.unregister(this.observers[t])}matches(t){let e=[];e=t instanceof s_?t.types:t;let i=!0;for(let t of this.types)if(!(i=i&&e.indexOf(t)>-1))return!1;return i}contain(t){return this.types.indexOf(t)>-1}}class ru{constructor(t){this._world=t,this._queries={}}_addQuery(t){for(let e of(this._queries[rd(t.types)]=t,this._world.entityManager.entities))t.addEntity(e)}maybeRemoveQuery(t){0===t.observers.length&&(t.clear(),delete this._queries[rd(t.types)])}addEntity(t){for(let e in this._queries)this._queries[e]&&this._queries[e].addEntity(t)}removeComponent(t,e){for(let i in this._queries)this._queries[i].contain(e.type)&&this._queries[i].removeEntity(t)}removeEntity(t){for(let e in this._queries)this._queries[e].removeEntity(t)}createQuery(t){let e=this.getQuery(t);if(e)return e;let i=new rc(t);return this._addQuery(i),i}getQuery(t){let e=rd(t);return this._queries[e]?this._queries[e]:null}}class rp{constructor(t){this._world=t,this.systems=[],this.initialized=!1}get(t){return this.systems.find(e=>e instanceof t)}addSystem(t){if(!t.types||0===t.types.length)throw Error("Attempted to add a System without any types");let e=this._world.queryManager.createQuery(t.types);this.systems.push(t),this.systems.sort((t,e)=>t.priority-e.priority),e.register(t),this.initialized&&t.initialize&&t.initialize(this._world.context)}removeSystem(t){eP(t,this.systems);let e=this._world.queryManager.getQuery(t.types);e&&(e.unregister(t),this._world.queryManager.maybeRemoveQuery(e))}initialize(){if(!this.initialized)for(let t of(this.initialized=!0,this.systems))t.initialize&&t.initialize(this._world.context)}updateSystems(t,e,i){let s=this.systems.filter(e=>e.systemType===t);for(let t of s)t.preupdate&&t.preupdate(e,i);for(let t of s){let s=this._world.queryManager.getQuery(t.types).getEntities(t.sort);if(e instanceof rz)for(let t of s)t._initialize(null==e?void 0:e.engine);t.update(s,i)}for(let t of s)t.postupdate&&t.postupdate(e,i)}clear(){for(let t=this.systems.length-1;t>=0;t--)this.removeSystem(this.systems[t])}}class r_{constructor(t){this.context=t,this.queryManager=new ru(this),this.entityManager=new rl(this),this.systemManager=new rp(this)}update(t,e){t===to.Update&&this.entityManager.updateEntities(this.context,e),this.systemManager.updateSystems(t,this.context,e),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(t){t instanceof s_&&this.entityManager.addEntity(t),t instanceof rr&&this.systemManager.addSystem(t)}remove(t,e=!0){t instanceof s_&&this.entityManager.removeEntity(t,e),t instanceof rr&&this.systemManager.removeSystem(t)}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class rg{static integrate(t,e,i,s){let r=s/1e3;e.vel.addEqual(i.scale(r,rg._ACC)),t.pos.add(e.vel.scale(r,rg._VEL),rg._POS).addEqual(i.scale(.5*r*r,rg._VEL_ACC)),e.angularVelocity+=e.torque*(1/e.inertia)*r;let n=t.rotation+e.angularVelocity*r;t.scale.add(e.scaleFactor.scale(r,this._SCALE_FACTOR),rg._SCALE),t.get().setTransform(rg._POS,n,rg._SCALE)}}rg._POS=new ey(0,0),rg._SCALE=new ey(1,1),rg._ACC=new ey(0,0),rg._VEL=new ey(0,0),rg._VEL_ACC=new ey(0,0),rg._SCALE_FACTOR=new ey(0,0);class rm extends rr{constructor(){super(...arguments),this.types=["ex.transform","ex.motion"],this.systemType=to.Update,this.priority=-1}update(t,e){let i,s;for(let r=0;r<t.length;r++){i=t[r].get(iY),s=t[r].get(ij);let n=t[r].get(sh);if(null==n?void 0:n.sleeping)continue;let o=s.acc.clone();(null==n?void 0:n.collisionType)===Z.Active&&(null==n?void 0:n.useGravity)&&o.addEqual(iW.gravity),null==n||n.captureOldTransform(),rg.integrate(i,s,o,e)}}}class rf{constructor(){this.directionMap=new Map,this.distanceMap=new Map}solve(t){for(let e of(this.preSolve(t),(t=t.filter(t=>!t.isCanceled())).sort((t,e)=>this.distanceMap.get(t.id)-this.distanceMap.get(e.id)),t))this.solvePosition(e),this.solveVelocity(e);return this.postSolve(t),t}preSolve(t){for(let e of t){if(1e-4>Math.abs(e.mtv.x)&&1e-4>Math.abs(e.mtv.y)){e.cancel();continue}let t=G.fromDirection(e.mtv),i=e.mtv.negate(),s=e.colliderA.worldPos.squareDistance(e.colliderB.worldPos);this.distanceMap.set(e.id,s),e.colliderA.events.emit("precollision",new tK(e.colliderA,e.colliderB,t,i,e)),e.colliderB.events.emit("precollision",new tK(e.colliderB,e.colliderA,G.getOpposite(t),i.negate(),e))}}postSolve(t){var e,i;for(let s of t){if(s.isCanceled())continue;let t=s.colliderA,r=s.colliderB,n=null===(e=t.owner)||void 0===e?void 0:e.get(sh),o=null===(i=r.owner)||void 0===i?void 0:i.get(sh);if(n&&o&&(n.collisionType===Z.Passive||o.collisionType===Z.Passive))continue;let a=G.fromDirection(s.mtv),h=s.mtv.negate();s.colliderA.events.emit("postcollision",new tY(s.colliderA,s.colliderB,a,h,s)),s.colliderB.events.emit("postcollision",new tY(s.colliderB,s.colliderA,G.getOpposite(a),h.negate(),s))}}solvePosition(t){var e,i;if(!t.colliderA.bounds.overlaps(t.colliderB.bounds,1e-4)||1e-4>Math.abs(t.mtv.x)&&1e-4>Math.abs(t.mtv.y)){t.cancel();return}let s=t.mtv,r=t.colliderA,n=t.colliderB,o=null===(e=r.owner)||void 0===e?void 0:e.get(sh),a=null===(i=n.owner)||void 0===i?void 0:i.get(sh);if(o&&a){if(o.collisionType===Z.Passive||a.collisionType===Z.Passive)return;o.collisionType===Z.Active&&a.collisionType===Z.Active&&(s=s.scale(.5)),o.collisionType===Z.Active&&(o.globalPos.x-=s.x,o.globalPos.y-=s.y,r.update(o.transform.get())),a.collisionType===Z.Active&&(a.globalPos.x+=s.x,a.globalPos.y+=s.y,n.update(a.transform.get()))}}solveVelocity(t){var e,i;if(t.isCanceled())return;let s=t.colliderA,r=t.colliderB,n=null===(e=s.owner)||void 0===e?void 0:e.get(sh),o=null===(i=r.owner)||void 0===i?void 0:i.get(sh);if(n&&o){if(n.collisionType===Z.Passive||o.collisionType===Z.Passive)return;let e=t.normal,i=e.negate();if(n.collisionType===Z.Active&&0>n.vel.normalize().dot(i)){let t=e.scale(e.dot(n.vel.negate()));n.vel=n.vel.add(t)}if(o.collisionType===Z.Active&&0>o.vel.normalize().dot(e)){let t=i.scale(i.dot(o.vel.negate()));o.vel=o.vel.add(t)}}}}class rv{constructor(t,e,i){this.point=t,this.local=e,this.contact=i,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new ey(0,0),this.bToContact=new ey(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){var t,e;let i=null===(t=this.contact.colliderA.owner)||void 0===t?void 0:t.get(sh),s=null===(e=this.contact.colliderB.owner)||void 0===e?void 0:e.get(sh);if(i&&s){let t=this.contact.normal,e=this.contact.tangent;this.aToContact=this.point.sub(i.globalPos),this.bToContact=this.point.sub(s.globalPos);let r=this.aToContact.cross(t),n=this.bToContact.cross(t);this.normalMass=i.inverseMass+s.inverseMass+i.inverseInertia*r*r+s.inverseInertia*n*n;let o=this.aToContact.cross(e),a=this.bToContact.cross(e);this.tangentMass=i.inverseMass+s.inverseMass+i.inverseInertia*o*o+s.inverseInertia*a*a}return this}getRelativeVelocity(){var t,e;let i=null===(t=this.contact.colliderA.owner)||void 0===t?void 0:t.get(sh),s=null===(e=this.contact.colliderB.owner)||void 0===e?void 0:e.get(sh);if(i&&s){let t=i.vel.add(ey.cross(i.angularVelocity,this.aToContact));return s.vel.add(ey.cross(s.angularVelocity,this.bToContact)).sub(t)}return ey.Zero}}class rx{constructor(){this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(t){var e;return null!==(e=this.idToContactConstraint.get(t))&&void 0!==e?e:[]}solve(t){return this.preSolve(t),t=t.filter(t=>!t.isCanceled()),this.solveVelocity(t),this.solvePosition(t),this.postSolve(t),t}preSolve(t){var e,i,s;for(let e of t){if(1e-4>Math.abs(e.mtv.x)&&1e-4>Math.abs(e.mtv.y)){e.cancel();continue}let t=G.fromDirection(e.mtv);e.colliderA.events.emit("precollision",new tK(e.colliderA,e.colliderB,t,e.mtv,e)),e.colliderA.events.emit("beforecollisionresolve",new tQ(e.colliderA,e.colliderB,t,e.mtv,e)),e.colliderB.events.emit("precollision",new tK(e.colliderB,e.colliderA,G.getOpposite(t),e.mtv.negate(),e)),e.colliderB.events.emit("beforecollisionresolve",new tQ(e.colliderB,e.colliderA,G.getOpposite(t),e.mtv.negate(),e)),e.matchAwake()}let r=Array.from(this.idToContactConstraint.keys());for(let n of t){let t=r.indexOf(n.id);t>-1&&r.splice(t,1);let o=null!==(e=this.idToContactConstraint.get(n.id))&&void 0!==e?e:[],a=0,h=n.colliderA.owner.get(sh),l=n.colliderB.owner.get(sh);if(h&&l)for(let t of n.points){let e=n.normal,r=n.tangent,d=t.sub(h.globalPos),c=t.sub(l.globalPos),u=d.cross(e),p=c.cross(e),_=h.inverseMass+l.inverseMass+h.inverseInertia*u*u+l.inverseInertia*p*p,g=d.cross(r),m=c.cross(r),f=h.inverseMass+l.inverseMass+h.inverseInertia*g*g+l.inverseInertia*m*m;o[a]&&(null===(s=null===(i=o[a])||void 0===i?void 0:i.point)||void 0===s?void 0:s.squareDistance(t))<4?(o[a].point=t,o[a].local=n.localPoints[a]):o[a]=new rv(t,n.localPoints[a],n),o[a].aToContact=d,o[a].bToContact=c,o[a].normalMass=1/_,o[a].tangentMass=1/f;let v=h.bounciness>l.bounciness?h.bounciness:l.bounciness,x=n.normal.dot(o[a].getRelativeVelocity());o[a].originalVelocityAndRestitution=0,x<-.1&&(o[a].originalVelocityAndRestitution=-v*x),a++}this.idToContactConstraint.set(n.id,o)}for(let t of r)this.idToContactConstraint.delete(t);if(iW.warmStart)this.warmStart(t);else for(let e of t)for(let t of this.getContactConstraints(e.id))t.normalImpulse=0,t.tangentImpulse=0}postSolve(t){for(let e of t){let t=e.colliderA.owner.get(sh),i=e.colliderB.owner.get(sh);if(t&&i){if(t.collisionType===Z.Passive||i.collisionType===Z.Passive)continue;t.updateMotion(),i.updateMotion()}let s=G.fromDirection(e.mtv);e.colliderA.events.emit("postcollision",new tY(e.colliderA,e.colliderB,s,e.mtv,e)),e.colliderA.events.emit("aftercollisionresolve",new tJ(e.colliderA,e.colliderB,s,e.mtv,e)),e.colliderB.events.emit("postcollision",new tY(e.colliderB,e.colliderA,G.getOpposite(s),e.mtv.negate(),e)),e.colliderB.events.emit("aftercollisionresolve",new tJ(e.colliderB,e.colliderA,G.getOpposite(s),e.mtv.negate(),e))}for(let e of(this.lastFrameContacts.clear(),t))this.lastFrameContacts.set(e.id,e)}warmStart(t){var e,i,s;for(let r of t){let t=null===(e=r.colliderA.owner)||void 0===e?void 0:e.get(sh),n=null===(i=r.colliderB.owner)||void 0===i?void 0:i.get(sh);if(t&&n)for(let e of null!==(s=this.idToContactConstraint.get(r.id))&&void 0!==s?s:[])if(iW.warmStart){let i=r.normal.scale(e.normalImpulse),s=r.tangent.scale(e.tangentImpulse),o=i.add(s);t.applyImpulse(e.point,o.negate()),n.applyImpulse(e.point,o)}else e.normalImpulse=0,e.tangentImpulse=0}}solvePosition(t){var e,i,s;for(let r=0;r<iW.positionIterations;r++)for(let r of t){let t=null===(e=r.colliderA.owner)||void 0===e?void 0:e.get(sh),n=null===(i=r.colliderB.owner)||void 0===i?void 0:i.get(sh);if(t&&n){if(t.collisionType===Z.Passive||n.collisionType===Z.Passive)continue;for(let e of null!==(s=this.idToContactConstraint.get(r.id))&&void 0!==s?s:[]){let i=r.normal,s=ss.FindContactSeparation(r,e.local),o=ep(iW.steeringFactor*(s+iW.slop),-5,0),a=i.scale(-o*e.normalMass);if(t.collisionType===Z.Active){let i=a.negate().scale(t.inverseMass);t.limitDegreeOfFreedom.includes(Q.X)&&(i.x=0),t.limitDegreeOfFreedom.includes(Q.Y)&&(i.y=0),t.globalPos=t.globalPos.add(i),t.limitDegreeOfFreedom.includes(Q.Rotation)||(t.rotation-=e.aToContact.cross(a)*t.inverseInertia)}if(n.collisionType===Z.Active){let t=a.scale(n.inverseMass);n.limitDegreeOfFreedom.includes(Q.X)&&(t.x=0),n.limitDegreeOfFreedom.includes(Q.Y)&&(t.y=0),n.globalPos=n.globalPos.add(t),n.limitDegreeOfFreedom.includes(Q.Rotation)||(n.rotation+=e.bToContact.cross(a)*n.inverseInertia)}}}}}solveVelocity(t){var e,i,s;for(let r=0;r<iW.velocityIterations;r++)for(let r of t){let t=null===(e=r.colliderA.owner)||void 0===e?void 0:e.get(sh),n=null===(i=r.colliderB.owner)||void 0===i?void 0:i.get(sh);if(t&&n){if(t.collisionType===Z.Passive||n.collisionType===Z.Passive)continue;let e=Math.min(t.friction,n.friction),i=null!==(s=this.idToContactConstraint.get(r.id))&&void 0!==s?s:[];for(let s of i){let i=-s.getRelativeVelocity().dot(r.tangent)*s.tangentMass,o=e*s.normalImpulse,a=ep(s.tangentImpulse+i,-o,o);i=a-s.tangentImpulse,s.tangentImpulse=a;let h=r.tangent.scale(i);t.applyImpulse(s.point,h.negate()),n.applyImpulse(s.point,h)}for(let e of i){let i=e.getRelativeVelocity().dot(r.normal),s=-e.normalMass*(i-e.originalVelocityAndRestitution),o=Math.max(e.normalImpulse+s,0);s=o-e.normalImpulse,e.normalImpulse=o;let a=r.normal.scale(s);t.applyImpulse(e.point,a.negate()),n.applyImpulse(e.point,a)}}}}}class ry extends rr{constructor(t){super(),this.types=["ex.transform","ex.motion","ex.collider"],this.systemType=to.Update,this.priority=-1,this._realisticSolver=new rx,this._arcadeSolver=new rf,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._processor=t.collisionProcessor,this._trackCollider=t=>this._processor.track(t),this._untrackCollider=t=>this._processor.untrack(t)}notify(t){if(ro(t)){let e=t.data.get(sa);e.$colliderAdded.subscribe(this._trackCollider),e.$colliderRemoved.subscribe(this._untrackCollider);let i=e.get();i&&this._processor.track(i)}else{let e=t.data.get(sa),i=e.get();e&&i&&this._processor.untrack(i)}}initialize(t){this._engine=t.engine}update(t,e){var i,s,r,n;if(!iW.enabled)return;let o=[];for(let e of t){let t=e.get(sa),s=null==t?void 0:t.get();if(t&&(null===(i=t.owner)||void 0===i?void 0:i.active)&&s){if(t.update(),s instanceof i6){let t=s.getColliders();o=o.concat(t)}else o.push(s)}}this._processor.update(o);let a=this._processor.broadphase(o,e);this._currentFrameContacts.clear();let h=this._processor.narrowphase(a,null===(n=null===(r=null===(s=this._engine)||void 0===s?void 0:s.debug)||void 0===r?void 0:r.stats)||void 0===n?void 0:n.currFrame);for(let t of h=this.getSolver().solve(h)){let e=t.id.indexOf("|");if(e>0){let i=t.id.substring(e+1);this._currentFrameContacts.set(i,t)}else this._currentFrameContacts.set(t.id,t)}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts)}getSolver(){return iW.collisionResolutionStrategy===K.Realistic?this._realisticSolver:this._arcadeSolver}debug(t){this._processor.debug(t)}runContactStartEnd(){for(let[t,e]of this._currentFrameContacts)if(!this._lastFrameContacts.has(t)){let t=e.colliderA,i=e.colliderB,s=G.fromDirection(e.mtv),r=G.getOpposite(s);t.events.emit("collisionstart",new t0(t,i,s,e)),t.events.emit("contactstart",new tj(t,i,s,e)),i.events.emit("collisionstart",new t0(i,t,r,e)),i.events.emit("contactstart",new tj(i,t,r,e))}for(let[t,e]of this._lastFrameContacts)if(!this._currentFrameContacts.has(t)){let t=e.colliderA,i=e.colliderB;t.events.emit("collisionend",new t1(t,i)),t.events.emit("contactend",new t$(t,i)),i.events.emit("collisionend",new t1(i,t)),i.events.emit("contactend",new t$(i,t))}}}(E=ta||(ta={})).Forward="forward",E.Backward="backward",(P=th||(th={})).End="end",P.Loop="loop",P.PingPong="pingpong",P.Freeze="freeze";let rw={Frame:"frame",Loop:"loop",End:"end"};class rb extends eH{constructor(t){var e,i,s;super(t),this.events=new tT,this.frames=[],this.strategy=th.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=t.frames,this.speed=null!==(e=t.speed)&&void 0!==e?e:this.speed,this.strategy=null!==(i=t.strategy)&&void 0!==i?i:this.strategy,this.frameDuration=t.totalDuration?t.totalDuration/this.frames.length:null!==(s=t.frameDuration)&&void 0!==s?s:this.frameDuration,t.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new rb({frames:this.frames.map(t=>({...t})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){let t=this.currentFrame;return t?Math.abs(t.graphic.width*this.scale.x):0}get height(){let t=this.currentFrame;return t?Math.abs(t.graphic.height*this.scale.y):0}static fromSpriteSheet(t,e,i,s=th.Loop){let r=t.sprites.length-1,n=e.filter(t=>t<0||t>r);return n.length&&rb._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${n.join(",")} no frame will be shown`),new rb({frames:t.sprites.filter((t,i)=>e.indexOf(i)>-1).map(t=>({graphic:t,duration:i})),strategy:s})}static fromSpriteSheetCoordinates(t){let{spriteSheet:e,frameCoordinates:i,durationPerFrameMs:s,speed:r,strategy:n,reverse:o}=t,a=null!=s?s:100,h=[];for(let t of i){let{x:i,y:s,duration:r}=t,n=e.getSprite(i,s);n?h.push({graphic:n,duration:null!=r?r:a}):rb._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${i}, ${s}), please check your SpriteSheet to confirm that sprite exists`)}return new rb({frames:h,strategy:n,speed:r,reverse:o})}get speed(){return this._speed}set speed(t){this._speed=ep(Math.abs(t),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return this._reversed&&1===this._pingPongDirection?ta.Backward:ta.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;let t=this.frames[this._currentFrame];t&&(this._timeLeftInFrame=(null==t?void 0:t.duration)||this.frameDuration)}get canFinish(){switch(this.strategy){case th.End:case th.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(t,e){this._currentFrame=t,this._timeLeftInFrame=null!=e?e:this.frameDuration;let i=this.frames[this._currentFrame];i&&!this._done&&(this._timeLeftInFrame=null!=e?e:(null==i?void 0:i.duration)||this.frameDuration,this.events.emit("frame",{...i,frameIndex:this.currentFrameIndex}))}_nextFrame(){let t=this._currentFrame;if(this._done)return t;let e=-1;switch(this.strategy){case th.Loop:0==(e=(t+1)%this.frames.length)&&this.events.emit("loop",this);break;case th.End:(e=t+1)>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break;case th.Freeze:(e=ep(t+1,0,this.frames.length-1))>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break;case th.PingPong:t+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),t+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),e=t+this._pingPongDirection%this.frames.length}return e}tick(t,e=0){this._idempotencyToken!==e&&(this._idempotencyToken=e,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=t*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(t,e,i){this.currentFrame&&this.currentFrame.graphic.draw(t,e,i)}}rb._LOGGER=es.getInstance();class rC extends eH{constructor(t){super(t),this.members=[],this.members=t.members,this._updateDimensions()}clone(){return new rC({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){let t=new eA;for(let{graphic:e,pos:i}of this.members)t=e.localBounds.translate(i).combine(t);return this.width=t.width,this.height=t.height,t}get localBounds(){let t=new eA;for(let{graphic:e,pos:i}of this.members)t=e.localBounds.translate(i).combine(t);return t}_isAnimationOrGroup(t){return t instanceof rb||t instanceof rC}tick(t,e){for(let i of this.members){let s=i.graphic;this._isAnimationOrGroup(s)&&s.tick(t,e)}}reset(){for(let t of this.members){let e=t.graphic;this._isAnimationOrGroup(e)&&e.reset()}}_preDraw(t,e,i){this._updateDimensions(),super._preDraw(t,e,i)}_drawImage(t,e,i){for(let s of this.members)t.save(),t.translate(e,i),s.graphic.draw(t,s.pos.x,s.pos.y),this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore()}}function rA(t){return class extends t{assign(t){for(let e in t)"function"!=typeof this[e]&&(this[e]=t[e])}constructor(...t){super(...t),1!==t.filter(function(t){return void 0!==t}).length||!t[0]||"object"!=typeof t[0]||t[0]instanceof Array||this.assign(t[0])}}}(I=tl||(tl={}))[I.Circle=0]="Circle",I[I.Rectangle=1]="Rectangle";class rT extends s_{constructor(t,e,i,s,r,n,o,a,h,l){super(),this.position=new ey(0,0),this.velocity=new ey(0,0),this.acceleration=new ey(0,0),this.particleRotationalVelocity=0,this.currentRotation=0,this.focus=null,this.focusAccel=0,this.opacity=1,this.beginColor=eb.White,this.endColor=eb.White,this.life=300,this.fadeFlag=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=eb.White,this.emitter=null,this.particleSize=5,this.particleSprite=null,this.sizeRate=0,this.elapsedMultiplier=0,this.visible=!0,this.isOffscreen=!1;let d=t;if(!d||t instanceof rE||(d=t.emitter,e=t.life,i=t.opacity,r=t.endColor,s=t.beginColor,n=t.position,o=t.velocity,a=t.acceleration,h=t.startSize,l=t.endSize),this.emitter=d,this.life=e||this.life,this.opacity=i||this.opacity,this.endColor=r||this.endColor.clone(),this.beginColor=s||this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.emitter.particleTransform===td.Global){let t=this.emitter.transform.globalPos;this.position=(n||this.position).add(t),this.velocity=(o||this.velocity).rotate(this.emitter.transform.globalRotation)}else this.velocity=o||this.velocity,this.position=n||this.position;this.acceleration=a||this.acceleration,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.opacity/this.life,this.startSize=h||0,this.endSize=l||0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.particleSize=this.startSize),this.addComponent(this.transform=new iY),this.addComponent(this.graphics=new sv),this.transform.pos=this.position,this.transform.rotation=this.currentRotation,this.transform.scale=ew(1,1),this.particleSprite?(this.graphics.opacity=this.opacity,this.graphics.use(this.particleSprite)):(this.graphics.localBounds=eA.fromDimension(this.particleSize,this.particleSize,ey.Half),this.graphics.onPostDraw=t=>{t.save(),this.graphics.opacity=this.opacity;let e=this._currentColor.clone();e.a=1,t.debug.drawPoint(ew(0,0),{color:e,size:this.particleSize}),t.restore()})}kill(){this.emitter.removeParticle(this)}update(t,e){if(this.life=this.life-e,this.elapsedMultiplier=this.elapsedMultiplier+e,this.life<0&&this.kill(),this.fadeFlag&&(this.opacity=ep(this._aRate*this.life,1e-4,1)),this.startSize>0&&this.endSize>0&&(this.particleSize=ep(this.sizeRate*e+this.particleSize,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=ep(this._currentColor.r+this._rRate*e,0,255),this._currentColor.g=ep(this._currentColor.g+this._gRate*e,0,255),this._currentColor.b=ep(this._currentColor.b+this._bRate*e,0,255),this._currentColor.a=ep(this.opacity,1e-4,1),this.focus){let t=this.focus.sub(this.position).normalize().scale(this.focusAccel).scale(e/1e3);this.velocity=this.velocity.add(t)}else this.velocity=this.velocity.add(this.acceleration.scale(e/1e3));this.position=this.position.add(this.velocity.scale(e/1e3)),this.particleRotationalVelocity&&(this.currentRotation=(this.currentRotation+this.particleRotationalVelocity*e/1e3)%(2*Math.PI)),this.transform.pos=this.position,this.transform.rotation=this.currentRotation,this.transform.scale=ew(1,1),this.graphics.opacity=this.opacity}}class rS extends rA(rT){constructor(t,e,i,s,r,n,o,a,h,l){super(t,e,i,s,r,n,o,a,h,l)}}(D=td||(td={})).Global="global",D.Local="local";class rE extends sZ{get opacity(){return super.graphics.opacity}set opacity(t){super.graphics.opacity=t}get particleSprite(){return this._sprite}set particleSprite(t){t&&(this._sprite=t)}constructor(t){var e,i;super({width:null!==(e=t.width)&&void 0!==e?e:0,height:null!==(i=t.height)&&void 0!==i?i:0}),this._particlesToEmit=0,this.numParticles=0,this.isEmitting=!0,this.particles=[],this.deadParticles=[],this.minVel=0,this.maxVel=0,this.acceleration=new ey(0,0),this.minAngle=0,this.maxAngle=0,this.emitRate=1,this.particleLife=2e3,this.fadeFlag=!1,this.focus=null,this.focusAccel=null,this.startSize=null,this.endSize=null,this.minSize=5,this.maxSize=5,this.beginColor=eb.White,this.endColor=eb.White,this._sprite=null,this.emitterType=tl.Rectangle,this.radius=0,this.particleRotationalVelocity=0,this.randomRotation=!1,this.particleTransform=td.Global;let{x:s,y:r,pos:n,isEmitting:o,minVel:a,maxVel:h,acceleration:l,minAngle:d,maxAngle:c,emitRate:u,particleLife:p,opacity:_,fadeFlag:g,focus:m,focusAccel:f,startSize:v,endSize:x,minSize:y,maxSize:w,beginColor:b,endColor:C,particleSprite:A,emitterType:T,radius:S,particleRotationalVelocity:E,particleTransform:P,randomRotation:I,random:D}={...t};this.pos=null!=n?n:ew(null!=s?s:0,null!=r?r:0),this.isEmitting=null!=o?o:this.isEmitting,this.minVel=null!=a?a:this.minVel,this.maxVel=null!=h?h:this.maxVel,this.acceleration=null!=l?l:this.acceleration,this.minAngle=null!=d?d:this.minAngle,this.maxAngle=null!=c?c:this.maxAngle,this.emitRate=null!=u?u:this.emitRate,this.particleLife=null!=p?p:this.particleLife,this.opacity=null!=_?_:this.opacity,this.fadeFlag=null!=g?g:this.fadeFlag,this.focus=null!=m?m:this.focus,this.focusAccel=null!=f?f:this.focusAccel,this.startSize=null!=v?v:this.startSize,this.endSize=null!=x?x:this.endSize,this.minSize=null!=y?y:this.minSize,this.maxSize=null!=w?w:this.maxSize,this.beginColor=null!=b?b:this.beginColor,this.endColor=null!=C?C:this.endColor,this.particleSprite=null!=A?A:this.particleSprite,this.emitterType=null!=T?T:this.emitterType,this.radius=null!=S?S:this.radius,this.particleRotationalVelocity=null!=E?E:this.particleRotationalVelocity,this.randomRotation=null!=I?I:this.randomRotation,this.particleTransform=null!=P?P:this.particleTransform,this.body.collisionType=Z.PreventCollision,this.random=null!=D?D:new el}removeParticle(t){this.deadParticles.push(t)}emitParticles(t){var e;for(let i=0;i<t;i++){let t=this._createParticle();this.particles.push(t),(null===(e=this===null||void 0===this?void 0:this.scene)||void 0===e?void 0:e.world)&&(this.particleTransform===td.Global?this.scene.world.add(t):this.addChild(t))}}clearParticles(){this.particles.length=0}_createParticle(){let t=0,e=0,i=ev(this.minAngle,this.maxAngle,this.random),s=ev(this.minVel,this.maxVel,this.random),r=this.startSize||ev(this.minSize,this.maxSize,this.random);if(this.emitterType===tl.Rectangle)t=ev(0,this.width,this.random),e=ev(0,this.height,this.random);else if(this.emitterType===tl.Circle){let s=ev(0,this.radius,this.random);t=s*Math.cos(i),e=s*Math.sin(i)}let n=new rS(this,this.particleLife,this.opacity,this.beginColor,this.endColor,new ey(t,e),new ey(s*Math.cos(i),s*Math.sin(i)),this.acceleration,this.startSize,this.endSize);return n.fadeFlag=this.fadeFlag,n.particleSize=r,this.particleSprite&&(n.particleSprite=this.particleSprite,n.graphics.opacity=this.opacity,n.graphics.use(this._sprite)),n.particleRotationalVelocity=this.particleRotationalVelocity,this.randomRotation&&(n.currentRotation=ev(0,2*Math.PI,this.random)),this.focus&&(n.focus=this.focus.add(new ey(this.pos.x,this.pos.y)),n.focusAccel=this.focusAccel),n}update(t,e){var i;super.update(t,e),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(e/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let t=0;t<this.deadParticles.length;t++)eP(this.deadParticles[t],this.particles),(null===(i=this===null||void 0===this?void 0:this.scene)||void 0===i?void 0:i.world)&&this.scene.world.remove(this.deadParticles[t],!1);this.deadParticles.length=0}}class rP extends rr{constructor(){super(...arguments),this.types=["ex.transform","ex.graphics"],this.systemType=to.Draw,this.priority=0,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new iq}get sortedTransforms(){return this._sortedTransforms}initialize(t){this._camera=t.camera,this._engine=t.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((t,e)=>t.z-e.z),this._zHasChanged=!1)}notify(t){if(ro(t)){let e=t.data.get(iY);this._sortedTransforms.push(e),e.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}else{let e=t.data.get(iY);e.zIndexChanged$.unsubscribe(this._zIndexUpdate);let i=this._sortedTransforms.indexOf(e);i>-1&&this._sortedTransforms.splice(i,1)}}update(t,e){let i;for(let t of(this._token++,sV.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),this._sortedTransforms)){let s=t.owner;if(s.hasTag("ex.offscreen")||!(i=s.get(sv)).visible)continue;i.onPreTransformDraw&&i.onPreTransformDraw(this._graphicsContext,e),s.events.emit("pretransformdraw",new tk(this._graphicsContext,e,s)),t.coordPlane===$.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),t.coordPlane===$.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),i.update(e,this._token);let r=s.get(s$);if(r){let t=ey.One.sub(r.parallaxFactor),e=this._camera.drawPos.scale(t);this._graphicsContext.translate(e.x,e.y)}this._applyTransform(s),i.material&&(this._graphicsContext.material=i.material),i.onPreDraw&&i.onPreDraw(this._graphicsContext,e),s.events.emit("predraw",new tB(this._graphicsContext,e,s));let n=s instanceof rS?s.opacity:1;this._graphicsContext.opacity*=i.opacity*n,this._drawGraphicsComponent(i),i.onPostDraw&&i.onPostDraw(this._graphicsContext,e),s.events.emit("postdraw",new tF(this._graphicsContext,e,s)),this._graphicsContext.restore(),t.coordPlane===$.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),i.onPostTransformDraw&&i.onPostTransformDraw(this._graphicsContext,e),s.events.emit("posttransformdraw",new tM(this._graphicsContext,e,s))}this._graphicsContext.restore()}_drawGraphicsComponent(t){var e,i;if(t.visible){let s=t.flipHorizontal,r=t.flipVertical;for(let n of t.layers.get())for(let{graphic:o,options:a}of n.graphics){let h=t.anchor,l=t.offset;(null==a?void 0:a.anchor)&&(h=a.anchor),(null==a?void 0:a.offset)&&(l=a.offset);let d=-o.width*h.x+l.x,c=-o.height*h.y+l.y,u=o.flipHorizontal,p=o.flipVertical;if((s||r)&&(o.flipHorizontal=s?!u:u,o.flipVertical=r?!p:p),null==o||o.draw(this._graphicsContext,d+n.offset.x,c+n.offset.y),(s||r)&&(o.flipHorizontal=u,o.flipVertical=p),(null===(e=this._engine)||void 0===e?void 0:e.isDebug)&&this._engine.debug.graphics.showBounds){let t=ew(d+n.offset.x,c+n.offset.y);if(o instanceof rC)for(let e of o.members)null===(i=e.graphic)||void 0===i||i.localBounds.translate(t.add(e.pos)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor);else null==o||o.localBounds.translate(t).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(t){for(let e of t.getAncestors()){let t=null==e?void 0:e.get(iY),i=null==e?void 0:e.get(sh),s=t.get();if(i&&this._engine.fixedUpdateFps&&i.__oldTransformCaptured&&i.enableFixedUpdateInterpolate){let e=this._engine.currentFrameLagMs/(1e3/this._engine.fixedUpdateFps);s=function(t,e,i,s){if(t.parent!==e.parent){let i=t.clone(),s=t.globalPos.clone(),r=t.globalScale.clone(),n=t.globalRotation;i.parent=e.parent,i.globalPos=s,i.globalScale=r,i.globalRotation=n,t=i}let r=e.pos,n=e.scale,o=e.rotation;r=e.pos.scale(i).add(t.pos.scale(1-i)),n=e.scale.scale(i).add(t.scale.scale(1-i));let a=(1-i)*Math.cos(t.rotation)+i*Math.cos(e.rotation);o=Math.atan2((1-i)*Math.sin(t.rotation)+i*Math.sin(e.rotation),a);let h=null!=s?s:new iq;return h.setTransform(r,o,n),h}(i.oldTransform,t.get(),e,this._targetInterpolationTransform)}t&&(this._graphicsContext.z=t.z,this._graphicsContext.translate(s.pos.x,s.pos.y),this._graphicsContext.scale(s.scale.x,s.scale.y),this._graphicsContext.rotate(s.rotation))}}}class rI extends rr{constructor(){super(...arguments),this.types=["ex.transform"],this.systemType=to.Draw,this.priority=999}initialize(t){this._graphicsContext=t.engine.graphicsContext,this._camera=t.camera,this._engine=t.engine,this._collisionSystem=t.world.systemManager.get(ry)}update(t,e){var i;let s,r,n,o,a,h,l,d;if(!this._engine.isDebug)return;let c=this._engine.debug.filter,u=this._engine.debug.entity,p=this._engine.debug.transform,_=this._engine.debug.motion,g=this._engine.debug.collider,m=this._engine.debug.physics,f=this._engine.debug.graphics,v=this._engine.debug.body,x=this._engine.debug.camera;for(let e of t){if(e.hasTag("offscreen")||e instanceof rS||c.useFilter&&(!(0===c.ids.length||c.ids.includes(e.id))||!(""===c.nameQuery||e.name.includes(c.nameQuery))))continue;let t=ey.Zero,m=ew(0,16);if(s=e.id,r=e.name,n=e.get(iY),this._pushCameraTransform(n),this._graphicsContext.save(),this._graphicsContext.z=p.debugZIndex,this._applyTransform(e),n&&((p.showAll||p.showPosition)&&this._graphicsContext.debug.drawPoint(ey.Zero,{size:4,color:p.positionColor}),(p.showAll||p.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${n.pos.toString(2)}`,t),t=t.add(m)),(p.showAll||p.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${n.z.toFixed(1)})`,t),t=t.add(m)),(u.showAll||u.showId)&&(this._graphicsContext.debug.drawText(`id(${s}) ${e.parent?"child of id("+(null===(i=e.parent)||void 0===i?void 0:i.id)+")":""}`,t),t=t.add(m)),(u.showAll||u.showName)&&(this._graphicsContext.debug.drawText(`name(${r})`,t),t=t.add(m)),(p.showAll||p.showRotation)&&(this._graphicsContext.drawLine(ey.Zero,ey.fromAngle(n.rotation).scale(50).add(ey.Zero),p.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${eg(n.rotation).toFixed(2)})`,t),t=t.add(m)),(p.showAll||p.showScale)&&this._graphicsContext.drawLine(ey.Zero,n.scale.add(ey.Zero),p.scaleColor,2)),(h=e.get(sv))&&(f.showAll||f.showBounds)&&h.localBounds.draw(this._graphicsContext,f.boundsColor),(l=e.get(sQ))&&(l.useTransform||this._graphicsContext.restore(),l.draw(this._graphicsContext,this._engine.debug),l.useTransform||(this._graphicsContext.save(),this._applyTransform(e))),(d=e.get(sh))&&((v.showAll||v.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${d.group.name})`,t),t=t.add(m)),(v.showAll||v.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${d.collisionType})`,t),t=t.add(m)),(v.showAll||v.showMass)&&(this._graphicsContext.debug.drawText(`mass(${d.mass})`,t),t=t.add(m)),(v.showAll||v.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${d.sleepMotion})`,t),t=t.add(m)),(v.showAll||v.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${d.canSleep?d.sleeping:"cant sleep"})`,t),t=t.add(m))),this._graphicsContext.restore(),this._graphicsContext.save(),this._graphicsContext.z=p.debugZIndex,(o=e.get(ij))&&((_.showAll||_.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${o.vel.toString(2)}`,t.add(n.globalPos)),this._graphicsContext.drawLine(n.globalPos,n.globalPos.add(o.vel),_.velocityColor,2),t=t.add(m)),(_.showAll||_.showAcceleration)&&this._graphicsContext.drawLine(n.globalPos,n.globalPos.add(o.acc),_.accelerationColor,2)),a=e.get(sa)){let t=a.get();if((g.showAll||g.showGeometry)&&t&&t.debug(this._graphicsContext,g.geometryColor,{lineWidth:g.geometryLineWidth,pointSize:g.geometryPointSize}),g.showAll||g.showBounds){if(t instanceof i6){for(let e of t.getColliders()){let t=e.bounds,i=ew(t.left,t.top);this._graphicsContext.debug.drawRect(i.x,i.y,t.width,t.height,{color:g.boundsColor}),(g.showAll||g.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${e.owner.id})`,i)}a.bounds.draw(this._graphicsContext,g.boundsColor)}else if(t){let t=a.bounds,e=ew(t.left,t.top);this._graphicsContext.debug.drawRect(e.x,e.y,t.width,t.height,{color:g.boundsColor}),(g.showAll||g.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${a.owner.id})`,e)}}}this._graphicsContext.restore(),this._popCameraTransform(n)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(m.showAll||m.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),m.showAll||m.showCollisionContacts||m.showCollisionNormals)for(let[t,e]of this._engine.debug.stats.currFrame.physics.contacts){if(m.showAll||m.showCollisionContacts)for(let t of e.points)this._graphicsContext.debug.drawPoint(t,{size:5,color:m.collisionContactColor});if(m.showAll||m.showCollisionNormals)for(let t of e.points)this._graphicsContext.debug.drawLine(t,e.normal.scale(30).add(t),{color:m.collisionNormalColor})}this._graphicsContext.restore(),x&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(x.showAll||x.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,x.focusColor),(x.showAll||x.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}_applyTransform(t){for(let e of t.getAncestors()){let t=null==e?void 0:e.get(iY);t&&(this._graphicsContext.translate(t.pos.x,t.pos.y),this._graphicsContext.scale(t.scale.x,t.scale.y),this._graphicsContext.rotate(t.rotation))}}_pushCameraTransform(t){t.coordPlane===$.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(t){t.coordPlane===$.World&&this._graphicsContext.restore()}}class rD extends rr{constructor(){super(...arguments),this.types=["ex.transform","ex.pointer"],this.systemType=to.Update,this.priority=-1,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this.lastFrameEntityToPointers=new Map,this.currentFrameEntityToPointers=new Map,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0}}initialize(t){this._engine=t.engine}preupdate(){this._receiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((t,e)=>e.z-t.z),this._sortedEntities=this._sortedTransforms.map(t=>t.owner),this._zHasChanged=!1)}notify(t){if(ro(t)){let e=t.data.get(iY);this._sortedTransforms.push(e),this._sortedEntities.push(e.owner),e.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}else{let e=t.data.get(iY);e.zIndexChanged$.unsubscribe(this._zIndexUpdate);let i=this._sortedTransforms.indexOf(e);i>-1&&(this._sortedTransforms.splice(i,1),this._sortedEntities.splice(i,1))}}entityCurrentlyUnderPointer(t,e){return this.currentFrameEntityToPointers.has(t.id)&&this.currentFrameEntityToPointers.get(t.id).includes(e)}entityWasUnderPointer(t,e){return this.lastFrameEntityToPointers.has(t.id)&&this.lastFrameEntityToPointers.get(t.id).includes(e)}entered(t,e){return this.entityCurrentlyUnderPointer(t,e)&&!this.lastFrameEntityToPointers.has(t.id)}left(t,e){return!this.currentFrameEntityToPointers.has(t.id)&&this.entityWasUnderPointer(t,e)}addPointerToEntity(t,e){if(!this.currentFrameEntityToPointers.has(t.id)){this.currentFrameEntityToPointers.set(t.id,[e]);return}let i=this.currentFrameEntityToPointers.get(t.id);this.currentFrameEntityToPointers.set(t.id,i.concat(e))}update(t){this._processPointerToEntity(this._sortedEntities),this._dispatchEvents(this._sortedEntities),this._receiver.update(),this.lastFrameEntityToPointers.clear(),this.lastFrameEntityToPointers=new Map(this.currentFrameEntityToPointers),this.currentFrameEntityToPointers.clear(),this._receiver.clear()}_processPointerToEntity(t){var e;let i,s,r,n;for(let o of t){if(i=o.get(iY),n=null!==(e=o.get(sw))&&void 0!==e?e:new sw,(s=o.get(sa))&&(n.useColliderShape||this.overrideUseColliderShape)){s.update();let t=s.get();if(t)for(let[e,s]of this._receiver.currentFramePointerCoords.entries())t.contains(i.coordPlane===$.World?s.worldPos:s.screenPos)&&this.addPointerToEntity(o,e)}if((r=o.get(sv))&&(n.useGraphicsBounds||this.overrideUseGraphicsBounds)){let t=r.localBounds.transform(i.get().matrix);for(let[e,s]of this._receiver.currentFramePointerCoords.entries())t.contains(i.coordPlane===$.World?s.worldPos:s.screenPos)&&this.addPointerToEntity(o,e)}}}_processDownAndEmit(t){let e=new Map;for(let i of this._receiver.currentFrameDown)i.active&&t.active&&this.entityCurrentlyUnderPointer(t,i.pointerId)&&(t.events.emit("pointerdown",i),this._receiver.isDragStart(i.pointerId)&&t.events.emit("pointerdragstart",i)),e.set(i.pointerId,i);return e}_processUpAndEmit(t){let e=new Map;for(let i of this._receiver.currentFrameUp)i.active&&t.active&&this.entityCurrentlyUnderPointer(t,i.pointerId)&&(t.events.emit("pointerup",i),this._receiver.isDragEnd(i.pointerId)&&t.events.emit("pointerdragend",i)),e.set(i.pointerId,i);return e}_processMoveAndEmit(t){let e=new Map;for(let i of this._receiver.currentFrameMove)i.active&&t.active&&this.entityCurrentlyUnderPointer(t,i.pointerId)&&(t.events.emit("pointermove",i),this._receiver.isDragging(i.pointerId)&&t.events.emit("pointerdragmove",i)),e.set(i.pointerId,i);return e}_processEnterLeaveAndEmit(t,e){for(let i of e){if(i.active&&t.active&&this.entered(t,i.pointerId)){t.events.emit("pointerenter",i),this._receiver.isDragging(i.pointerId)&&t.events.emit("pointerdragenter",i);break}if(i.active&&t.active&&(this.left(t,i.pointerId)||this.entityCurrentlyUnderPointer(t,i.pointerId)&&"up"===i.type)){t.events.emit("pointerleave",i),this._receiver.isDragging(i.pointerId)&&t.events.emit("pointerdragleave",i);break}}}_processCancelAndEmit(t){for(let e of this._receiver.currentFrameCancel)e.active&&t.active&&this.entityCurrentlyUnderPointer(t,e.pointerId)&&t.events.emit("pointercancel",e)}_processWheelAndEmit(t){for(let e of this._receiver.currentFrameWheel)e.active&&t.active&&this.entityCurrentlyUnderPointer(t,0)&&t.events.emit("pointerwheel",e)}_dispatchEvents(t){let e,i;let s=new Set(this.lastFrameEntityToPointers.keys()),r=new Set(this.currentFrameEntityToPointers.keys());for(let n of t.filter(t=>s.has(t.id)||r.has(t.id))){i=this._processDownAndEmit(n),e=this._processUpAndEmit(n);let t=[...this._processMoveAndEmit(n).values(),...i.values(),...e.values()];this._processEnterLeaveAndEmit(n,t),this._processCancelAndEmit(n),this._processWheelAndEmit(n)}}}class rR extends rr{constructor(){super(...arguments),this.types=["ex.actions"],this.systemType=to.Update,this.priority=-1,this._actions=[]}notify(t){if(ro(t)){let e=t.data.get(sW);this._actions.push(e)}else{let e=t.data.get(sW),i=this._actions.indexOf(e);i>-1&&this._actions.splice(i,1)}}update(t,e){for(let t of this._actions)t.update(e)}}class rB extends iX{constructor(t){super(),this.type="ex.isometricentity",this.elevation=0,this.columns=t.columns,this.rows=t.rows,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight}}class rF extends rr{constructor(){super(...arguments),this.types=["ex.transform","ex.isometricentity"],this.systemType=to.Update,this.priority=99}update(t,e){let i,s;for(let e of t){i=e.get(iY);let t=Math.max((s=e.get(rB)).columns*s.tileWidth,s.rows*s.tileHeight)*s.elevation+i.pos.y;i.z=t}}}class rk extends rr{constructor(){super(...arguments),this.types=["ex.transform","ex.graphics"],this.systemType=to.Draw,this.priority=-1}initialize(t){this._camera=t.camera,this._screen=t.engine.screen}update(t){let e,i,s;for(let r of(this._worldBounds=this._screen.getWorldBounds(),t)){let t;if(i=r.get(sv),e=r.get(iY),s=r.get(s$)){let e=ey.One.sub(s.parallaxFactor);t=this._camera.pos.scale(e)}let n=this._isOffscreen(e,i,t);n&&!r.hasTag("ex.offscreen")&&(r.events.emit("exitviewport",new t3(r)),r.addTag("ex.offscreen")),!n&&r.hasTag("ex.offscreen")&&(r.events.emit("enterviewport",new t6(r)),r.removeTag("ex.offscreen"))}}_isOffscreen(t,e,i){if(t.coordPlane!==$.World)return!1;{let s=e.localBounds;i&&(s=s.translate(i));let r=s.transform(t.get().matrix);return!this._worldBounds.overlaps(r)}}}class rM{constructor(){this.collisionProcessor=new i4}rayCast(t,e){return this.collisionProcessor.rayCast(t,e)}}let rL={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw"};class rz{get actors(){return this.world.entityManager.entities.filter(t=>t instanceof sZ)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(t=>t instanceof rs)}get tileMaps(){return this.world.entityManager.entities.filter(t=>t instanceof s1)}get timers(){return this._timers}constructor(){this._logger=es.getInstance(),this.events=new tT,this.camera=new rt,this.world=new r_(this),this.physics=new rM,this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(new rR),this.world.add(new rm),this.world.add(new ry(this.physics)),this.world.add(new rD),this.world.add(new rF),this.world.add(new rk),this.world.add(new rP),this.world.add(new rI)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}onInitialize(t){}onActivate(t){}onDeactivate(t){}onPreUpdate(t,e){}onPostUpdate(t,e){}onPreDraw(t,e){}onPostDraw(t,e){}_initializeChildren(){for(let t of this.entities)t._initialize(this.engine)}get isInitialized(){return this._isInitialized}_initialize(t){this.isInitialized||(this.engine=t,this.camera._initialize(t),this.world.systemManager.initialize(),this.onInitialize.call(this,t),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,t),this.events.emit("initialize",new t2(t,this)),this._isInitialized=!0)}_activate(t){this._logger.debug("Scene.onActivate",this),this.onActivate(t)}_deactivate(t){this._logger.debug("Scene.onDeactivate",this),this.onDeactivate(t)}_preupdate(t,e){this.emit("preupdate",new tU(t,e,this)),this.onPreUpdate(t,e)}_postupdate(t,e){this.emit("postupdate",new tO(t,e,this)),this.onPostUpdate(t,e)}_predraw(t,e){this.emit("predraw",new tB(t,e,this)),this.onPreDraw(t,e)}_postdraw(t,e){this.emit("postdraw",new tF(t,e,this)),this.onPostDraw(t,e)}update(t,e){let i,s;for(this._preupdate(t,e),i=0,s=this._cancelQueue.length;i<s;i++)this.removeTimer(this._cancelQueue[i]);for(let t of(this._cancelQueue.length=0,this._timers))t.update(e);this.world.update(to.Update,e),this.camera&&this.camera.update(t,e),this._collectActorStats(t),this._postupdate(t,e)}draw(t,e){var i;this._predraw(t,e),this.world.update(to.Draw,e),(null===(i=this.engine)||void 0===i?void 0:i.isDebug)&&this.debugDraw(t),this._postdraw(t,e)}debugDraw(t){this.emit("predebugdraw",new tL(t,this)),this.emit("postdebugdraw",new tz(t,this))}contains(t){return this.actors.indexOf(t)>-1}add(t){if(this.emit("entityadded",{target:t}),this.world.add(t),t.scene=this,t instanceof sj){eI(this._timers,t)||this.addTimer(t);return}}transfer(t){let e;t instanceof s_&&t.scene&&t.scene!==this&&(e=t.scene,t.scene.world.remove(t,!1)),t instanceof sj&&t.scene&&(e=t.scene,t.scene.removeTimer(t)),null==e||e.emit("entityremoved",{target:t}),this.add(t)}remove(t){t instanceof s_&&(this.emit("entityremoved",{target:t}),t.active&&t.kill(),this.world.remove(t)),t instanceof sj&&this.removeTimer(t)}clear(t=!0){for(let e=this.entities.length-1;e>=0;e--)this.world.remove(this.entities[e],t);for(let t=this.timers.length-1;t>=0;t--)this.removeTimer(this.timers[t])}addTimer(t){return this._timers.push(t),t.scene=this,t}removeTimer(t){let e=this._timers.indexOf(t);return -1!==e&&this._timers.splice(e,1),t}cancelTimer(t){return this._cancelQueue.push(t),t}isTimerActive(t){return this._timers.indexOf(t)>-1&&!t.complete}isCurrentScene(){return!!this.engine&&this.engine.currentScene===this}_collectActorStats(t){for(let e of this.actors.filter(t=>t instanceof sY))t.stats.currFrame.actors.ui++;for(let e of this.actors)for(let i of(t.stats.currFrame.actors.alive++,e.children))sK(i)?t.stats.currFrame.actors.ui++:t.stats.currFrame.actors.alive++}}(R=tc||(tc={})).Protanope="Protanope",R.Deuteranope="Deuteranope",R.Tritanope="Tritanope";class rU{constructor(t,e){this._shader=new eJ({gl:t,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_texcoord;
      out vec2 v_texcoord;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_texcoord;
      }`,fragmentSource:e}),this._shader.compile(),this._buffer=new e0({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new e1({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class rO{constructor(t,e=!1){this._colorBlindnessMode=t,this._simulate=!1,this._simulate=e}initialize(t){this._shader=new rU(t,"#version 300 es\nprecision mediump float;\n// our texture\nuniform sampler2D u_image;\n// the texCoords passed in from the vertex shader.\nin vec2 v_texcoord;\n\n// color blind type\nuniform int u_type;\n\n// simulation?\nuniform bool u_simulate;\n\nout vec4 fragColor;\n\nvoid main() {\n  vec4 o =  texture(u_image, v_texcoord);\n  // RGB to LMS matrix conversion\n  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\n  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\n  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\n  // Simulate color blindness\n  float l;\n  float m;\n  float s;\n  //MODE CODE//\n  if (u_type == 0) {\n    // Protanope\n    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\n    m = 0.0 * L + 1.0 * M + 0.0 * S;\n    s = 0.0 * L + 0.0 * M + 1.0 * S;;\n  } else if (u_type == 1) {\n    // Deuteranope\n    l = 1.0 * L + 0.0 * M + 0.0 * S;\n    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\n    s = 0.0 * L + 0.0 * M + 1.0 * S;\n  } else if (u_type == 2) {\n    // Tritanope\n    l = 1.0 * L + 0.0 * M + 0.0 * S;\n    m = 0.0 * L + 1.0 * M + 0.0 * S;\n    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\n  }\n\n  // LMS to RGB matrix conversion\n  vec4 error; // simulate the colors\n  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\n  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\n  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\n  error.a = 1.0;\n  vec4 diff = o - error;\n  vec4 correction; // correct the colors\n  correction.r = 0.0;\n  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\n  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\n  correction = o + correction;\n  correction.a = o.a;\n  //SIMULATE//\n\n  // sim \n  if (u_simulate) {\n    fragColor = error.rgba;\n  } else {\n    fragColor = correction.rgba;\n  }\n}"),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(t){if(this._colorBlindnessMode=t,this._shader){let t=this._shader.getShader();t.use(),this._colorBlindnessMode===tc.Protanope?t.setUniformInt("u_type",0):this._colorBlindnessMode===tc.Deuteranope?t.setUniformInt("u_type",1):this._colorBlindnessMode===tc.Tritanope&&t.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(t){if(this._simulate=t,this._shader){let e=this._shader.getShader();e.use(),e.setUniformBoolean("u_simulate",t)}}get simulate(){return this._simulate}}class rN{constructor(t){this._engine=t,this._colorBlindPostProcessor=new rO(tc.Protanope)}correct(t){this._engine.graphicsContext instanceof ih&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(t){this._engine.graphicsContext instanceof ih&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class rH{constructor(t){this.stats={currFrame:new rW,prevFrame:new rW},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:eb.Yellow,showZIndex:!1,showScale:!1,scaleColor:eb.Green,showRotation:!1,rotationColor:eb.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:eb.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:eb.Blue,showOwner:!1,showGeometry:!0,geometryColor:eb.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:eb.Cyan,showCollisionContacts:!0,collisionContactColor:eb.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:eb.Yellow,showAcceleration:!1,accelerationColor:eb.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:eb.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:eb.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:eb.fromHex("#8080807F"),showColliderGeometry:!0,showQuadTree:!1},this.isometric={showAll:!1,showPosition:!1,positionColor:eb.Yellow,positionSize:1,showGrid:!1,gridColor:eb.Red,gridWidth:1,showColliderGeometry:!0},this._engine=t,this.colorBlindMode=new rN(this._engine)}useTestClock(){let t=this._engine.clock,e=t.isRunning();t.stop();let i=t.toTestClock();return e&&i.start(),this._engine.clock=i,i}useStandardClock(){let t=this._engine.clock,e=t.isRunning();t.stop();let i=t.toStandardClock();return e&&i.start(),this._engine.clock=i,i}}class rW{constructor(){this._id=0,this._delta=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new rG,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(t){t?(this.id=t.id,this.delta=t.delta,this.fps=t.fps,this.actors.alive=t.actors.alive,this.actors.killed=t.actors.killed,this.actors.ui=t.actors.ui,this.duration.update=t.duration.update,this.duration.draw=t.duration.draw,this._physicsStats.reset(t.physics),this.graphics.drawCalls=t.graphics.drawCalls,this.graphics.drawnImages=t.graphics.drawnImages):(this.id=this.delta=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){let t=new rW;return t.reset(this),t}get id(){return this._id}set id(t){this._id=t}get delta(){return this._delta}set delta(t){this._delta=t}get fps(){return this._fps}set fps(t){this._fps=t}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class rG{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(t){t?(this.pairs=t.pairs,this.collisions=t.collisions,this.contacts=t.contacts,this.fastBodies=t.fastBodies,this.fastBodyCollisions=t.fastBodyCollisions,this.broadphase=t.broadphase,this.narrowphase=t.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){let t=new rG;return t.reset(this),t}get pairs(){return this._pairs}set pairs(t){this._pairs=t}get collisions(){return this._collisions}set collisions(t){this._collisions=t}get contacts(){return this._contacts}set contacts(t){this._contacts=t}get fastBodies(){return this._fastBodies}set fastBodies(t){this._fastBodies=t}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(t){this._fastBodyCollisions=t}get broadphase(){return this._broadphase}set broadphase(t){this._broadphase=t}get narrowphase(){return this._narrowphase}set narrowphase(t){this._narrowphase=t}}class rV{on(t,e){this._nativeHandlers[t]&&this.off(t,this._nativeHandlers[t]),this._nativeHandlers[t]=this._decorate(e),this.nativeComponent.addEventListener(t,this._nativeHandlers[t])}off(t,e){e||(e=this._nativeHandlers[t]),this.nativeComponent.removeEventListener(t,e),this._nativeHandlers[t]=null}_decorate(t){return e=>{this._paused||t(e)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(let t in this._nativeHandlers)this.off(t)}constructor(t){this.nativeComponent=t,this._paused=!1,this._nativeHandlers={}}}class rq{constructor(t,e){this._windowGlobal=t,this._documentGlobal=e,this._windowComponent=new rV(this._windowGlobal),this._documentComponent=new rV(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}class rX{static fromPagePosition(t,e,i){let s,r;3==arguments.length?(s=new ey(t,e),r=i):((s=t).x,s.y,r=e);let n=r.screen.pageToScreenCoordinates(s);return new rX(r.screen.screenToWorldCoordinates(n),s,n)}constructor(t,e,i){this.worldPos=t,this.pagePos=e,this.screenPos=i}}class rZ{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(t,e,i,s,r,n){this.type=t,this.pointerId=e,this.button=i,this.pointerType=s,this.coordinates=r,this.nativeEvent=n,this.active=!0}}class rK{cancel(){this.active=!1}constructor(t,e,i,s,r,n,o,a,h,l,d,c){this.x=t,this.y=e,this.pageX=i,this.pageY=s,this.screenX=r,this.screenY=n,this.index=o,this.deltaX=a,this.deltaY=h,this.deltaZ=l,this.deltaMode=d,this.ev=c,this.active=!0}}class rY{constructor(){this.events=new tT,this.lastPagePos=ey.Zero,this.lastScreenPos=ey.Zero,this.lastWorldPos=ey.Zero,this._onPointerMove=t=>{this.lastPagePos=new ey(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new ey(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new ey(t.worldPos.x,t.worldPos.y)},this._onPointerDown=t=>{this.lastPagePos=new ey(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new ey(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new ey(t.worldPos.x,t.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}}(B=tu||(tu={})).Pixel="Pixel",B.Line="Line",B.Page="Page",(F=tp||(tp={}))[F.NoButton=-1]="NoButton",F[F.Left=0]="Left",F[F.Middle=1]="Middle",F[F.Right=2]="Right",F[F.Unknown=3]="Unknown",(k=t_||(t_={})).Left="Left",k.Middle="Middle",k.Right="Right",k.Unknown="Unknown",k.NoButton="NoButton",(M=tg||(tg={})).Touch="Touch",M.Mouse="Mouse",M.Pen="Pen",M.Unknown="Unknown";class rj{constructor(t,e){this.target=t,this.engine=e,this.events=new tT,this.primary=new rY,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}recreate(t,e){let i=new rj(t,e);return i.primary=this.primary,i._pointers=this._pointers,i}at(t){if(t>=this._pointers.length)for(let e=this._pointers.length-1;e<t;e++)this._pointers.push(new rY);return this._pointers[t]}count(){return this._pointers.length}isDown(t){var e;return null!==(e=this.currentFramePointerDown.get(t))&&void 0!==e&&e}wasDown(t){var e;return null!==(e=this.lastFramePointerDown.get(t))&&void 0!==e&&e}isDragging(t){return this.isDown(t)}isDragStart(t){return this.isDown(t)&&!this.wasDown(t)}isDragEnd(t){return!this.isDown(t)&&this.wasDown(t)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}update(){for(let t of(this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords),this.currentFrameDown))this.emit("down",t),this.at(t.pointerId).emit("down",t),this.primary.emit("pointerdown",t);for(let t of this.currentFrameUp)this.emit("up",t),this.at(t.pointerId).emit("up",t);for(let t of this.currentFrameMove)this.emit("move",t),this.at(t.pointerId).emit("move",t);for(let t of this.currentFrameCancel)this.emit("cancel",t),this.at(t.pointerId).emit("cancel",t);for(let t of this.currentFrameWheel)this.emit("wheel",t),this.primary.emit("pointerwheel",t),this.primary.emit("wheel",t)}clear(){for(let t of this.currentFrameUp)for(let[e,i]of(this.currentFramePointerCoords.delete(t.pointerId),this._activeNativePointerIdsToNormalized.entries()))i===t.pointerId&&this._activeNativePointerIdsToNormalized.delete(e);this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(t){var e;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));let i={passive:!(this.engine.pageScrollPreventionMode===tm.All||this.engine.pageScrollPreventionMode===tm.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,i):void 0!==document.onmousewheel?this.target.addEventListener("mousewheel",this._boundWheel,i):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,i),(null===(e=null==t?void 0:t.grabWindowFocus)||void 0===e||e)&&eo()){let t=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",t):(this.target.addEventListener("touchstart",t),this.target.addEventListener("mousedown",t))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):void 0!==document.onmousewheel?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(t){this._activeNativePointerIdsToNormalized.set(t,-1);let e=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((t,e)=>t-e).findIndex(e=>e===t);return this._activeNativePointerIdsToNormalized.set(t,e),e}_handle(t){let e,i;t.preventDefault();let s=new Map;if(globalThis.TouchEvent&&t instanceof globalThis.TouchEvent){e=t_.Unknown,i=tg.Touch;for(let e=0;e<t.changedTouches.length;e++){let i=t.changedTouches[e],r=rX.fromPagePosition(i.pageX,i.pageY,this.engine),n=e+1,o=this._normalizePointerId(n);this.currentFramePointerCoords.set(o,r),s.set(o,r)}}else{e=this._nativeButtonToPointerButton(t.button),i=tg.Mouse;let r=rX.fromPagePosition(t.pageX,t.pageY,this.engine),n=1;globalThis.PointerEvent&&t instanceof globalThis.PointerEvent&&(n=t.pointerId,i=this._stringToPointerType(t.pointerType));let o=this._normalizePointerId(n);this.currentFramePointerCoords.set(o,r),s.set(o,r)}for(let[r,n]of s.entries())switch(t.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new rZ("down",r,e,i,n,t)),this.currentFramePointerDown.set(r,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new rZ("up",r,e,i,n,t)),this.currentFramePointerDown.set(r,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new rZ("move",r,e,i,n,t));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new rZ("cancel",r,e,i,n,t))}}_handleWheel(t){(this.engine.pageScrollPreventionMode===tm.All||this.engine.pageScrollPreventionMode===tm.Canvas&&t.target===this.engine.canvas)&&t.preventDefault();let e=this.engine.screen.pageToScreenCoordinates(ew(t.pageX,t.pageY)),i=this.engine.screen.screenToWorldCoordinates(e),s=-1/40,r=t.deltaX||t.wheelDeltaX*s||0,n=t.deltaY||t.wheelDeltaY*s||t.wheelDelta*s||t.detail||0,o=t.deltaZ||0,a=tu.Pixel;t.deltaMode&&(1===t.deltaMode?a=tu.Line:2===t.deltaMode&&(a=tu.Page));let h=new rK(i.x,i.y,t.pageX,t.pageY,e.x,e.y,0,r,n,o,a,t);this.currentFrameWheel.push(h)}triggerEvent(t,e){let i=this.engine.screen.worldToPageCoordinates(e);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+t,{pointerId:0,clientX:i.x,clientY:i.y})):this._handle(new window.MouseEvent("mouse"+t,{clientX:i.x,clientY:i.y}));let s=this.engine.currentScene.world.systemManager.get(rD),r=this.engine.currentScene.world.queryManager.createQuery(s.types);s.preupdate(),s.update(r.getEntities())}_nativeButtonToPointerButton(t){switch(t){case tp.NoButton:return t_.NoButton;case tp.Left:return t_.Left;case tp.Middle:return t_.Middle;case tp.Right:return t_.Right;case tp.Unknown:return t_.Unknown;default:return eD(t)}}_stringToPointerType(t){switch(t){case"touch":return tg.Touch;case"mouse":return tg.Mouse;case"pen":return tg.Pen;default:return tg.Unknown}}}class r${constructor(t){var e;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=t.initialFps,this._samplePeriod=null!==(e=t.samplePeriod)&&void 0!==e?e:this._samplePeriod,this._currentFrameTime=1e3/t.initialFps,this._nowFn=t.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;let t=this._nowFn();this._currentFrameTime=t-this._beginFrameTime,t>=this._previousSampleTime+this._samplePeriod&&(this._fps=1e3*this._frames/(t-this._previousSampleTime),this._previousSampleTime=t,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class rQ{constructor(t){var e,i,s;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=t,this.tick=t.tick,this._lastTime=null!==(e=this.now())&&void 0!==e?e:0,this._maxFps=null!==(i=t.maxFps)&&void 0!==i?i:this._maxFps,this._onFatalException=null!==(s=t.onFatalException)&&void 0!==s?s:this._onFatalException,this.fpsSampler=new r$({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new r0({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new rJ({...this._options})}setFatalExceptionHandler(t){this._onFatalException=t}schedule(t,e=0){let i=this._totalElapsed+e;this._scheduledCbs.push([t,i])}_runScheduledCbs(){for(let t=this._scheduledCbs.length-1;t>-1;t--)this._scheduledCbs[t][1]<=this._totalElapsed&&(this._scheduledCbs[t][0](),this._scheduledCbs.splice(t,1))}update(t){try{this.fpsSampler.start();let e=this.now(),i=e-this._lastTime||1,s=1e3/this._maxFps;if(i>=s){let r=0;0!==s&&(r=i%s,i-=r),i>200&&(i=1),this._elapsed=t||i,this._totalElapsed+=this._elapsed,this._runScheduledCbs(),this.tick(t||i),0!==s?this._lastTime=e-r:this._lastTime=e,this.fpsSampler.end()}}catch(t){this._onFatalException(t),this.stop()}}}class rJ extends rQ{constructor(t){super(t),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;let t=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(t),this.update()}catch(t){throw window.cancelAnimationFrame(this._requestId),t}};t()}stop(){this._running=!1}}class r0 extends rQ{constructor(t){super({...t}),this._logger=es.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=t.defaultUpdateMs}now(){var t;return null!==(t=this._currentTime)&&void 0!==t?t:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(t){let e=null!=t?t:this._updateMs;this._running?(this.update(e),this._currentTime+=e):this._logger.warn("The clock is not running, no step will be performed")}run(t,e){for(let i=0;i<t;i++)this.step(null!=e?e:this._updateMs)}}var r1=i(7379);class r2{constructor(){this._toasterCss=r1.Z.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(t){let e=document.createElement("span");return e.innerText=t,e}toast(t,e,i){this._initialize();let s=document.createElement("div");s.className="ex-toast-message";let r=t.split("[LINK]").map(t=>this._createFragment(t));if(e){let t=document.createElement("a");t.href=e,i?t.innerText=i:t.innerText=e,r.splice(1,0,t)}let n=document.createElement("div");r.forEach(t=>{n.appendChild(t)}),s.appendChild(n);let o=document.createElement("button");o.innerText="x",o.addEventListener("click",()=>{this._container.removeChild(s)}),s.appendChild(o);let a=t=>{if("Escape"===t.key)try{this._container.removeChild(s)}catch(t){}document.removeEventListener("keydown",a)};document.addEventListener("keydown",a);let h=this._container.firstChild;this._container.insertBefore(s,h)}}class r5{constructor(t){this.inputs=t,this._handlers=new Map}execute(){for(let[t,e]of this._handlers.entries()){let i=t(this.inputs);i&&e(i)}}on(t,e){this._handlers.set(t,e)}}tb();let r4={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};(L=tm||(tm={}))[L.None=0]="None",L[L.Canvas=1]="Canvas",L[L.All=2]="All";class r3{get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(t){this.graphicsContext.snapToPixel=t}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}constructor(t){var e,i,s,r,n,o;this.version=ny,this.events=new tT,this.maxFps=Number.POSITIVE_INFINITY,this.scenes={},this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=t=>{es.getInstance().fatal(t)},this._toaster=new r2,this._timescale=1,this._isInitialized=!1,this._deferredGoTo=null,this._originalOptions={},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._loadingComplete=!1,this._isReady=!1,this._isReadyPromise=new Promise(t=>{this._isReadyResolve=t}),this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],t={...r3._DEFAULT_ENGINE_OPTIONS,...t},this._originalOptions=t,tC.freeze(),this.browser=new rq(window,document);let a=new iL;if(t.suppressMinimumBrowserFeatureDetection||(this._compatible=a.test()))this._compatible=!0;else{let e=document.createElement("div");if(e.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(e),a.failedTests.forEach(function(t){let e=document.createElement("div");e.innerText="Browser feature missing "+t,document.body.appendChild(e)}),t.canvasElementId){let e=document.getElementById(t.canvasElementId);e&&e.parentElement.removeChild(e)}return}console.log&&!t.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${ny})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log("\n      /| ________________\nO|===|* >________________>\n      \\|"),console.log("Visit","http://excaliburjs.com","for more information")),t.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=es.getInstance(),this._logger.defaultLevel===N.Debug&&a.logBrowserFeatures(),this._logger.debug("Building engine..."),this.canvasElementId=t.canvasElementId,t.canvasElementId?(this._logger.debug("Using Canvas element specified: "+t.canvasElementId),this.canvas=document.getElementById(t.canvasElementId)):t.canvasElement?(this._logger.debug("Using Canvas element specified:",t.canvasElement),this.canvas=t.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));let h=null!==(e=t.displayMode)&&void 0!==e?e:X.Fixed;t.width&&t.height||t.viewport?(void 0===t.displayMode&&(h=X.Fixed),this._logger.debug("Engine viewport is size "+t.width+" x "+t.height)):t.displayMode||(this._logger.debug("Engine viewport is fit"),h=X.FitScreen),this._originalDisplayMode=h;let l=tC.isEnabled("use-canvas-context");if(!l)try{this.graphicsContext=new ih({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,smoothing:t.antialiasing,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting})}catch(t){this._logger.warn(`Excalibur could not load webgl for some reason (${t.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/webgl`),l=!0}l&&(this.graphicsContext=new id({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,smoothing:t.antialiasing,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting})),this.screen=new ip({canvas:this.canvas,context:this.graphicsContext,antialiasing:null===(i=t.antialiasing)||void 0===i||i,browser:this.browser,viewport:null!==(s=t.viewport)&&void 0!==s?s:t.width&&t.height?{width:t.width,height:t.height}:ic.SVGA,resolution:t.resolution,displayMode:h,pixelRatio:t.suppressHiDPIScaling?1:null!==(r=t.pixelRatio)&&void 0!==r?r:null}),eG.filtering=t.antialiasing?q.Blended:q.Pixel,t.backgroundColor&&(this.backgroundColor=t.backgroundColor.clone()),this.maxFps=null!==(n=t.maxFps)&&void 0!==n?n:this.maxFps,this.fixedUpdateFps=null!==(o=t.fixedUpdateFps)&&void 0!==o?o:this.fixedUpdateFps,this.clock=new rJ({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:t=>this.onFatalException(t)}),this.enableCanvasTransparency=t.enableCanvasTransparency,this._loader=new ik,this._loader.wireEngine(this),this.debug=new rH(this),this._initialize(t),this.rootScene=this.currentScene=new rz,this.addScene("root",this.rootScene),window.___EXCALIBUR_DEVTOOL=this}_monitorPerformanceThresholdAndTriggerFallback(){let{allow:t}=this._originalOptions.configurePerformanceCanvas2DFallback,{threshold:e,showPlayerMessage:i}=this._originalOptions.configurePerformanceCanvas2DFallback;if(void 0===e&&(e=r3._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),void 0===i&&(i=r3._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!tC.isEnabled("use-canvas-context")&&t&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===e.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let t=0;for(let e=0;e<this._fpsSamples.length;e++)t+=this._fpsSamples[e];let s=t/this._fpsSamples.length;this._fpsSamples.length===e.numberOfFrames&&s<=e.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),i&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var t,e,i;let s=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(s,this.canvas),this.canvas=s;let r={...this._originalOptions,antialiasing:this.getAntialiasing()},n=this._originalDisplayMode;this.graphicsContext=new id({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,smoothing:r.antialiasing,backgroundColor:r.backgroundColor,snapToPixel:r.snapToPixel,useDrawSorting:r.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new ip({canvas:this.canvas,context:this.graphicsContext,antialiasing:null===(t=r.antialiasing)||void 0===t||t,browser:this.browser,viewport:null!==(e=r.viewport)&&void 0!==e?e:r.width&&r.height?{width:r.width,height:r.height}:ic.SVGA,resolution:r.resolution,displayMode:n,pixelRatio:r.suppressHiDPIScaling?1:null!==(i=r.pixelRatio)&&void 0!==i?i:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();let o=r&&r.pointerScope===W.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(o,this),this.input.pointers.init()}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(t){if(t<=0){es.getInstance().error("Cannot set engine.timescale to a value of 0 or less than 0.");return}this._timescale=t}addTimer(t){return this.currentScene.addTimer(t)}removeTimer(t){return this.currentScene.removeTimer(t)}addScene(t,e){this.scenes[t]&&this._logger.warn("Scene",t,"already exists overwriting"),this.scenes[t]=e}removeScene(t){if(t instanceof rz)for(let e in this.scenes)this.scenes.hasOwnProperty(e)&&this.scenes[e]===t&&delete this.scenes[e];"string"==typeof t&&delete this.scenes[t]}add(t){if(2==arguments.length){this.addScene(arguments[0],arguments[1]);return}this._deferredGoTo&&this.scenes[this._deferredGoTo]?this.scenes[this._deferredGoTo].add(t):this.currentScene.add(t)}remove(t){t instanceof s_&&this.currentScene.remove(t),t instanceof rz&&this.removeScene(t),"string"==typeof t&&this.removeScene(t)}goToScene(t,e){if(!this.isInitialized){this._deferredGoTo=t;return}if(this.scenes[t]){let i=this.currentScene,s=this.scenes[t];if(this._logger.debug("Going to scene:",t),this.currentScene.isInitialized){let t={engine:this,previousScene:i,nextScene:s};this.currentScene._deactivate.apply(this.currentScene,[t,s]),this.currentScene.events.emit("deactivate",new t4(t,this.currentScene))}this.currentScene=s,this.screen.setCurrentCamera(s.camera),this.currentScene._initialize(this);let r={engine:this,previousScene:i,nextScene:s,data:e};this.currentScene._activate.apply(this.currentScene,[r,s]),this.currentScene.events.emit("activate",new t5(r,this.currentScene))}else this._logger.error("Scene",t,"does not exist!")}screenToWorldCoordinates(t){return this.screen.screenToWorldCoordinates(t)}worldToScreenCoordinates(t){return this.screen.worldToScreenCoordinates(t)}_initialize(t){var e,i,s,r;this.pageScrollPreventionMode=t.scrollPreventionMode;let n=t&&t.pointerScope===W.Document?document:this.canvas;this.input={keyboard:new eh,pointers:new rj(n,this),gamepads:new ee},this.input.keyboard.init({grabWindowFocus:null===(i=null===(e=this._originalOptions)||void 0===e?void 0:e.grabWindowFocus)||void 0===i||i}),this.input.pointers.init({grabWindowFocus:null===(r=null===(s=this._originalOptions)||void 0===s?void 0:s.grabWindowFocus)||void 0===r||r}),this.input.gamepads.init(),this.inputMapper=new r5(this.input),this.browser.document.on("visibilitychange",()=>{"hidden"===document.visibilityState?(this.events.emit("hidden",new tZ(this)),this._logger.debug("Window hidden")):"visible"===document.visibilityState&&(this.events.emit("visible",new tX(this)),this._logger.debug("Window visible"))}),this.canvasElementId||t.canvasElement||document.body.appendChild(this.canvas)}onInitialize(t){}setAntialiasing(t){this.screen.antialiasing=t}getAntialiasing(){return this.screen.antialiasing}get isInitialized(){return this._isInitialized}_overrideInitialize(t){if(!this.isInitialized){if(this.onInitialize(t),this.events.emit("initialize",new t2(t,this)),this._isInitialized=!0,this._deferredGoTo){let t=this._deferredGoTo;this._deferredGoTo=null,this.goToScene(t)}else this.goToScene("root")}}_update(t){if(!this.ready){this._loader.update(this,t),this.inputMapper.execute(),this.input.keyboard.update(),this.input.gamepads.update();return}this._preupdate(t),this.currentScene.update(this,t),this.graphicsContext.updatePostProcessors(t),this._postupdate(t),this.inputMapper.execute(),this.input.keyboard.update(),this.input.gamepads.update()}_preupdate(t){this.emit("preupdate",new tU(this,t,this)),this.onPreUpdate(this,t)}onPreUpdate(t,e){}_postupdate(t){this.emit("postupdate",new tO(this,t,this)),this.onPostUpdate(this,t)}onPostUpdate(t,e){}_draw(t){var e;if(this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this._predraw(this.graphicsContext,t),!this._isReady){this._loader.canvas.draw(this.graphicsContext,0,0),this.graphicsContext.flush();return}this.graphicsContext.backgroundColor=null!==(e=this.currentScene.backgroundColor)&&void 0!==e?e:this.backgroundColor,this.currentScene.draw(this.graphicsContext,t),this._postdraw(this.graphicsContext,t),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(t,e){this.emit("predraw",new tB(t,e,this)),this.onPreDraw(t,e)}onPreDraw(t,e){}_postdraw(t,e){this.emit("postdraw",new tF(t,e,this)),this.onPostDraw(t,e)}onPostDraw(t,e){}showDebug(t){this._isDebug=t}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return this._loadingComplete}get ready(){return this._isReady}isReady(){return this._isReadyPromise}async start(t){if(!this._compatible)throw Error("Excalibur is incompatible with your browser");return t&&(this.screen.pushResolutionAndViewport(),this.screen.resolution=this.screen.viewport,this.screen.applyResolutionAndViewport(),this._loader=t,this._loader.suppressPlayButton=this._suppressPlayButton||this._loader.suppressPlayButton,this._loader.wireEngine(this)),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this._logger.debug("Game clock started"),t&&(await this.load(this._loader),this._loadingComplete=!0,this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport()),this._loadingComplete=!0,this._overrideInitialize(this),this._isReady=!0,this._isReadyResolve(),this.emit("start",new tD(this)),this._isReadyPromise}_mainloop(t){this.emit("preframe",new tN(this,this.stats.prevFrame));let e=t*this.timescale;this.currentFrameElapsedMs=e;let i=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=i,this.stats.currFrame.delta=e,this.stats.currFrame.fps=this.clock.fpsSampler.fps,e2.clear();let s=this.clock.now(),r=1e3/this.fixedUpdateFps;if(this.fixedUpdateFps)for(this._lagMs+=e;this._lagMs>=r;)this._update(r),this._lagMs-=r;else this._update(e);let n=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(e);let o=this.clock.now();this.stats.currFrame.duration.update=n-s,this.stats.currFrame.duration.draw=o-n,this.stats.currFrame.graphics.drawnImages=e2.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=e2.DrawCallCount,this.emit("postframe",new tH(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()}stop(){this.clock.isRunning()&&(this.emit("stop",new tR(this)),this.browser.pause(),this.clock.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(t=!1){return new Promise(e=>{this._screenShotRequests.push({preserveHiDPIResolution:t,resolve:e})})}_checkForScreenShots(){for(let t of this._screenShotRequests){let e=t.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,i=t.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,s=document.createElement("canvas");s.width=e,s.height=i;let r=s.getContext("2d");r.imageSmoothingEnabled=this.screen.antialiasing,r.drawImage(this.canvas,0,0,e,i);let n=new Image,o=s.toDataURL("image/png");n.src=o,t.resolve(n)}this._screenShotRequests.length=0}async load(t){try{await t.load()}catch(t){this._logger.error("Error loading resources, things may not behave properly",t),await Promise.resolve()}}}r3._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,snapToPixel:!1,pointerScope:W.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:tm.Canvas,backgroundColor:eb.fromHex("#2185d0")};class r6{constructor(){this._handlers={},this._wiredEventDispatchers=[],this._deferedHandlerRemovals=[]}clear(){this._handlers={},this._wiredEventDispatchers=[]}_processDeferredHandlerRemovals(){for(let t of this._deferedHandlerRemovals)this._removeHandler(t.name,t.handler);this._deferedHandlerRemovals.length=0}emit(t,e){let i,s;if(this._processDeferredHandlerRemovals(),t){if(t=t.toLowerCase(),null==e&&(e=new tS),this._handlers[t])for(i=0,s=this._handlers[t].length;i<s;i++)this._handlers[t][i](e);for(i=0,s=this._wiredEventDispatchers.length;i<s;i++)this._wiredEventDispatchers[i].emit(t,e)}}on(t,e){this._processDeferredHandlerRemovals(),t=t.toLowerCase(),this._handlers[t]||(this._handlers[t]=[]),this._handlers[t].push(e)}off(t,e){this._deferedHandlerRemovals.push({name:t,handler:e})}_removeHandler(t,e){t=t.toLowerCase();let i=this._handlers[t];if(i){if(e){let s=i.indexOf(e);s>-1&&this._handlers[t].splice(s,1)}else this._handlers[t].length=0}}once(t,e){this._processDeferredHandlerRemovals();let i=s=>{let r=s||new tS;this.off(t,i),e(r)};this.on(t,i)}wire(t){t._wiredEventDispatchers.push(this)}unwire(t){let e=t._wiredEventDispatchers.indexOf(this);e>-1&&t._wiredEventDispatchers.splice(e,1)}}class r9 extends sZ{get font(){return this._font}set font(t){this._font=t,this._text.font=t}get text(){return this._text.text}set text(t){this._text.text=t}get color(){return this._text.color}set color(t){this._text&&(this._text.color=t)}get opacity(){return this._text.opacity}set opacity(t){this._text.opacity=t}get spriteFont(){return this._spriteFont}set spriteFont(t){t&&(this._spriteFont=t,this._text.font=this._spriteFont)}constructor(t){super(t),this._font=new sq,this._text=new sX({text:"",font:this._font});let{text:e,pos:i,x:s,y:r,spriteFont:n,font:o,color:a}=t;this.pos=null!=i?i:s&&r?ew(s,r):this.pos,this.text=null!=e?e:this.text,this.font=null!=o?o:this.font,this.spriteFont=null!=n?n:this.spriteFont,this._text.color=null!=a?a:this.color;let h=this.get(sv);h.anchor=ey.Zero,h.use(this._text)}_initialize(t){super._initialize(t)}getTextWidth(){return this._text.width}}class r7 extends s_{getGraphics(){return this._graphics}addGraphic(t,e){this._graphics.push(t),this._gfx.visible=this.map.visible,this._gfx.opacity=this.map.opacity,(null==e?void 0:e.offset)&&(this._gfx.offset=e.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let t=this._tileBounds.clone();for(let e of this._graphics){let i=ew(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:e.height-this.map.tileHeight));t=t.combine(e.localBounds.translate(i))}return t}removeGraphic(t){let e=this._graphics.indexOf(t);e>-1&&this._graphics.splice(e,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.visible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){let e=this._colliders.indexOf(t);e>-1&&this._colliders.splice(e,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(ew(this.x,this.y))}get center(){return this.pos.add(ew(0,this.map.tileHeight/2))}constructor(t,e,i,s){super([new iY,new sv({offset:null!=i?i:ey.Zero,onPostDraw:(t,e)=>this.draw(t,e)}),new rB(s)]),this.solid=!1,this._tileBounds=new eA,this._graphics=[],this._colliders=[],this.data=new Map,this.x=t,this.y=e,this.map=s,this._transform=this.get(iY),this._isometricEntityComponent=this.get(rB);let r=this.map.tileWidth/2,n=this.map.tileHeight/2,o=(this.x-this.y)*r,a=(this.x+this.y)*n;this._transform.pos=ew(o,a),this._isometricEntityComponent.elevation=s.elevation,this._gfx=this.get(sv),this._gfx.visible=!1;let h=this.map.tileWidth,l=this.map.tileHeight,d=ew(0,this.map.renderFromTopOfGraphic?l:0);this._gfx.localBounds=this._tileBounds=new eA({left:-h/2,top:-l,right:h/2,bottom:l}).translate(d)}draw(t,e){let i=this.map.tileWidth/2;for(let e of(t.save(),t.translate(-i,0),this._graphics))e.draw(t,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:e.height-this.map.tileHeight));t.restore()}}class r8 extends s_{constructor(t){super([new iY,new sh({type:Z.Fixed}),new sa,new sQ((t,e)=>this.debug(t,e),!1)],t.name),this.elevation=0,this.visible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=ew(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;let{pos:e,tileWidth:i,tileHeight:s,columns:r,rows:n,renderFromTopOfGraphic:o,graphicsOffset:a,elevation:h}=t;this.transform=this.get(iY),e&&(this.transform.pos=e),this.collider=this.get(sa),this.collider&&this.collider.set(this._composite=new i6([])),this.renderFromTopOfGraphic=null!=o?o:this.renderFromTopOfGraphic,this.graphicsOffset=null!=a?a:this.graphicsOffset,this.elevation=null!=h?h:this.elevation,this.tileWidth=i,this.tileHeight=s,this.columns=r,this.rows=n,this.tiles=Array(r*n);for(let t=0;t<n;t++)for(let e=0;e<r;e++){let i=new r7(e,t,this.graphicsOffset,this);this.tiles[e+t*r]=i,this.addChild(i)}}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1)}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(t){if(this._originalOffsets.has(t))return this._originalOffsets.get(t);{let e=t.offset;return this._originalOffsets.set(t,e),e}}updateColliders(){this._composite.clearColliders();let t=this.get(iY).pos;for(let e of this.tiles)if(e.solid)for(let i of e.getColliders()){let s=this._getOrSetColliderOriginalOffset(i);i.offset=this.tileToWorld(ew(e.x,e.y)).sub(t).add(s).sub(ew(this.tileWidth/2,this.tileHeight)),i.owner=this,this._composite.addCollider(i)}this.collider.update()}worldToTile(t){t=t.sub(this.transform.globalPos);let e=this.tileWidth/2,i=this.tileHeight/2;return ew(~~((t.x/e+t.y/i)/2),~~((t.y/i-t.x/e)/2))}tileToWorld(t){let e=this.tileWidth/2,i=this.tileHeight/2;return ew((t.x-t.y)*e,(t.x+t.y)*i).add(this.transform.pos)}getTile(t,e){return t<0||e<0||t>=this.columns||e>=this.rows?null:this.tiles[t+e*this.columns]}getTileByPoint(t){let e=this.worldToTile(t);return this.getTile(e.x,e.y)}_getMaxZIndex(){let t=Number.NEGATIVE_INFINITY;for(let e of this.tiles){let i=e.get(iY).z;i>t&&(t=i)}return t}debug(t,e){let{showAll:i,showPosition:s,positionColor:r,positionSize:n,showGrid:o,gridColor:a,gridWidth:h,showColliderGeometry:l}=e.isometric,{geometryColor:d,geometryLineWidth:c,geometryPointSize:u}=e.collider;if(t.save(),t.z=this._getMaxZIndex()+.5,i||o){for(let e=0;e<this.rows+1;e++){let i=this.tileToWorld(ew(0,e)),s=this.tileToWorld(ew(this.columns,e));t.drawLine(i,s,a,h)}for(let e=0;e<this.columns+1;e++){let i=this.tileToWorld(ew(e,0)),s=this.tileToWorld(ew(e,this.rows));t.drawLine(i,s,a,h)}}if(i||s)for(let e of this.tiles)t.drawCircle(this.tileToWorld(ew(e.x,e.y)),n,r);if(i||l){for(let e of this.tiles)if(e.solid)for(let i of e.getColliders())i.debug(t,d,{lineWidth:c,pointSize:u})}t.restore()}}class nt{constructor(t,e){this._stopped=!1,this._sequenceBuilder=e,this._sequenceContext=new sH(t),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(t){this._actionQueue.update(t)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(t){return new nt(t,this._sequenceBuilder)}}class ne{constructor(t){this._actions=t}update(t){for(let e=0;e<this._actions.length;e++)this._actions[e].update(t)}isComplete(t){return this._actions.every(e=>e.isComplete(t))}reset(){this._actions.forEach(t=>t.reset())}stop(){this._actions.forEach(t=>t.stop())}}function ni(t){return!!t._initialize}function ns(t){return!!t.onInitialize}function nr(t){return!!t._preupdate}function nn(t){return!!t.onPreUpdate}function no(t){return!!t.onPostUpdate}function na(t){return!!t.onPostUpdate}function nh(t){return!!t.onPreDraw}function nl(t){return!!t.onPostDraw}class nd{constructor(t,e=eb.Magenta,i=!1){this.path=t,this.color=e,this._stream=null,this._gif=null,this._textures=[],this._animation=null,this._transparentColor=null,this._resource=new eU(t,"arraybuffer",i),this._transparentColor=e}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){let t=await this._resource.load();this._stream=new np(t),this._gif=new ng(this._stream,this._transparentColor);let e=this._gif.images.map(t=>new eV(t.src,!1));return await Promise.all(e.map(t=>t.load())),this.data=this._textures=e}isLoaded(){return!!this.data}toSprite(t=0){return this._textures[t].toSprite()}toSpriteSheet(){return new eq({sprites:this._textures.map(t=>t.toSprite())})}toAnimation(t){let e=this.toSpriteSheet(),i=e.sprites.length;return this._animation=rb.fromSpriteSheet(e,ef(0,i),t),this._animation}get readCheckBytes(){return this._gif.checkBytes}}let nc=t=>t.reduce(function(t,e){return 2*t+e},0),nu=t=>{let e=[];for(let i=7;i>=0;i--)e.push(!!(t&1<<i));return e};class np{constructor(t){if(this.data=null,this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=t=>{let e=[];for(let i=0;i<t;i++)e.push(this.readByte());return e},this.read=t=>{let e="";for(let i=0;i<t;i++)e+=String.fromCharCode(this.readByte());return e},this.readUnsigned=()=>{let t=this.readBytes(2);return(t[1]<<8)+t[0]},this.data=new Uint8Array(t),this.len=this.data.byteLength,0===this.len)throw Error("No data loaded from file")}}let n_=function(t,e){let i,s,r=0,n=[],o=1<<t,a=o+1,h=t+1,l=[];for(;;){if(s=i,(i=function(t){let i=0;for(let s=0;s<t;s++)e.charCodeAt(r>>3)&1<<(7&r)&&(i|=1<<s),r++;return i}(h))===o){!function(){l=[],h=t+1;for(let t=0;t<o;t++)l[t]=[t];l[o]=[],l[a]=null}();continue}if(i===a)break;if(i<l.length)s!==o&&l.push(l[s].concat(l[i][0]));else{if(i!==l.length)throw Error("Invalid LZW code.");l.push(l[s].concat(l[s][0]))}n.push.apply(n,l[i]),l.length===1<<h&&h<12&&h++}return n};class ng{constructor(t,e=eb.Magenta){this._st=null,this._handler={},this._transparentColor=null,this.frames=[],this.images=[],this.globalColorTable=[],this.checkBytes=[],this.parseColorTable=t=>{let e=[];for(let i=0;i<t;i++){let t="#"+this._st.readBytes(3).map(t=>{let e=t.toString(16);return 1===e.length?"0"+e:e}).join("");e.push(t)}return e},this.readSubBlocks=()=>{let t,e;e="";do t=this._st.readByte(),e+=this._st.read(t);while(0!==t)return e},this.parseHeader=()=>{let t={sig:null,ver:null,width:null,height:null,colorRes:null,globalColorTableSize:null,gctFlag:null,sorted:null,globalColorTable:[],bgColor:null,pixelAspectRatio:null};if(t.sig=this._st.read(3),t.ver=this._st.read(3),"GIF"!==t.sig)throw Error("Not a GIF file.");t.width=this._st.readUnsigned(),t.height=this._st.readUnsigned();let e=nu(this._st.readByte());t.gctFlag=e.shift(),t.colorRes=nc(e.splice(0,3)),t.sorted=e.shift(),t.globalColorTableSize=nc(e.splice(0,3)),t.bgColor=this._st.readByte(),t.pixelAspectRatio=this._st.readByte(),t.gctFlag&&(t.globalColorTable=this.parseColorTable(1<<t.globalColorTableSize+1),this.globalColorTable=t.globalColorTable),this._handler.hdr&&this._handler.hdr(t)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=t=>{switch(t.label=this._st.readByte(),t.label){case 249:t.extType="gce",(t=>{this.checkBytes.push(this._st.readByte());let e=nu(this._st.readByte());t.reserved=e.splice(0,3),t.disposalMethod=nc(e.splice(0,3)),t.userInput=e.shift(),t.transparencyGiven=e.shift(),t.delayTime=this._st.readUnsigned(),t.transparencyIndex=this._st.readByte(),t.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(t)&&this.checkBytes.push(this._handler.gce)})(t);break;case 254:t.extType="com",(t=>{t.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(t)&&this.checkBytes.push(this._handler.com)})(t);break;case 1:t.extType="pte",(t=>{this.checkBytes.push(this._st.readByte()),t.ptHeader=this._st.readBytes(12),t.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(t)&&this.checkBytes.push(this._handler.pte)})(t);break;case 255:t.extType="app",(t=>{(this.checkBytes.push(this._st.readByte()),t.identifier=this._st.read(8),t.authCode=this._st.read(3),"NETSCAPE"===t.identifier)?(t=>{this.checkBytes.push(this._st.readByte()),t.unknown=this._st.readByte(),t.iterations=this._st.readUnsigned(),t.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(t)&&this.checkBytes.push(this._handler.app)})(t):(t=>{t.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[t.identifier]&&this._handler.app[t.identifier](t)&&this.checkBytes.push(this._handler.app[t.identifier])})(t)})(t);break;default:t.extType="unknown",(t=>{t.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(t)&&this.checkBytes.push(this._handler.unknown)})(t)}},this.parseImg=t=>{t.leftPos=this._st.readUnsigned(),t.topPos=this._st.readUnsigned(),t.width=this._st.readUnsigned(),t.height=this._st.readUnsigned();let e=nu(this._st.readByte());t.lctFlag=e.shift(),t.interlaced=e.shift(),t.sorted=e.shift(),t.reserved=e.splice(0,2),t.lctSize=nc(e.splice(0,3)),t.lctFlag&&(t.lct=this.parseColorTable(1<<t.lctSize+1)),t.lzwMinCodeSize=this._st.readByte();let i=this.readSubBlocks();t.pixels=n_(t.lzwMinCodeSize,i),t.interlaced&&(t.pixels=((t,e)=>{let i=Array(t.length),s=t.length/e,r=(s,r)=>{let n=t.slice(r*e,(r+1)*e);i.splice.apply(i,[s*e,e].concat(n))},n=[0,4,2,1],o=[8,8,4,2],a=0;for(let t=0;t<4;t++)for(let e=n[t];e<s;e+=o[t])r(e,a),a++;return i})(t.pixels,t.width)),this.frames.push(t),this.arrayToImage(t),this._handler.img&&this._handler.img(t)&&this.checkBytes.push(this._handler)},this.parseBlock=()=>{let t={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(t.sentinel)){case"!":t.type="ext",this.parseExt(t);break;case",":t.type="img",this.parseImg(t);break;case";":t.type="eof",this._handler.eof&&this._handler.eof(t)&&this.checkBytes.push(this._handler.eof);break;default:throw Error("Unknown block: 0x"+t.sentinel.toString(16))}"eof"!==t.type&&this.parseBlock()},this.arrayToImage=t=>{let e=0,i=document.createElement("canvas");i.id=e.toString(),i.width=t.width,i.height=t.height,e++;let s=i.getContext("2d"),r=0,n=0;for(let e=0;e<t.pixels.length;e++)n%t.width==0&&(r++,n=0),this.globalColorTable[t.pixels[e]]===this._transparentColor.toHex()?s.fillStyle="rgba(0, 0, 0, 0)":s.fillStyle=this.globalColorTable[t.pixels[e]],s.fillRect(n,r,1,1),n++;let o=new Image;o.src=i.toDataURL(),this.images.push(o)},this._st=t,this._handler={},this._transparentColor=e,this.parseHeader(),this.parseBlock()}}class nm extends eH{constructor(t){super(),this.color=eb.Black,this.thickness=1;let{start:e,end:i,color:s,thickness:r}=t;this.start=e,this.end=i,this.color=null!=s?s:this.color,this.thickness=null!=r?r:this.thickness,this._localBounds=this._calculateBounds();let{width:n,height:o}=this._localBounds;this.width=n,this.height=o}get localBounds(){return this._localBounds}_calculateBounds(){let t=this.end.sub(this.start).normal(),e=this.thickness/2,i=[this.start.add(t.scale(e)),this.end.add(t.scale(e)),this.end.add(t.scale(-e)),this.start.add(t.scale(-e))];return eA.fromPoints(i)}_drawImage(t,e,i){t.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new nm({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class nf extends iC{get points(){return this._points}set points(t){this._points=t;let e=this.minPoint;this.width=this._points.reduce((t,e)=>Math.max(e.x,t),0)-e.x,this.height=this._points.reduce((t,e)=>Math.max(e.y,t),0)-e.y,this.flagDirty()}get minPoint(){return ew(this._points.reduce((t,e)=>Math.min(e.x,t),1/0),this._points.reduce((t,e)=>Math.min(e.y,t),1/0))}constructor(t){super(t),this.points=t.points,this.filtering=q.Blended,this.rasterize()}clone(){return new nf({points:this.points.map(t=>t.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){if(this.points&&this.points.length){t.beginPath();let e=this.minPoint.negate(),i=this.points[0].add(e);t.moveTo(i.x,i.y),this.points.forEach(i=>{t.lineTo(i.x+e.x,i.y+e.y)}),t.lineTo(i.x,i.y),t.closePath(),this.color&&t.fill(),this.strokeColor&&t.stroke()}}}class nv{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){let t=new eT;return this._queue.push(t),t.promise}dequeue(t){this._queue.shift().resolve(t)}}class nx{constructor(t){this._count=t,this._waitQueue=new nv}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return 0!==this._count?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(t=1){if(0!==t){for(;0!==t&&0!==this._waitQueue.length;)this._waitQueue.dequeue(null),t--;this._count+=t}}}let ny="0.29.0-alpha.4+6f6d7bb";tb()})(),s.y1j,s.fWn,s.Ia8,s.rqv,s.zH6,s.hLI,s.yyv,s.tX5;var r=s.vtX;s.r7K,s.lCh,s.cE4,s.fwF,s.sce,s.AQ6,s._c7,s.KUs,s.Ajp,s.dkO,s.RDh,s._H9,s.mxs,s.OmD,s.kBf,s.C4F,s.NQt,s.JjN,s.EK_,s.V1s,s.xHm,s.Xz7,s.Cdc,s.FKn,s.SUY,s.ab2,s.GfZ,s.YMS,s.oyv,s.aUb,s.SdD,s.JUv,s.jEj,s.TFq,s.HDU,s.R_y,s.ydN,s.t50,s.s$$;var n=s.v2G,o=s.Ilk;s.s9i,s.dxL,s.LLX,s.wA2,s.R_p,s.IQ$,s.I5F,s.X8$,s.FR6,s.U8o,s.kbG,s.iS_,s.cGG,s.RPN,s.skb,s.SLU,s.RdJ,s.cNu,s.gU7,s.LSk,s.Nmp,s.d1Y,s.xrL,s.sRW,s.cmV,s.qWz,s.N0Q,s.q8b,s.ynB,s.jT9,s.wAz;var a=s.D4V;s.NLr,s.N6H,s.W1A,s.JHW,s.ZZ$,s.v2K,s.pBf,s.vpe,s.GMl,s.zW2,s.B0K,s.Nv7,s.C_p,s.MUA,s.xqU,s.pTp,s.vUK,s.j9l,s.Zxw,s.v51,s.Hdx,s.Z$d,s.iqV,s.o$7,s.olM,s.Zm$,s.$QH,s.i78,s.nJg,s.h6u,s.hts,s.j88,s.VME,s.fy2,s.nt,s.Ukr,s.zsu,s.oA6,s.TVh,s.TwZ,s.GTT,s.xxj,s.XdK,s.Jmb,s.cXo,s.Dm5,s.IIB,s.ebW,s.zI0,s.LYD,s.cEG,s.SEl,s.t9V,s.ez5,s.N1d,s.R8U,s.SKZ,s.__J,s.RI$,s.x12,s.ccz,s.aNw,s.XrL,s.xwn,s.dNK,s.ini,s.YdH,s.F5T,s.y3G,s.l57,s.xn0,s.t2V,s.uxB,s.cpd,s.fiy,s.$XZ,s.UG6,s.uqK,s.STE,s.y$z,s.mAD,s.sOq,s.hUw,s._0G,s.Sqs,s.hpZ,s.Vol,s.vYX,s.wIZ,s.cBi,s.c30,s.MPV,s.RFv,s.Ux6,s.rxy,s.I$c,s.kfC,s.VjY,s.mgq,s.YVA,s.Kgp,s.HH$,s.M_d,s.rgh,s.Ra6,s.KhR,s.gvQ,s.BS5,s.xhz,s.xOq,s.a9j,s.bHk,s.CgK,s.cEd,s.cuY,s.kvE,s.SBu,s.PsT,s.AE_,s.ctO,s.OLH,s.kky,s.nSF,s.zHn,s.zwx,s.AeJ,s.hLz,s.D9g,s.wA,s.jhr,s.GVs,s._zO,s.LXZ,s.w6$,s.mhV,s.MOD,s.kwd,s.Lmr,s.xsS,s.K5l,s.lLr,s.Z$r,s.IXb,s.Xsu,s.SGH,s.SMj,s.L34,s.exe,s.bnF,s.MFA,s.$uU,s.Sap,s.jyi,s.E03,s.V6q,s.rg2,s.DVW,s.nVo,s.F6N,s.xP7,s.Odq,s.Zif,s.ZGJ,s.MJk,s.xvT,s.PHM,s.dpR,s.n9L,s.KwO,s.SxM,s.B7y,s.x7r,s.wx7,s.Uvn,s.OFT,s.xzN,s.CcZ,s.M5Z,s.ZrN,s.OWs,s.dF9,s.oZy,s.rD2,s.VHo,s.ohE,s.R$E,s.xQN,s.AdJ,s.q3I,s.Pab,s.uZ5,s.McK,s.F9c,s.k0b,s.hnT,s.RSJ,s.Mku,s.h90,s.rms,s.ErP,s.aVg,s.lPc,s.Z8E,s._N2,s.yFn,s.lNv,s.cu9,s.MZQ,s.FUM,s.BxR,s.vdf,s.iaL,s.w6H,s.Q4c,s.Xxe,s.Uxb,s.Yr5;var h=s.Bhw;s.yOA;const l=new a({width:800,height:600}),d=new r({x:150,y:l.drawHeight-40,width:200,height:20,color:o.Chartreuse});d.body.collisionType=n.Fixed,l.add(d),l.input.pointers.primary.on("move",t=>{d.pos.x=t.worldPos.x});const c=new r({x:100,y:300,radius:10,color:o.Red}),u=h(100,100);setTimeout(()=>{c.vel=u},1e3),c.body.collisionType=n.Passive,l.add(c),c.on("postupdate",()=>{c.pos.x<c.width/2&&(c.vel.x=u.x),c.pos.x+c.width/2>l.drawWidth&&(c.vel.x=-1*u.x),c.pos.y<c.height/2&&(c.vel.y=u.y)});const p=[o.Violet,o.Orange,o.Yellow],_=l.drawWidth/5-20-4,g=[];for(let t=0;t<3;t++)for(let e=0;e<5;e++)g.push(new r({x:65+e*(_+20)+20,y:20+50*t+20,width:_,height:30,color:p[t%p.length]}));g.forEach(function(t){t.body.collisionType=n.Active,l.add(t)});let m=!1;c.on("collisionstart",function(t){g.indexOf(t.other)>-1&&t.other.kill();var e=t.contact.mtv.normalize();m||(m=!0,Math.abs(e.x)>Math.abs(e.y)?c.vel.x*=-1:c.vel.y*=-1)}),c.on("collisionend",()=>{m=!1}),c.on("exitviewport",()=>{alert("You lose!")}),l.start();
//# sourceMappingURL=index.318d1d23.js.map
